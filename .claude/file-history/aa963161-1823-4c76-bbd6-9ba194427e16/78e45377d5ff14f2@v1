import React, { useState, useEffect } from 'react';
import { useAgents } from '../../context/AgentContext';
import { useNavigate } from 'react-router-dom';
import { HierarchyTree } from './HierarchyTree';
import { Search, Loader2, Bot, Plus } from 'lucide-react';
import { ask } from '@tauri-apps/plugin-dialog';
import { useQuery } from '@tanstack/react-query';
import { api } from '../../lib/api';
import { isHotkey } from '../../lib/hotkeys';

export const AgentExplorer: React.FC = () => {
  const {
    agents,
    activeAgentId,
    selectAgent,
    renameAgent,
    updateAgentState,
    createAgent,
    deleteAgent,
    focusedPane
  } = useAgents();
  const navigate = useNavigate();
  const [searchQuery, setSearchQuery] = useState('');
  const [isSearching, setIsSearching] = useState(false);
  const [activeIndex, setActiveIndex] = useState(-1);
  const [contextMenu, setContextMenu] = useState<{ x: number, y: number } | null>(null);

  useEffect(() => {
    const handleClick = () => setContextMenu(null);
    window.addEventListener('click', handleClick);
    return () => window.removeEventListener('click', handleClick);
  }, []);

  const handleContextMenu = (e: React.MouseEvent) => {
    e.preventDefault();
    setContextMenu({ x: e.clientX, y: e.clientY });
  };

  const { data: config } = useQuery({
    queryKey: ['config'],
    queryFn: () => api.getConfig(),
  });

  const { data: apiKeys } = useQuery({
    queryKey: ['apiKeys'],
    queryFn: () => api.getApiKeys(),
  });

  const filteredAgents = React.useMemo(() => {
    if (!searchQuery) return agents;
    const filtered: Record<string, any> = {};
    Object.entries(agents).forEach(([id, agent]) => {
      if (
        agent.name?.toLowerCase().includes(searchQuery.toLowerCase()) ||
        id.toLowerCase().includes(searchQuery.toLowerCase())
      ) {
        filtered[id] = agent;
      }
    });
    return filtered;
  }, [agents, searchQuery]);

  const flatVisibleAgents = React.useMemo(() => {
    const result: any[] = [];
    const visited = new Set<string>();

    const addWithChildren = (parentId: string | null) => {
      const children = Object.values(filteredAgents)
        .filter(a => a.parent_id === parentId)
        .sort((a, b) => new Date(a.created_at).getTime() - new Date(b.created_at).getTime());

      children.forEach(child => {
        if (visited.has(child.id)) return;
        visited.add(child.id);
        result.push(child);
        addWithChildren(child.id);
      });
    };

    addWithChildren(null);
    Object.keys(filteredAgents).forEach(id => {
      if (!visited.has(id)) {
        visited.add(id);
        result.push(filteredAgents[id]);
        addWithChildren(id);
      }
    });
    return result;
  }, [filteredAgents]);

  useEffect(() => {
    const handleKeyDown = (e: KeyboardEvent) => {
      if (e.key === 'Escape' && isSearching) {
        setIsSearching(false);
        setSearchQuery('');
      }

      if (focusedPane !== 'explorer') return;

      if (e.key === 'ArrowDown') {
        e.preventDefault();
        setActiveIndex(prev => Math.min(prev + 1, flatVisibleAgents.length - 1));
      } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        setActiveIndex(prev => Math.max(prev - 1, 0));
      } else if (e.key === 'Enter') {
        if (activeIndex >= 0 && flatVisibleAgents[activeIndex]) {
          e.preventDefault();
          const agent = flatVisibleAgents[activeIndex];
          selectAgent(agent.id);
          navigate(`/agent/${agent.id}`);
        }
      }
    };

    window.addEventListener('keydown', handleKeyDown);
    return () => window.removeEventListener('keydown', handleKeyDown);
  }, [isSearching, focusedPane, flatVisibleAgents, activeIndex, selectAgent, navigate]);

  const handleRename = async (id: string) => {
    const agent = agents[id];
    if (!agent) return;

    const newName = window.prompt("Enter new name for agent:", agent.name || agent.id.slice(0, 8));

    if (newName && newName !== agent.name) {
      await renameAgent(id, newName);
    }
  };

  const handleAddSubagent = async (parentId: string) => {
    const parent = agents[parentId];
    if (!parent) return;

    try {
      const response = await createAgent(
        parent.model_config,
        "",
        { parent_id: parentId }
      );
      if (response && response.id) {
        selectAgent(response.id);
        navigate(`/agent/${response.id}`);
      }
    } catch (err) {
      console.error('Failed to create subagent:', err);
    }
  };

  const handleAction = async (id: string, action: 'pause' | 'pause_tree' | 'resume' | 'resume_tree' | 'delete') => {
    switch (action) {
      case 'pause':
      case 'pause_tree':
      case 'resume':
      case 'resume_tree':
        await updateAgentState(id, action);
        break;
      case 'delete':
        const confirmed = await ask("Are you sure you want to delete this agent and all its history? This cannot be undone.", {
          title: 'Delete Agent',
          kind: 'warning',
        });
        if (confirmed) {
          await deleteAgent(id);
          if (activeAgentId === id) {
            navigate('/');
          }
        }
        break;
    }
  };

  const handleCreateAgent = async () => {
    try {
      let provider = config?.inference?.chat?.provider || '';
      let model = config?.inference?.chat?.model || '';

      if (apiKeys) {
        const keyData = apiKeys.find(k => k.provider === provider);
        if (!provider || !model || keyData?.enabled !== true) {
          const firstValid = apiKeys.find(k => k.enabled === true);
          if (firstValid) {
            provider = firstValid.provider;
            model = config?.available_models?.[provider]?.chat?.[0] || '';
          }
        }
      }

      if (!provider || !model) {
        navigate('/settings');
        return;
      }

      const response = await createAgent({ provider, model }, "");
      if (response && response.id) {
        selectAgent(response.id);
        navigate(`/agent/${response.id}`);
      }
    } catch (err) {
      console.error('Failed to create agent:', err);
    }
  };

  return (
    <div className="flex flex-col h-full bg-[#0f1117] select-none relative group/explorer">
      {/* Sidebar Header */}
      <div className="p-3 border-b border-[#1e293b] flex flex-col gap-2">
        <div className="flex items-center gap-2">
          <span className="text-[12px] font-medium text-[#e2e8f0]">Agents</span>
        </div>
        <p className="text-[11px] text-[#64748b] leading-tight">
          Navigate and manage agent hierarchy
        </p>

        <button
          onClick={() => navigate('/')}
          className="w-full flex items-center justify-start gap-2 py-1.5 px-2 hover:bg-[#6366f1]/10 text-[#6366f1] transition-all rounded"
        >
          <span className="text-[11px] font-medium">Back to Fleet</span>
        </button>
      </div>

      {/* Search Overlay */}
      {isSearching && (
        <div className="absolute inset-x-0 top-0 z-20 p-1 bg-background border-b border-border/40">
          <div className="flex items-center gap-2 px-2 py-1 bg-surface/50 border border-accent/20 font-mono">
            <span className="text-accent text-[10px] font-black animate-pulse">{'>'}</span>
            <input
              autoFocus
              type="text"
              placeholder="QUERY..."
              value={searchQuery}
              onChange={(e) => setSearchQuery(e.target.value)}
              onBlur={() => { if (!searchQuery) setIsSearching(false); }}
              className="bg-transparent border-none outline-none text-[10px] text-text-primary placeholder:text-text-tertiary/20 uppercase w-full font-black tracking-tighter"
            />
          </div>
        </div>
      )}

      {/* Hierarchy Tree */}
      <div
        className="flex-1 overflow-y-auto custom-scrollbar pt-0.5"
        onContextMenu={handleContextMenu}
      >
        <HierarchyTree
          agents={filteredAgents}
          activeAgentId={activeAgentId}
          highlightedAgentId={activeIndex >= 0 ? flatVisibleAgents[activeIndex]?.id : null}
          onSelectAgent={(id) => {
            selectAgent(id);
            navigate(`/agent/${id}`);
          }}
          onRename={handleRename}
          onAddSubagent={handleAddSubagent}
          onAction={handleAction}
        />
      </div>

      {contextMenu && (
        <div
          className="fixed z-[100] w-40 bg-surface border border-border rounded shadow-2xl overflow-hidden animate-in fade-in zoom-in-95 duration-100 backdrop-blur-md"
          style={{ top: contextMenu.y, left: contextMenu.x }}
          onClick={(e) => e.stopPropagation()}
        >
          <button
            className="w-full text-left px-3 py-2 hover:bg-accent hover:text-background transition-colors flex items-center gap-2 text-[10px] font-bold uppercase tracking-wider"
            onClick={() => {
              handleCreateAgent();
              setContextMenu(null);
            }}
          >
            <Plus size={10} />
            NEW AGENT
          </button>
        </div>
      )}
    </div>
  );
};
