import React, { useState, useEffect, useRef, useCallback } from 'react';
import { useAgents } from '../context/AgentContext';
import { useNavigate, useLocation } from 'react-router-dom';
import { Zap, Search, Plus, ChevronLeft, ChevronRight } from 'lucide-react';
import { clsx } from 'clsx';
import { type Agent, isSubAgentManagedCLI } from '../lib/api';
import { useQuery } from '@tanstack/react-query';
import { api } from '../lib/api';
import { ask } from '@tauri-apps/plugin-dialog';
import { isHotkey } from '../lib/hotkeys';
import { Tag, Status } from './ui';

interface Command {
  id: string;
  label: string;
  path?: string;
  action?: () => void;
}

export const Unibar: React.FC = () => {
  const { agents, selectAgent, createAgent, setSidebarCollapsed, updateAgentState, renameAgent, deleteAgent } = useAgents();
  const [isOpen, setIsOpen] = useState(false);
  const [query, setQuery] = useState('');
  const [selectedIndex, setSelectedIndex] = useState(0);
  const [contextMenu, setContextMenu] = useState<{ x: number, y: number, agentId: string } | null>(null);
  const inputRef = useRef<HTMLInputElement>(null);
  const listRef = useRef<HTMLDivElement>(null);
  const navigate = useNavigate();
  const location = useLocation();

  useEffect(() => {
    const handleClick = () => setContextMenu(null);
    window.addEventListener('click', handleClick);
    return () => window.removeEventListener('click', handleClick);
  }, []);

  const agentMatch = location.pathname.match(/\/agent\/([^/]+)/);
  const activeAgentId = agentMatch ? agentMatch[1] : null;

  const { data: config } = useQuery({
    queryKey: ['config'],
    queryFn: () => api.getConfig(),
  });

  const { data: apiKeys } = useQuery({
    queryKey: ['apiKeys'],
    queryFn: () => api.getApiKeys(),
  });

  const handleDuplicate = async (agentId: string) => {
    const agent = agents[agentId];
    if (!agent) return;

    try {
      const response = await createAgent(
        agent.model_config,
        agent.initial_prompt,
        {
          name: `${agent.name || 'Agent'} (Copy)`,
          plan_enabled: agent.plan_enabled,
          sub_agents_enabled: agent.sub_agents_enabled
        }
      );
      if (response && response.id) {
        selectAgent(response.id);
        navigate(`/agent/${response.id}`);
      }
    } catch (err) {
      console.error('Failed to duplicate agent:', err);
    }
  };

  const handleRename = async (agentId: string) => {
    const agent = agents[agentId];
    if (!agent) return;

    const newName = window.prompt("Enter new name for agent:", agent.name || '');

    if (newName && newName !== agent.name) {
      await renameAgent(agentId, newName);
    }
  };

  const handleDelete = async (agentId: string) => {
    const confirmed = await ask("Are you sure you want to delete this agent? This action cannot be undone.", {
      title: 'Delete Agent',
      kind: 'warning',
    });

    if (confirmed) {
      await deleteAgent(agentId);
      if (activeAgentId === agentId) {
        navigate('/');
      }
    }
  };

  const handleCreateAgent = async () => {
    try {
      let provider = config?.inference?.chat?.provider || '';
      let model = config?.inference?.chat?.model || '';

      if (apiKeys) {
        const keyData = apiKeys.find(k => k.provider === provider);
        const currentValid = provider && model && keyData?.enabled === true;

        if (!currentValid) {
          const firstValid = apiKeys.find(k => k.enabled === true);
          if (firstValid) {
            provider = firstValid.provider;
            model = config?.available_models?.[provider]?.chat?.[0] || '';
          } else {
            const confirmed = await ask("No LLM provider is enabled. You must enable at least one provider in Settings to create agents. Would you like to go to Settings now?", {
              title: 'No Providers Enabled',
              kind: 'warning',
            });
            if (confirmed) {
              navigate('/settings');
            }
            handleClose();
            return;
          }
        }
      }

      if (!provider || !model) {
        navigate('/settings');
        handleClose();
        return;
      }

      const response = await createAgent({ provider, model }, "");
      if (response && response.id) {
        setSidebarCollapsed(true);
        navigate(`/agent/${response.id}`);
      }
    } catch (err) {
      console.error('Failed to create agent from omnibar:', err);
    }
  };

  const sortedAgents = React.useMemo(() => {
    const allArr = Object.values(agents);
    const all = allArr.filter(a => {
      if (a.is_internal) return false;

      let curr = a;
      while (curr.parent_id) {
        const parent = agents[curr.parent_id];
        if (parent && parent.is_internal) return false;
        if (parent && (parent.name === 'Feedback Collector' || parent.name?.toLowerCase().includes('skill architect') || parent.name?.toLowerCase().includes('trigger architect'))) return false;
        if (!parent) break;
        curr = parent;
      }

      return (
        a.name?.toLowerCase().includes(query.toLowerCase()) ||
        a.id.toLowerCase().includes(query.toLowerCase()) ||
        a.model_config.model.toLowerCase().includes(query.toLowerCase())
      );
    });

    const result: typeof all = [];
    const visited = new Set<string>();

    const addWithChildren = (parentId: string | null) => {
      const children = all
        .filter(a => a.parent_id === parentId)
        .sort((a, b) => new Date(b.created_at).getTime() - new Date(a.created_at).getTime());

      children.forEach(child => {
        if (visited.has(child.id)) return;
        visited.add(child.id);
        result.push(child);
        addWithChildren(child.id);
      });
    };

    addWithChildren(null);

    all.forEach(a => {
      if (!visited.has(a.id)) {
        visited.add(a.id);
        result.push(a);
        addWithChildren(a.id);
      }
    });

    return result;
  }, [agents, query]);

  const commands: Command[] = [
    { id: 'dashboard', label: 'Agent Dashboard', path: '/' },
    { id: 'create-agent', label: 'Create New Agent', action: handleCreateAgent },
    { id: 'skills', label: 'Skills', path: '/skills' },
    { id: 'triggers', label: 'Triggers', path: '/triggers' },
    { id: 'usage', label: 'Usage', path: '/usage' },
    { id: 'settings', label: 'Settings', path: '/settings' },
  ].filter(c => c.label.toLowerCase().includes(query.toLowerCase()));

  const results = [...commands, ...sortedAgents];

  const handleOpen = useCallback(() => {
    setIsOpen(true);
    setQuery('');
    setSelectedIndex(0);
    setTimeout(() => inputRef.current?.focus(), 10);
  }, []);

  const handleClose = useCallback(() => {
    setIsOpen(false);
    setQuery('');
  }, []);

  useEffect(() => {
    const handleKeyDown = (e: KeyboardEvent) => {
      const toggleHotkey = (config?.ui as any)?.hotkeys?.['toggle_unibar'] || 'Cmd+K';
      if (isHotkey(e, toggleHotkey)) {
        e.preventDefault();
        if (isOpen) {
          handleClose();
        } else {
          handleOpen();
        }
      }
      if (e.key === 'Escape') {
        if (isOpen) {
          e.preventDefault();
          e.stopPropagation();
          handleClose();
        }
      }
    };

    window.addEventListener('keydown', handleKeyDown);
    return () => window.removeEventListener('keydown', handleKeyDown);
  }, [handleOpen, handleClose, isOpen, config]);

  useEffect(() => {
    if (isOpen && listRef.current) {
      const selectedElement = listRef.current.children[selectedIndex] as HTMLElement;
      if (selectedElement) {
        selectedElement.scrollIntoView({
          block: 'nearest',
        });
      }
    }
  }, [selectedIndex, isOpen]);

  const handleSelect = (item: Agent | Command) => {
    if ('path' in item || 'action' in item) {
      const cmd = item as Command;
      if (cmd.action) {
        cmd.action();
      } else if (cmd.path) {
        navigate(cmd.path);
        if (cmd.id === 'dashboard') selectAgent(null);
      }
    } else {
      selectAgent(item.id);
      navigate(`/agent/${item.id}`);
    }
    handleClose();
  };

  const onKeyDown = (e: React.KeyboardEvent) => {
    if (e.key === 'ArrowDown') {
      e.preventDefault();
      setSelectedIndex(prev => (prev + 1) % Math.max(1, results.length));
    } else if (e.key === 'ArrowUp') {
      e.preventDefault();
      setSelectedIndex(prev => (prev - 1 + results.length) % Math.max(1, results.length));
    } else if (e.key === 'Enter') {
      e.preventDefault();
      if (results[selectedIndex]) {
        handleSelect(results[selectedIndex]);
      }
    }
  };

  const navItems = [
    { id: 'fleet', label: 'Fleet', path: '/' },
    { id: 'skills', label: 'Skills', path: '/skills' },
    { id: 'triggers', label: 'Triggers', path: '/triggers' },
    { id: 'usage', label: 'Usage', path: '/usage' },
    { id: 'settings', label: 'Settings', path: '/settings' },
  ];

  const isActive = (path: string) => {
    if (path === '/') return location.pathname === '/' || location.pathname.endsWith('/');
    return location.pathname === path;
  };

  if (!isOpen) {
    return (
      <header
        className="fixed top-0 left-0 right-0 h-9 bg-[#0a0b0f] border-b border-[#1e293b] flex items-center px-3 gap-4 z-40"
        data-tauri-drag-region
      >
        <div className="flex items-center gap-1.5 pointer-events-auto">
          <Zap size={14} className="text-[#8b5cf6]" />
          <span className="font-semibold text-[13px] text-[#e2e8f0]">Familiar</span>
          <Tag color="#f59e0b">DEV</Tag>
        </div>

        <nav className="flex gap-0.5 pointer-events-auto">
          {navItems.map(item => (
            <button
              key={item.id}
              onClick={() => {
                if (item.path === '/') selectAgent(null);
                navigate(item.path);
              }}
              className={clsx(
                "px-2.5 py-1.5 rounded text-[12px] transition-colors",
                isActive(item.path)
                  ? "bg-[#6366f1]/15 text-[#a5b4fc]"
                  : "text-[#64748b] hover:text-[#94a3b8]"
              )}
            >
              {item.label}
            </button>
          ))}
        </nav>

        <div className="flex-1" />

        <div className="flex items-center gap-2 pointer-events-auto">
          <button
            onClick={handleOpen}
            className="flex items-center gap-1.5 px-2 py-1 bg-[#1e293b] rounded text-[12px] text-[#64748b] hover:text-[#94a3b8] transition-colors"
          >
            <Search size={12} />
            <span>Search...</span>
            <span className="text-[10px] font-mono text-[#475569]">⌘K</span>
          </button>
        </div>

        <div className="flex items-center gap-1 pointer-events-auto opacity-50">
          <button
            onClick={() => navigate(-1)}
            className="p-1 hover:bg-[#1e293b] rounded transition-colors text-[#64748b] hover:text-[#94a3b8]"
            title="Back"
          >
            <ChevronLeft size={14} />
          </button>
          <button
            onClick={() => navigate(1)}
            className="p-1 hover:bg-[#1e293b] rounded transition-colors text-[#64748b] hover:text-[#94a3b8]"
            title="Forward"
          >
            <ChevronRight size={14} />
          </button>
        </div>

        {contextMenu && (
          <div
            className="fixed z-[100] w-44 bg-[#0a0b0f] border border-[#1e293b] rounded text-[11px] overflow-hidden shadow-xl"
            style={{ top: contextMenu.y, left: contextMenu.x }}
            onClick={(e) => e.stopPropagation()}
          >
            <div className="px-2 py-1.5 border-b border-[#1e293b] text-[#64748b] text-[10px]">
              {agents[contextMenu.agentId]?.name || agents[contextMenu.agentId]?.id.slice(0, 8)}
            </div>
            <button
              className="w-full text-left px-2 py-1.5 text-[#94a3b8] hover:bg-[#1e293b] transition-colors"
              onClick={() => {
                selectAgent(contextMenu.agentId);
                navigate(`/agent/${contextMenu.agentId}`);
                setContextMenu(null);
              }}
            >
              View Logs
            </button>
            <button
              className="w-full text-left px-2 py-1.5 text-[#94a3b8] hover:bg-[#1e293b] transition-colors"
              onClick={() => {
                const agent = agents[contextMenu.agentId];
                if (agent) {
                  updateAgentState(contextMenu.agentId, agent.state === 'running' ? 'pause' : 'resume');
                }
                setContextMenu(null);
              }}
            >
              {agents[contextMenu.agentId]?.state === 'running' ? 'Pause' : 'Resume'}
            </button>
            <button
              className="w-full text-left px-2 py-1.5 text-[#94a3b8] hover:bg-[#1e293b] transition-colors"
              onClick={() => {
                handleRename(contextMenu.agentId);
                setContextMenu(null);
              }}
            >
              Rename
            </button>
            <button
              className="w-full text-left px-2 py-1.5 text-[#94a3b8] hover:bg-[#1e293b] transition-colors"
              onClick={() => {
                handleDuplicate(contextMenu.agentId);
                setContextMenu(null);
              }}
            >
              Duplicate
            </button>
            <button
              className="w-full text-left px-2 py-1.5 text-[#ef4444] hover:bg-[#ef4444]/10 transition-colors"
              onClick={async () => {
                await handleDelete(contextMenu.agentId);
                setContextMenu(null);
              }}
            >
              Delete
            </button>
          </div>
        )}
      </header>
    );
  }

  return (
    <div className="fixed inset-0 z-50 flex items-start justify-center">
      <div
        className="absolute inset-0 bg-gradient-to-b from-black/80 via-black/40 to-transparent"
        onClick={handleClose}
      />
      <div className="w-full bg-[#0a0b0f] border-b border-[#6366f1]/30 shadow-2xl flex flex-col relative">
        <div className="flex items-center px-4 h-9 border-b border-[#1e293b]">
          <Search size={12} className="text-[#64748b] mr-2" />
          <input
            ref={inputRef}
            type="text"
            className="flex-1 bg-transparent border-none outline-none text-[12px] text-[#e2e8f0] placeholder:text-[#475569]"
            placeholder="Search agents or commands..."
            value={query}
            onChange={(e) => {
              setQuery(e.target.value);
              setSelectedIndex(0);
            }}
            onKeyDown={onKeyDown}
          />
          <div className="flex items-center gap-4 ml-4">
            <span className="text-[10px] text-[#475569]">↑↓ Navigate</span>
            <span className="text-[10px] text-[#475569]">↵ Select</span>
            <span className="text-[10px] text-[#475569]">Esc Close</span>
          </div>
        </div>

        <div
          ref={listRef}
          className="max-h-[280px] overflow-y-auto"
        >
          {results.length === 0 ? (
            <div className="py-4 text-center text-[#475569] text-[12px]">
              No results found
            </div>
          ) : (
            results.map((item: Agent | Command, index) => {
              const isCommand = 'path' in item || 'action' in item;
              const depth = isCommand ? 0 : (() => {
                let d = 0;
                let curr = item as Agent;
                while (curr.parent_id && agents[curr.parent_id]) {
                  d++;
                  curr = agents[curr.parent_id];
                }
                return d;
              })();

              const contextPct = !isCommand && (item as Agent).max_context_tokens > 0
                ? Math.min(100, Math.round(((item as Agent).context_tokens / (item as Agent).max_context_tokens) * 100))
                : 0;

              return (
                <div
                  key={isCommand ? (item as Command).id : (item as Agent).id}
                  onClick={() => handleSelect(item)}
                  className={clsx(
                    "flex items-center px-4 py-2 cursor-pointer transition-colors",
                    index === selectedIndex ? "bg-[#6366f1]/20" : "hover:bg-[#1e293b]"
                  )}
                  style={{ paddingLeft: `${16 + depth * 16}px` }}
                >
                  <div className="flex-1 min-w-0 flex items-center gap-3">
                    <span className={clsx(
                      "text-[12px]",
                      index === selectedIndex ? "text-[#a5b4fc]" : "text-[#e2e8f0]"
                    )}>
                      {isCommand ? (item as Command).label : (item as Agent).name || (item as Agent).id.slice(0, 8)}
                    </span>
                    {!isCommand && (
                      <span className="text-[10px] text-[#475569] font-mono">
                        {(item as Agent).id.slice(0, 8)}
                      </span>
                    )}
                  </div>
                  {!isCommand && (
                    <div className="flex items-center gap-3">
                      <Status status={(item as Agent).state as any} />
                      {!isSubAgentManagedCLI(item as Agent) && (
                        <>
                          <div className="w-12 h-1 bg-[#1e293b] rounded overflow-hidden">
                            <div
                              className={clsx(
                                "h-full",
                                contextPct > 90 ? "bg-[#ef4444]" : contextPct > 75 ? "bg-[#f59e0b]" : "bg-[#6366f1]"
                              )}
                              style={{ width: `${contextPct}%` }}
                            />
                          </div>
                          <span className="text-[10px] text-[#64748b] font-mono w-8">{contextPct}%</span>
                          <Tag color="#8b5cf6">{(item as Agent).model_config.model.split('/').pop()}</Tag>
                        </>
                      )}
                    </div>
                  )}
                </div>
              );
            })
          )}
        </div>
      </div>
    </div>
  );
};
