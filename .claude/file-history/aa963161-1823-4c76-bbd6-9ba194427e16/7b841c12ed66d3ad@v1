import React from 'react';
import { clsx } from 'clsx';
import { ChevronRight, ChevronDown } from 'lucide-react';
import type { Agent } from '../../lib/api';
import { Status } from '../ui';

interface HierarchyTreeProps {
    agents: Record<string, Agent>;
    activeAgentId: string | null;
    highlightedAgentId?: string | null;
    onSelectAgent: (id: string) => void;
    onRename?: (id: string) => void;
    onAddSubagent?: (parentId: string) => void;
    onAction?: (id: string, action: 'pause' | 'pause_tree' | 'resume' | 'resume_tree' | 'delete') => void;
}

export const HierarchyTree: React.FC<HierarchyTreeProps> = ({
    agents,
    activeAgentId,
    highlightedAgentId,
    onSelectAgent,
    onRename,
    onAddSubagent,
    onAction
}) => {
    const [contextMenu, setContextMenu] = React.useState<{ x: number, y: number, agentId: string } | null>(null);
    const [expandedIds, setExpandedIds] = React.useState<Record<string, boolean>>({});

    React.useEffect(() => {
        const handleClick = () => setContextMenu(null);
        window.addEventListener('click', handleClick);
        return () => window.removeEventListener('click', handleClick);
    }, []);

    const handleContextMenu = (e: React.MouseEvent, agentId: string) => {
        e.preventDefault();
        e.stopPropagation();
        setContextMenu({ x: e.clientX, y: e.clientY, agentId });
    };

    const renderAgentNode = (agent: Agent, depth: number) => {
        const isCurrent = activeAgentId ? agent.id.toLowerCase() === activeAgentId.toLowerCase() : false;
        const isHighlighted = highlightedAgentId ? agent.id.toLowerCase() === highlightedAgentId.toLowerCase() : false;

        // Build path to active agent for expansion
        const pathIds = new Set<string>();
        if (activeAgentId && agents[activeAgentId]) {
            let curr = agents[activeAgentId];
            pathIds.add(curr.id.toLowerCase());
            while (curr.parent_id && agents[curr.parent_id]) {
                curr = agents[curr.parent_id];
                pathIds.add(curr.id.toLowerCase());
            }
        }

        const isOnPath = pathIds.has(agent.id.toLowerCase());

        // Find visible children for this agent
        const children = Object.values(agents).filter(
            (a) => a.parent_id?.toLowerCase() === agent.id.toLowerCase() && !a.is_internal
        ).sort((a, b) => new Date(a.created_at).getTime() - new Date(b.created_at).getTime());

        const hasChildren = children.length > 0;
        // Always show up to 3 levels deep, or if on path, unless manually toggled
        const defaultExpand = depth < 3 || isOnPath || isCurrent;
        const shouldExpand = expandedIds[agent.id] !== undefined ? expandedIds[agent.id] : defaultExpand;

        return (
            <div key={agent.id} className="flex flex-col">
                <div className="group flex flex-col relative">
                    <div
                        onClick={() => onSelectAgent(agent.id)}
                        onContextMenu={(e) => handleContextMenu(e, agent.id)}
                        style={{ paddingLeft: `${depth * 12 + 4}px` }}
                        className={clsx(
                            "flex items-center gap-1.5 py-0.5 px-1 cursor-pointer relative transition-colors",
                            isCurrent ? "bg-accent/20 text-accent" : (isHighlighted ? "bg-accent/10 text-accent/80" : "hover:bg-surface/30 text-text-secondary hover:text-text-primary")
                        )}
                    >
                        {/* Keyboard Highlight Marker */}
                        <span className="text-accent/40 w-2 shrink-0">{isHighlighted ? '>' : ' '}</span>

                        {/* Status Marker */}
                        <span className={clsx(
                            "text-[9px] font-black shrink-0 font-mono w-8 text-center",
                            agent.state === 'running' ? "text-status-success" :
                                (agent.state === 'waiting' || agent.state === 'awaiting_approval' || agent.state === 'awaiting_secret') ? "text-status-warning" :
                                    agent.state === 'error' ? "text-status-error" :
                                        "text-text-tertiary/40"
                        )}>
                            {agent.state === 'running' ? '[RUN]' :
                                agent.state === 'waiting' ? '[WAI]' :
                                    (agent.state === 'awaiting_approval' || agent.state === 'awaiting_secret') ? '[!!!]' :
                                        agent.state === 'error' ? '[ERR]' :
                                            agent.state === 'paused' ? '[PAU]' : '[IDL]'}
                        </span>

                        <span className={clsx(
                            "text-[10px] truncate font-mono flex-1 min-w-0 tracking-tighter uppercase",
                            isCurrent ? "font-black" : (isHighlighted ? "font-black" : "font-bold opacity-80")
                        )}>
                            {depth > 0 && <span className="opacity-30 mr-1">â†³</span>}
                            {agent.name || agent.id.slice(0, 8)}
                        </span>

                        {agent.type === 'cli' && (
                            <span className="text-[8px] text-accent opacity-50 font-black shrink-0">@CLI</span>
                        )}

                        {hasChildren && !isCurrent && (
                            <span
                                onClick={(e) => {
                                    e.stopPropagation();
                                    setExpandedIds(prev => ({ ...prev, [agent.id]: !shouldExpand }));
                                }}
                                className="text-[9px] text-text-tertiary hover:text-text-primary opacity-40 hover:opacity-100 shrink-0 font-mono p-1 -m-1"
                            >
                                {shouldExpand ? '[-]' : '[+]'}
                            </span>
                        )}
                    </div>
                </div>

                {shouldExpand && hasChildren && (
                    <div className="flex flex-col">
                        {children.map((child) => renderAgentNode(child, depth + 1))}
                    </div>
                )}
            </div>
        );
    };

    // Find root agents (no parent or parent not found)
    const rootAgents = Object.values(agents).filter(
        (a) => (!a.parent_id || !agents[a.parent_id]) && !a.is_internal
    ).sort((a, b) => new Date(a.created_at).getTime() - new Date(b.created_at).getTime());

    return (
        <div className="flex flex-col py-1">
            {rootAgents.map((agent) => renderAgentNode(agent, 0))}

            {contextMenu && (
                <div
                    className="fixed z-[100] w-44 bg-[#0a0a0a] border border-[#333] font-mono text-[10px] overflow-hidden animate-in fade-in duration-75"
                    style={{ top: contextMenu.y, left: contextMenu.x }}
                    onClick={(e) => e.stopPropagation()}
                >
                    <div className="px-2 py-1 border-b border-[#333] bg-[#111] text-[#666]">
                        <span className="text-[8px] tracking-wider">
                            *** {agents[contextMenu.agentId]?.name || agents[contextMenu.agentId]?.id.slice(0, 8)}
                        </span>
                    </div>

                    <button
                        className="w-full text-left px-2 py-1.5 text-[#0f0] hover:bg-[#0f0]/10 hover:text-[#0f0] transition-colors border-b border-[#222]"
                        onClick={() => {
                            onRename?.(contextMenu.agentId);
                            setContextMenu(null);
                        }}
                    >
                        RENAME
                    </button>

                    <button
                        className="w-full text-left px-2 py-1.5 text-[#0f0] hover:bg-[#0f0]/10 hover:text-[#0f0] transition-colors border-b border-[#222]"
                        onClick={() => {
                            onAddSubagent?.(contextMenu.agentId);
                            setContextMenu(null);
                        }}
                    >
                        ADD SUBAGENT
                    </button>

                    <button
                        className="w-full text-left px-2 py-1.5 text-[#0f0] hover:bg-[#0f0]/10 hover:text-[#0f0] transition-colors border-b border-[#222]"
                        onClick={() => {
                            const agent = agents[contextMenu.agentId];
                            if (agent) {
                                onAction?.(contextMenu.agentId, agent.state === 'running' ? 'pause' : 'resume');
                            }
                            setContextMenu(null);
                        }}
                    >
                        {agents[contextMenu.agentId]?.state === 'running' ? 'PAUSE' : 'RESUME'}
                    </button>

                    {agents[contextMenu.agentId]?.state === 'running' && (
                        <button
                            className="w-full text-left px-2 py-1.5 text-[#0f0] hover:bg-[#0f0]/10 hover:text-[#0f0] transition-colors border-b border-[#222]"
                            onClick={() => {
                                onAction?.(contextMenu.agentId, 'pause_tree');
                                setContextMenu(null);
                            }}
                        >
                            PAUSE TREE
                        </button>
                    )}

                    {(agents[contextMenu.agentId]?.state === 'paused' || agents[contextMenu.agentId]?.state === 'waiting') && (
                        <button
                            className="w-full text-left px-2 py-1.5 text-[#0f0] hover:bg-[#0f0]/10 hover:text-[#0f0] transition-colors border-b border-[#222]"
                            onClick={() => {
                                onAction?.(contextMenu.agentId, 'resume_tree');
                                setContextMenu(null);
                            }}
                        >
                            RESUME TREE
                        </button>
                    )}

                    <button
                        className="w-full text-left px-2 py-1.5 text-[#f44] hover:bg-[#f44]/10 hover:text-[#f44] transition-colors"
                        onClick={async () => {
                            await onAction?.(contextMenu.agentId, 'delete');
                            setContextMenu(null);
                        }}
                    >
                        DELETE
                    </button>
                </div>
            )}
        </div>
    );
};

