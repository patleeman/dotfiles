{"type":"summary","summary":"CLI Session Closed with Goodbye Message","leafUuid":"57a73971-b3cf-4326-a91d-03047a30ff37"}
{"type":"file-history-snapshot","messageId":"c0657f1c-2107-41fa-b55a-b1b2fa66216e","snapshot":{"messageId":"c0657f1c-2107-41fa-b55a-b1b2fa66216e","trackedFileBackups":{},"timestamp":"2026-01-03T02:40:09.795Z"},"isSnapshotUpdate":false}
{"parentUuid":null,"isSidechain":false,"userType":"external","cwd":"/Users/patrick/workingdir/familiar","sessionId":"507f4396-f3e4-4a63-8b43-9c891e06f5ee","version":"2.0.76","gitBranch":"main","type":"user","message":{"role":"user","content":"In settings/general, get rid of the theme picker"},"uuid":"c0657f1c-2107-41fa-b55a-b1b2fa66216e","timestamp":"2026-01-03T02:40:09.788Z","thinkingMetadata":{"level":"high","disabled":false,"triggers":[]},"todos":[]}
{"parentUuid":"c0657f1c-2107-41fa-b55a-b1b2fa66216e","isSidechain":false,"userType":"external","cwd":"/Users/patrick/workingdir/familiar","sessionId":"507f4396-f3e4-4a63-8b43-9c891e06f5ee","version":"2.0.76","gitBranch":"main","message":{"model":"claude-opus-4-5-20251101","id":"msg_013oRVpNBUe4NpX3QQUvfYqU","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"The user wants me to remove the theme picker from the settings/general section. Let me first find and read the relevant file to understand the current implementation.","signature":"Es8CCkYICxgCKkAx7e2Aifb9DiRks8WZhPzGXnbcSr3XeCTLzLBrEfTAdX9rO4UJv8PYr+VWhIQp+kkBf3LAaN4IK0eO5iiEzhM0EgwqnzYKa0638PCuCm8aDB2Yt4IwgLy6g7aVXSIwgAc6D968i4WfOjjhj3rlskMs426eUmuf/bkqBIrWkDqMrDH95KmZNREi0o2sguNoKrYBokaJW/Kw5LhjRQDtAhuv4yuzrv0ebF3HTfOhO0z7T9r+xDd1Pqrldlt69sSfFqgAo+tibsLYmPvnviX1q6T0iirW1+23ukdJcw8/Hzb/UgriD8KHZczQa0zskBdPm0fzK08dYSWNu2vV/Nqb6gUmm7rnrJ32mmktC2MK1kE+k9Vc3j11J/tl9XAngG/vq3Xw6dd3CbzUCA+xRIcfENV05bWpSKCsacP/eqxTMoOd7FFM3dUVgRgYAQ=="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":9,"cache_creation_input_tokens":6190,"cache_read_input_tokens":20762,"cache_creation":{"ephemeral_5m_input_tokens":6190,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CWjftNLY8cMUTq9gWD7Wv","type":"assistant","uuid":"ffe55810-d90a-4d0a-ae16-13eb73f08d47","timestamp":"2026-01-03T02:40:16.573Z"}
{"parentUuid":"ffe55810-d90a-4d0a-ae16-13eb73f08d47","isSidechain":false,"userType":"external","cwd":"/Users/patrick/workingdir/familiar","sessionId":"507f4396-f3e4-4a63-8b43-9c891e06f5ee","version":"2.0.76","gitBranch":"main","message":{"model":"claude-opus-4-5-20251101","id":"msg_013oRVpNBUe4NpX3QQUvfYqU","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01LPxntB9G1MtN8ZCgtze9hC","name":"Glob","input":{"pattern":"**/settings/**/*.{tsx,jsx,ts,js}"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":9,"cache_creation_input_tokens":6190,"cache_read_input_tokens":20762,"cache_creation":{"ephemeral_5m_input_tokens":6190,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CWjftNLY8cMUTq9gWD7Wv","type":"assistant","uuid":"9331ec4b-0af5-4dc1-8ceb-0d38fa3e9cdf","timestamp":"2026-01-03T02:40:17.190Z"}
{"parentUuid":"9331ec4b-0af5-4dc1-8ceb-0d38fa3e9cdf","isSidechain":false,"userType":"external","cwd":"/Users/patrick/workingdir/familiar","sessionId":"507f4396-f3e4-4a63-8b43-9c891e06f5ee","version":"2.0.76","gitBranch":"main","message":{"model":"claude-opus-4-5-20251101","id":"msg_013oRVpNBUe4NpX3QQUvfYqU","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01G4tXXw9oGzzPiz1UMFxxmY","name":"Grep","input":{"pattern":"theme.*picker|ThemePicker|theme-picker","glob":"*.tsx"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":9,"cache_creation_input_tokens":6190,"cache_read_input_tokens":20762,"cache_creation":{"ephemeral_5m_input_tokens":6190,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CWjftNLY8cMUTq9gWD7Wv","type":"assistant","uuid":"287e829a-f227-4782-b4d7-161c08daae09","timestamp":"2026-01-03T02:40:17.894Z"}
{"parentUuid":"287e829a-f227-4782-b4d7-161c08daae09","isSidechain":false,"userType":"external","cwd":"/Users/patrick/workingdir/familiar","sessionId":"507f4396-f3e4-4a63-8b43-9c891e06f5ee","version":"2.0.76","gitBranch":"main","slug":"precious-crunching-toast","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01G4tXXw9oGzzPiz1UMFxxmY","type":"tool_result","content":"No files found"}]},"uuid":"c1f6580c-92f6-4e3b-aad3-3e02d5ab9a3e","timestamp":"2026-01-03T02:40:17.982Z","toolUseResult":{"mode":"files_with_matches","filenames":[],"numFiles":0}}
{"parentUuid":"c1f6580c-92f6-4e3b-aad3-3e02d5ab9a3e","isSidechain":false,"userType":"external","cwd":"/Users/patrick/workingdir/familiar","sessionId":"507f4396-f3e4-4a63-8b43-9c891e06f5ee","version":"2.0.76","gitBranch":"main","slug":"precious-crunching-toast","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01LPxntB9G1MtN8ZCgtze9hC","type":"tool_result","content":"No files found"}]},"uuid":"38d77366-6edb-4264-89ab-3fae66ba2a6f","timestamp":"2026-01-03T02:40:18.478Z","toolUseResult":{"filenames":[],"durationMs":515,"numFiles":0,"truncated":false}}
{"parentUuid":"38d77366-6edb-4264-89ab-3fae66ba2a6f","isSidechain":false,"userType":"external","cwd":"/Users/patrick/workingdir/familiar","sessionId":"507f4396-f3e4-4a63-8b43-9c891e06f5ee","version":"2.0.76","gitBranch":"main","slug":"precious-crunching-toast","message":{"model":"claude-opus-4-5-20251101","id":"msg_01EfnwtoqLB1qvARB4WjqSAR","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Let me search more broadly for the settings view and for theme-related code.","signature":"EvQBCkYICxgCKkC8nG8nCFtcc2ZqGknrgW+6K2DD1rI9U50+1Lyr4edT2dlkdHnzRojmio3sOL9+MW3NZoII/0ZCA2L3EBXBl4ymEgzCn1DE3/0QiQKq5i8aDI23C5NVaSK43IW8uSIwSAAd1FTr3HjK85XuSdvNcgGS5lAkS+nlwqBeKpU3IW5tig2n2gSSs7KMvhBGsEF7KlwtlRqm2lMsTBYbOTG37J7tbsMJP7nIqi4mJHlGmT2TpWuxPpTswSK8QZiUkuKUTnGHgzFSDPHC1Yx9wrnyAT9i6LEadjMQ/BNlLPj1327NfQ5xNkLttblxD33XuRgB"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":40,"cache_creation_input_tokens":210,"cache_read_input_tokens":26952,"cache_creation":{"ephemeral_5m_input_tokens":210,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWjfu1MWEomQn7PybcYyQ","type":"assistant","uuid":"31d8e96e-3274-482f-aeb1-5bacef83c772","timestamp":"2026-01-03T02:40:24.135Z"}
{"parentUuid":"31d8e96e-3274-482f-aeb1-5bacef83c772","isSidechain":false,"userType":"external","cwd":"/Users/patrick/workingdir/familiar","sessionId":"507f4396-f3e4-4a63-8b43-9c891e06f5ee","version":"2.0.76","gitBranch":"main","slug":"precious-crunching-toast","message":{"model":"claude-opus-4-5-20251101","id":"msg_01EfnwtoqLB1qvARB4WjqSAR","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_016KNDusexVA589WHcFY1XbQ","name":"Grep","input":{"pattern":"theme","glob":"**/*Settings*.tsx","output_mode":"files_with_matches"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":40,"cache_creation_input_tokens":210,"cache_read_input_tokens":26952,"cache_creation":{"ephemeral_5m_input_tokens":210,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWjfu1MWEomQn7PybcYyQ","type":"assistant","uuid":"56e5d1e8-f04a-476e-b9fc-60fd8fabf28f","timestamp":"2026-01-03T02:40:25.136Z"}
{"parentUuid":"56e5d1e8-f04a-476e-b9fc-60fd8fabf28f","isSidechain":false,"userType":"external","cwd":"/Users/patrick/workingdir/familiar","sessionId":"507f4396-f3e4-4a63-8b43-9c891e06f5ee","version":"2.0.76","gitBranch":"main","slug":"precious-crunching-toast","message":{"model":"claude-opus-4-5-20251101","id":"msg_01EfnwtoqLB1qvARB4WjqSAR","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01GA6qjbPxzfj4Pmjf6CMTSw","name":"Glob","input":{"pattern":"**/*Settings*.tsx"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":40,"cache_creation_input_tokens":210,"cache_read_input_tokens":26952,"cache_creation":{"ephemeral_5m_input_tokens":210,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWjfu1MWEomQn7PybcYyQ","type":"assistant","uuid":"94957554-f0b3-4237-9ed7-f158922edc3a","timestamp":"2026-01-03T02:40:25.339Z"}
{"parentUuid":"94957554-f0b3-4237-9ed7-f158922edc3a","isSidechain":false,"userType":"external","cwd":"/Users/patrick/workingdir/familiar","sessionId":"507f4396-f3e4-4a63-8b43-9c891e06f5ee","version":"2.0.76","gitBranch":"main","slug":"precious-crunching-toast","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_016KNDusexVA589WHcFY1XbQ","type":"tool_result","content":"Found 1 file\npackages/desktop/ui/src/components/Agent/SettingsView.tsx"}]},"uuid":"48d718d6-75a6-41a9-842a-9794eceae54d","timestamp":"2026-01-03T02:40:25.403Z","toolUseResult":{"mode":"files_with_matches","filenames":["packages/desktop/ui/src/components/Agent/SettingsView.tsx"],"numFiles":1}}
{"parentUuid":"48d718d6-75a6-41a9-842a-9794eceae54d","isSidechain":false,"userType":"external","cwd":"/Users/patrick/workingdir/familiar","sessionId":"507f4396-f3e4-4a63-8b43-9c891e06f5ee","version":"2.0.76","gitBranch":"main","slug":"precious-crunching-toast","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01GA6qjbPxzfj4Pmjf6CMTSw","type":"tool_result","content":"/Users/patrick/workingdir/familiar/packages/desktop/ui/src/components/Agent/SettingsSidebar.tsx\n/Users/patrick/workingdir/familiar/packages/desktop/ui/src/components/Agent/AgentSettings.tsx\n/Users/patrick/workingdir/familiar/packages/desktop/ui/src/components/Agent/SettingsView.tsx"}]},"uuid":"6abec896-1c9e-429e-95a2-111fa96b4220","timestamp":"2026-01-03T02:40:25.568Z","toolUseResult":{"filenames":["/Users/patrick/workingdir/familiar/packages/desktop/ui/src/components/Agent/SettingsSidebar.tsx","/Users/patrick/workingdir/familiar/packages/desktop/ui/src/components/Agent/AgentSettings.tsx","/Users/patrick/workingdir/familiar/packages/desktop/ui/src/components/Agent/SettingsView.tsx"],"durationMs":182,"numFiles":3,"truncated":false}}
{"parentUuid":"6abec896-1c9e-429e-95a2-111fa96b4220","isSidechain":false,"userType":"external","cwd":"/Users/patrick/workingdir/familiar","sessionId":"507f4396-f3e4-4a63-8b43-9c891e06f5ee","version":"2.0.76","gitBranch":"main","slug":"precious-crunching-toast","message":{"model":"claude-opus-4-5-20251101","id":"msg_01SR3U6AdJTBetW3EU7snna1","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Found the SettingsView.tsx file which contains theme-related code. Let me read it to understand the theme picker implementation.","signature":"EqkCCkYICxgCKkB3SsreqdhWbpXhOviyVvm22sHLJiM5sWqCcdupptxc9oenjFtdwgrk1tWwyrL9YlJbXchvoRVCYRth2nvbkHPjEgw35oUnj0u/K3SWVxoaDF9RHyCnZwDWpO3ByyIwAEMf33X7tRdDY1RcWsTnsssRV1PH2W6Tc1+7Z41gUfZK2+3S2ZcOCOIRctGOlrdjKpAByPrNxAnTk4HtOBwgachoEQ3auE5qAefSad1mFh1gjqt8+pmaYQGJfPN/VB+5bfyFddTdvL92jG4RFI2bY3Bb9OeurqywxA6NfzivO5pSWMwNtugOr1q4HEY4hf/9e4z0rod1JITwuv6qVbYJZ57KotcJvuIvxsDqkCWyoFmVajcEzDByQSOPx2EFUArz3Y9aGAE="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":373,"cache_read_input_tokens":27162,"cache_creation":{"ephemeral_5m_input_tokens":373,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWjfuXbvptBUrnmbeT8a6","type":"assistant","uuid":"4bd8b6ac-d4a8-421c-94e6-f07c0ac89aac","timestamp":"2026-01-03T02:40:31.101Z"}
{"parentUuid":"4bd8b6ac-d4a8-421c-94e6-f07c0ac89aac","isSidechain":false,"userType":"external","cwd":"/Users/patrick/workingdir/familiar","sessionId":"507f4396-f3e4-4a63-8b43-9c891e06f5ee","version":"2.0.76","gitBranch":"main","slug":"precious-crunching-toast","message":{"model":"claude-opus-4-5-20251101","id":"msg_01SR3U6AdJTBetW3EU7snna1","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_017M6mgna8RNJ3rdmzwPPkA1","name":"Read","input":{"file_path":"/Users/patrick/workingdir/familiar/packages/desktop/ui/src/components/Agent/SettingsView.tsx"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":373,"cache_read_input_tokens":27162,"cache_creation":{"ephemeral_5m_input_tokens":373,"ephemeral_1h_input_tokens":0},"output_tokens":116,"service_tier":"standard"}},"requestId":"req_011CWjfuXbvptBUrnmbeT8a6","type":"assistant","uuid":"9313577d-0d33-482b-acf0-a8a3885a454b","timestamp":"2026-01-03T02:40:31.467Z"}
{"parentUuid":"9313577d-0d33-482b-acf0-a8a3885a454b","isSidechain":false,"userType":"external","cwd":"/Users/patrick/workingdir/familiar","sessionId":"507f4396-f3e4-4a63-8b43-9c891e06f5ee","version":"2.0.76","gitBranch":"main","slug":"precious-crunching-toast","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_017M6mgna8RNJ3rdmzwPPkA1","type":"tool_result","content":"     1→import React, { useState, useEffect, useRef, useCallback } from 'react';\n     2→import { useQuery, useQueryClient } from '@tanstack/react-query';\n     3→import { useNavigate } from 'react-router-dom';\n     4→import { api } from '../../lib/api';\n     5→import { clsx } from 'clsx';\n     6→import { ask } from '@tauri-apps/plugin-dialog';\n     7→import { useSystem } from '../../context/SystemContext';\n     8→import { useAgents } from '../../context/AgentContext';\n     9→\n    10→export const SettingsView: React.FC = () => {\n    11→  const navigate = useNavigate();\n    12→  const queryClient = useQueryClient();\n    13→  const { setExplorerCollapsed } = useAgents();\n    14→  const { data: config, refetch: refetchConfig } = useQuery({\n    15→    queryKey: ['config'],\n    16→    queryFn: () => api.getConfig(),\n    17→  });\n    18→\n    19→  const { data: apiKeys, refetch: refetchKeys } = useQuery({\n    20→    queryKey: ['apiKeys'],\n    21→    queryFn: () => api.getApiKeys(),\n    22→  });\n    23→\n    24→  const { data: vaultSecrets, refetch: refetchVault } = useQuery({\n    25→    queryKey: ['vaultSecrets'],\n    26→    queryFn: () => api.listVaultSecrets(),\n    27→  });\n    28→\n    29→  const { data: status } = useQuery({\n    30→    queryKey: ['status'],\n    31→    queryFn: () => api.getStatus(),\n    32→    refetchInterval: 5000,\n    33→  });\n    34→\n    35→  const handleToggleAlwaysAllowAll = async () => {\n    36→    const current = !!config?.security?.always_allow_all;\n    37→    if (!current) {\n    38→      const confirmed = await ask(\"WARNING: This will automatically approve ALL tool calls (including shell and browser) from ALL agents and sub-agents. This grants autonomous agents full control over your local system and web presence. Are you sure you want to disable all security oversight?\", {\n    39→        title: \"Danger: Disable All Approvals\",\n    40→        kind: \"error\",\n    41→      });\n    42→      if (!confirmed) return;\n    43→    }\n    44→\n    45→    try {\n    46→      await api.updateConfig({ security: { always_allow_all: !current } });\n    47→      await refetchConfig();\n    48→      triggerSuccess();\n    49→    } catch (err) {\n    50→      console.error('Failed to toggle always allow all:', err);\n    51→    }\n    52→  };\n    53→\n    54→  const handleUpdateShellPermissionMode = async (mode: string) => {\n    55→    try {\n    56→      await api.updateConfig({ security: { shell_permission_mode: mode } });\n    57→      await refetchConfig();\n    58→      triggerSuccess();\n    59→    } catch (err) {\n    60→      console.error('Failed to update shell permission mode:', err);\n    61→    }\n    62→  };\n    63→\n    64→  const handleToggleSubAgentsGlobal = async () => {\n    65→    try {\n    66→      const current = !!config?.sub_agent?.enabled;\n    67→      await api.updateConfig({ sub_agent: { enabled: !current } });\n    68→      await refetchConfig();\n    69→      triggerSuccess();\n    70→    } catch (err) {\n    71→      console.error('Failed to toggle sub-agents globally:', err);\n    72→    }\n    73→  };\n    74→\n    75→\n    76→\n    77→  const handleToggleCLIEnabled = async (cli: 'claude_code' | 'codex') => {\n    78→    try {\n    79→      const current = !!config?.sub_agent?.[cli]?.enabled;\n    80→      await api.updateConfig({ sub_agent: { [cli]: { enabled: !current } } });\n    81→      await refetchConfig();\n    82→      triggerSuccess();\n    83→    } catch (err) {\n    84→      console.error(`Failed to toggle ${cli}:`, err);\n    85→    }\n    86→  };\n    87→\n    88→  const handleUpdateClaudeTools = async (tools: string) => {\n    89→    try {\n    90→      const toolList = tools.split(',').map(t => t.trim()).filter(Boolean);\n    91→      await api.updateConfig({ sub_agent: { claude_code: { allowed_tools: toolList } } });\n    92→      await refetchConfig();\n    93→      triggerSuccess();\n    94→    } catch (err) {\n    95→      console.error('Failed to update Claude tools:', err);\n    96→    }\n    97→  };\n    98→\n    99→  const handleUpdateCodexMode = async (mode: string) => {\n   100→    try {\n   101→      await api.updateConfig({ sub_agent: { codex: { approval_mode: mode } } });\n   102→      await refetchConfig();\n   103→      triggerSuccess();\n   104→    } catch (err) {\n   105→      console.error('Failed to update Codex mode:', err);\n   106→    }\n   107→  };\n   108→\n   109→  const [theme, setTheme] = useState(config?.ui?.theme || 'default');\n   110→  const [isSaving, setIsSaving] = useState(false);\n   111→  const [showSuccess, setShowSuccess] = useState(false);\n   112→  const [newKey, setNewKey] = useState<{ provider: string; key: string }>({ provider: '', key: '' });\n   113→  const [newVaultSecret, setNewVaultSecret] = useState<{ name: string; value: string }>({ name: '', value: '' });\n   114→  const [customBaseUrl, setCustomBaseUrl] = useState('');\n   115→  const [isAddingCustomProvider, setIsAddingCustomProvider] = useState(false);\n   116→  const [newCustomProviderName, setNewCustomProviderName] = useState('');\n   117→\n   118→  const [editingProvider, setEditingProvider] = useState<string | null>(null);\n   119→  const [editingCapability, setEditingCapability] = useState<string>('chat');\n   120→  const [newModelName, setNewModelName] = useState('');\n   121→  const [isFetchingModels, setIsFetchingModels] = useState(false);\n   122→  const { activeSettingsTab: activeTab } = useSystem();\n   123→\n   124→  const [recordingHotkey, setRecordingHotkey] = useState<string | null>(null);\n   125→  const autoFetchedProviders = useRef<Set<string>>(new Set());\n   126→\n   127→  // Thinking configuration state - track which model is being edited\n   128→  const [editingThinkingModel, setEditingThinkingModel] = useState<string | null>(null);\n   129→\n   130→  // Reasoning levels\n   131→  type ReasoningLevel = '' | 'low' | 'medium' | 'high';\n   132→  const reasoningLevels: { value: ReasoningLevel; label: string }[] = [\n   133→    { value: '', label: 'None' },\n   134→    { value: 'low', label: 'Low' },\n   135→    { value: 'medium', label: 'Medium' },\n   136→    { value: 'high', label: 'High' },\n   137→  ];\n   138→\n   139→  // Helper to parse model string for reasoning level\n   140→  // e.g., \"claude-haiku-4.5:thinking-high\" -> { baseModel: \"claude-haiku-4.5\", level: \"high\" }\n   141→  const parseModelLevel = (model: string): { baseModel: string; level: ReasoningLevel } => {\n   142→    for (const l of ['low', 'medium', 'high'] as ReasoningLevel[]) {\n   143→      const suffix = `:thinking-${l}`;\n   144→      if (model.endsWith(suffix)) {\n   145→        return { baseModel: model.replace(suffix, ''), level: l };\n   146→      }\n   147→    }\n   148→    // Legacy: :thinking without level = high\n   149→    if (model.endsWith(':thinking')) {\n   150→      return { baseModel: model.replace(':thinking', ''), level: 'high' };\n   151→    }\n   152→    return { baseModel: model, level: '' };\n   153→  };\n   154→\n   155→  // Helper to build model string from base and level\n   156→  const buildModelString = (baseModel: string, level: ReasoningLevel): string => {\n   157→    if (level) {\n   158→      return `${baseModel}:thinking-${level}`;\n   159→    }\n   160→    return baseModel;\n   161→  };\n   162→\n   163→  // Providers that support thinking/reasoning\n   164→  const thinkingProviders = ['openrouter', 'anthropic', 'openai', 'gemini'];\n   165→\n   166→  // Update a model's reasoning level\n   167→  const handleUpdateModelLevel = async (oldModel: string, newLevel: ReasoningLevel) => {\n   168→    if (!editingProvider || !editingCapability) return;\n   169→\n   170→    const { baseModel } = parseModelLevel(oldModel);\n   171→    const newModel = buildModelString(baseModel, newLevel);\n   172→\n   173→    if (newModel === oldModel) return; // No change\n   174→\n   175→    const models = availableModels[editingProvider]?.[editingCapability] || [];\n   176→    const updatedModels = models.map(m => m === oldModel ? newModel : m);\n   177→\n   178→    const updatedAvailableModels = {\n   179→      ...availableModels,\n   180→      [editingProvider]: {\n   181→        ...(availableModels[editingProvider] || {}),\n   182→        [editingCapability]: updatedModels\n   183→      }\n   184→    };\n   185→\n   186→    setIsSaving(true);\n   187→    try {\n   188→      await api.updateConfig({ available_models: updatedAvailableModels });\n   189→      await refetchConfig();\n   190→      triggerSuccess();\n   191→    } catch (err) {\n   192→      console.error('Failed to update model reasoning level:', err);\n   193→    } finally {\n   194→      setIsSaving(false);\n   195→    }\n   196→  };\n   197→\n   198→  useEffect(() => {\n   199→    setExplorerCollapsed(false);\n   200→  }, []);\n   201→\n   202→  const successTimeoutRef = useRef<ReturnType<typeof setTimeout> | null>(null);\n   203→  const triggerSuccess = useCallback(() => {\n   204→    setShowSuccess(true);\n   205→    if (successTimeoutRef.current) clearTimeout(successTimeoutRef.current);\n   206→    successTimeoutRef.current = setTimeout(() => setShowSuccess(false), 3000);\n   207→  }, []);\n   208→\n   209→  useEffect(() => {\n   210→    if (recordingHotkey) {\n   211→      const handleGlobalKeyDown = (e: KeyboardEvent) => {\n   212→        // Don't intercept if it's just a modifier key\n   213→        if (['Control', 'Shift', 'Alt', 'Meta'].includes(e.key)) return;\n   214→\n   215→        e.preventDefault();\n   216→        e.stopPropagation();\n   217→\n   218→        if (e.key === 'Escape') {\n   219→          setRecordingHotkey(null);\n   220→          return;\n   221→        }\n   222→\n   223→        const modifiers = [];\n   224→        if (e.metaKey) modifiers.push('Cmd');\n   225→        else if (e.ctrlKey) modifiers.push('Ctrl');\n   226→\n   227→        if (e.shiftKey) modifiers.push('Shift');\n   228→        if (e.altKey) modifiers.push('Alt');\n   229→\n   230→        let key = e.key;\n   231→        if (key === ' ') key = 'Space';\n   232→        if (key.length === 1) key = key.toUpperCase();\n   233→\n   234→        const hotkey = modifiers.length > 0 ? `${modifiers.join('+')}+${key}` : key;\n   235→\n   236→        handleUpdateHotkey(recordingHotkey, hotkey);\n   237→        setRecordingHotkey(null);\n   238→      };\n   239→\n   240→      window.addEventListener('keydown', handleGlobalKeyDown, true);\n   241→      return () => window.removeEventListener('keydown', handleGlobalKeyDown, true);\n   242→    }\n   243→  }, [recordingHotkey, config]);\n   244→\n   245→  const handleUpdateHotkey = async (key: string, value: string) => {\n   246→    const updatedHotkeys = { ...((config?.ui as any)?.hotkeys || {}), [key]: value };\n   247→    try {\n   248→      await api.updateConfig({ ui: { hotkeys: updatedHotkeys } });\n   249→      await refetchConfig();\n   250→      triggerSuccess();\n   251→    } catch (err) {\n   252→      console.error('Failed to update hotkey:', err);\n   253→    }\n   254→  };\n   255→\n   256→  const hotkeyDefaults: Record<string, string> = {\n   257→    'global_back': 'Escape',\n   258→    'new_agent': 'Cmd+N',\n   259→    'focus_input': 'Cmd+L',\n   260→    'toggle_sidebar': 'Cmd+B',\n   261→    'toggle_settings': 'Cmd+,',\n   262→    'toggle_pause': 'Cmd+P',\n   263→    'compact': 'Cmd+Shift+C',\n   264→    'toggle_unibar': 'Cmd+K',\n   265→    'delete_agent': 'Cmd+D',\n   266→    'toggle_explorer': 'Cmd+E',\n   267→  };\n   268→\n   269→  const hotkeyLabels: Record<string, string> = {\n   270→    'global_back': 'Global Back / Exit Dashboard',\n   271→    'new_agent': 'Create New Agent (Dashboard)',\n   272→    'focus_input': 'Focus Chat Input (Workspace)',\n   273→    'toggle_sidebar': 'Toggle Sidebar (Workspace)',\n   274→    'toggle_settings': 'Toggle Settings (Workspace)',\n   275→    'toggle_pause': 'Toggle Pause/Resume',\n   276→    'compact': 'Compact History (Workspace)',\n   277→    'toggle_unibar': 'Omnibar / Command Palette',\n   278→    'delete_agent': 'Delete Highlighted Agent (Dashboard)',\n   279→    'toggle_explorer': 'Toggle Explorer Panel',\n   280→  };\n   281→\n   282→  // Pointer-based drag state (bypasses Tauri's drag interception)\n   283→  const [isDragging, setIsDragging] = useState(false);\n   284→  const [dragSourceIndex, setDragSourceIndex] = useState<number | null>(null);\n   285→  const [dragTargetIndex, setDragTargetIndex] = useState<number | null>(null);\n   286→  const itemRefs = useRef<(HTMLDivElement | null)[]>([]);\n   287→  const containerRef = useRef<HTMLDivElement>(null);\n   288→  const scrollRef = useRef<HTMLDivElement>(null);\n   289→\n   290→  useEffect(() => {\n   291→    const handleKeyDown = (e: KeyboardEvent) => {\n   292→      // Don't scroll if we're recording a hotkey or typing in an input\n   293→      if (recordingHotkey) return;\n   294→\n   295→      const activeElement = document.activeElement;\n   296→      const isInput = activeElement instanceof HTMLInputElement ||\n   297→        activeElement instanceof HTMLTextAreaElement ||\n   298→        (activeElement as HTMLElement)?.isContentEditable;\n   299→\n   300→      if (isInput && !(e.metaKey || e.ctrlKey)) return;\n   301→\n   302→      if (e.key === 'ArrowUp') {\n   303→        if (scrollRef.current) {\n   304→          e.preventDefault();\n   305→          scrollRef.current.scrollBy({ top: -100, behavior: 'smooth' });\n   306→        }\n   307→      }\n   308→      if (e.key === 'ArrowDown') {\n   309→        if (scrollRef.current) {\n   310→          e.preventDefault();\n   311→          scrollRef.current.scrollBy({ top: 100, behavior: 'smooth' });\n   312→        }\n   313→      }\n   314→      if (e.key === ' ' && !isInput) {\n   315→        if (scrollRef.current) {\n   316→          e.preventDefault();\n   317→          const direction = e.shiftKey ? -1 : 1;\n   318→          scrollRef.current.scrollBy({\n   319→            top: direction * scrollRef.current.clientHeight * 0.8,\n   320→            behavior: 'smooth'\n   321→          });\n   322→        }\n   323→      }\n   324→    };\n   325→\n   326→    window.addEventListener('keydown', handleKeyDown);\n   327→    return () => window.removeEventListener('keydown', handleKeyDown);\n   328→  }, [recordingHotkey]);\n   329→\n   330→\n   331→\n   332→  useEffect(() => {\n   333→    if (!editingProvider && config?.available_models && apiKeys) {\n   334→      const availableModels = config.available_models;\n   335→      const providers = Object.keys(availableModels);\n   336→\n   337→      // Preference order for default selection\n   338→      const preference = ['openrouter', 'anthropic', 'openai', 'gemini'];\n   339→      const defaultProvider = preference.find(p => providers.some(ap => ap.toLowerCase() === p));\n   340→\n   341→      if (defaultProvider) {\n   342→        const matching = providers.find(p => p.toLowerCase() === defaultProvider);\n   343→        if (matching) {\n   344→          setEditingProvider(matching);\n   345→          setNewKey(prev => ({ ...prev, provider: matching }));\n   346→        }\n   347→      } else if (providers.length > 0) {\n   348→        setEditingProvider(providers[0]);\n   349→        setNewKey(prev => ({ ...prev, provider: providers[0] }));\n   350→      }\n   351→    }\n   352→  }, [config, editingProvider, apiKeys]);\n   353→\n   354→  useEffect(() => {\n   355→    if (editingProvider && config?.custom_providers?.[editingProvider]) {\n   356→      setCustomBaseUrl(config?.custom_providers[editingProvider].base_url || '');\n   357→    } else {\n   358→      setCustomBaseUrl('');\n   359→    }\n   360→  }, [editingProvider, config?.custom_providers]);\n   361→\n   362→  const availableModels = config?.available_models || {};\n   363→  const localProvidersList = ['ollama', 'lmstudio'];\n   364→  const standardProviders = ['openrouter', 'anthropic', 'openai', 'gemini', 'ollama', 'lmstudio'];\n   365→\n   366→  const handleFetchModels = useCallback(async (provider: string) => {\n   367→    if (isFetchingModels) return;\n   368→    setIsFetchingModels(true);\n   369→    try {\n   370→      const response = await api.fetchModels(provider);\n   371→      if (response && response.models) {\n   372→        const updatedAvailableModels = {\n   373→          ...availableModels,\n   374→          [provider]: {\n   375→            ...(availableModels[provider] || {}),\n   376→            chat: response.models\n   377→          }\n   378→        };\n   379→\n   380→        // If this is the active provider and has no model set, pick the first one\n   381→        const updates: any = { available_models: updatedAvailableModels };\n   382→        if (provider === config?.inference?.chat?.provider && (!config?.inference?.chat?.model || (availableModels[provider]?.chat?.length || 0) === 0)) {\n   383→          if (response.models.length > 0) {\n   384→            updates.inference = {\n   385→              ...config.inference,\n   386→              chat: {\n   387→                ...config.inference.chat,\n   388→                model: response.models[0]\n   389→              }\n   390→            };\n   391→          }\n   392→        }\n   393→\n   394→        await api.updateConfig(updates);\n   395→        await refetchConfig();\n   396→        triggerSuccess();\n   397→      }\n   398→    } catch (err) {\n   399→      console.error('Failed to fetch models:', err);\n   400→    } finally {\n   401→      setIsFetchingModels(false);\n   402→    }\n   403→  }, [availableModels, config, isFetchingModels, refetchConfig, triggerSuccess]);\n   404→\n   405→  useEffect(() => {\n   406→    if (editingProvider && localProvidersList.includes(editingProvider.toLowerCase())) {\n   407→      const currentChatModels = availableModels[editingProvider]?.chat || [];\n   408→      if (currentChatModels.length === 0 && !isFetchingModels && !autoFetchedProviders.current.has(editingProvider.toLowerCase())) {\n   409→        autoFetchedProviders.current.add(editingProvider.toLowerCase());\n   410→        handleFetchModels(editingProvider);\n   411→      }\n   412→    }\n   413→  }, [editingProvider, availableModels, isFetchingModels, handleFetchModels]);\n   414→\n   415→  const allProviders = Object.keys(availableModels);\n   416→  const cloudProviders = allProviders.filter(p => standardProviders.includes(p.toLowerCase()) && !localProvidersList.includes(p.toLowerCase()));\n   417→  const localProviders = allProviders.filter(p => standardProviders.includes(p.toLowerCase()) && localProvidersList.includes(p.toLowerCase()));\n   418→  const userCustomProvidersList = allProviders.filter(p => !standardProviders.includes(p.toLowerCase()));\n   419→\n   420→  const currentModels = (editingProvider && editingCapability) ? (availableModels[editingProvider]?.[editingCapability] || []) : [];\n   421→  const hasCustomBaseUrl = !!customBaseUrl.trim();\n   422→\n   423→  const handleAddCustomProvider = async () => {\n   424→    if (!newCustomProviderName.trim()) return;\n   425→    const name = newCustomProviderName.trim().toLowerCase();\n   426→    if (standardProviders.includes(name) || userCustomProvidersList.includes(name)) {\n   427→      alert('Provider name already exists or is reserved.');\n   428→      return;\n   429→    }\n   430→\n   431→    setIsSaving(true);\n   432→    try {\n   433→      const updatedCustomProviders = {\n   434→        ...(config?.custom_providers || {}),\n   435→        [name]: { base_url: '' }\n   436→      };\n   437→      await api.updateConfig({ custom_providers: updatedCustomProviders });\n   438→      await refetchConfig();\n   439→      setEditingProvider(name);\n   440→      setIsAddingCustomProvider(false);\n   441→      setNewCustomProviderName('');\n   442→      triggerSuccess();\n   443→    } catch (err) {\n   444→      console.error('Failed to add custom provider:', err);\n   445→    } finally {\n   446→      setIsSaving(false);\n   447→    }\n   448→  };\n   449→\n   450→  const handleRemoveCustomProvider = async (name: string) => {\n   451→    const confirmed = await ask(`Are you sure you want to delete the custom provider \"${name}\"?`, {\n   452→      title: 'Delete Provider',\n   453→      kind: 'warning',\n   454→    });\n   455→\n   456→    if (!confirmed) return;\n   457→\n   458→    setIsSaving(true);\n   459→    try {\n   460→      // Wipe API key from keychain first\n   461→      try {\n   462→        await api.removeApiKey(name);\n   463→      } catch (keyErr) {\n   464→        console.warn(`Failed to remove API key for ${name}:`, keyErr);\n   465→      }\n   466→\n   467→      const updatedCustomProviders = { ...(config?.custom_providers || {}) };\n   468→      delete updatedCustomProviders[name];\n   469→\n   470→      const updatedAvailableModels = { ...(config?.available_models || {}) };\n   471→      delete updatedAvailableModels[name];\n   472→\n   473→      await api.updateConfig({\n   474→        custom_providers: updatedCustomProviders,\n   475→        available_models: updatedAvailableModels\n   476→      });\n   477→      await queryClient.invalidateQueries({ queryKey: ['config'] });\n   478→      await queryClient.invalidateQueries({ queryKey: ['apiKeys'] });\n   479→      if (editingProvider === name) {\n   480→        setEditingProvider(cloudProviders[0] || 'openai');\n   481→      }\n   482→      triggerSuccess();\n   483→    } catch (err) {\n   484→      console.error('Failed to remove custom provider:', err);\n   485→    } finally {\n   486→      setIsSaving(false);\n   487→    }\n   488→  };\n   489→\n   490→  const handleAddModel = async () => {\n   491→    if (!editingProvider || !editingCapability || !newModelName.trim()) return;\n   492→\n   493→    const modelToAdd = newModelName.trim();\n   494→    if (currentModels.includes(modelToAdd)) return;\n   495→\n   496→    const updatedModels = [...currentModels, modelToAdd];\n   497→    const updatedAvailableModels = {\n   498→      ...availableModels,\n   499→      [editingProvider]: {\n   500→        ...(availableModels[editingProvider] || {}),\n   501→        [editingCapability]: updatedModels\n   502→      }\n   503→    };\n   504→\n   505→    const updates: any = { available_models: updatedAvailableModels };\n   506→\n   507→    // If this is the first model for this provider, and it's the default provider, set it as default model\n   508→    if (editingProvider === config?.inference?.chat?.provider && editingCapability === 'chat' && currentModels.length === 0) {\n   509→      updates.inference = {\n   510→        ...config.inference,\n   511→        chat: {\n   512→          ...config.inference.chat,\n   513→          model: modelToAdd\n   514→        }\n   515→      };\n   516→    }\n   517→\n   518→    setIsSaving(true);\n   519→    try {\n   520→      await api.updateConfig(updates);\n   521→      setNewModelName('');\n   522→      await refetchConfig();\n   523→      triggerSuccess();\n   524→    } catch (err) {\n   525→      console.error('Failed to add model:', err);\n   526→    } finally {\n   527→      setIsSaving(false);\n   528→    }\n   529→  };\n   530→\n   531→  const handleRemoveModel = async (modelName: string) => {\n   532→    if (!editingProvider || !editingCapability) return;\n   533→    const updatedModels = currentModels.filter(m => m !== modelName);\n   534→    const updatedAvailableModels = {\n   535→      ...availableModels,\n   536→      [editingProvider]: {\n   537→        ...(availableModels[editingProvider] || {}),\n   538→        [editingCapability]: updatedModels\n   539→      }\n   540→    };\n   541→\n   542→    const updates: any = { available_models: updatedAvailableModels };\n   543→\n   544→    // If we removed the top model, or changed the list, and this is the default provider, update the default model\n   545→    if (editingProvider === config?.inference?.chat?.provider && editingCapability === 'chat' && updatedModels.length > 0) {\n   546→      if (updatedModels[0] !== currentModels[0]) {\n   547→        updates.inference = {\n   548→          ...config.inference,\n   549→          chat: {\n   550→            ...config.inference.chat,\n   551→            model: updatedModels[0]\n   552→          }\n   553→        };\n   554→      }\n   555→    }\n   556→\n   557→    setIsSaving(true);\n   558→    try {\n   559→      await api.updateConfig(updates);\n   560→      await refetchConfig();\n   561→      triggerSuccess();\n   562→    } catch (err) {\n   563→      console.error('Failed to remove model:', err);\n   564→    } finally {\n   565→      setIsSaving(false);\n   566→    }\n   567→  };\n   568→\n   569→  const saveModelOrder = async (newModels: string[]) => {\n   570→    if (!editingProvider || !editingCapability) return;\n   571→\n   572→    const updatedAvailableModels = {\n   573→      ...availableModels,\n   574→      [editingProvider]: {\n   575→        ...(availableModels[editingProvider] || {}),\n   576→        [editingCapability]: newModels\n   577→      }\n   578→    };\n   579→\n   580→    const updates: any = { available_models: updatedAvailableModels };\n   581→\n   582→    // If we moved something to the top, and this is the default provider, update the default model\n   583→    if (editingProvider === config?.inference?.chat?.provider && editingCapability === 'chat') {\n   584→      updates.inference = {\n   585→        ...config.inference,\n   586→        chat: {\n   587→          ...config.inference.chat,\n   588→          model: newModels[0]\n   589→        }\n   590→      };\n   591→    }\n   592→\n   593→    setIsSaving(true);\n   594→    try {\n   595→      await api.updateConfig(updates);\n   596→      await refetchConfig();\n   597→      triggerSuccess();\n   598→    } catch (err) {\n   599→      console.error('Failed to update model order:', err);\n   600→    } finally {\n   601→      setIsSaving(false);\n   602→    }\n   603→  };\n   604→\n   605→  const handleMoveModel = async (modelName: string, direction: 'up' | 'down') => {\n   606→    if (!editingProvider || !editingCapability) return;\n   607→\n   608→    const index = currentModels.indexOf(modelName);\n   609→    if (index === -1) return;\n   610→    if (direction === 'up' && index === 0) return;\n   611→    if (direction === 'down' && index === currentModels.length - 1) return;\n   612→\n   613→    const newModels = [...currentModels];\n   614→    const targetIndex = direction === 'up' ? index - 1 : index + 1;\n   615→    [newModels[index], newModels[targetIndex]] = [newModels[targetIndex], newModels[index]];\n   616→\n   617→    await saveModelOrder(newModels);\n   618→  };\n   619→\n   620→  // Pointer-based drag handlers (works in Tauri)\n   621→  const handlePointerDown = useCallback((e: React.PointerEvent, index: number) => {\n   622→    e.preventDefault();\n   623→    setIsDragging(true);\n   624→    setDragSourceIndex(index);\n   625→    setDragTargetIndex(index);\n   626→    (e.target as HTMLElement).setPointerCapture(e.pointerId);\n   627→  }, []);\n   628→\n   629→  const handlePointerMove = useCallback((e: React.PointerEvent) => {\n   630→    if (!isDragging || dragSourceIndex === null || !containerRef.current) return;\n   631→\n   632→    const containerRect = containerRef.current.getBoundingClientRect();\n   633→    const y = e.clientY - containerRect.top;\n   634→\n   635→    // Find which item we're over\n   636→    let newTargetIndex = dragSourceIndex;\n   637→    for (let i = 0; i < itemRefs.current.length; i++) {\n   638→      const item = itemRefs.current[i];\n   639→      if (!item) continue;\n   640→      const rect = item.getBoundingClientRect();\n   641→      const itemY = rect.top - containerRect.top + rect.height / 2;\n   642→      if (y < itemY) {\n   643→        newTargetIndex = i;\n   644→        break;\n   645→      }\n   646→      newTargetIndex = i + 1;\n   647→    }\n   648→    newTargetIndex = Math.max(0, Math.min(newTargetIndex, currentModels.length - 1));\n   649→\n   650→    if (newTargetIndex !== dragTargetIndex) {\n   651→      setDragTargetIndex(newTargetIndex);\n   652→    }\n   653→  }, [isDragging, dragSourceIndex, dragTargetIndex, currentModels.length]);\n   654→\n   655→  const handlePointerUp = useCallback(async (e: React.PointerEvent) => {\n   656→    if (!isDragging) return;\n   657→    (e.target as HTMLElement).releasePointerCapture(e.pointerId);\n   658→\n   659→    const sourceIndex = dragSourceIndex;\n   660→    const targetIndex = dragTargetIndex;\n   661→\n   662→    setIsDragging(false);\n   663→    setDragSourceIndex(null);\n   664→    setDragTargetIndex(null);\n   665→\n   666→    if (sourceIndex === null || targetIndex === null || sourceIndex === targetIndex) return;\n   667→\n   668→    const newModels = [...currentModels];\n   669→    const [removed] = newModels.splice(sourceIndex, 1);\n   670→    newModels.splice(targetIndex, 0, removed);\n   671→\n   672→    await saveModelOrder(newModels);\n   673→  }, [isDragging, dragSourceIndex, dragTargetIndex, currentModels, saveModelOrder]);\n   674→\n   675→  const handleUpdateTheme = async (newTheme: string) => {\n   676→    setTheme(newTheme);\n   677→    try {\n   678→      await api.updateConfig({ ui: { theme: newTheme } });\n   679→      localStorage.setItem('pa_theme', newTheme);\n   680→      if (newTheme === 'default') {\n   681→        document.documentElement.removeAttribute('data-theme');\n   682→      } else {\n   683→        document.documentElement.setAttribute('data-theme', newTheme);\n   684→      }\n   685→      await refetchConfig();\n   686→      triggerSuccess();\n   687→    } catch (err) {\n   688→      console.error('Failed to update theme:', err);\n   689→    }\n   690→  };\n   691→\n   692→  const handleToggleAutoCompaction = async () => {\n   693→    try {\n   694→      const current = config?.agent?.auto_compaction_enabled !== false; // Default to true if undefined\n   695→      await api.updateConfig({ agent: { auto_compaction_enabled: !current } });\n   696→      await refetchConfig();\n   697→      triggerSuccess();\n   698→    } catch (err) {\n   699→      console.error('Failed to toggle auto-compaction:', err);\n   700→    }\n   701→  };\n   702→\n   703→  const handleSetApiKey = async () => {\n   704→    if (!newKey.provider || !newKey.key) return;\n   705→    setIsSaving(true);\n   706→    try {\n   707→      await api.setApiKey(newKey.provider, newKey.key);\n   708→      setNewKey({ provider: '', key: '' });\n   709→      await queryClient.invalidateQueries({ queryKey: ['apiKeys'] });\n   710→      triggerSuccess();\n   711→    } catch (err) {\n   712→      console.error('Failed to set API key:', err);\n   713→    } finally {\n   714→      setIsSaving(false);\n   715→    }\n   716→  };\n   717→\n   718→  const handleSaveCustomBaseUrl = async () => {\n   719→    if (!customBaseUrl.trim() || !editingProvider) return;\n   720→    setIsSaving(true);\n   721→    try {\n   722→      const updatedCustomProviders = {\n   723→        ...(config?.custom_providers || {}),\n   724→        [editingProvider]: { base_url: customBaseUrl.trim() }\n   725→      };\n   726→      await api.updateConfig({ custom_providers: updatedCustomProviders });\n   727→      await queryClient.invalidateQueries({ queryKey: ['config'] });\n   728→      triggerSuccess();\n   729→    } catch (err) {\n   730→      console.error('Failed to update custom provider base URL:', err);\n   731→    } finally {\n   732→      setIsSaving(false);\n   733→    }\n   734→  };\n   735→\n   736→  const handleRemoveApiKey = async (provider: string) => {\n   737→    const confirmed = await ask(`Are you sure you want to wipe the API key for ${provider.toUpperCase()}? This will prevent agents from using this provider until a new key is registered.`, {\n   738→      title: 'Wipe API Key',\n   739→      kind: 'warning',\n   740→    });\n   741→\n   742→    if (!confirmed) return;\n   743→\n   744→    try {\n   745→      await api.removeApiKey(provider);\n   746→      await queryClient.invalidateQueries({ queryKey: ['apiKeys'] });\n   747→    } catch (err) {\n   748→      console.error('Failed to remove API key:', err);\n   749→    }\n   750→  };\n   751→\n   752→  const handleToggleProvider = async (provider: string, currentEnabled: boolean) => {\n   753→    setIsSaving(true);\n   754→    try {\n   755→      const updatedProviders = {\n   756→        ...(config?.providers || {}),\n   757→        [provider]: { enabled: !currentEnabled }\n   758→      };\n   759→      await api.updateConfig({ providers: updatedProviders });\n   760→      await queryClient.invalidateQueries({ queryKey: ['config'] });\n   761→      await queryClient.invalidateQueries({ queryKey: ['apiKeys'] });\n   762→      triggerSuccess();\n   763→    } catch (err) {\n   764→      console.error('Failed to toggle provider:', err);\n   765→    } finally {\n   766→      setIsSaving(false);\n   767→    }\n   768→  };\n   769→\n   770→  const handleSetVaultSecret = async () => {\n   771→    if (!newVaultSecret.name || !newVaultSecret.value) return;\n   772→    setIsSaving(true);\n   773→    try {\n   774→      await api.setVaultSecret(newVaultSecret.name, newVaultSecret.value);\n   775→      setNewVaultSecret({ name: '', value: '' });\n   776→      await refetchVault();\n   777→      triggerSuccess();\n   778→    } catch (err) {\n   779→      console.error('Failed to set vault secret:', err);\n   780→    } finally {\n   781→      setIsSaving(false);\n   782→    }\n   783→  };\n   784→\n   785→  const handleRemoveVaultSecret = async (name: string) => {\n   786→    const confirmed = await ask(`Are you sure you want to delete the secret \"${name}\"? This cannot be undone.`, {\n   787→      title: 'Delete Secret',\n   788→      kind: 'warning',\n   789→    });\n   790→\n   791→    if (!confirmed) return;\n   792→\n   793→    try {\n   794→      await api.removeVaultSecret(name);\n   795→      refetchVault();\n   796→    } catch (err) {\n   797→      console.error('Failed to remove vault secret:', err);\n   798→    }\n   799→  };\n   800→\n   801→  const themes = [\n   802→    { id: 'default', name: 'Matrix Dark', colors: 'bg-[#181c21]', accent: 'bg-[#22d3ee]' },\n   803→    { id: 'light', name: 'Paper White', colors: 'bg-[#f2f2f2]', accent: 'bg-[#2563eb]' },\n   804→    { id: 'cobalt2', name: 'Cobalt2', colors: 'bg-[#193549]', accent: 'bg-[#ffc600]' },\n   805→    { id: 'nerv', name: 'NERV HQ', colors: 'bg-[#1c1c1c]', accent: 'bg-[#ff9500]' },\n   806→  ];\n   807→\n   808→  return (\n   809→    <div className=\"flex h-full bg-background font-mono text-[13px] overflow-hidden\">\n   810→      {/* Main Content Area */}\n   811→      <div className=\"flex-1 flex flex-col min-w-0 bg-background relative\">\n   812→        <div className=\"flex-1 overflow-auto p-8 custom-scrollbar relative\" ref={scrollRef}>\n   813→          <div className=\"max-w-4xl mx-auto pb-20\">\n   814→            {activeTab === 'models' && (\n   815→              <div className=\"space-y-8 animate-in fade-in slide-in-from-bottom-2 duration-300 font-mono\">\n   816→                {/* Model Registry Section */}\n   817→                <section className=\"space-y-3\">\n   818→                  <div className=\"flex flex-col gap-0.5\">\n   819→                    <div className=\"flex items-center gap-2 text-accent/80\">\n   820→                      <h2 className=\"text-[12px] font-black uppercase tracking-[0.2em]\">Provider Configuration</h2>\n   821→                    </div>\n   822→                    <p className=\"text-[10px] text-text-tertiary/60 italic leading-normal font-black tracking-tight\">\n   823→                      LLM providers and endpoints. Credentials stored in system keychain.\n   824→                    </p>\n   825→                  </div>\n   826→\n   827→                  <div className=\"flex flex-col md:flex-row bg-surface/5 border border-border/10 overflow-hidden min-h-[450px]\">\n   828→                    {/* Left Sidebar: Providers */}\n   829→                    <div className=\"w-full md:w-48 border-b md:border-b-0 md:border-r border-border/10 bg-background/20 flex flex-col font-mono\">\n   830→                      <div className=\"p-3 border-b border-border/10 bg-background/10\">\n   831→                        <span className=\"text-[10px] font-black text-accent/60 uppercase tracking-[0.2em]\">Index</span>\n   832→                      </div>\n   833→                      <div className=\"flex-1 overflow-auto p-1.5 space-y-0.5 custom-scrollbar\">\n   834→                        <div className=\"px-2 pb-1\">\n   835→                          <span className=\"text-[8px] font-black text-text-tertiary/30 uppercase tracking-widest\">Cloud</span>\n   836→                        </div>\n   837→                        {cloudProviders.map(p => {\n   838→                          const providerData = apiKeys?.find(k => k.provider.toLowerCase() === p.toLowerCase());\n   839→                          const isConfigured = providerData?.configured;\n   840→                          const isEnabled = providerData?.enabled === true;\n   841→                          return (\n   842→                            <button\n   843→                              key={p}\n   844→                              onClick={() => {\n   845→                                setEditingProvider(p);\n   846→                                setNewKey(prev => ({ ...prev, provider: p }));\n   847→                              }}\n   848→                              className={clsx(\n   849→                                \"w-full px-2 py-1 text-left text-[11px] font-black uppercase transition-all flex items-center justify-between\",\n   850→                                editingProvider === p\n   851→                                  ? \"text-accent\"\n   852→                                  : \"text-text-tertiary/60 hover:text-text-secondary hover:translate-x-0.5\",\n   853→                                !isEnabled && \"opacity-40\"\n   854→                              )}\n   855→                            >\n   856→                              <div className=\"flex items-center gap-2\">\n   857→                                <span className=\"w-2\">{editingProvider === p ? '>' : ' '}</span>\n   858→                                <span className=\"truncate\">{p}</span>\n   859→                              </div>\n   860→                              <div className={clsx(\n   861→                                \"w-1 h-1 rounded-full\",\n   862→                                isConfigured ? \"bg-status-success animate-pulse\" : \"bg-status-error/40\"\n   863→                              )} />\n   864→                            </button>\n   865→                          );\n   866→                        })}\n   867→\n   868→                        <div className=\"pt-4 mt-2\">\n   869→                          <div className=\"px-2 pb-1 flex items-center justify-between\">\n   870→                            <span className=\"text-[8px] font-black text-text-tertiary/30 uppercase tracking-widest\">Custom</span>\n   871→                            <button\n   872→                              onClick={() => setIsAddingCustomProvider(true)}\n   873→                              className=\"text-accent/60 hover:text-accent transition-colors text-[10px]\"\n   874→                            >\n   875→                              [+]\n   876→                            </button>\n   877→                          </div>\n   878→\n   879→                          {isAddingCustomProvider && (\n   880→                            <div className=\"px-1.5 py-1 space-y-1\">\n   881→                              <input\n   882→                                autoFocus\n   883→                                type=\"text\"\n   884→                                placeholder=\"NAME...\"\n   885→                                value={newCustomProviderName}\n   886→                                onChange={(e) => setNewCustomProviderName(e.target.value.toLowerCase().replace(/[^a-z0-9_-]/g, ''))}\n   887→                                onKeyDown={(e) => {\n   888→                                  if (e.key === 'Enter') handleAddCustomProvider();\n   889→                                  if (e.key === 'Escape') setIsAddingCustomProvider(false);\n   890→                                }}\n   891→                                className=\"w-full bg-transparent border-b border-accent/20 px-1 py-0.5 text-[10px] text-text-primary focus:outline-none font-mono uppercase\"\n   892→                              />\n   893→                              <div className=\"flex gap-1\">\n   894→                                  <button\n   895→                                    onClick={handleAddCustomProvider}\n   896→                                    className=\"flex-1 py-0.5 text-accent text-[9px] font-black border border-accent/20 hover:bg-accent/5\"\n   897→                                  >\n   898→                                    Add\n   899→                                  </button>\n   900→                                  <button\n   901→                                    onClick={() => setIsAddingCustomProvider(false)}\n   902→                                    className=\"flex-1 py-0.5 text-text-tertiary/60 text-[9px] font-black border border-border/10 hover:bg-surface/10\"\n   903→                                  >\n   904→                                    Cancel\n   905→                                  </button>\n   906→                              </div>\n   907→                            </div>\n   908→                          )}\n   909→\n   910→                          {userCustomProvidersList.map(p => {\n   911→                            const providerData = apiKeys?.find(k => k.provider.toLowerCase() === p.toLowerCase());\n   912→                            const isConfigured = providerData?.configured;\n   913→                            const isEnabled = providerData?.enabled === true;\n   914→                            return (\n   915→                              <button\n   916→                                key={p}\n   917→                                onClick={() => {\n   918→                                  setEditingProvider(p);\n   919→                                  setNewKey(prev => ({ ...prev, provider: p }));\n   920→                                }}\n   921→                                className={clsx(\n   922→                                  \"w-full px-2 py-1 text-left text-[11px] font-black uppercase transition-all flex items-center justify-between\",\n   923→                                  editingProvider === p\n   924→                                    ? \"text-accent\"\n   925→                                    : \"text-text-tertiary/60 hover:text-text-secondary hover:translate-x-0.5\",\n   926→                                  !isEnabled && \"opacity-40\"\n   927→                                )}\n   928→                              >\n   929→                                <div className=\"flex items-center gap-2\">\n   930→                                  <span className=\"w-2\">{editingProvider === p ? '>' : ' '}</span>\n   931→                                  <span className=\"truncate\">{p}</span>\n   932→                                </div>\n   933→                                <div className={clsx(\n   934→                                  \"w-1 h-1 rounded-full\",\n   935→                                  isConfigured ? \"bg-status-success animate-pulse\" : \"bg-status-error/40\"\n   936→                                )} />\n   937→                              </button>\n   938→                            );\n   939→                          })}\n   940→                        </div>\n   941→\n   942→                        <div className=\"pt-4 mt-2\">\n   943→                          <div className=\"px-2 pb-1\">\n   944→                            <span className=\"text-[8px] font-black text-text-tertiary/30 uppercase tracking-widest\">Local</span>\n   945→                          </div>\n   946→\n   947→                          <div className=\"space-y-0.5\">\n   948→                            {localProviders.map(p => {\n   949→                              const isEnabled = apiKeys?.find(k => k.provider.toLowerCase() === p.toLowerCase())?.enabled === true;\n   950→                              return (\n   951→                                <button\n   952→                                  key={p}\n   953→                                  onClick={() => {\n   954→                                    setNewKey(prev => ({ ...prev, provider: p }));\n   955→                                    setEditingProvider(p);\n   956→                                  }}\n   957→                                  className={clsx(\n   958→                                    \"w-full px-2 py-1 text-left text-[11px] font-black uppercase transition-all flex items-center justify-between\",\n   959→                                    editingProvider === p\n   960→                                      ? \"text-accent\"\n   961→                                      : \"text-text-tertiary/60 hover:text-text-secondary hover:translate-x-0.5\",\n   962→                                    !isEnabled && \"opacity-40\"\n   963→                                  )}\n   964→                                >\n   965→                                  <div className=\"flex items-center gap-2\">\n   966→                                    <span className=\"w-2\">{editingProvider === p ? '>' : ' '}</span>\n   967→                                    <span className=\"truncate\">{p}</span>\n   968→                                  </div>\n   969→                                  <div className=\"w-1 h-1 rounded-full bg-status-success animate-pulse\" />\n   970→                                </button>\n   971→                              );\n   972→                            })}\n   973→                          </div>\n   974→                        </div>\n   975→                      </div>\n   976→                    </div>\n   977→\n   978→                    {/* Right Panel: Skills and Models */}\n   979→                    <div className=\"flex-1 flex flex-col bg-background/5 font-mono\">\n   980→                      {!editingProvider ? (\n   981→                        <div className=\"flex-1 flex flex-col items-center justify-center text-text-tertiary/20 space-y-2\">\n   982→                          <span className=\"text-[10px] uppercase font-black tracking-[0.2em]\">Select a provider</span>\n   983→                          <div className=\"animate-pulse\">_</div>\n   984→                        </div>\n   985→                      ) : (\n   986→                        <div className=\"flex-1 overflow-auto p-5 space-y-8 custom-scrollbar\">\n   987→                          {/* Provider Header & API Key Management */}\n   988→                          <div className=\"space-y-4\">\n   989→                            <div className=\"flex items-center justify-between border-b border-border/10 pb-3\">\n   990→                              <div className=\"flex items-center gap-3\">\n   991→                                <span className=\"text-[13px] font-black text-text-primary uppercase tracking-[0.1em]\">\n   992→                                  {editingProvider}\n   993→                                </span>\n   994→                              </div>\n   995→\n   996→                              <div className=\"flex items-center gap-2\">\n   997→                                {(() => {\n   998→                                  const providerData = apiKeys?.find(k => k.provider.toLowerCase() === editingProvider.toLowerCase());\n   999→                                  const isEnabled = providerData?.enabled === true;\n  1000→\n  1001→                                  return (\n  1002→                                    <button\n  1003→                                      onClick={() => handleToggleProvider(editingProvider, isEnabled)}\n  1004→                                      className={clsx(\n  1005→                                        \"text-[9px] font-black px-2 py-0.5 transition-all tracking-widest uppercase border active:scale-95\",\n  1006→                                        isEnabled\n  1007→                                          ? \"text-status-success border-status-success/20 hover:bg-status-success/5\"\n  1008→                                          : \"text-status-error border-status-error/20 hover:bg-status-error/5\"\n  1009→                                      )}\n  1010→                                    >\n  1011→                                      {isEnabled ? 'On' : 'Off'}\n  1012→                                    </button>\n  1013→                                  );\n  1014→                                })()}\n  1015→\n  1016→                                {userCustomProvidersList.includes(editingProvider) && (\n  1017→                                  <button\n  1018→                                    onClick={() => handleRemoveCustomProvider(editingProvider)}\n  1019→                                    className=\"text-[9px] text-text-tertiary/40 hover:text-status-error transition-all uppercase font-black px-2 py-0.5 border border-border/10 hover:bg-status-error/5 active:scale-95\"\n  1020→                                  >\n  1021→                                    Delete\n  1022→                                  </button>\n  1023→                                )}\n  1024→\n  1025→                                {apiKeys?.find(k => k.provider.toLowerCase() === editingProvider.toLowerCase())?.configured && !localProvidersList.includes(editingProvider.toLowerCase()) && (\n  1026→                                  <button\n  1027→                                    onClick={() => handleRemoveApiKey(editingProvider)}\n  1028→                                    className=\"text-[9px] text-text-tertiary/40 hover:text-status-error transition-all uppercase font-black px-2 py-0.5 border border-border/10 hover:bg-status-error/5 active:scale-95\"\n  1029→                                  >\n  1030→                                    Wipe Key\n  1031→                                  </button>\n  1032→                                )}\n  1033→                              </div>\n  1034→                            </div>\n  1035→\n  1036→                            {/* API Key Input */}\n  1037→                            {!localProvidersList.includes(editingProvider.toLowerCase()) ? (\n  1038→                              <div className=\"space-y-2\">\n  1039→                                <div className=\"flex flex-col gap-0.5\">\n  1040→                                  <div className=\"flex items-center gap-2\">\n  1041→                                    <span className=\"text-[9px] font-black text-text-tertiary/60 uppercase tracking-widest\">API Key</span>\n  1042→                                  </div>\n  1043→                                </div>\n  1044→                                <div className=\"flex flex-col sm:flex-row gap-2\">\n  1045→                                  <div className=\"flex-1 relative\">\n  1046→                                    <input\n  1047→                                      type=\"password\"\n  1048→                                      placeholder=\"Paste key...\"\n  1049→                                      value={newKey.key}\n  1050→                                      onChange={(e) => setNewKey(prev => ({ ...prev, key: e.target.value }))}\n  1051→                                      onKeyDown={(e) => e.key === 'Enter' && handleSetApiKey()}\n  1052→                                      className=\"w-full bg-transparent border-b border-border/10 px-0 py-1 text-[11px] text-text-primary focus:outline-none focus:border-accent/40 font-mono transition-all uppercase\"\n  1053→                                    />\n  1054→                                  </div>\n  1055→                                  <button\n  1056→                                    onClick={handleSetApiKey}\n  1057→                                    disabled={isSaving || !newKey.key}\n  1058→                                    className=\"px-3 py-1 text-accent hover:text-accent-hover font-black text-[10px] uppercase tracking-widest transition-all disabled:opacity-20\"\n  1059→                                  >\n  1060→                                    Register\n  1061→                                  </button>\n  1062→                                </div>\n  1063→                              </div>\n  1064→                            ) : (\n  1065→                              <div className=\"text-[9px] text-accent/40 font-black uppercase tracking-widest\">\n  1066→                                Local provider - no authentication required\n  1067→                              </div>\n  1068→                            )}\n  1069→                          </div>\n  1070→\n  1071→                          {userCustomProvidersList.includes(editingProvider) && (\n  1072→                            <div className=\"space-y-2\">\n  1073→                              <div className=\"flex flex-col gap-0.5\">\n  1074→                                <span className=\"text-[9px] font-black text-text-tertiary/60 uppercase tracking-widest\">Endpoint URL</span>\n  1075→                              </div>\n  1076→                              <div className=\"flex flex-col sm:flex-row gap-2\">\n  1077→                                <div className=\"flex-1 relative\">\n  1078→                                  <input\n  1079→                                    type=\"text\"\n  1080→                                    placeholder=\"https://api.provider.com/v1\"\n  1081→                                    value={customBaseUrl}\n  1082→                                    onChange={(e) => setCustomBaseUrl(e.target.value)}\n  1083→                                    onKeyDown={(e) => e.key === 'Enter' && handleSaveCustomBaseUrl()}\n  1084→                                    className=\"w-full bg-transparent border-b border-border/10 px-0 py-1 text-[11px] text-text-primary focus:outline-none focus:border-accent/40 font-mono transition-all\"\n  1085→                                  />\n  1086→                                </div>\n  1087→                                <button\n  1088→                                  onClick={handleSaveCustomBaseUrl}\n  1089→                                  disabled={isSaving || !customBaseUrl.trim()}\n  1090→                                  className=\"px-3 py-1 text-accent hover:text-accent-hover font-black text-[10px] uppercase tracking-widest transition-all disabled:opacity-20\"\n  1091→                                >\n  1092→                                  [SAVE]\n  1093→                                </button>\n  1094→                              </div>\n  1095→                            </div>\n  1096→                          )}\n  1097→\n  1098→                          {/* Model Registry Content */}\n  1099→                          <div className=\"space-y-6\">\n  1100→                            <div className=\"flex items-center justify-between\">\n  1101→                              <span className=\"text-[9px] font-black text-text-tertiary/60 uppercase tracking-widest\">Models</span>\n  1102→                              {localProvidersList.includes(editingProvider?.toLowerCase() || '') && (\n  1103→                                <button\n  1104→                                  onClick={() => editingProvider && handleFetchModels(editingProvider)}\n  1105→                                  disabled={isFetchingModels}\n  1106→                                  className={clsx(\n  1107→                                    \"text-[9px] font-black uppercase tracking-widest transition-all\",\n  1108→                                    isFetchingModels ? \"text-text-tertiary/20 animate-pulse\" : \"text-accent hover:text-accent-hover\"\n  1109→                                  )}\n  1110→                                >\n  1111→                                  {isFetchingModels ? 'Discovering...' : 'Discover local models'}\n  1112→                                </button>\n  1113→                              )}\n  1114→                            </div>\n  1115→\n  1116→                            {['chat'].map(cap => {\n  1117→                              const models = availableModels[editingProvider]?.[cap] || [];\n  1118→                              const isEditing = editingCapability === cap;\n  1119→\n  1120→                              const isOpenRouter = editingProvider?.toLowerCase() === 'openrouter';\n  1121→                              const supportsThinking = thinkingProviders.includes(editingProvider?.toLowerCase() || '');\n  1122→\n  1123→                              return (\n  1124→                                <div key={cap} className=\"space-y-1\">\n  1125→                                  {/* Column headers */}\n  1126→                                  {(supportsThinking || isOpenRouter) && models.length > 0 && (\n  1127→                                    <div className=\"flex items-center gap-2 px-2 py-1 border-b border-border/10\">\n  1128→                                      <div className=\"w-6\" /> {/* Spacer for drag handle */}\n  1129→                                      <span className=\"flex-1 text-[8px] font-black text-text-tertiary/40 uppercase tracking-widest\">MODEL NAME</span>\n  1130→                                      {isOpenRouter && (\n  1131→                                        <span className=\"text-[8px] font-black text-text-tertiary/40 uppercase tracking-widest w-24 text-right\">PRICING (INPUT/OUTPUT per 1M TOK)</span>\n  1132→                                      )}\n  1133→                                      {supportsThinking && (\n  1134→                                        <span className=\"text-[8px] font-black text-text-tertiary/40 uppercase tracking-widest w-20 text-right\">REASONING</span>\n  1135→                                      )}\n  1136→                                      <div className=\"w-6\" /> {/* Spacer for delete button */}\n  1137→                                    </div>\n  1138→                                  )}\n  1139→                                  <div\n  1140→                                    ref={containerRef}\n  1141→                                    className=\"flex flex-col gap-0.5 min-h-[50px]\"\n  1142→                                  >\n  1143→                                    {models.map((model, index) => {\n  1144→                                      const { baseModel, level } = parseModelLevel(model);\n  1145→                                      // Use baseModel for pricing lookup since pricing is stored by base model name\n  1146→                                      const pricing = isOpenRouter && config?.model_pricing?.['openrouter']?.[cap]?.[baseModel];\n  1147→\n  1148→                                      return (\n  1149→                                        <div\n  1150→                                          key={model}\n  1151→                                          ref={el => { itemRefs.current[index] = el; }}\n  1152→                                          className={clsx(\n  1153→                                            \"flex items-center justify-between px-2 py-1 border-b border-border/5 group transition-all relative select-none gap-2\",\n  1154→                                            isDragging && dragSourceIndex === index && \"opacity-50\",\n  1155→                                            isDragging && dragTargetIndex === index && dragSourceIndex !== index && \"border-t border-accent\"\n  1156→                                          )}\n  1157→                                        >\n  1158→                                          {/* Drag handle */}\n  1159→                                          <div\n  1160→                                            className=\"text-text-tertiary/20 hover:text-accent transition-all cursor-grab active:cursor-grabbing p-1 -m-1 touch-none shrink-0\"\n  1161→                                            onPointerDown={(e) => handlePointerDown(e, index)}\n  1162→                                            onPointerMove={handlePointerMove}\n  1163→                                            onPointerUp={handlePointerUp}\n  1164→                                            onPointerCancel={handlePointerUp}\n  1165→                                          >\n  1166→                                            <span className=\"text-[8px] font-black\">{index === 0 ? '@' : '#'}</span>\n  1167→                                          </div>\n  1168→\n  1169→                                          {/* Model name */}\n  1170→                                          <div className=\"flex-1 min-w-0\">\n  1171→                                            <span className={clsx(\n  1172→                                              \"text-[10px] transition-colors truncate font-mono uppercase block\",\n  1173→                                              index === 0 ? \"text-accent font-black\" : \"text-text-primary/60 group-hover:text-text-primary\"\n  1174→                                            )}>{baseModel}</span>\n  1175→                                          </div>\n  1176→\n  1177→                                          {/* Pricing column for OpenRouter */}\n  1178→                                          {isOpenRouter && (\n  1179→                                            <div className=\"text-[9px] text-text-tertiary/60 font-mono text-right shrink-0 w-24\">\n  1180→                                              {pricing ? (\n  1181→                                                <span>${pricing.prompt.toFixed(2)}/${pricing.completion.toFixed(2)}</span>\n  1182→                                              ) : (\n  1183→                                                <span className=\"text-text-tertiary/20\">—</span>\n  1184→                                              )}\n  1185→                                            </div>\n  1186→                                          )}\n  1187→\n  1188→                                          {/* Reasoning level dropdown */}\n  1189→                                          {supportsThinking && (\n  1190→                                            <select\n  1191→                                              value={level}\n  1192→                                              onChange={(e) => handleUpdateModelLevel(model, e.target.value as typeof level)}\n  1193→                                              className={clsx(\n  1194→                                                \"bg-transparent border px-1.5 py-0.5 text-[9px] font-black uppercase cursor-pointer transition-all shrink-0 w-20\",\n  1195→                                                level\n  1196→                                                  ? \"text-status-success border-status-success/30 bg-status-success/5\"\n  1197→                                                  : \"text-text-tertiary/50 border-border/20 hover:border-border/40\"\n  1198→                                              )}\n  1199→                                              style={{ WebkitAppearance: 'none', appearance: 'none', paddingRight: '16px', backgroundImage: 'url(\"data:image/svg+xml,%3csvg xmlns=%27http://www.w3.org/2000/svg%27 fill=%27none%27 viewBox=%270 0 24 24%27 stroke=%27%23666%27%3e%3cpath stroke-linecap=%27round%27 stroke-linejoin=%27round%27 stroke-width=%272%27 d=%27M19 9l-7 7-7-7%27/%3e%3c/svg%3e\")', backgroundRepeat: 'no-repeat', backgroundPosition: 'right 2px center', backgroundSize: '10px' }}\n  1200→                                            >\n  1201→                                              {reasoningLevels.map(l => (\n  1202→                                                <option key={l.value} value={l.value}>{l.label}</option>\n  1203→                                              ))}\n  1204→                                            </select>\n  1205→                                          )}\n  1206→\n  1207→                                          {/* Remove button */}\n  1208→                                          <button\n  1209→                                            onClick={(e) => {\n  1210→                                              e.stopPropagation();\n  1211→                                              setEditingCapability(cap);\n  1212→                                              handleRemoveModel(model);\n  1213→                                            }}\n  1214→                                            className=\"text-text-tertiary/20 hover:text-status-error opacity-0 group-hover:opacity-100 transition-all text-[10px] font-black shrink-0\"\n  1215→                                          >\n  1216→                                            [X]\n  1217→                                          </button>\n  1218→                                        </div>\n  1219→                                      );\n  1220→                                    })}\n  1221→\n  1222→                                    {/* Inline Add Model Input */}\n  1223→                                    <div className=\"flex gap-2 group/input mt-1\">\n  1224→                                      <div className=\"flex-1 relative\">\n  1225→                                        <input\n  1226→                                          type=\"text\"\n  1227→                                          placeholder=\"Add model...\"\n  1228→                                          value={isEditing ? newModelName : ''}\n  1229→                                          onFocus={() => setEditingCapability(cap)}\n  1230→                                          onChange={(e) => {\n  1231→                                            setEditingCapability(cap);\n  1232→                                            setNewModelName(e.target.value);\n  1233→                                          }}\n  1234→                                          onKeyDown={(e) => e.key === 'Enter' && handleAddModel()}\n  1235→                                          className=\"w-full bg-transparent border-b border-dashed border-border/20 px-0 py-0.5 text-[10px] text-text-primary placeholder:text-text-tertiary/20 focus:outline-none focus:border-accent/40 focus:border-solid font-mono transition-all uppercase\"\n  1236→                                        />\n  1237→                                      </div>\n  1238→                                      {isEditing && newModelName.trim() && (\n  1239→                                        <button\n  1240→                                          onClick={handleAddModel}\n  1241→                                          className=\"text-accent text-[10px] font-black\"\n  1242→                                        >\n  1243→                                          [+]\n  1244→                                        </button>\n  1245→                                      )}\n  1246→                                    </div>\n  1247→                                  </div>\n  1248→                                </div>\n  1249→                              );\n  1250→                            })}\n  1251→                          </div>\n  1252→                        </div>\n  1253→                      )}\n  1254→                    </div>\n  1255→                  </div>\n  1256→                </section>\n  1257→              </div>\n  1258→            )}\n  1259→\n  1260→            {activeTab === 'general' && (\n  1261→              <div className=\"space-y-12 animate-in fade-in slide-in-from-bottom-2 duration-300 font-mono\">\n  1262→                {/* Appearance Section */}\n  1263→                <section className=\"space-y-3\">\n  1264→                  <div className=\"flex flex-col gap-0.5\">\n  1265→                    <div className=\"flex items-center justify-between\">\n  1266→                      <div className=\"flex items-center gap-2 text-accent/80\">\n  1267→                        <h2 className=\"text-[12px] font-black uppercase tracking-[0.2em]\">Interface Theme</h2>\n  1268→                      </div>\n  1269→                    </div>\n  1270→                    <p className=\"text-[10px] text-text-tertiary/60 italic leading-normal font-black tracking-tight\">\n  1271→                      Visual styles update instantly across all sessions.\n  1272→                    </p>\n  1273→                  </div>\n  1274→                  <div className=\"grid grid-cols-2 sm:grid-cols-4 gap-2.5\">\n  1275→                    {themes.map((t) => (\n  1276→                      <button\n  1277→                        key={t.id}\n  1278→                        onClick={() => handleUpdateTheme(t.id)}\n  1279→                        className={clsx(\n  1280→                          \"group relative flex flex-col p-2 border transition-all text-left h-20 active:scale-[0.98]\",\n  1281→                          theme === t.id\n  1282→                            ? \"border-accent bg-accent/5 shadow-[0_0_15px_rgba(var(--accent),0.05)]\"\n  1283→                            : \"border-border/10 hover:border-accent/40 bg-surface/5\"\n  1284→                        )}\n  1285→                      >\n  1286→                        <div className={clsx(\"w-full flex-1 mb-1.5 border border-border/10 overflow-hidden relative opacity-60\", t.colors)}>\n  1287→                          <div className=\"absolute top-0 left-0 w-full h-1 bg-surface/20 border-b border-border/10\" />\n  1288→                          <div className={clsx(\"absolute bottom-1 right-1 w-2 h-2 rounded-full\", t.accent)} />\n  1289→                        </div>\n  1290→                        <div className=\"flex items-center justify-between font-mono\">\n  1291→                          <span className={clsx(\n  1292→                            \"text-[10px] font-black uppercase tracking-widest\",\n  1293→                            theme === t.id ? \"text-accent\" : \"text-text-tertiary/60 group-hover:text-text-secondary\"\n  1294→                          )}>\n  1295→                            {theme === t.id ? `[${t.name}]` : `  ${t.name}`}\n  1296→                          </span>\n  1297→                        </div>\n  1298→                      </button>\n  1299→                    ))}\n  1300→                  </div>\n  1301→                </section>\n  1302→\n  1303→                <div className=\"grid grid-cols-1 gap-12\">\n  1304→                  {/* Agent Behavior Section */}\n  1305→                  <section className=\"space-y-3\">\n  1306→                    <div className=\"flex flex-col gap-0.5\">\n  1307→                      <div className=\"flex items-center gap-2 text-accent/80\">\n  1308→                        <h2 className=\"text-[12px] font-black uppercase tracking-[0.2em]\">Behavior</h2>\n  1309→                      </div>\n  1310→                      <p className=\"text-[10px] text-text-tertiary/60 italic leading-normal font-black tracking-tight\">\n  1311→                        Global execution and memory policies.\n  1312→                      </p>\n  1313→                    </div>\n  1314→\n  1315→                    <div className=\"bg-surface/5 border border-border/10 p-4 space-y-3 font-mono\">\n  1316→                      <div className=\"flex items-center justify-between border-b border-border/5 pb-3\">\n  1317→                        <div className=\"flex flex-col gap-0.5\">\n  1318→                          <div className=\"flex items-center gap-2\">\n  1319→                            <span className=\"text-[11px] font-black text-text-primary uppercase tracking-[0.2em]\">Auto-compaction</span>\n  1320→                          </div>\n  1321→                          <p className=\"text-[10px] text-text-tertiary/60 italic px-3 leading-normal font-black tracking-tight\">\n  1322→                            Reduce token overhead automatically at threshold.\n  1323→                          </p>\n  1324→                        </div>\n  1325→                        <button\n  1326→                          onClick={handleToggleAutoCompaction}\n  1327→                          className={clsx(\n  1328→                            \"text-[10px] font-black px-2 py-1 transition-all tracking-widest uppercase active:scale-95\",\n  1329→                            config?.agent?.auto_compaction_enabled !== false\n  1330→                              ? \"text-status-success hover:bg-status-success/5\"\n  1331→                              : \"text-status-error hover:bg-status-error/5\"\n  1332→                          )}\n  1333→                        >\n  1334→                          {config?.agent?.auto_compaction_enabled !== false ? 'Active' : 'Inactive'}\n  1335→                        </button>\n  1336→                      </div>\n  1337→                    </div>\n  1338→                  </section>\n  1339→\n  1340→                  {/* Sub-Agent Ecosystem */}\n  1341→                  <section className=\"space-y-4\">\n  1342→                    <div className=\"flex flex-col gap-0.5\">\n  1343→                      <div className=\"flex items-center justify-between\">\n  1344→                        <div className=\"flex items-center gap-2 text-accent/80\">\n  1345→                          <h2 className=\"text-[12px] font-black uppercase tracking-[0.2em]\">Sub-agents</h2>\n  1346→                        </div>\n  1347→                        <button\n  1348→                          onClick={handleToggleSubAgentsGlobal}\n  1349→                          className={clsx(\n  1350→                            \"text-[10px] font-black px-2 py-0.5 transition-all tracking-widest uppercase border active:scale-95 font-mono\",\n  1351→                            config?.sub_agent?.enabled\n  1352→                              ? \"text-status-success border-status-success/20 hover:bg-status-success/5\"\n  1353→                              : \"text-status-error border-status-error/20 hover:bg-status-error/5\"\n  1354→                          )}\n  1355→                        >\n  1356→                          {config?.sub_agent?.enabled ? 'Enabled' : 'Disabled'}\n  1357→                        </button>\n  1358→                      </div>\n  1359→                      <p className=\"text-[10px] text-text-tertiary/60 italic leading-normal font-black tracking-tight\">\n  1360→                        Autonomous child-agents for specialized task processing.\n  1361→                      </p>\n  1362→                    </div>\n  1363→\n  1364→                    <div className={clsx(\n  1365→                      \"flex flex-col gap-4 transition-opacity duration-300 font-mono\",\n  1366→                      !config?.sub_agent?.enabled && \"opacity-30 pointer-events-none grayscale\"\n  1367→                    )}>\n  1368→                      {/* Configuration Controls */}\n  1369→                      <div className=\"flex flex-col gap-4\">\n  1370→\n  1371→\n  1372→                        <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n  1373→                          {/* Claude Code */}\n  1374→                          <div className=\"bg-surface/5 border border-border/10 p-4 space-y-3\">\n  1375→                            <div className=\"flex items-center justify-between\">\n  1376→                              <div className=\"flex items-center gap-2\">\n  1377→                                <span className=\"text-[11px] font-black uppercase tracking-widest text-text-primary\">Claude Code</span>\n  1378→                                {status?.components?.claude === 'ok' && status?.auth?.claude?.startsWith('ok') && (\n  1379→                                  <span className=\"text-[8px] font-black text-status-success uppercase\">Ready</span>\n  1380→                                )}\n  1381→                              </div>\n  1382→                              <button\n  1383→                                onClick={() => handleToggleCLIEnabled('claude_code')}\n  1384→                                className={clsx(\n  1385→                                  \"text-[9px] font-black px-1.5 py-0.5 transition-all border active:scale-95\",\n  1386→                                  config?.sub_agent?.claude_code?.enabled\n  1387→                                    ? \"text-status-success border-status-success/20 hover:bg-status-success/5\"\n  1388→                                    : \"text-text-tertiary/40 border-border/10 hover:text-text-secondary\"\n  1389→                                )}\n  1390→                              >\n  1391→                                {config?.sub_agent?.claude_code?.enabled ? 'On' : 'Off'}\n  1392→                              </button>\n  1393→                            </div>\n  1394→\n  1395→                            <div className=\"space-y-3\">\n  1396→                              <div className=\"space-y-1\">\n  1397→                                <label className=\"text-[9px] font-black text-text-tertiary/40 uppercase tracking-widest ml-1\">Tools</label>\n  1398→                                <input\n  1399→                                  type=\"text\"\n  1400→                                  defaultValue={config?.sub_agent?.claude_code?.allowed_tools?.join(', ')}\n  1401→                                  onBlur={(e) => handleUpdateClaudeTools(e.target.value)}\n  1402→                                  placeholder=\"Edit, Bash, Read...\"\n  1403→                                  className=\"w-full bg-transparent border-b border-border/10 px-0 py-1 text-[10px] text-text-primary focus:outline-none focus:border-accent/40 font-mono transition-all uppercase\"\n  1404→                                />\n  1405→                              </div>\n  1406→                            </div>\n  1407→                          </div>\n  1408→\n  1409→                          {/* Codex */}\n  1410→                          <div className=\"bg-surface/5 border border-border/10 p-4 space-y-3\">\n  1411→                            <div className=\"flex items-center justify-between\">\n  1412→                              <div className=\"flex items-center gap-2\">\n  1413→                                <span className=\"text-[11px] font-black uppercase tracking-widest text-text-primary\">Codex</span>\n  1414→                                {status?.components?.codex === 'ok' && status?.auth?.codex?.startsWith('ok') && (\n  1415→                                  <span className=\"text-[8px] font-black text-status-success uppercase\">Ready</span>\n  1416→                                )}\n  1417→                              </div>\n  1418→                              <button\n  1419→                                onClick={() => handleToggleCLIEnabled('codex')}\n  1420→                                className={clsx(\n  1421→                                  \"text-[9px] font-black px-1.5 py-0.5 transition-all border active:scale-95\",\n  1422→                                  config?.sub_agent?.codex?.enabled\n  1423→                                    ? \"text-status-success border-status-success/20 hover:bg-status-success/5\"\n  1424→                                    : \"text-text-tertiary/40 border-border/10 hover:text-text-secondary\"\n  1425→                                )}\n  1426→                              >\n  1427→                                {config?.sub_agent?.codex?.enabled ? 'On' : 'Off'}\n  1428→                              </button>\n  1429→                            </div>\n  1430→\n  1431→                            <div className=\"space-y-3\">\n  1432→                              <div className=\"space-y-1\">\n  1433→                                <label className=\"text-[9px] font-black text-text-tertiary/40 uppercase tracking-widest ml-1\">Approval</label>\n  1434→                                <div className=\"flex gap-1\">\n  1435→                                  {['untrusted', 'on-failure', 'on-request', 'never'].map((mode) => (\n  1436→                                    <button\n  1437→                                      key={mode}\n  1438→                                      onClick={() => handleUpdateCodexMode(mode)}\n  1439→                                      className={clsx(\n  1440→                                        \"flex-1 py-1 text-[8px] font-black uppercase border transition-all active:scale-95\",\n  1441→                                        config?.sub_agent?.codex?.approval_mode?.toLowerCase() === mode.toLowerCase()\n  1442→                                          ? \"text-accent border-accent/40 bg-accent/5\"\n  1443→                                          : \"border-border/10 text-text-tertiary/40 hover:text-text-secondary hover:bg-surface/5\"\n  1444→                                      )}\n  1445→                                    >\n  1446→                                      {config?.sub_agent?.codex?.approval_mode?.toLowerCase() === mode.toLowerCase() \n  1447→                                        ? `[${mode.toUpperCase().replace('-', '_')}]` \n  1448→                                        : mode.toUpperCase().replace('-', '_')}\n  1449→                                    </button>\n  1450→                                  ))}\n  1451→                                </div>\n  1452→                              </div>\n  1453→                            </div>\n  1454→                          </div>\n  1455→                        </div>\n  1456→                      </div>\n  1457→                    </div>\n  1458→                  </section>\n  1459→                </div>\n  1460→              </div>\n  1461→            )\n  1462→            }\n  1463→\n  1464→            {activeTab === 'security' && (\n  1465→              <div className=\"space-y-12 animate-in fade-in slide-in-from-bottom-2 duration-300 font-mono\">\n  1466→                {/* Unrestricted Execution Mode Toggle */}\n  1467→                <div className={clsx(\n  1468→                  \"p-4 border transition-all duration-500\",\n  1469→                  config?.security?.always_allow_all\n  1470→                    ? \"bg-status-error text-background border-status-error shadow-[0_0_25px_rgba(var(--status-error),0.2)]\"\n  1471→                    : \"bg-status-error/5 border-status-error/10\"\n  1472→                )}>\n  1473→                  <div className=\"flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4\">\n  1474→                    <div className=\"flex flex-col gap-1 pr-4\">\n  1475→                      <div className=\"flex items-center gap-2\">\n  1476→                        <span className={clsx(\n  1477→                          \"text-[11px] font-black uppercase tracking-[0.2em]\",\n  1478→                          config?.security?.always_allow_all ? \"text-background\" : \"text-status-error\"\n  1479→                        )}>Unrestricted Execution</span>\n  1480→                        {config?.security?.always_allow_all && (\n  1481→                          <span className=\"text-[8px] font-black bg-background text-status-error px-1 py-0.5 animate-pulse tracking-widest\">System unlocked</span>\n  1482→                        )}\n  1483→                      </div>\n  1484→                      <p className={clsx(\n  1485→                        \"text-[9px] italic leading-relaxed max-w-2xl font-black uppercase tracking-tight\",\n  1486→                        config?.security?.always_allow_all ? \"text-background/90\" : \"text-text-tertiary/60\"\n  1487→                      )}>\n  1488→                        Bypass all security checks. Agents gain full unmonitored system access. Use only in trusted environments.\n  1489→                      </p>\n  1490→                    </div>\n  1491→                    <button\n  1492→                      onClick={handleToggleAlwaysAllowAll}\n  1493→                      className={clsx(\n  1494→                        \"text-[9px] font-black px-3 py-1.5 transition-all tracking-[0.1em] uppercase border whitespace-nowrap active:scale-95\",\n  1495→                        config?.security?.always_allow_all\n  1496→                          ? \"bg-background text-status-error border-background\"\n  1497→                          : \"bg-status-error text-background border-status-error\"\n  1498→                      )}\n  1499→                    >\n  1500→                      {config?.security?.always_allow_all ? 'Restore Security' : 'Disable Security'}\n  1501→                    </button>\n  1502→                  </div>\n  1503→                </div>\n  1504→\n  1505→                {/* Shell Execution Policy */}\n  1506→                <section className={clsx(\n  1507→                  \"space-y-3 transition-all duration-300\",\n  1508→                  config?.security?.always_allow_all && \"opacity-40 grayscale\"\n  1509→                )}>\n  1510→                  <div className=\"flex flex-col gap-0.5\">\n  1511→                    <div className=\"flex items-center justify-between\">\n  1512→                      <div className=\"flex items-center gap-2 text-accent/80\">\n  1513→                        <h2 className=\"text-[12px] font-black uppercase tracking-[0.2em]\">Shell Policy</h2>\n  1514→                      </div>\n  1515→                      {config?.security?.always_allow_all && (\n  1516→                        <span className=\"text-[8px] font-black text-status-error uppercase tracking-widest bg-status-error/10 px-1.5 py-0.5\">\n  1517→                          Overridden by unrestricted mode\n  1518→                        </span>\n  1519→                      )}\n  1520→                    </div>\n  1521→                    <p className=\"text-[10px] text-text-tertiary/60 italic leading-normal font-black tracking-tight\">\n  1522→                      Control auto-approval levels for terminal commands.\n  1523→                    </p>\n  1524→                  </div>\n  1525→\n  1526→                  <div className={clsx(\n  1527→                    \"bg-surface/5 border border-border/10 p-5 space-y-4\",\n  1528→                    config?.security?.always_allow_all && \"pointer-events-none\"\n  1529→                  )}>\n  1530→                    <div className=\"flex flex-col gap-0.5\">\n  1531→                      <span className=\"text-[11px] font-black text-text-primary uppercase tracking-[0.2em]\">Execution Mode</span>\n  1532→                    </div>\n  1533→\n  1534→                    <div className=\"grid grid-cols-2 sm:grid-cols-4 gap-2\">\n  1535→                      {[\n  1536→                        { id: 'restricted', label: 'RESTRICTED', desc: 'Minimal safe set' },\n  1537→                        { id: 'read-only', label: 'READ_ONLY', desc: 'All inspections' },\n  1538→                        { id: 'non-destructive', label: 'MUTABLE', desc: 'No deletions' },\n  1539→                        { id: 'unrestricted', label: 'OPEN', desc: 'No approvals' },\n  1540→                      ].map((mode) => (\n  1541→                        <button\n  1542→                          key={mode.id}\n  1543→                          onClick={() => handleUpdateShellPermissionMode(mode.id)}\n  1544→                          className={clsx(\n  1545→                            \"flex flex-col items-start p-3 border transition-all text-left group active:scale-[0.98]\",\n  1546→                            config?.security?.shell_permission_mode === mode.id\n  1547→                              ? \"border-accent bg-accent/5 shadow-[0_0_15px_rgba(var(--accent),0.05)]\"\n  1548→                              : \"border-border/10 hover:border-accent/40 bg-surface/5\"\n  1549→                          )}\n  1550→                        >\n  1551→                          <span className={clsx(\n  1552→                            \"text-[10px] font-black uppercase tracking-widest mb-1\",\n  1553→                            config?.security?.shell_permission_mode === mode.id ? \"text-accent\" : \"text-text-tertiary/60 group-hover:text-text-secondary\"\n  1554→                          )}>\n  1555→                            {config?.security?.shell_permission_mode === mode.id ? `[${mode.label}]` : `  ${mode.label}`}\n  1556→                          </span>\n  1557→                          <span className=\"text-[8px] text-text-tertiary/40 font-black uppercase leading-tight\">\n  1558→                            {mode.desc}\n  1559→                          </span>\n  1560→                        </button>\n  1561→                      ))}\n  1562→                    </div>\n  1563→                  </div>\n  1564→                </section>\n  1565→\n  1566→                {/* Vault Section */}\n  1567→                <section className=\"space-y-3\">\n  1568→                  <div className=\"flex flex-col gap-0.5\">\n  1569→                    <div className=\"flex items-center gap-2 text-accent/80\">\n  1570→                      <h2 className=\"text-[12px] font-black uppercase tracking-[0.2em]\">Secure Vault</h2>\n  1571→                    </div>\n  1572→                    <p className=\"text-[10px] text-text-tertiary/60 italic leading-normal font-black tracking-tight\">\n  1573→                      Protected tokens and environment variables.\n  1574→                    </p>\n  1575→                  </div>\n  1576→\n  1577→                  <div className=\"bg-surface/5 border border-border/10 p-5 space-y-6\">\n  1578→                    <div className=\"space-y-4\">\n  1579→                      <div className=\"flex flex-col gap-0.5\">\n  1580→                        <span className=\"text-[11px] font-black text-text-primary uppercase tracking-[0.2em]\">Vault Index</span>\n  1581→                        <p className=\"text-[10px] text-text-tertiary/60 italic px-3 font-black tracking-tight\">\n  1582→                          Access in tools via <code className=\"text-accent underline\">{\"{{vault:KEY}}\"}</code>.\n  1583→                        </p>\n  1584→                      </div>\n  1585→\n  1586→                      <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-2\">\n  1587→                        {vaultSecrets && vaultSecrets.length > 0 ? (\n  1588→                          vaultSecrets.map((secret: any) => (\n  1589→                            <div\n  1590→                              key={secret.name}\n  1591→                              className=\"flex items-center justify-between px-3 py-1.5 bg-background/20 border border-border/5 group hover:border-accent/20 transition-all\"\n  1592→                            >\n  1593→                              <div className=\"flex items-center gap-2\">\n  1594→                                <span className=\"text-[8px] font-black text-accent/40 uppercase\">[KEY]</span>\n  1595→                                <span className=\"text-[11px] font-black text-text-primary/70 font-mono truncate max-w-[120px]\">\n  1596→                                  {secret.name}\n  1597→                                </span>\n  1598→                              </div>\n  1599→                              <button\n  1600→                                onClick={() => handleRemoveVaultSecret(secret.name)}\n  1601→                                className=\"text-text-tertiary/20 hover:text-status-error opacity-0 group-hover:opacity-100 transition-all text-[10px] font-black\"\n  1602→                              >\n  1603→                                [X]\n  1604→                              </button>\n  1605→                            </div>\n  1606→                          ))\n  1607→                        ) : (\n  1608→                          <div className=\"col-span-full py-6 border border-dashed border-border/10 flex flex-col items-center justify-center text-text-tertiary/20\">\n  1609→                            <span className=\"text-[9px] uppercase font-black tracking-[0.2em]\">No secrets stored</span>\n  1610→                          </div>\n  1611→                        )}\n  1612→                      </div>\n  1613→\n  1614→                      {/* Add Secret Form */}\n  1615→                      <div className=\"mt-4 p-4 border-t border-border/5 space-y-3\">\n  1616→                        <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-4\">\n  1617→                          <div className=\"space-y-1\">\n  1618→                            <label className=\"text-[9px] font-black text-text-tertiary/40 uppercase tracking-widest ml-1\">Key</label>\n  1619→                            <input\n  1620→                              type=\"text\"\n  1621→                              placeholder=\"GITHUB_TOKEN\"\n  1622→                              value={newVaultSecret.name}\n  1623→                              onChange={(e) => setNewVaultSecret(prev => ({ ...prev, name: e.target.value.toUpperCase().replace(/[^A-Z0-9_]/g, '_') }))}\n  1624→                              className=\"w-full bg-transparent border-b border-border/10 px-0 py-1 text-[11px] text-text-primary focus:outline-none focus:border-accent/40 font-mono transition-all uppercase\"\n  1625→                            />\n  1626→                          </div>\n  1627→                          <div className=\"space-y-1\">\n  1628→                            <label className=\"text-[9px] font-black text-text-tertiary/40 uppercase tracking-widest ml-1\">Value</label>\n  1629→                            <input\n  1630→                              type=\"password\"\n  1631→                              placeholder=\"Secret value\"\n  1632→                              value={newVaultSecret.value}\n  1633→                              onChange={(e) => setNewVaultSecret(prev => ({ ...prev, value: e.target.value }))}\n  1634→                              className=\"w-full bg-transparent border-b border-border/10 px-0 py-1 text-[11px] text-text-primary focus:outline-none focus:border-accent/40 font-mono transition-all\"\n  1635→                            />\n  1636→                          </div>\n  1637→                        </div>\n  1638→                        <button\n  1639→                          onClick={handleSetVaultSecret}\n  1640→                          disabled={isSaving || !newVaultSecret.name || !newVaultSecret.value}\n  1641→                          className=\"w-full py-1 text-accent hover:text-accent-hover font-black text-[10px] uppercase tracking-widest transition-all disabled:opacity-20 active:scale-[0.98]\"\n  1642→                        >\n  1643→                          Store in Vault\n  1644→                        </button>\n  1645→                      </div>\n  1646→                    </div>\n  1647→                  </div>\n  1648→                </section>\n  1649→              </div>\n  1650→            )\n  1651→            }\n  1652→\n  1653→            {activeTab === 'shortcuts' && (\n  1654→              <div className=\"space-y-8 animate-in fade-in slide-in-from-bottom-2 duration-300 font-mono\">\n  1655→                {/* All Hotkeys Section */}\n  1656→                <section className=\"space-y-3\">\n  1657→                  <div className=\"flex flex-col gap-0.5\">\n  1658→                    <div className=\"flex items-center gap-2 text-accent/80\">\n  1659→                      <h2 className=\"text-[12px] font-black uppercase tracking-[0.2em]\">Shortcuts</h2>\n  1660→                    </div>\n  1661→                  </div>\n  1662→\n  1663→                  <div className=\"bg-surface/5 border border-border/10 p-5\">\n  1664→                    <div className=\"grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-1\">\n  1665→                      {Object.entries(hotkeyLabels).map(([key, label]) => (\n  1666→                        <div key={key} className=\"flex items-center justify-between py-1.5 border-b border-border/5 last:border-0 md:[&:nth-last-child(-n+2)]:border-0\">\n  1667→                          <span className=\"text-[10px] font-black text-text-tertiary/60 uppercase tracking-widest\">{label}</span>\n  1668→                          <button\n  1669→                            onClick={() => setRecordingHotkey(key)}\n  1670→                            className={clsx(\n  1671→                              \"font-mono text-[10px] font-black transition-all min-w-[90px] text-right\",\n  1672→                              recordingHotkey === key\n  1673→                                ? \"text-accent animate-pulse\"\n  1674→                                : \"text-accent/60 hover:text-accent\"\n  1675→                            )}\n  1676→                          >\n  1677→                            {recordingHotkey === key ? 'Recording...' : ((config?.ui as any)?.hotkeys?.[key] || hotkeyDefaults[key] || 'N/A')}\n  1678→                          </button>\n  1679→                        </div>\n  1680→                      ))}\n  1681→                    </div>\n  1682→                        <div className=\"mt-6 pt-3 border-t border-border/5\">\n  1683→                      <p className=\"text-[9px] text-text-tertiary/20 tracking-tighter italic font-black\">\n  1684→                        Press Escape to cancel. System reserved keys may override.\n  1685→                      </p>\n  1686→                    </div>\n  1687→                  </div>\n  1688→                </section>\n  1689→              </div>\n  1690→            )\n  1691→            }\n  1692→          </div >\n  1693→        </div >\n  1694→      </div >\n  1695→    </div >\n  1696→  );\n  1697→};\n  1698→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"a2e010da-9e0e-431b-a1f4-10f5946fd160","timestamp":"2026-01-03T02:40:31.658Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/patrick/workingdir/familiar/packages/desktop/ui/src/components/Agent/SettingsView.tsx","content":"import React, { useState, useEffect, useRef, useCallback } from 'react';\nimport { useQuery, useQueryClient } from '@tanstack/react-query';\nimport { useNavigate } from 'react-router-dom';\nimport { api } from '../../lib/api';\nimport { clsx } from 'clsx';\nimport { ask } from '@tauri-apps/plugin-dialog';\nimport { useSystem } from '../../context/SystemContext';\nimport { useAgents } from '../../context/AgentContext';\n\nexport const SettingsView: React.FC = () => {\n  const navigate = useNavigate();\n  const queryClient = useQueryClient();\n  const { setExplorerCollapsed } = useAgents();\n  const { data: config, refetch: refetchConfig } = useQuery({\n    queryKey: ['config'],\n    queryFn: () => api.getConfig(),\n  });\n\n  const { data: apiKeys, refetch: refetchKeys } = useQuery({\n    queryKey: ['apiKeys'],\n    queryFn: () => api.getApiKeys(),\n  });\n\n  const { data: vaultSecrets, refetch: refetchVault } = useQuery({\n    queryKey: ['vaultSecrets'],\n    queryFn: () => api.listVaultSecrets(),\n  });\n\n  const { data: status } = useQuery({\n    queryKey: ['status'],\n    queryFn: () => api.getStatus(),\n    refetchInterval: 5000,\n  });\n\n  const handleToggleAlwaysAllowAll = async () => {\n    const current = !!config?.security?.always_allow_all;\n    if (!current) {\n      const confirmed = await ask(\"WARNING: This will automatically approve ALL tool calls (including shell and browser) from ALL agents and sub-agents. This grants autonomous agents full control over your local system and web presence. Are you sure you want to disable all security oversight?\", {\n        title: \"Danger: Disable All Approvals\",\n        kind: \"error\",\n      });\n      if (!confirmed) return;\n    }\n\n    try {\n      await api.updateConfig({ security: { always_allow_all: !current } });\n      await refetchConfig();\n      triggerSuccess();\n    } catch (err) {\n      console.error('Failed to toggle always allow all:', err);\n    }\n  };\n\n  const handleUpdateShellPermissionMode = async (mode: string) => {\n    try {\n      await api.updateConfig({ security: { shell_permission_mode: mode } });\n      await refetchConfig();\n      triggerSuccess();\n    } catch (err) {\n      console.error('Failed to update shell permission mode:', err);\n    }\n  };\n\n  const handleToggleSubAgentsGlobal = async () => {\n    try {\n      const current = !!config?.sub_agent?.enabled;\n      await api.updateConfig({ sub_agent: { enabled: !current } });\n      await refetchConfig();\n      triggerSuccess();\n    } catch (err) {\n      console.error('Failed to toggle sub-agents globally:', err);\n    }\n  };\n\n\n\n  const handleToggleCLIEnabled = async (cli: 'claude_code' | 'codex') => {\n    try {\n      const current = !!config?.sub_agent?.[cli]?.enabled;\n      await api.updateConfig({ sub_agent: { [cli]: { enabled: !current } } });\n      await refetchConfig();\n      triggerSuccess();\n    } catch (err) {\n      console.error(`Failed to toggle ${cli}:`, err);\n    }\n  };\n\n  const handleUpdateClaudeTools = async (tools: string) => {\n    try {\n      const toolList = tools.split(',').map(t => t.trim()).filter(Boolean);\n      await api.updateConfig({ sub_agent: { claude_code: { allowed_tools: toolList } } });\n      await refetchConfig();\n      triggerSuccess();\n    } catch (err) {\n      console.error('Failed to update Claude tools:', err);\n    }\n  };\n\n  const handleUpdateCodexMode = async (mode: string) => {\n    try {\n      await api.updateConfig({ sub_agent: { codex: { approval_mode: mode } } });\n      await refetchConfig();\n      triggerSuccess();\n    } catch (err) {\n      console.error('Failed to update Codex mode:', err);\n    }\n  };\n\n  const [theme, setTheme] = useState(config?.ui?.theme || 'default');\n  const [isSaving, setIsSaving] = useState(false);\n  const [showSuccess, setShowSuccess] = useState(false);\n  const [newKey, setNewKey] = useState<{ provider: string; key: string }>({ provider: '', key: '' });\n  const [newVaultSecret, setNewVaultSecret] = useState<{ name: string; value: string }>({ name: '', value: '' });\n  const [customBaseUrl, setCustomBaseUrl] = useState('');\n  const [isAddingCustomProvider, setIsAddingCustomProvider] = useState(false);\n  const [newCustomProviderName, setNewCustomProviderName] = useState('');\n\n  const [editingProvider, setEditingProvider] = useState<string | null>(null);\n  const [editingCapability, setEditingCapability] = useState<string>('chat');\n  const [newModelName, setNewModelName] = useState('');\n  const [isFetchingModels, setIsFetchingModels] = useState(false);\n  const { activeSettingsTab: activeTab } = useSystem();\n\n  const [recordingHotkey, setRecordingHotkey] = useState<string | null>(null);\n  const autoFetchedProviders = useRef<Set<string>>(new Set());\n\n  // Thinking configuration state - track which model is being edited\n  const [editingThinkingModel, setEditingThinkingModel] = useState<string | null>(null);\n\n  // Reasoning levels\n  type ReasoningLevel = '' | 'low' | 'medium' | 'high';\n  const reasoningLevels: { value: ReasoningLevel; label: string }[] = [\n    { value: '', label: 'None' },\n    { value: 'low', label: 'Low' },\n    { value: 'medium', label: 'Medium' },\n    { value: 'high', label: 'High' },\n  ];\n\n  // Helper to parse model string for reasoning level\n  // e.g., \"claude-haiku-4.5:thinking-high\" -> { baseModel: \"claude-haiku-4.5\", level: \"high\" }\n  const parseModelLevel = (model: string): { baseModel: string; level: ReasoningLevel } => {\n    for (const l of ['low', 'medium', 'high'] as ReasoningLevel[]) {\n      const suffix = `:thinking-${l}`;\n      if (model.endsWith(suffix)) {\n        return { baseModel: model.replace(suffix, ''), level: l };\n      }\n    }\n    // Legacy: :thinking without level = high\n    if (model.endsWith(':thinking')) {\n      return { baseModel: model.replace(':thinking', ''), level: 'high' };\n    }\n    return { baseModel: model, level: '' };\n  };\n\n  // Helper to build model string from base and level\n  const buildModelString = (baseModel: string, level: ReasoningLevel): string => {\n    if (level) {\n      return `${baseModel}:thinking-${level}`;\n    }\n    return baseModel;\n  };\n\n  // Providers that support thinking/reasoning\n  const thinkingProviders = ['openrouter', 'anthropic', 'openai', 'gemini'];\n\n  // Update a model's reasoning level\n  const handleUpdateModelLevel = async (oldModel: string, newLevel: ReasoningLevel) => {\n    if (!editingProvider || !editingCapability) return;\n\n    const { baseModel } = parseModelLevel(oldModel);\n    const newModel = buildModelString(baseModel, newLevel);\n\n    if (newModel === oldModel) return; // No change\n\n    const models = availableModels[editingProvider]?.[editingCapability] || [];\n    const updatedModels = models.map(m => m === oldModel ? newModel : m);\n\n    const updatedAvailableModels = {\n      ...availableModels,\n      [editingProvider]: {\n        ...(availableModels[editingProvider] || {}),\n        [editingCapability]: updatedModels\n      }\n    };\n\n    setIsSaving(true);\n    try {\n      await api.updateConfig({ available_models: updatedAvailableModels });\n      await refetchConfig();\n      triggerSuccess();\n    } catch (err) {\n      console.error('Failed to update model reasoning level:', err);\n    } finally {\n      setIsSaving(false);\n    }\n  };\n\n  useEffect(() => {\n    setExplorerCollapsed(false);\n  }, []);\n\n  const successTimeoutRef = useRef<ReturnType<typeof setTimeout> | null>(null);\n  const triggerSuccess = useCallback(() => {\n    setShowSuccess(true);\n    if (successTimeoutRef.current) clearTimeout(successTimeoutRef.current);\n    successTimeoutRef.current = setTimeout(() => setShowSuccess(false), 3000);\n  }, []);\n\n  useEffect(() => {\n    if (recordingHotkey) {\n      const handleGlobalKeyDown = (e: KeyboardEvent) => {\n        // Don't intercept if it's just a modifier key\n        if (['Control', 'Shift', 'Alt', 'Meta'].includes(e.key)) return;\n\n        e.preventDefault();\n        e.stopPropagation();\n\n        if (e.key === 'Escape') {\n          setRecordingHotkey(null);\n          return;\n        }\n\n        const modifiers = [];\n        if (e.metaKey) modifiers.push('Cmd');\n        else if (e.ctrlKey) modifiers.push('Ctrl');\n\n        if (e.shiftKey) modifiers.push('Shift');\n        if (e.altKey) modifiers.push('Alt');\n\n        let key = e.key;\n        if (key === ' ') key = 'Space';\n        if (key.length === 1) key = key.toUpperCase();\n\n        const hotkey = modifiers.length > 0 ? `${modifiers.join('+')}+${key}` : key;\n\n        handleUpdateHotkey(recordingHotkey, hotkey);\n        setRecordingHotkey(null);\n      };\n\n      window.addEventListener('keydown', handleGlobalKeyDown, true);\n      return () => window.removeEventListener('keydown', handleGlobalKeyDown, true);\n    }\n  }, [recordingHotkey, config]);\n\n  const handleUpdateHotkey = async (key: string, value: string) => {\n    const updatedHotkeys = { ...((config?.ui as any)?.hotkeys || {}), [key]: value };\n    try {\n      await api.updateConfig({ ui: { hotkeys: updatedHotkeys } });\n      await refetchConfig();\n      triggerSuccess();\n    } catch (err) {\n      console.error('Failed to update hotkey:', err);\n    }\n  };\n\n  const hotkeyDefaults: Record<string, string> = {\n    'global_back': 'Escape',\n    'new_agent': 'Cmd+N',\n    'focus_input': 'Cmd+L',\n    'toggle_sidebar': 'Cmd+B',\n    'toggle_settings': 'Cmd+,',\n    'toggle_pause': 'Cmd+P',\n    'compact': 'Cmd+Shift+C',\n    'toggle_unibar': 'Cmd+K',\n    'delete_agent': 'Cmd+D',\n    'toggle_explorer': 'Cmd+E',\n  };\n\n  const hotkeyLabels: Record<string, string> = {\n    'global_back': 'Global Back / Exit Dashboard',\n    'new_agent': 'Create New Agent (Dashboard)',\n    'focus_input': 'Focus Chat Input (Workspace)',\n    'toggle_sidebar': 'Toggle Sidebar (Workspace)',\n    'toggle_settings': 'Toggle Settings (Workspace)',\n    'toggle_pause': 'Toggle Pause/Resume',\n    'compact': 'Compact History (Workspace)',\n    'toggle_unibar': 'Omnibar / Command Palette',\n    'delete_agent': 'Delete Highlighted Agent (Dashboard)',\n    'toggle_explorer': 'Toggle Explorer Panel',\n  };\n\n  // Pointer-based drag state (bypasses Tauri's drag interception)\n  const [isDragging, setIsDragging] = useState(false);\n  const [dragSourceIndex, setDragSourceIndex] = useState<number | null>(null);\n  const [dragTargetIndex, setDragTargetIndex] = useState<number | null>(null);\n  const itemRefs = useRef<(HTMLDivElement | null)[]>([]);\n  const containerRef = useRef<HTMLDivElement>(null);\n  const scrollRef = useRef<HTMLDivElement>(null);\n\n  useEffect(() => {\n    const handleKeyDown = (e: KeyboardEvent) => {\n      // Don't scroll if we're recording a hotkey or typing in an input\n      if (recordingHotkey) return;\n\n      const activeElement = document.activeElement;\n      const isInput = activeElement instanceof HTMLInputElement ||\n        activeElement instanceof HTMLTextAreaElement ||\n        (activeElement as HTMLElement)?.isContentEditable;\n\n      if (isInput && !(e.metaKey || e.ctrlKey)) return;\n\n      if (e.key === 'ArrowUp') {\n        if (scrollRef.current) {\n          e.preventDefault();\n          scrollRef.current.scrollBy({ top: -100, behavior: 'smooth' });\n        }\n      }\n      if (e.key === 'ArrowDown') {\n        if (scrollRef.current) {\n          e.preventDefault();\n          scrollRef.current.scrollBy({ top: 100, behavior: 'smooth' });\n        }\n      }\n      if (e.key === ' ' && !isInput) {\n        if (scrollRef.current) {\n          e.preventDefault();\n          const direction = e.shiftKey ? -1 : 1;\n          scrollRef.current.scrollBy({\n            top: direction * scrollRef.current.clientHeight * 0.8,\n            behavior: 'smooth'\n          });\n        }\n      }\n    };\n\n    window.addEventListener('keydown', handleKeyDown);\n    return () => window.removeEventListener('keydown', handleKeyDown);\n  }, [recordingHotkey]);\n\n\n\n  useEffect(() => {\n    if (!editingProvider && config?.available_models && apiKeys) {\n      const availableModels = config.available_models;\n      const providers = Object.keys(availableModels);\n\n      // Preference order for default selection\n      const preference = ['openrouter', 'anthropic', 'openai', 'gemini'];\n      const defaultProvider = preference.find(p => providers.some(ap => ap.toLowerCase() === p));\n\n      if (defaultProvider) {\n        const matching = providers.find(p => p.toLowerCase() === defaultProvider);\n        if (matching) {\n          setEditingProvider(matching);\n          setNewKey(prev => ({ ...prev, provider: matching }));\n        }\n      } else if (providers.length > 0) {\n        setEditingProvider(providers[0]);\n        setNewKey(prev => ({ ...prev, provider: providers[0] }));\n      }\n    }\n  }, [config, editingProvider, apiKeys]);\n\n  useEffect(() => {\n    if (editingProvider && config?.custom_providers?.[editingProvider]) {\n      setCustomBaseUrl(config?.custom_providers[editingProvider].base_url || '');\n    } else {\n      setCustomBaseUrl('');\n    }\n  }, [editingProvider, config?.custom_providers]);\n\n  const availableModels = config?.available_models || {};\n  const localProvidersList = ['ollama', 'lmstudio'];\n  const standardProviders = ['openrouter', 'anthropic', 'openai', 'gemini', 'ollama', 'lmstudio'];\n\n  const handleFetchModels = useCallback(async (provider: string) => {\n    if (isFetchingModels) return;\n    setIsFetchingModels(true);\n    try {\n      const response = await api.fetchModels(provider);\n      if (response && response.models) {\n        const updatedAvailableModels = {\n          ...availableModels,\n          [provider]: {\n            ...(availableModels[provider] || {}),\n            chat: response.models\n          }\n        };\n\n        // If this is the active provider and has no model set, pick the first one\n        const updates: any = { available_models: updatedAvailableModels };\n        if (provider === config?.inference?.chat?.provider && (!config?.inference?.chat?.model || (availableModels[provider]?.chat?.length || 0) === 0)) {\n          if (response.models.length > 0) {\n            updates.inference = {\n              ...config.inference,\n              chat: {\n                ...config.inference.chat,\n                model: response.models[0]\n              }\n            };\n          }\n        }\n\n        await api.updateConfig(updates);\n        await refetchConfig();\n        triggerSuccess();\n      }\n    } catch (err) {\n      console.error('Failed to fetch models:', err);\n    } finally {\n      setIsFetchingModels(false);\n    }\n  }, [availableModels, config, isFetchingModels, refetchConfig, triggerSuccess]);\n\n  useEffect(() => {\n    if (editingProvider && localProvidersList.includes(editingProvider.toLowerCase())) {\n      const currentChatModels = availableModels[editingProvider]?.chat || [];\n      if (currentChatModels.length === 0 && !isFetchingModels && !autoFetchedProviders.current.has(editingProvider.toLowerCase())) {\n        autoFetchedProviders.current.add(editingProvider.toLowerCase());\n        handleFetchModels(editingProvider);\n      }\n    }\n  }, [editingProvider, availableModels, isFetchingModels, handleFetchModels]);\n\n  const allProviders = Object.keys(availableModels);\n  const cloudProviders = allProviders.filter(p => standardProviders.includes(p.toLowerCase()) && !localProvidersList.includes(p.toLowerCase()));\n  const localProviders = allProviders.filter(p => standardProviders.includes(p.toLowerCase()) && localProvidersList.includes(p.toLowerCase()));\n  const userCustomProvidersList = allProviders.filter(p => !standardProviders.includes(p.toLowerCase()));\n\n  const currentModels = (editingProvider && editingCapability) ? (availableModels[editingProvider]?.[editingCapability] || []) : [];\n  const hasCustomBaseUrl = !!customBaseUrl.trim();\n\n  const handleAddCustomProvider = async () => {\n    if (!newCustomProviderName.trim()) return;\n    const name = newCustomProviderName.trim().toLowerCase();\n    if (standardProviders.includes(name) || userCustomProvidersList.includes(name)) {\n      alert('Provider name already exists or is reserved.');\n      return;\n    }\n\n    setIsSaving(true);\n    try {\n      const updatedCustomProviders = {\n        ...(config?.custom_providers || {}),\n        [name]: { base_url: '' }\n      };\n      await api.updateConfig({ custom_providers: updatedCustomProviders });\n      await refetchConfig();\n      setEditingProvider(name);\n      setIsAddingCustomProvider(false);\n      setNewCustomProviderName('');\n      triggerSuccess();\n    } catch (err) {\n      console.error('Failed to add custom provider:', err);\n    } finally {\n      setIsSaving(false);\n    }\n  };\n\n  const handleRemoveCustomProvider = async (name: string) => {\n    const confirmed = await ask(`Are you sure you want to delete the custom provider \"${name}\"?`, {\n      title: 'Delete Provider',\n      kind: 'warning',\n    });\n\n    if (!confirmed) return;\n\n    setIsSaving(true);\n    try {\n      // Wipe API key from keychain first\n      try {\n        await api.removeApiKey(name);\n      } catch (keyErr) {\n        console.warn(`Failed to remove API key for ${name}:`, keyErr);\n      }\n\n      const updatedCustomProviders = { ...(config?.custom_providers || {}) };\n      delete updatedCustomProviders[name];\n\n      const updatedAvailableModels = { ...(config?.available_models || {}) };\n      delete updatedAvailableModels[name];\n\n      await api.updateConfig({\n        custom_providers: updatedCustomProviders,\n        available_models: updatedAvailableModels\n      });\n      await queryClient.invalidateQueries({ queryKey: ['config'] });\n      await queryClient.invalidateQueries({ queryKey: ['apiKeys'] });\n      if (editingProvider === name) {\n        setEditingProvider(cloudProviders[0] || 'openai');\n      }\n      triggerSuccess();\n    } catch (err) {\n      console.error('Failed to remove custom provider:', err);\n    } finally {\n      setIsSaving(false);\n    }\n  };\n\n  const handleAddModel = async () => {\n    if (!editingProvider || !editingCapability || !newModelName.trim()) return;\n\n    const modelToAdd = newModelName.trim();\n    if (currentModels.includes(modelToAdd)) return;\n\n    const updatedModels = [...currentModels, modelToAdd];\n    const updatedAvailableModels = {\n      ...availableModels,\n      [editingProvider]: {\n        ...(availableModels[editingProvider] || {}),\n        [editingCapability]: updatedModels\n      }\n    };\n\n    const updates: any = { available_models: updatedAvailableModels };\n\n    // If this is the first model for this provider, and it's the default provider, set it as default model\n    if (editingProvider === config?.inference?.chat?.provider && editingCapability === 'chat' && currentModels.length === 0) {\n      updates.inference = {\n        ...config.inference,\n        chat: {\n          ...config.inference.chat,\n          model: modelToAdd\n        }\n      };\n    }\n\n    setIsSaving(true);\n    try {\n      await api.updateConfig(updates);\n      setNewModelName('');\n      await refetchConfig();\n      triggerSuccess();\n    } catch (err) {\n      console.error('Failed to add model:', err);\n    } finally {\n      setIsSaving(false);\n    }\n  };\n\n  const handleRemoveModel = async (modelName: string) => {\n    if (!editingProvider || !editingCapability) return;\n    const updatedModels = currentModels.filter(m => m !== modelName);\n    const updatedAvailableModels = {\n      ...availableModels,\n      [editingProvider]: {\n        ...(availableModels[editingProvider] || {}),\n        [editingCapability]: updatedModels\n      }\n    };\n\n    const updates: any = { available_models: updatedAvailableModels };\n\n    // If we removed the top model, or changed the list, and this is the default provider, update the default model\n    if (editingProvider === config?.inference?.chat?.provider && editingCapability === 'chat' && updatedModels.length > 0) {\n      if (updatedModels[0] !== currentModels[0]) {\n        updates.inference = {\n          ...config.inference,\n          chat: {\n            ...config.inference.chat,\n            model: updatedModels[0]\n          }\n        };\n      }\n    }\n\n    setIsSaving(true);\n    try {\n      await api.updateConfig(updates);\n      await refetchConfig();\n      triggerSuccess();\n    } catch (err) {\n      console.error('Failed to remove model:', err);\n    } finally {\n      setIsSaving(false);\n    }\n  };\n\n  const saveModelOrder = async (newModels: string[]) => {\n    if (!editingProvider || !editingCapability) return;\n\n    const updatedAvailableModels = {\n      ...availableModels,\n      [editingProvider]: {\n        ...(availableModels[editingProvider] || {}),\n        [editingCapability]: newModels\n      }\n    };\n\n    const updates: any = { available_models: updatedAvailableModels };\n\n    // If we moved something to the top, and this is the default provider, update the default model\n    if (editingProvider === config?.inference?.chat?.provider && editingCapability === 'chat') {\n      updates.inference = {\n        ...config.inference,\n        chat: {\n          ...config.inference.chat,\n          model: newModels[0]\n        }\n      };\n    }\n\n    setIsSaving(true);\n    try {\n      await api.updateConfig(updates);\n      await refetchConfig();\n      triggerSuccess();\n    } catch (err) {\n      console.error('Failed to update model order:', err);\n    } finally {\n      setIsSaving(false);\n    }\n  };\n\n  const handleMoveModel = async (modelName: string, direction: 'up' | 'down') => {\n    if (!editingProvider || !editingCapability) return;\n\n    const index = currentModels.indexOf(modelName);\n    if (index === -1) return;\n    if (direction === 'up' && index === 0) return;\n    if (direction === 'down' && index === currentModels.length - 1) return;\n\n    const newModels = [...currentModels];\n    const targetIndex = direction === 'up' ? index - 1 : index + 1;\n    [newModels[index], newModels[targetIndex]] = [newModels[targetIndex], newModels[index]];\n\n    await saveModelOrder(newModels);\n  };\n\n  // Pointer-based drag handlers (works in Tauri)\n  const handlePointerDown = useCallback((e: React.PointerEvent, index: number) => {\n    e.preventDefault();\n    setIsDragging(true);\n    setDragSourceIndex(index);\n    setDragTargetIndex(index);\n    (e.target as HTMLElement).setPointerCapture(e.pointerId);\n  }, []);\n\n  const handlePointerMove = useCallback((e: React.PointerEvent) => {\n    if (!isDragging || dragSourceIndex === null || !containerRef.current) return;\n\n    const containerRect = containerRef.current.getBoundingClientRect();\n    const y = e.clientY - containerRect.top;\n\n    // Find which item we're over\n    let newTargetIndex = dragSourceIndex;\n    for (let i = 0; i < itemRefs.current.length; i++) {\n      const item = itemRefs.current[i];\n      if (!item) continue;\n      const rect = item.getBoundingClientRect();\n      const itemY = rect.top - containerRect.top + rect.height / 2;\n      if (y < itemY) {\n        newTargetIndex = i;\n        break;\n      }\n      newTargetIndex = i + 1;\n    }\n    newTargetIndex = Math.max(0, Math.min(newTargetIndex, currentModels.length - 1));\n\n    if (newTargetIndex !== dragTargetIndex) {\n      setDragTargetIndex(newTargetIndex);\n    }\n  }, [isDragging, dragSourceIndex, dragTargetIndex, currentModels.length]);\n\n  const handlePointerUp = useCallback(async (e: React.PointerEvent) => {\n    if (!isDragging) return;\n    (e.target as HTMLElement).releasePointerCapture(e.pointerId);\n\n    const sourceIndex = dragSourceIndex;\n    const targetIndex = dragTargetIndex;\n\n    setIsDragging(false);\n    setDragSourceIndex(null);\n    setDragTargetIndex(null);\n\n    if (sourceIndex === null || targetIndex === null || sourceIndex === targetIndex) return;\n\n    const newModels = [...currentModels];\n    const [removed] = newModels.splice(sourceIndex, 1);\n    newModels.splice(targetIndex, 0, removed);\n\n    await saveModelOrder(newModels);\n  }, [isDragging, dragSourceIndex, dragTargetIndex, currentModels, saveModelOrder]);\n\n  const handleUpdateTheme = async (newTheme: string) => {\n    setTheme(newTheme);\n    try {\n      await api.updateConfig({ ui: { theme: newTheme } });\n      localStorage.setItem('pa_theme', newTheme);\n      if (newTheme === 'default') {\n        document.documentElement.removeAttribute('data-theme');\n      } else {\n        document.documentElement.setAttribute('data-theme', newTheme);\n      }\n      await refetchConfig();\n      triggerSuccess();\n    } catch (err) {\n      console.error('Failed to update theme:', err);\n    }\n  };\n\n  const handleToggleAutoCompaction = async () => {\n    try {\n      const current = config?.agent?.auto_compaction_enabled !== false; // Default to true if undefined\n      await api.updateConfig({ agent: { auto_compaction_enabled: !current } });\n      await refetchConfig();\n      triggerSuccess();\n    } catch (err) {\n      console.error('Failed to toggle auto-compaction:', err);\n    }\n  };\n\n  const handleSetApiKey = async () => {\n    if (!newKey.provider || !newKey.key) return;\n    setIsSaving(true);\n    try {\n      await api.setApiKey(newKey.provider, newKey.key);\n      setNewKey({ provider: '', key: '' });\n      await queryClient.invalidateQueries({ queryKey: ['apiKeys'] });\n      triggerSuccess();\n    } catch (err) {\n      console.error('Failed to set API key:', err);\n    } finally {\n      setIsSaving(false);\n    }\n  };\n\n  const handleSaveCustomBaseUrl = async () => {\n    if (!customBaseUrl.trim() || !editingProvider) return;\n    setIsSaving(true);\n    try {\n      const updatedCustomProviders = {\n        ...(config?.custom_providers || {}),\n        [editingProvider]: { base_url: customBaseUrl.trim() }\n      };\n      await api.updateConfig({ custom_providers: updatedCustomProviders });\n      await queryClient.invalidateQueries({ queryKey: ['config'] });\n      triggerSuccess();\n    } catch (err) {\n      console.error('Failed to update custom provider base URL:', err);\n    } finally {\n      setIsSaving(false);\n    }\n  };\n\n  const handleRemoveApiKey = async (provider: string) => {\n    const confirmed = await ask(`Are you sure you want to wipe the API key for ${provider.toUpperCase()}? This will prevent agents from using this provider until a new key is registered.`, {\n      title: 'Wipe API Key',\n      kind: 'warning',\n    });\n\n    if (!confirmed) return;\n\n    try {\n      await api.removeApiKey(provider);\n      await queryClient.invalidateQueries({ queryKey: ['apiKeys'] });\n    } catch (err) {\n      console.error('Failed to remove API key:', err);\n    }\n  };\n\n  const handleToggleProvider = async (provider: string, currentEnabled: boolean) => {\n    setIsSaving(true);\n    try {\n      const updatedProviders = {\n        ...(config?.providers || {}),\n        [provider]: { enabled: !currentEnabled }\n      };\n      await api.updateConfig({ providers: updatedProviders });\n      await queryClient.invalidateQueries({ queryKey: ['config'] });\n      await queryClient.invalidateQueries({ queryKey: ['apiKeys'] });\n      triggerSuccess();\n    } catch (err) {\n      console.error('Failed to toggle provider:', err);\n    } finally {\n      setIsSaving(false);\n    }\n  };\n\n  const handleSetVaultSecret = async () => {\n    if (!newVaultSecret.name || !newVaultSecret.value) return;\n    setIsSaving(true);\n    try {\n      await api.setVaultSecret(newVaultSecret.name, newVaultSecret.value);\n      setNewVaultSecret({ name: '', value: '' });\n      await refetchVault();\n      triggerSuccess();\n    } catch (err) {\n      console.error('Failed to set vault secret:', err);\n    } finally {\n      setIsSaving(false);\n    }\n  };\n\n  const handleRemoveVaultSecret = async (name: string) => {\n    const confirmed = await ask(`Are you sure you want to delete the secret \"${name}\"? This cannot be undone.`, {\n      title: 'Delete Secret',\n      kind: 'warning',\n    });\n\n    if (!confirmed) return;\n\n    try {\n      await api.removeVaultSecret(name);\n      refetchVault();\n    } catch (err) {\n      console.error('Failed to remove vault secret:', err);\n    }\n  };\n\n  const themes = [\n    { id: 'default', name: 'Matrix Dark', colors: 'bg-[#181c21]', accent: 'bg-[#22d3ee]' },\n    { id: 'light', name: 'Paper White', colors: 'bg-[#f2f2f2]', accent: 'bg-[#2563eb]' },\n    { id: 'cobalt2', name: 'Cobalt2', colors: 'bg-[#193549]', accent: 'bg-[#ffc600]' },\n    { id: 'nerv', name: 'NERV HQ', colors: 'bg-[#1c1c1c]', accent: 'bg-[#ff9500]' },\n  ];\n\n  return (\n    <div className=\"flex h-full bg-background font-mono text-[13px] overflow-hidden\">\n      {/* Main Content Area */}\n      <div className=\"flex-1 flex flex-col min-w-0 bg-background relative\">\n        <div className=\"flex-1 overflow-auto p-8 custom-scrollbar relative\" ref={scrollRef}>\n          <div className=\"max-w-4xl mx-auto pb-20\">\n            {activeTab === 'models' && (\n              <div className=\"space-y-8 animate-in fade-in slide-in-from-bottom-2 duration-300 font-mono\">\n                {/* Model Registry Section */}\n                <section className=\"space-y-3\">\n                  <div className=\"flex flex-col gap-0.5\">\n                    <div className=\"flex items-center gap-2 text-accent/80\">\n                      <h2 className=\"text-[12px] font-black uppercase tracking-[0.2em]\">Provider Configuration</h2>\n                    </div>\n                    <p className=\"text-[10px] text-text-tertiary/60 italic leading-normal font-black tracking-tight\">\n                      LLM providers and endpoints. Credentials stored in system keychain.\n                    </p>\n                  </div>\n\n                  <div className=\"flex flex-col md:flex-row bg-surface/5 border border-border/10 overflow-hidden min-h-[450px]\">\n                    {/* Left Sidebar: Providers */}\n                    <div className=\"w-full md:w-48 border-b md:border-b-0 md:border-r border-border/10 bg-background/20 flex flex-col font-mono\">\n                      <div className=\"p-3 border-b border-border/10 bg-background/10\">\n                        <span className=\"text-[10px] font-black text-accent/60 uppercase tracking-[0.2em]\">Index</span>\n                      </div>\n                      <div className=\"flex-1 overflow-auto p-1.5 space-y-0.5 custom-scrollbar\">\n                        <div className=\"px-2 pb-1\">\n                          <span className=\"text-[8px] font-black text-text-tertiary/30 uppercase tracking-widest\">Cloud</span>\n                        </div>\n                        {cloudProviders.map(p => {\n                          const providerData = apiKeys?.find(k => k.provider.toLowerCase() === p.toLowerCase());\n                          const isConfigured = providerData?.configured;\n                          const isEnabled = providerData?.enabled === true;\n                          return (\n                            <button\n                              key={p}\n                              onClick={() => {\n                                setEditingProvider(p);\n                                setNewKey(prev => ({ ...prev, provider: p }));\n                              }}\n                              className={clsx(\n                                \"w-full px-2 py-1 text-left text-[11px] font-black uppercase transition-all flex items-center justify-between\",\n                                editingProvider === p\n                                  ? \"text-accent\"\n                                  : \"text-text-tertiary/60 hover:text-text-secondary hover:translate-x-0.5\",\n                                !isEnabled && \"opacity-40\"\n                              )}\n                            >\n                              <div className=\"flex items-center gap-2\">\n                                <span className=\"w-2\">{editingProvider === p ? '>' : ' '}</span>\n                                <span className=\"truncate\">{p}</span>\n                              </div>\n                              <div className={clsx(\n                                \"w-1 h-1 rounded-full\",\n                                isConfigured ? \"bg-status-success animate-pulse\" : \"bg-status-error/40\"\n                              )} />\n                            </button>\n                          );\n                        })}\n\n                        <div className=\"pt-4 mt-2\">\n                          <div className=\"px-2 pb-1 flex items-center justify-between\">\n                            <span className=\"text-[8px] font-black text-text-tertiary/30 uppercase tracking-widest\">Custom</span>\n                            <button\n                              onClick={() => setIsAddingCustomProvider(true)}\n                              className=\"text-accent/60 hover:text-accent transition-colors text-[10px]\"\n                            >\n                              [+]\n                            </button>\n                          </div>\n\n                          {isAddingCustomProvider && (\n                            <div className=\"px-1.5 py-1 space-y-1\">\n                              <input\n                                autoFocus\n                                type=\"text\"\n                                placeholder=\"NAME...\"\n                                value={newCustomProviderName}\n                                onChange={(e) => setNewCustomProviderName(e.target.value.toLowerCase().replace(/[^a-z0-9_-]/g, ''))}\n                                onKeyDown={(e) => {\n                                  if (e.key === 'Enter') handleAddCustomProvider();\n                                  if (e.key === 'Escape') setIsAddingCustomProvider(false);\n                                }}\n                                className=\"w-full bg-transparent border-b border-accent/20 px-1 py-0.5 text-[10px] text-text-primary focus:outline-none font-mono uppercase\"\n                              />\n                              <div className=\"flex gap-1\">\n                                  <button\n                                    onClick={handleAddCustomProvider}\n                                    className=\"flex-1 py-0.5 text-accent text-[9px] font-black border border-accent/20 hover:bg-accent/5\"\n                                  >\n                                    Add\n                                  </button>\n                                  <button\n                                    onClick={() => setIsAddingCustomProvider(false)}\n                                    className=\"flex-1 py-0.5 text-text-tertiary/60 text-[9px] font-black border border-border/10 hover:bg-surface/10\"\n                                  >\n                                    Cancel\n                                  </button>\n                              </div>\n                            </div>\n                          )}\n\n                          {userCustomProvidersList.map(p => {\n                            const providerData = apiKeys?.find(k => k.provider.toLowerCase() === p.toLowerCase());\n                            const isConfigured = providerData?.configured;\n                            const isEnabled = providerData?.enabled === true;\n                            return (\n                              <button\n                                key={p}\n                                onClick={() => {\n                                  setEditingProvider(p);\n                                  setNewKey(prev => ({ ...prev, provider: p }));\n                                }}\n                                className={clsx(\n                                  \"w-full px-2 py-1 text-left text-[11px] font-black uppercase transition-all flex items-center justify-between\",\n                                  editingProvider === p\n                                    ? \"text-accent\"\n                                    : \"text-text-tertiary/60 hover:text-text-secondary hover:translate-x-0.5\",\n                                  !isEnabled && \"opacity-40\"\n                                )}\n                              >\n                                <div className=\"flex items-center gap-2\">\n                                  <span className=\"w-2\">{editingProvider === p ? '>' : ' '}</span>\n                                  <span className=\"truncate\">{p}</span>\n                                </div>\n                                <div className={clsx(\n                                  \"w-1 h-1 rounded-full\",\n                                  isConfigured ? \"bg-status-success animate-pulse\" : \"bg-status-error/40\"\n                                )} />\n                              </button>\n                            );\n                          })}\n                        </div>\n\n                        <div className=\"pt-4 mt-2\">\n                          <div className=\"px-2 pb-1\">\n                            <span className=\"text-[8px] font-black text-text-tertiary/30 uppercase tracking-widest\">Local</span>\n                          </div>\n\n                          <div className=\"space-y-0.5\">\n                            {localProviders.map(p => {\n                              const isEnabled = apiKeys?.find(k => k.provider.toLowerCase() === p.toLowerCase())?.enabled === true;\n                              return (\n                                <button\n                                  key={p}\n                                  onClick={() => {\n                                    setNewKey(prev => ({ ...prev, provider: p }));\n                                    setEditingProvider(p);\n                                  }}\n                                  className={clsx(\n                                    \"w-full px-2 py-1 text-left text-[11px] font-black uppercase transition-all flex items-center justify-between\",\n                                    editingProvider === p\n                                      ? \"text-accent\"\n                                      : \"text-text-tertiary/60 hover:text-text-secondary hover:translate-x-0.5\",\n                                    !isEnabled && \"opacity-40\"\n                                  )}\n                                >\n                                  <div className=\"flex items-center gap-2\">\n                                    <span className=\"w-2\">{editingProvider === p ? '>' : ' '}</span>\n                                    <span className=\"truncate\">{p}</span>\n                                  </div>\n                                  <div className=\"w-1 h-1 rounded-full bg-status-success animate-pulse\" />\n                                </button>\n                              );\n                            })}\n                          </div>\n                        </div>\n                      </div>\n                    </div>\n\n                    {/* Right Panel: Skills and Models */}\n                    <div className=\"flex-1 flex flex-col bg-background/5 font-mono\">\n                      {!editingProvider ? (\n                        <div className=\"flex-1 flex flex-col items-center justify-center text-text-tertiary/20 space-y-2\">\n                          <span className=\"text-[10px] uppercase font-black tracking-[0.2em]\">Select a provider</span>\n                          <div className=\"animate-pulse\">_</div>\n                        </div>\n                      ) : (\n                        <div className=\"flex-1 overflow-auto p-5 space-y-8 custom-scrollbar\">\n                          {/* Provider Header & API Key Management */}\n                          <div className=\"space-y-4\">\n                            <div className=\"flex items-center justify-between border-b border-border/10 pb-3\">\n                              <div className=\"flex items-center gap-3\">\n                                <span className=\"text-[13px] font-black text-text-primary uppercase tracking-[0.1em]\">\n                                  {editingProvider}\n                                </span>\n                              </div>\n\n                              <div className=\"flex items-center gap-2\">\n                                {(() => {\n                                  const providerData = apiKeys?.find(k => k.provider.toLowerCase() === editingProvider.toLowerCase());\n                                  const isEnabled = providerData?.enabled === true;\n\n                                  return (\n                                    <button\n                                      onClick={() => handleToggleProvider(editingProvider, isEnabled)}\n                                      className={clsx(\n                                        \"text-[9px] font-black px-2 py-0.5 transition-all tracking-widest uppercase border active:scale-95\",\n                                        isEnabled\n                                          ? \"text-status-success border-status-success/20 hover:bg-status-success/5\"\n                                          : \"text-status-error border-status-error/20 hover:bg-status-error/5\"\n                                      )}\n                                    >\n                                      {isEnabled ? 'On' : 'Off'}\n                                    </button>\n                                  );\n                                })()}\n\n                                {userCustomProvidersList.includes(editingProvider) && (\n                                  <button\n                                    onClick={() => handleRemoveCustomProvider(editingProvider)}\n                                    className=\"text-[9px] text-text-tertiary/40 hover:text-status-error transition-all uppercase font-black px-2 py-0.5 border border-border/10 hover:bg-status-error/5 active:scale-95\"\n                                  >\n                                    Delete\n                                  </button>\n                                )}\n\n                                {apiKeys?.find(k => k.provider.toLowerCase() === editingProvider.toLowerCase())?.configured && !localProvidersList.includes(editingProvider.toLowerCase()) && (\n                                  <button\n                                    onClick={() => handleRemoveApiKey(editingProvider)}\n                                    className=\"text-[9px] text-text-tertiary/40 hover:text-status-error transition-all uppercase font-black px-2 py-0.5 border border-border/10 hover:bg-status-error/5 active:scale-95\"\n                                  >\n                                    Wipe Key\n                                  </button>\n                                )}\n                              </div>\n                            </div>\n\n                            {/* API Key Input */}\n                            {!localProvidersList.includes(editingProvider.toLowerCase()) ? (\n                              <div className=\"space-y-2\">\n                                <div className=\"flex flex-col gap-0.5\">\n                                  <div className=\"flex items-center gap-2\">\n                                    <span className=\"text-[9px] font-black text-text-tertiary/60 uppercase tracking-widest\">API Key</span>\n                                  </div>\n                                </div>\n                                <div className=\"flex flex-col sm:flex-row gap-2\">\n                                  <div className=\"flex-1 relative\">\n                                    <input\n                                      type=\"password\"\n                                      placeholder=\"Paste key...\"\n                                      value={newKey.key}\n                                      onChange={(e) => setNewKey(prev => ({ ...prev, key: e.target.value }))}\n                                      onKeyDown={(e) => e.key === 'Enter' && handleSetApiKey()}\n                                      className=\"w-full bg-transparent border-b border-border/10 px-0 py-1 text-[11px] text-text-primary focus:outline-none focus:border-accent/40 font-mono transition-all uppercase\"\n                                    />\n                                  </div>\n                                  <button\n                                    onClick={handleSetApiKey}\n                                    disabled={isSaving || !newKey.key}\n                                    className=\"px-3 py-1 text-accent hover:text-accent-hover font-black text-[10px] uppercase tracking-widest transition-all disabled:opacity-20\"\n                                  >\n                                    Register\n                                  </button>\n                                </div>\n                              </div>\n                            ) : (\n                              <div className=\"text-[9px] text-accent/40 font-black uppercase tracking-widest\">\n                                Local provider - no authentication required\n                              </div>\n                            )}\n                          </div>\n\n                          {userCustomProvidersList.includes(editingProvider) && (\n                            <div className=\"space-y-2\">\n                              <div className=\"flex flex-col gap-0.5\">\n                                <span className=\"text-[9px] font-black text-text-tertiary/60 uppercase tracking-widest\">Endpoint URL</span>\n                              </div>\n                              <div className=\"flex flex-col sm:flex-row gap-2\">\n                                <div className=\"flex-1 relative\">\n                                  <input\n                                    type=\"text\"\n                                    placeholder=\"https://api.provider.com/v1\"\n                                    value={customBaseUrl}\n                                    onChange={(e) => setCustomBaseUrl(e.target.value)}\n                                    onKeyDown={(e) => e.key === 'Enter' && handleSaveCustomBaseUrl()}\n                                    className=\"w-full bg-transparent border-b border-border/10 px-0 py-1 text-[11px] text-text-primary focus:outline-none focus:border-accent/40 font-mono transition-all\"\n                                  />\n                                </div>\n                                <button\n                                  onClick={handleSaveCustomBaseUrl}\n                                  disabled={isSaving || !customBaseUrl.trim()}\n                                  className=\"px-3 py-1 text-accent hover:text-accent-hover font-black text-[10px] uppercase tracking-widest transition-all disabled:opacity-20\"\n                                >\n                                  [SAVE]\n                                </button>\n                              </div>\n                            </div>\n                          )}\n\n                          {/* Model Registry Content */}\n                          <div className=\"space-y-6\">\n                            <div className=\"flex items-center justify-between\">\n                              <span className=\"text-[9px] font-black text-text-tertiary/60 uppercase tracking-widest\">Models</span>\n                              {localProvidersList.includes(editingProvider?.toLowerCase() || '') && (\n                                <button\n                                  onClick={() => editingProvider && handleFetchModels(editingProvider)}\n                                  disabled={isFetchingModels}\n                                  className={clsx(\n                                    \"text-[9px] font-black uppercase tracking-widest transition-all\",\n                                    isFetchingModels ? \"text-text-tertiary/20 animate-pulse\" : \"text-accent hover:text-accent-hover\"\n                                  )}\n                                >\n                                  {isFetchingModels ? 'Discovering...' : 'Discover local models'}\n                                </button>\n                              )}\n                            </div>\n\n                            {['chat'].map(cap => {\n                              const models = availableModels[editingProvider]?.[cap] || [];\n                              const isEditing = editingCapability === cap;\n\n                              const isOpenRouter = editingProvider?.toLowerCase() === 'openrouter';\n                              const supportsThinking = thinkingProviders.includes(editingProvider?.toLowerCase() || '');\n\n                              return (\n                                <div key={cap} className=\"space-y-1\">\n                                  {/* Column headers */}\n                                  {(supportsThinking || isOpenRouter) && models.length > 0 && (\n                                    <div className=\"flex items-center gap-2 px-2 py-1 border-b border-border/10\">\n                                      <div className=\"w-6\" /> {/* Spacer for drag handle */}\n                                      <span className=\"flex-1 text-[8px] font-black text-text-tertiary/40 uppercase tracking-widest\">MODEL NAME</span>\n                                      {isOpenRouter && (\n                                        <span className=\"text-[8px] font-black text-text-tertiary/40 uppercase tracking-widest w-24 text-right\">PRICING (INPUT/OUTPUT per 1M TOK)</span>\n                                      )}\n                                      {supportsThinking && (\n                                        <span className=\"text-[8px] font-black text-text-tertiary/40 uppercase tracking-widest w-20 text-right\">REASONING</span>\n                                      )}\n                                      <div className=\"w-6\" /> {/* Spacer for delete button */}\n                                    </div>\n                                  )}\n                                  <div\n                                    ref={containerRef}\n                                    className=\"flex flex-col gap-0.5 min-h-[50px]\"\n                                  >\n                                    {models.map((model, index) => {\n                                      const { baseModel, level } = parseModelLevel(model);\n                                      // Use baseModel for pricing lookup since pricing is stored by base model name\n                                      const pricing = isOpenRouter && config?.model_pricing?.['openrouter']?.[cap]?.[baseModel];\n\n                                      return (\n                                        <div\n                                          key={model}\n                                          ref={el => { itemRefs.current[index] = el; }}\n                                          className={clsx(\n                                            \"flex items-center justify-between px-2 py-1 border-b border-border/5 group transition-all relative select-none gap-2\",\n                                            isDragging && dragSourceIndex === index && \"opacity-50\",\n                                            isDragging && dragTargetIndex === index && dragSourceIndex !== index && \"border-t border-accent\"\n                                          )}\n                                        >\n                                          {/* Drag handle */}\n                                          <div\n                                            className=\"text-text-tertiary/20 hover:text-accent transition-all cursor-grab active:cursor-grabbing p-1 -m-1 touch-none shrink-0\"\n                                            onPointerDown={(e) => handlePointerDown(e, index)}\n                                            onPointerMove={handlePointerMove}\n                                            onPointerUp={handlePointerUp}\n                                            onPointerCancel={handlePointerUp}\n                                          >\n                                            <span className=\"text-[8px] font-black\">{index === 0 ? '@' : '#'}</span>\n                                          </div>\n\n                                          {/* Model name */}\n                                          <div className=\"flex-1 min-w-0\">\n                                            <span className={clsx(\n                                              \"text-[10px] transition-colors truncate font-mono uppercase block\",\n                                              index === 0 ? \"text-accent font-black\" : \"text-text-primary/60 group-hover:text-text-primary\"\n                                            )}>{baseModel}</span>\n                                          </div>\n\n                                          {/* Pricing column for OpenRouter */}\n                                          {isOpenRouter && (\n                                            <div className=\"text-[9px] text-text-tertiary/60 font-mono text-right shrink-0 w-24\">\n                                              {pricing ? (\n                                                <span>${pricing.prompt.toFixed(2)}/${pricing.completion.toFixed(2)}</span>\n                                              ) : (\n                                                <span className=\"text-text-tertiary/20\">—</span>\n                                              )}\n                                            </div>\n                                          )}\n\n                                          {/* Reasoning level dropdown */}\n                                          {supportsThinking && (\n                                            <select\n                                              value={level}\n                                              onChange={(e) => handleUpdateModelLevel(model, e.target.value as typeof level)}\n                                              className={clsx(\n                                                \"bg-transparent border px-1.5 py-0.5 text-[9px] font-black uppercase cursor-pointer transition-all shrink-0 w-20\",\n                                                level\n                                                  ? \"text-status-success border-status-success/30 bg-status-success/5\"\n                                                  : \"text-text-tertiary/50 border-border/20 hover:border-border/40\"\n                                              )}\n                                              style={{ WebkitAppearance: 'none', appearance: 'none', paddingRight: '16px', backgroundImage: 'url(\"data:image/svg+xml,%3csvg xmlns=%27http://www.w3.org/2000/svg%27 fill=%27none%27 viewBox=%270 0 24 24%27 stroke=%27%23666%27%3e%3cpath stroke-linecap=%27round%27 stroke-linejoin=%27round%27 stroke-width=%272%27 d=%27M19 9l-7 7-7-7%27/%3e%3c/svg%3e\")', backgroundRepeat: 'no-repeat', backgroundPosition: 'right 2px center', backgroundSize: '10px' }}\n                                            >\n                                              {reasoningLevels.map(l => (\n                                                <option key={l.value} value={l.value}>{l.label}</option>\n                                              ))}\n                                            </select>\n                                          )}\n\n                                          {/* Remove button */}\n                                          <button\n                                            onClick={(e) => {\n                                              e.stopPropagation();\n                                              setEditingCapability(cap);\n                                              handleRemoveModel(model);\n                                            }}\n                                            className=\"text-text-tertiary/20 hover:text-status-error opacity-0 group-hover:opacity-100 transition-all text-[10px] font-black shrink-0\"\n                                          >\n                                            [X]\n                                          </button>\n                                        </div>\n                                      );\n                                    })}\n\n                                    {/* Inline Add Model Input */}\n                                    <div className=\"flex gap-2 group/input mt-1\">\n                                      <div className=\"flex-1 relative\">\n                                        <input\n                                          type=\"text\"\n                                          placeholder=\"Add model...\"\n                                          value={isEditing ? newModelName : ''}\n                                          onFocus={() => setEditingCapability(cap)}\n                                          onChange={(e) => {\n                                            setEditingCapability(cap);\n                                            setNewModelName(e.target.value);\n                                          }}\n                                          onKeyDown={(e) => e.key === 'Enter' && handleAddModel()}\n                                          className=\"w-full bg-transparent border-b border-dashed border-border/20 px-0 py-0.5 text-[10px] text-text-primary placeholder:text-text-tertiary/20 focus:outline-none focus:border-accent/40 focus:border-solid font-mono transition-all uppercase\"\n                                        />\n                                      </div>\n                                      {isEditing && newModelName.trim() && (\n                                        <button\n                                          onClick={handleAddModel}\n                                          className=\"text-accent text-[10px] font-black\"\n                                        >\n                                          [+]\n                                        </button>\n                                      )}\n                                    </div>\n                                  </div>\n                                </div>\n                              );\n                            })}\n                          </div>\n                        </div>\n                      )}\n                    </div>\n                  </div>\n                </section>\n              </div>\n            )}\n\n            {activeTab === 'general' && (\n              <div className=\"space-y-12 animate-in fade-in slide-in-from-bottom-2 duration-300 font-mono\">\n                {/* Appearance Section */}\n                <section className=\"space-y-3\">\n                  <div className=\"flex flex-col gap-0.5\">\n                    <div className=\"flex items-center justify-between\">\n                      <div className=\"flex items-center gap-2 text-accent/80\">\n                        <h2 className=\"text-[12px] font-black uppercase tracking-[0.2em]\">Interface Theme</h2>\n                      </div>\n                    </div>\n                    <p className=\"text-[10px] text-text-tertiary/60 italic leading-normal font-black tracking-tight\">\n                      Visual styles update instantly across all sessions.\n                    </p>\n                  </div>\n                  <div className=\"grid grid-cols-2 sm:grid-cols-4 gap-2.5\">\n                    {themes.map((t) => (\n                      <button\n                        key={t.id}\n                        onClick={() => handleUpdateTheme(t.id)}\n                        className={clsx(\n                          \"group relative flex flex-col p-2 border transition-all text-left h-20 active:scale-[0.98]\",\n                          theme === t.id\n                            ? \"border-accent bg-accent/5 shadow-[0_0_15px_rgba(var(--accent),0.05)]\"\n                            : \"border-border/10 hover:border-accent/40 bg-surface/5\"\n                        )}\n                      >\n                        <div className={clsx(\"w-full flex-1 mb-1.5 border border-border/10 overflow-hidden relative opacity-60\", t.colors)}>\n                          <div className=\"absolute top-0 left-0 w-full h-1 bg-surface/20 border-b border-border/10\" />\n                          <div className={clsx(\"absolute bottom-1 right-1 w-2 h-2 rounded-full\", t.accent)} />\n                        </div>\n                        <div className=\"flex items-center justify-between font-mono\">\n                          <span className={clsx(\n                            \"text-[10px] font-black uppercase tracking-widest\",\n                            theme === t.id ? \"text-accent\" : \"text-text-tertiary/60 group-hover:text-text-secondary\"\n                          )}>\n                            {theme === t.id ? `[${t.name}]` : `  ${t.name}`}\n                          </span>\n                        </div>\n                      </button>\n                    ))}\n                  </div>\n                </section>\n\n                <div className=\"grid grid-cols-1 gap-12\">\n                  {/* Agent Behavior Section */}\n                  <section className=\"space-y-3\">\n                    <div className=\"flex flex-col gap-0.5\">\n                      <div className=\"flex items-center gap-2 text-accent/80\">\n                        <h2 className=\"text-[12px] font-black uppercase tracking-[0.2em]\">Behavior</h2>\n                      </div>\n                      <p className=\"text-[10px] text-text-tertiary/60 italic leading-normal font-black tracking-tight\">\n                        Global execution and memory policies.\n                      </p>\n                    </div>\n\n                    <div className=\"bg-surface/5 border border-border/10 p-4 space-y-3 font-mono\">\n                      <div className=\"flex items-center justify-between border-b border-border/5 pb-3\">\n                        <div className=\"flex flex-col gap-0.5\">\n                          <div className=\"flex items-center gap-2\">\n                            <span className=\"text-[11px] font-black text-text-primary uppercase tracking-[0.2em]\">Auto-compaction</span>\n                          </div>\n                          <p className=\"text-[10px] text-text-tertiary/60 italic px-3 leading-normal font-black tracking-tight\">\n                            Reduce token overhead automatically at threshold.\n                          </p>\n                        </div>\n                        <button\n                          onClick={handleToggleAutoCompaction}\n                          className={clsx(\n                            \"text-[10px] font-black px-2 py-1 transition-all tracking-widest uppercase active:scale-95\",\n                            config?.agent?.auto_compaction_enabled !== false\n                              ? \"text-status-success hover:bg-status-success/5\"\n                              : \"text-status-error hover:bg-status-error/5\"\n                          )}\n                        >\n                          {config?.agent?.auto_compaction_enabled !== false ? 'Active' : 'Inactive'}\n                        </button>\n                      </div>\n                    </div>\n                  </section>\n\n                  {/* Sub-Agent Ecosystem */}\n                  <section className=\"space-y-4\">\n                    <div className=\"flex flex-col gap-0.5\">\n                      <div className=\"flex items-center justify-between\">\n                        <div className=\"flex items-center gap-2 text-accent/80\">\n                          <h2 className=\"text-[12px] font-black uppercase tracking-[0.2em]\">Sub-agents</h2>\n                        </div>\n                        <button\n                          onClick={handleToggleSubAgentsGlobal}\n                          className={clsx(\n                            \"text-[10px] font-black px-2 py-0.5 transition-all tracking-widest uppercase border active:scale-95 font-mono\",\n                            config?.sub_agent?.enabled\n                              ? \"text-status-success border-status-success/20 hover:bg-status-success/5\"\n                              : \"text-status-error border-status-error/20 hover:bg-status-error/5\"\n                          )}\n                        >\n                          {config?.sub_agent?.enabled ? 'Enabled' : 'Disabled'}\n                        </button>\n                      </div>\n                      <p className=\"text-[10px] text-text-tertiary/60 italic leading-normal font-black tracking-tight\">\n                        Autonomous child-agents for specialized task processing.\n                      </p>\n                    </div>\n\n                    <div className={clsx(\n                      \"flex flex-col gap-4 transition-opacity duration-300 font-mono\",\n                      !config?.sub_agent?.enabled && \"opacity-30 pointer-events-none grayscale\"\n                    )}>\n                      {/* Configuration Controls */}\n                      <div className=\"flex flex-col gap-4\">\n\n\n                        <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                          {/* Claude Code */}\n                          <div className=\"bg-surface/5 border border-border/10 p-4 space-y-3\">\n                            <div className=\"flex items-center justify-between\">\n                              <div className=\"flex items-center gap-2\">\n                                <span className=\"text-[11px] font-black uppercase tracking-widest text-text-primary\">Claude Code</span>\n                                {status?.components?.claude === 'ok' && status?.auth?.claude?.startsWith('ok') && (\n                                  <span className=\"text-[8px] font-black text-status-success uppercase\">Ready</span>\n                                )}\n                              </div>\n                              <button\n                                onClick={() => handleToggleCLIEnabled('claude_code')}\n                                className={clsx(\n                                  \"text-[9px] font-black px-1.5 py-0.5 transition-all border active:scale-95\",\n                                  config?.sub_agent?.claude_code?.enabled\n                                    ? \"text-status-success border-status-success/20 hover:bg-status-success/5\"\n                                    : \"text-text-tertiary/40 border-border/10 hover:text-text-secondary\"\n                                )}\n                              >\n                                {config?.sub_agent?.claude_code?.enabled ? 'On' : 'Off'}\n                              </button>\n                            </div>\n\n                            <div className=\"space-y-3\">\n                              <div className=\"space-y-1\">\n                                <label className=\"text-[9px] font-black text-text-tertiary/40 uppercase tracking-widest ml-1\">Tools</label>\n                                <input\n                                  type=\"text\"\n                                  defaultValue={config?.sub_agent?.claude_code?.allowed_tools?.join(', ')}\n                                  onBlur={(e) => handleUpdateClaudeTools(e.target.value)}\n                                  placeholder=\"Edit, Bash, Read...\"\n                                  className=\"w-full bg-transparent border-b border-border/10 px-0 py-1 text-[10px] text-text-primary focus:outline-none focus:border-accent/40 font-mono transition-all uppercase\"\n                                />\n                              </div>\n                            </div>\n                          </div>\n\n                          {/* Codex */}\n                          <div className=\"bg-surface/5 border border-border/10 p-4 space-y-3\">\n                            <div className=\"flex items-center justify-between\">\n                              <div className=\"flex items-center gap-2\">\n                                <span className=\"text-[11px] font-black uppercase tracking-widest text-text-primary\">Codex</span>\n                                {status?.components?.codex === 'ok' && status?.auth?.codex?.startsWith('ok') && (\n                                  <span className=\"text-[8px] font-black text-status-success uppercase\">Ready</span>\n                                )}\n                              </div>\n                              <button\n                                onClick={() => handleToggleCLIEnabled('codex')}\n                                className={clsx(\n                                  \"text-[9px] font-black px-1.5 py-0.5 transition-all border active:scale-95\",\n                                  config?.sub_agent?.codex?.enabled\n                                    ? \"text-status-success border-status-success/20 hover:bg-status-success/5\"\n                                    : \"text-text-tertiary/40 border-border/10 hover:text-text-secondary\"\n                                )}\n                              >\n                                {config?.sub_agent?.codex?.enabled ? 'On' : 'Off'}\n                              </button>\n                            </div>\n\n                            <div className=\"space-y-3\">\n                              <div className=\"space-y-1\">\n                                <label className=\"text-[9px] font-black text-text-tertiary/40 uppercase tracking-widest ml-1\">Approval</label>\n                                <div className=\"flex gap-1\">\n                                  {['untrusted', 'on-failure', 'on-request', 'never'].map((mode) => (\n                                    <button\n                                      key={mode}\n                                      onClick={() => handleUpdateCodexMode(mode)}\n                                      className={clsx(\n                                        \"flex-1 py-1 text-[8px] font-black uppercase border transition-all active:scale-95\",\n                                        config?.sub_agent?.codex?.approval_mode?.toLowerCase() === mode.toLowerCase()\n                                          ? \"text-accent border-accent/40 bg-accent/5\"\n                                          : \"border-border/10 text-text-tertiary/40 hover:text-text-secondary hover:bg-surface/5\"\n                                      )}\n                                    >\n                                      {config?.sub_agent?.codex?.approval_mode?.toLowerCase() === mode.toLowerCase() \n                                        ? `[${mode.toUpperCase().replace('-', '_')}]` \n                                        : mode.toUpperCase().replace('-', '_')}\n                                    </button>\n                                  ))}\n                                </div>\n                              </div>\n                            </div>\n                          </div>\n                        </div>\n                      </div>\n                    </div>\n                  </section>\n                </div>\n              </div>\n            )\n            }\n\n            {activeTab === 'security' && (\n              <div className=\"space-y-12 animate-in fade-in slide-in-from-bottom-2 duration-300 font-mono\">\n                {/* Unrestricted Execution Mode Toggle */}\n                <div className={clsx(\n                  \"p-4 border transition-all duration-500\",\n                  config?.security?.always_allow_all\n                    ? \"bg-status-error text-background border-status-error shadow-[0_0_25px_rgba(var(--status-error),0.2)]\"\n                    : \"bg-status-error/5 border-status-error/10\"\n                )}>\n                  <div className=\"flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4\">\n                    <div className=\"flex flex-col gap-1 pr-4\">\n                      <div className=\"flex items-center gap-2\">\n                        <span className={clsx(\n                          \"text-[11px] font-black uppercase tracking-[0.2em]\",\n                          config?.security?.always_allow_all ? \"text-background\" : \"text-status-error\"\n                        )}>Unrestricted Execution</span>\n                        {config?.security?.always_allow_all && (\n                          <span className=\"text-[8px] font-black bg-background text-status-error px-1 py-0.5 animate-pulse tracking-widest\">System unlocked</span>\n                        )}\n                      </div>\n                      <p className={clsx(\n                        \"text-[9px] italic leading-relaxed max-w-2xl font-black uppercase tracking-tight\",\n                        config?.security?.always_allow_all ? \"text-background/90\" : \"text-text-tertiary/60\"\n                      )}>\n                        Bypass all security checks. Agents gain full unmonitored system access. Use only in trusted environments.\n                      </p>\n                    </div>\n                    <button\n                      onClick={handleToggleAlwaysAllowAll}\n                      className={clsx(\n                        \"text-[9px] font-black px-3 py-1.5 transition-all tracking-[0.1em] uppercase border whitespace-nowrap active:scale-95\",\n                        config?.security?.always_allow_all\n                          ? \"bg-background text-status-error border-background\"\n                          : \"bg-status-error text-background border-status-error\"\n                      )}\n                    >\n                      {config?.security?.always_allow_all ? 'Restore Security' : 'Disable Security'}\n                    </button>\n                  </div>\n                </div>\n\n                {/* Shell Execution Policy */}\n                <section className={clsx(\n                  \"space-y-3 transition-all duration-300\",\n                  config?.security?.always_allow_all && \"opacity-40 grayscale\"\n                )}>\n                  <div className=\"flex flex-col gap-0.5\">\n                    <div className=\"flex items-center justify-between\">\n                      <div className=\"flex items-center gap-2 text-accent/80\">\n                        <h2 className=\"text-[12px] font-black uppercase tracking-[0.2em]\">Shell Policy</h2>\n                      </div>\n                      {config?.security?.always_allow_all && (\n                        <span className=\"text-[8px] font-black text-status-error uppercase tracking-widest bg-status-error/10 px-1.5 py-0.5\">\n                          Overridden by unrestricted mode\n                        </span>\n                      )}\n                    </div>\n                    <p className=\"text-[10px] text-text-tertiary/60 italic leading-normal font-black tracking-tight\">\n                      Control auto-approval levels for terminal commands.\n                    </p>\n                  </div>\n\n                  <div className={clsx(\n                    \"bg-surface/5 border border-border/10 p-5 space-y-4\",\n                    config?.security?.always_allow_all && \"pointer-events-none\"\n                  )}>\n                    <div className=\"flex flex-col gap-0.5\">\n                      <span className=\"text-[11px] font-black text-text-primary uppercase tracking-[0.2em]\">Execution Mode</span>\n                    </div>\n\n                    <div className=\"grid grid-cols-2 sm:grid-cols-4 gap-2\">\n                      {[\n                        { id: 'restricted', label: 'RESTRICTED', desc: 'Minimal safe set' },\n                        { id: 'read-only', label: 'READ_ONLY', desc: 'All inspections' },\n                        { id: 'non-destructive', label: 'MUTABLE', desc: 'No deletions' },\n                        { id: 'unrestricted', label: 'OPEN', desc: 'No approvals' },\n                      ].map((mode) => (\n                        <button\n                          key={mode.id}\n                          onClick={() => handleUpdateShellPermissionMode(mode.id)}\n                          className={clsx(\n                            \"flex flex-col items-start p-3 border transition-all text-left group active:scale-[0.98]\",\n                            config?.security?.shell_permission_mode === mode.id\n                              ? \"border-accent bg-accent/5 shadow-[0_0_15px_rgba(var(--accent),0.05)]\"\n                              : \"border-border/10 hover:border-accent/40 bg-surface/5\"\n                          )}\n                        >\n                          <span className={clsx(\n                            \"text-[10px] font-black uppercase tracking-widest mb-1\",\n                            config?.security?.shell_permission_mode === mode.id ? \"text-accent\" : \"text-text-tertiary/60 group-hover:text-text-secondary\"\n                          )}>\n                            {config?.security?.shell_permission_mode === mode.id ? `[${mode.label}]` : `  ${mode.label}`}\n                          </span>\n                          <span className=\"text-[8px] text-text-tertiary/40 font-black uppercase leading-tight\">\n                            {mode.desc}\n                          </span>\n                        </button>\n                      ))}\n                    </div>\n                  </div>\n                </section>\n\n                {/* Vault Section */}\n                <section className=\"space-y-3\">\n                  <div className=\"flex flex-col gap-0.5\">\n                    <div className=\"flex items-center gap-2 text-accent/80\">\n                      <h2 className=\"text-[12px] font-black uppercase tracking-[0.2em]\">Secure Vault</h2>\n                    </div>\n                    <p className=\"text-[10px] text-text-tertiary/60 italic leading-normal font-black tracking-tight\">\n                      Protected tokens and environment variables.\n                    </p>\n                  </div>\n\n                  <div className=\"bg-surface/5 border border-border/10 p-5 space-y-6\">\n                    <div className=\"space-y-4\">\n                      <div className=\"flex flex-col gap-0.5\">\n                        <span className=\"text-[11px] font-black text-text-primary uppercase tracking-[0.2em]\">Vault Index</span>\n                        <p className=\"text-[10px] text-text-tertiary/60 italic px-3 font-black tracking-tight\">\n                          Access in tools via <code className=\"text-accent underline\">{\"{{vault:KEY}}\"}</code>.\n                        </p>\n                      </div>\n\n                      <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-2\">\n                        {vaultSecrets && vaultSecrets.length > 0 ? (\n                          vaultSecrets.map((secret: any) => (\n                            <div\n                              key={secret.name}\n                              className=\"flex items-center justify-between px-3 py-1.5 bg-background/20 border border-border/5 group hover:border-accent/20 transition-all\"\n                            >\n                              <div className=\"flex items-center gap-2\">\n                                <span className=\"text-[8px] font-black text-accent/40 uppercase\">[KEY]</span>\n                                <span className=\"text-[11px] font-black text-text-primary/70 font-mono truncate max-w-[120px]\">\n                                  {secret.name}\n                                </span>\n                              </div>\n                              <button\n                                onClick={() => handleRemoveVaultSecret(secret.name)}\n                                className=\"text-text-tertiary/20 hover:text-status-error opacity-0 group-hover:opacity-100 transition-all text-[10px] font-black\"\n                              >\n                                [X]\n                              </button>\n                            </div>\n                          ))\n                        ) : (\n                          <div className=\"col-span-full py-6 border border-dashed border-border/10 flex flex-col items-center justify-center text-text-tertiary/20\">\n                            <span className=\"text-[9px] uppercase font-black tracking-[0.2em]\">No secrets stored</span>\n                          </div>\n                        )}\n                      </div>\n\n                      {/* Add Secret Form */}\n                      <div className=\"mt-4 p-4 border-t border-border/5 space-y-3\">\n                        <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-4\">\n                          <div className=\"space-y-1\">\n                            <label className=\"text-[9px] font-black text-text-tertiary/40 uppercase tracking-widest ml-1\">Key</label>\n                            <input\n                              type=\"text\"\n                              placeholder=\"GITHUB_TOKEN\"\n                              value={newVaultSecret.name}\n                              onChange={(e) => setNewVaultSecret(prev => ({ ...prev, name: e.target.value.toUpperCase().replace(/[^A-Z0-9_]/g, '_') }))}\n                              className=\"w-full bg-transparent border-b border-border/10 px-0 py-1 text-[11px] text-text-primary focus:outline-none focus:border-accent/40 font-mono transition-all uppercase\"\n                            />\n                          </div>\n                          <div className=\"space-y-1\">\n                            <label className=\"text-[9px] font-black text-text-tertiary/40 uppercase tracking-widest ml-1\">Value</label>\n                            <input\n                              type=\"password\"\n                              placeholder=\"Secret value\"\n                              value={newVaultSecret.value}\n                              onChange={(e) => setNewVaultSecret(prev => ({ ...prev, value: e.target.value }))}\n                              className=\"w-full bg-transparent border-b border-border/10 px-0 py-1 text-[11px] text-text-primary focus:outline-none focus:border-accent/40 font-mono transition-all\"\n                            />\n                          </div>\n                        </div>\n                        <button\n                          onClick={handleSetVaultSecret}\n                          disabled={isSaving || !newVaultSecret.name || !newVaultSecret.value}\n                          className=\"w-full py-1 text-accent hover:text-accent-hover font-black text-[10px] uppercase tracking-widest transition-all disabled:opacity-20 active:scale-[0.98]\"\n                        >\n                          Store in Vault\n                        </button>\n                      </div>\n                    </div>\n                  </div>\n                </section>\n              </div>\n            )\n            }\n\n            {activeTab === 'shortcuts' && (\n              <div className=\"space-y-8 animate-in fade-in slide-in-from-bottom-2 duration-300 font-mono\">\n                {/* All Hotkeys Section */}\n                <section className=\"space-y-3\">\n                  <div className=\"flex flex-col gap-0.5\">\n                    <div className=\"flex items-center gap-2 text-accent/80\">\n                      <h2 className=\"text-[12px] font-black uppercase tracking-[0.2em]\">Shortcuts</h2>\n                    </div>\n                  </div>\n\n                  <div className=\"bg-surface/5 border border-border/10 p-5\">\n                    <div className=\"grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-1\">\n                      {Object.entries(hotkeyLabels).map(([key, label]) => (\n                        <div key={key} className=\"flex items-center justify-between py-1.5 border-b border-border/5 last:border-0 md:[&:nth-last-child(-n+2)]:border-0\">\n                          <span className=\"text-[10px] font-black text-text-tertiary/60 uppercase tracking-widest\">{label}</span>\n                          <button\n                            onClick={() => setRecordingHotkey(key)}\n                            className={clsx(\n                              \"font-mono text-[10px] font-black transition-all min-w-[90px] text-right\",\n                              recordingHotkey === key\n                                ? \"text-accent animate-pulse\"\n                                : \"text-accent/60 hover:text-accent\"\n                            )}\n                          >\n                            {recordingHotkey === key ? 'Recording...' : ((config?.ui as any)?.hotkeys?.[key] || hotkeyDefaults[key] || 'N/A')}\n                          </button>\n                        </div>\n                      ))}\n                    </div>\n                        <div className=\"mt-6 pt-3 border-t border-border/5\">\n                      <p className=\"text-[9px] text-text-tertiary/20 tracking-tighter italic font-black\">\n                        Press Escape to cancel. System reserved keys may override.\n                      </p>\n                    </div>\n                  </div>\n                </section>\n              </div>\n            )\n            }\n          </div >\n        </div >\n      </div >\n    </div >\n  );\n};\n","numLines":1698,"startLine":1,"totalLines":1698}}}
{"parentUuid":"a2e010da-9e0e-431b-a1f4-10f5946fd160","isSidechain":false,"userType":"external","cwd":"/Users/patrick/workingdir/familiar","sessionId":"507f4396-f3e4-4a63-8b43-9c891e06f5ee","version":"2.0.76","gitBranch":"main","slug":"precious-crunching-toast","message":{"model":"claude-opus-4-5-20251101","id":"msg_019dtuKov9HrWfe8gV4ggBn2","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"I found the theme picker in the SettingsView.tsx file. Looking at the code, in the `activeTab === 'general'` section (starting around line 1260), there's an \"Appearance Section\" (lines 1262-1301) that contains the theme picker.\n\nThe theme picker is this entire section:\n- Lines 1262-1301: The \"Interface Theme\" section with buttons to select different themes\n\nI need to remove this entire section. Let me identify the exact code to remove:\n\n```jsx\n{/* Appearance Section */}\n<section className=\"space-y-3\">\n  <div className=\"flex flex-col gap-0.5\">\n    <div className=\"flex items-center justify-between\">\n      <div className=\"flex items-center gap-2 text-accent/80\">\n        <h2 className=\"text-[12px] font-black uppercase tracking-[0.2em]\">Interface Theme</h2>\n      </div>\n    </div>\n    <p className=\"text-[10px] text-text-tertiary/60 italic leading-normal font-black tracking-tight\">\n      Visual styles update instantly across all sessions.\n    </p>\n  </div>\n  <div className=\"grid grid-cols-2 sm:grid-cols-4 gap-2.5\">\n    {themes.map((t) => (\n      <button\n        key={t.id}\n        onClick={() => handleUpdateTheme(t.id)}\n        className={clsx(\n          \"group relative flex flex-col p-2 border transition-all text-left h-20 active:scale-[0.98]\",\n          theme === t.id\n            ? \"border-accent bg-accent/5 shadow-[0_0_15px_rgba(var(--accent),0.05)]\"\n            : \"border-border/10 hover:border-accent/40 bg-surface/5\"\n        )}\n      >\n        <div className={clsx(\"w-full flex-1 mb-1.5 border border-border/10 overflow-hidden relative opacity-60\", t.colors)}>\n          <div className=\"absolute top-0 left-0 w-full h-1 bg-surface/20 border-b border-border/10\" />\n          <div className={clsx(\"absolute bottom-1 right-1 w-2 h-2 rounded-full\", t.accent)} />\n        </div>\n        <div className=\"flex items-center justify-between font-mono\">\n          <span className={clsx\n\nI see the theme selection button's visual structure continues with a complex className configuration for rendering theme preview elements. The code uses dynamic classes to represent different theme variations and visual states.\n\nThe component appears to conditionally style the theme name display, using typography and color classes that change based on the current selected theme. I'll remove related state management and cleanup associated code references to eliminate this unused interface section.","signature":"ErEVCkYICxgCKkCdllDkHekU3UW/pKQN3gnJ/UrMxFoliqc82uxXB8QlVao+7266a9LtJbyb4VDmZDR0C90EPMH2yO+Za5XQcDomEgxrD9bRTlOvPtoEvJsaDDndzPQXkphnG7EOWSIwRlBXbZWBSSR3Fr7Fhs5ZSSzx0YruzFUtCpWtbv00D6GbFv5jtfkOu6aF8S8zfZ6hKpgU8p+kp8Of5rxq6mH/dKmPa5pT5QYJ0yy4ZUQFgJ/96bgDZV+yboE7zuUCXrCeCRiplca9y3GuC2JJkvWA7o0NJvnPhSRWTsdWg1TXZN+kQDaeTtN492vvD20yRMGEDiIkstopS8DgjkIO3IgfCNnAVkDlGO3GO2icS3J9OTG90SBJkT6ibD+p6MnIWGhjPq5sMpum4ZZwSDoPOrPwMdCYCJkb6LJvYI+orgvjZyKLzQGJE+ZXay40p+HrrBLcBjYm6eILhmOXmHy/qf5V3OF2yctlWT7POPnPEW+zWzL1nErE+aDiVlW+93U+lypxLdlFHyWEDbB15fJUPDcXxDH2AXsuSWVeq7dbI343/Ki8YugH8ZAxKY6Tsy3QPzea7WpRdc/4vpOM/pPbFNP1c6PjszYan1XB0yUqpOR4TRaVeX1fMjWr/Z9faAB7iXxKoAp+Woc0Hu7JdCcV35TFYPXUAsR7YS5UzGJ309cjkqYpqshbhcgZeRldfb0RR3D24Z8E7s2JWjuv8CCLaEYUN2IiT36+FOHuSDHVCZLMOcqlp6YM24p28sHdqHFZdYl4Ozxsugyg0H984mRVVyOuv/La+szpyM2cR//Phq8vxTFek5ZPcrLVm/f6SU5yzx/YXNotsAGTVqMIC4VwhZWnU0X2hhJqXUQ2JmVWx9U2GKOGc1qiy/H1Nu/NqEqVjnJQ8f17rHt3sKlOmsJs7W02eYptZRudSHxwT3Fn3IjPk9yASfJMTnyXjZw8625r+Aj6SFhC3SUCnLUx3yu1Kom4dtYRKnCpW1hB69jf6Q8dQIICJaEuToMAnipNJIycR3AaVhmVSBsDTdVDxIuebFdDJweuB8nr0OVpYk5V4+W+qFQIJbVBlIO1I1Jx3Xj9O+NZET3vc14hiJGoyGkZ1gufttlLVekfmP+zjLiAChjDRxUTriHyFTpYujg3Ijzyg+GS+Ov91eAH+UYS3sSOHe25nXX/1GQdkiLPWFCpah7ERO5BTMXHAhqtMjyTiiJyxLIDC5IPcg8OsuJJW4uqCxYMN/5jSXf2GjkaxiCfEnOTZMFFuePMj3pAdUHGAmrbDxQfSHBUGtKvKj4/uEpeYRXQjXhh7Muj5McFmhH3gmA5XgTmNgaq47MW1ToSEAl+tCKxQiCajnXXgs8Y8EEsXHlHgh0B+nQBW5XNbJQVl6gldHXbUfcZJJ+5CNE4X3eC3qNwgQg+2hQ2NPwwKT/hX6447rkwCxfKmYf/1wvkZ92Lsm/hucCgSA+eUojxXOMOFncyjq3SwF9HFZYUqK1sUcA5Naco7h46U8vqyum0im1g+8jCEEcCDHnd91IS9+wbVfuJslUC9msDbbuEScwdbyVCQXbYYJ3BK18t73qGxtUjl3ESJSKet2YsoWzsQmd64AOuH/J0TIePlAJ5PtuF77FSe7UFgyyvt8mqc/wxPGRKhnWhJQerSgZsRfclHJr7Gm2t0srTqGth82n1oNUJDi1SpcVcAxJ6D0UWXD1fnsLJWI0XgKzMv/i4gpiButUMpg3dgTd1A1CoZShVOhLWBLVkEmkFPTuMyl4B9fOLgOQ9gGB25fkWNNw4Np2O8dQyHrn2mLASkFQ40ih7guCtnlnFM30mLExgFlR2CPlHl5Vzw2dqKbxmctMwFqt6rSin3LyhrhKHtoEO0ZUbL+9w2/vP9ITWIU6GPTgqmddPeJFIh+vUa0UjsXjoLNdMi9ypZ0xU2vBLOGqA51c5/cqB7gs+eKyH65nleZC632sqbNoEiV805tY7am19ahMrfduv8w0OLw04WVZtYdZ1RM6/mJPt+ARQblHLLAJ5s+f2yxtnpk1PBOQ9mnl4laDG9u3eM93Ep04Rcd89dkVvPeeEhzDEMc7KS+MCzuQwZ+BSr09NKNNJuH4hcG4y6ZsZSguBNMT0bobmWB5dpDfWdrMVAmQmFuS5SWaXuDrqB5lFEXA3u2+dUdO3zhHBcymiyavCjuZ3aBqu6Q8kpd8XVm9nlmIv+/0Lg0vX3gW8YbluuI2QU/tNqZZd/Y6pum5H9AyTNO9sDc5+zsDqg4zoYS4AE+ZexDyxAYYCUrx05eenKkUuiJgeRtHZFIKP7ib8f2Ly9G/AVsS3hQVmhSZ3X7YsKHZ/DdGn+QaEs0CVuDKLfN2SKBqinfFZT503RZOBb5rH4BysDA40+1RH6OiUp12AraFg2PHRE0m1bAl30Qx0MJJMcxP/WDcR0ox05aGftcN1jwdBAlbGvDQVSwqZiFau3y1QkMnTzZOryHgArcdFovanIQDBr8kQyxBpP5S9iSAr6wy3CeWOwmwKuhboztr1rE2uC3I2db2tIknpgGtkucSM2FO6HwzObrgK9uZtN19zqReWiliuxrWmVHR7BwCzRVieJqeQX9hWUhyJHOhATbbiDcxqeI2mPXVTVEdHAIaxYHo5+1r3JJqgqCeJcaOm36P2wfqrv2RzJMxDzPmYjiKgFXQWsoBTiBGQxOvnU23/68ExDPMncXOGXtge/JmrN5/yEbc/2373GTuoaOBtKsmz9M1VXwnp9D7S+2q1ntKY7Q5ml1Vozh8ry8txFri0Yy9SaJ2kBksVoaRl0VxxMHKx15VAsn1VRyKnErwaPNOJAIFz7SB8mVaTQnvhb5dpInDa6A1rcm0I/KL4a9AunvNhZfoqhpbjzsOOkw0OozTwSqUwHtGZHIRIlKEiz1cfo7CG1VzYxyWg5HJ5BLXWhM0DL4ZR1INdNgd+Lo2rZQU/I51ENEW3nV9PVxriNdXCIIB+32/oo0A+uhi1ZmpkEiYFdVJ6c5RwOatw3fcUS1MLhZT67qQt6j+TYZA1c/nqPAmlaMFuFeD489iBjEgZ/p3AkobgU1FXah8MtqprKk2LoP1FR7/nMgFx53NjBG1y+mltIZ5WOHnIf5kmgYk4mh3WGWY8S1amiu2udrV4BF4srMDN5JL8aYfTklsaYqeUrcJHL6Su3s/oXBqfayZlUCWVj+IgUDVYm0MX88shpbjBhs5/rhu+oIIda1E5nYLgxY/uCLCqE7xKwSlQpDt8SP3GFhptTzhifDGQ17iVp75AbFPqLEHfgFq90yxt27sxI/Oc9SdFuuqGC3aq2sYJsYivr60BZyqll1FXxhW91cAkDr+hvQplPKECI2dfaZ7a74vGFr64vPRyXRNwhNEgBEt9x+mSxE3LwOOIu+6AA6eclvkoFbX/aP1854FqdUfh1VGJkCl8DNzaojfMqemHPsprOcd3/lNF0o7rLazvmAZ+T6S8v6mcc0q/Ao7j6tSdyFe1qUipdpNmGXfsLqUX9JONdVtg+tBHLj1LtdKN3y4TUtzIJotN7n+5dllAyXxdyZ2Dh+OOfWyl6EmfCVxhb5MeElKZ4IVikyRfTFGRgXC2MgFO/YMgvXHU9N3Wh3ZsYl39yfk7LBJgWPNA7CSJGHYMwyhKXG+ejl6MnP8ZURgB"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":27778,"cache_read_input_tokens":27535,"cache_creation":{"ephemeral_5m_input_tokens":27778,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWjfuyjZ2MypLAh5drwVL","type":"assistant","uuid":"b79293c6-42e1-4f87-b57c-7e5a380a703e","timestamp":"2026-01-03T02:40:52.513Z"}
{"parentUuid":"b79293c6-42e1-4f87-b57c-7e5a380a703e","isSidechain":false,"userType":"external","cwd":"/Users/patrick/workingdir/familiar","sessionId":"507f4396-f3e4-4a63-8b43-9c891e06f5ee","version":"2.0.76","gitBranch":"main","slug":"precious-crunching-toast","message":{"model":"claude-opus-4-5-20251101","id":"msg_019dtuKov9HrWfe8gV4ggBn2","type":"message","role":"assistant","content":[{"type":"text","text":"I can see the theme picker in the `general` tab section. Let me remove the entire \"Interface Theme\" section along with the related dead code (theme state, handler, and themes array)."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":27778,"cache_read_input_tokens":27535,"cache_creation":{"ephemeral_5m_input_tokens":27778,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWjfuyjZ2MypLAh5drwVL","type":"assistant","uuid":"7d90da5d-b5f2-4550-bd80-826ffce09fa4","timestamp":"2026-01-03T02:40:52.608Z"}
{"parentUuid":"7d90da5d-b5f2-4550-bd80-826ffce09fa4","isSidechain":false,"userType":"external","cwd":"/Users/patrick/workingdir/familiar","sessionId":"507f4396-f3e4-4a63-8b43-9c891e06f5ee","version":"2.0.76","gitBranch":"main","slug":"precious-crunching-toast","message":{"model":"claude-opus-4-5-20251101","id":"msg_019dtuKov9HrWfe8gV4ggBn2","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_018zyxKGcYYrBJMYHLfkMLSN","name":"Edit","input":{"file_path":"/Users/patrick/workingdir/familiar/packages/desktop/ui/src/components/Agent/SettingsView.tsx","old_string":"                {/* Appearance Section */}\n                <section className=\"space-y-3\">\n                  <div className=\"flex flex-col gap-0.5\">\n                    <div className=\"flex items-center justify-between\">\n                      <div className=\"flex items-center gap-2 text-accent/80\">\n                        <h2 className=\"text-[12px] font-black uppercase tracking-[0.2em]\">Interface Theme</h2>\n                      </div>\n                    </div>\n                    <p className=\"text-[10px] text-text-tertiary/60 italic leading-normal font-black tracking-tight\">\n                      Visual styles update instantly across all sessions.\n                    </p>\n                  </div>\n                  <div className=\"grid grid-cols-2 sm:grid-cols-4 gap-2.5\">\n                    {themes.map((t) => (\n                      <button\n                        key={t.id}\n                        onClick={() => handleUpdateTheme(t.id)}\n                        className={clsx(\n                          \"group relative flex flex-col p-2 border transition-all text-left h-20 active:scale-[0.98]\",\n                          theme === t.id\n                            ? \"border-accent bg-accent/5 shadow-[0_0_15px_rgba(var(--accent),0.05)]\"\n                            : \"border-border/10 hover:border-accent/40 bg-surface/5\"\n                        )}\n                      >\n                        <div className={clsx(\"w-full flex-1 mb-1.5 border border-border/10 overflow-hidden relative opacity-60\", t.colors)}>\n                          <div className=\"absolute top-0 left-0 w-full h-1 bg-surface/20 border-b border-border/10\" />\n                          <div className={clsx(\"absolute bottom-1 right-1 w-2 h-2 rounded-full\", t.accent)} />\n                        </div>\n                        <div className=\"flex items-center justify-between font-mono\">\n                          <span className={clsx(\n                            \"text-[10px] font-black uppercase tracking-widest\",\n                            theme === t.id ? \"text-accent\" : \"text-text-tertiary/60 group-hover:text-text-secondary\"\n                          )}>\n                            {theme === t.id ? `[${t.name}]` : `  ${t.name}`}\n                          </span>\n                        </div>\n                      </button>\n                    ))}\n                  </div>\n                </section>\n\n                <div className=\"grid grid-cols-1 gap-12\">","new_string":"                <div className=\"grid grid-cols-1 gap-12\">"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":27778,"cache_read_input_tokens":27535,"cache_creation":{"ephemeral_5m_input_tokens":27778,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWjfuyjZ2MypLAh5drwVL","type":"assistant","uuid":"b345aa18-279a-45d6-b29c-047a4ba1976c","timestamp":"2026-01-03T02:40:56.646Z"}
{"parentUuid":"b345aa18-279a-45d6-b29c-047a4ba1976c","isSidechain":false,"userType":"external","cwd":"/Users/patrick/workingdir/familiar","sessionId":"507f4396-f3e4-4a63-8b43-9c891e06f5ee","version":"2.0.76","gitBranch":"main","slug":"precious-crunching-toast","message":{"model":"claude-opus-4-5-20251101","id":"msg_019dtuKov9HrWfe8gV4ggBn2","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_014SH8XG4XkAxs2MZarwx9Yj","name":"Edit","input":{"file_path":"/Users/patrick/workingdir/familiar/packages/desktop/ui/src/components/Agent/SettingsView.tsx","old_string":"  const [theme, setTheme] = useState(config?.ui?.theme || 'default');","new_string":""}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":27778,"cache_read_input_tokens":27535,"cache_creation":{"ephemeral_5m_input_tokens":27778,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWjfuyjZ2MypLAh5drwVL","type":"assistant","uuid":"94dda831-bad6-40a8-8e0d-f14e7848fe29","timestamp":"2026-01-03T02:40:57.288Z"}
{"parentUuid":"94dda831-bad6-40a8-8e0d-f14e7848fe29","isSidechain":false,"userType":"external","cwd":"/Users/patrick/workingdir/familiar","sessionId":"507f4396-f3e4-4a63-8b43-9c891e06f5ee","version":"2.0.76","gitBranch":"main","slug":"precious-crunching-toast","message":{"model":"claude-opus-4-5-20251101","id":"msg_019dtuKov9HrWfe8gV4ggBn2","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_017BTNXUwMoYua8wXG36pW5d","name":"Edit","input":{"file_path":"/Users/patrick/workingdir/familiar/packages/desktop/ui/src/components/Agent/SettingsView.tsx","old_string":"  const handleUpdateTheme = async (newTheme: string) => {\n    setTheme(newTheme);\n    try {\n      await api.updateConfig({ ui: { theme: newTheme } });\n      localStorage.setItem('pa_theme', newTheme);\n      if (newTheme === 'default') {\n        document.documentElement.removeAttribute('data-theme');\n      } else {\n        document.documentElement.setAttribute('data-theme', newTheme);\n      }\n      await refetchConfig();\n      triggerSuccess();\n    } catch (err) {\n      console.error('Failed to update theme:', err);\n    }\n  };","new_string":""}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":27778,"cache_read_input_tokens":27535,"cache_creation":{"ephemeral_5m_input_tokens":27778,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWjfuyjZ2MypLAh5drwVL","type":"assistant","uuid":"d7798914-0a57-4214-ac8b-ce38e39d0f9f","timestamp":"2026-01-03T02:40:59.812Z"}
{"parentUuid":"d7798914-0a57-4214-ac8b-ce38e39d0f9f","isSidechain":false,"userType":"external","cwd":"/Users/patrick/workingdir/familiar","sessionId":"507f4396-f3e4-4a63-8b43-9c891e06f5ee","version":"2.0.76","gitBranch":"main","slug":"precious-crunching-toast","message":{"model":"claude-opus-4-5-20251101","id":"msg_019dtuKov9HrWfe8gV4ggBn2","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01GynvDkXDWpPVaWbEh5FiXq","name":"Edit","input":{"file_path":"/Users/patrick/workingdir/familiar/packages/desktop/ui/src/components/Agent/SettingsView.tsx","old_string":"  const themes = [\n    { id: 'default', name: 'Matrix Dark', colors: 'bg-[#181c21]', accent: 'bg-[#22d3ee]' },\n    { id: 'light', name: 'Paper White', colors: 'bg-[#f2f2f2]', accent: 'bg-[#2563eb]' },\n    { id: 'cobalt2', name: 'Cobalt2', colors: 'bg-[#193549]', accent: 'bg-[#ffc600]' },\n    { id: 'nerv', name: 'NERV HQ', colors: 'bg-[#1c1c1c]', accent: 'bg-[#ff9500]' },\n  ];\n\n  return (","new_string":"  return ("}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":27778,"cache_read_input_tokens":27535,"cache_creation":{"ephemeral_5m_input_tokens":27778,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWjfuyjZ2MypLAh5drwVL","type":"assistant","uuid":"d61aa116-3aae-41cf-b26c-558c55de48ca","timestamp":"2026-01-03T02:41:03.242Z"}
{"type":"file-history-snapshot","messageId":"b345aa18-279a-45d6-b29c-047a4ba1976c","snapshot":{"messageId":"c0657f1c-2107-41fa-b55a-b1b2fa66216e","trackedFileBackups":{"packages/desktop/ui/src/components/Agent/SettingsView.tsx":{"backupFileName":"09d0ee9d4e040ead@v1","version":1,"backupTime":"2026-01-03T02:41:10.994Z"}},"timestamp":"2026-01-03T02:40:09.795Z"},"isSnapshotUpdate":true}
{"parentUuid":"d61aa116-3aae-41cf-b26c-558c55de48ca","isSidechain":false,"userType":"external","cwd":"/Users/patrick/workingdir/familiar","sessionId":"507f4396-f3e4-4a63-8b43-9c891e06f5ee","version":"2.0.76","gitBranch":"main","slug":"precious-crunching-toast","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_018zyxKGcYYrBJMYHLfkMLSN","type":"tool_result","content":"The file /Users/patrick/workingdir/familiar/packages/desktop/ui/src/components/Agent/SettingsView.tsx has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n  1258→            )}\n  1259→\n  1260→            {activeTab === 'general' && (\n  1261→              <div className=\"space-y-12 animate-in fade-in slide-in-from-bottom-2 duration-300 font-mono\">\n  1262→                <div className=\"grid grid-cols-1 gap-12\">\n  1263→                  {/* Agent Behavior Section */}\n  1264→                  <section className=\"space-y-3\">\n  1265→                    <div className=\"flex flex-col gap-0.5\">\n  1266→                      <div className=\"flex items-center gap-2 text-accent/80\">"}]},"uuid":"b82694c8-01c6-4557-ae08-22e23fc19ec6","timestamp":"2026-01-03T02:41:10.984Z","toolUseResult":{"filePath":"/Users/patrick/workingdir/familiar/packages/desktop/ui/src/components/Agent/SettingsView.tsx","oldString":"                {/* Appearance Section */}\n                <section className=\"space-y-3\">\n                  <div className=\"flex flex-col gap-0.5\">\n                    <div className=\"flex items-center justify-between\">\n                      <div className=\"flex items-center gap-2 text-accent/80\">\n                        <h2 className=\"text-[12px] font-black uppercase tracking-[0.2em]\">Interface Theme</h2>\n                      </div>\n                    </div>\n                    <p className=\"text-[10px] text-text-tertiary/60 italic leading-normal font-black tracking-tight\">\n                      Visual styles update instantly across all sessions.\n                    </p>\n                  </div>\n                  <div className=\"grid grid-cols-2 sm:grid-cols-4 gap-2.5\">\n                    {themes.map((t) => (\n                      <button\n                        key={t.id}\n                        onClick={() => handleUpdateTheme(t.id)}\n                        className={clsx(\n                          \"group relative flex flex-col p-2 border transition-all text-left h-20 active:scale-[0.98]\",\n                          theme === t.id\n                            ? \"border-accent bg-accent/5 shadow-[0_0_15px_rgba(var(--accent),0.05)]\"\n                            : \"border-border/10 hover:border-accent/40 bg-surface/5\"\n                        )}\n                      >\n                        <div className={clsx(\"w-full flex-1 mb-1.5 border border-border/10 overflow-hidden relative opacity-60\", t.colors)}>\n                          <div className=\"absolute top-0 left-0 w-full h-1 bg-surface/20 border-b border-border/10\" />\n                          <div className={clsx(\"absolute bottom-1 right-1 w-2 h-2 rounded-full\", t.accent)} />\n                        </div>\n                        <div className=\"flex items-center justify-between font-mono\">\n                          <span className={clsx(\n                            \"text-[10px] font-black uppercase tracking-widest\",\n                            theme === t.id ? \"text-accent\" : \"text-text-tertiary/60 group-hover:text-text-secondary\"\n                          )}>\n                            {theme === t.id ? `[${t.name}]` : `  ${t.name}`}\n                          </span>\n                        </div>\n                      </button>\n                    ))}\n                  </div>\n                </section>\n\n                <div className=\"grid grid-cols-1 gap-12\">","newString":"                <div className=\"grid grid-cols-1 gap-12\">","originalFile":"import React, { useState, useEffect, useRef, useCallback } from 'react';\nimport { useQuery, useQueryClient } from '@tanstack/react-query';\nimport { useNavigate } from 'react-router-dom';\nimport { api } from '../../lib/api';\nimport { clsx } from 'clsx';\nimport { ask } from '@tauri-apps/plugin-dialog';\nimport { useSystem } from '../../context/SystemContext';\nimport { useAgents } from '../../context/AgentContext';\n\nexport const SettingsView: React.FC = () => {\n  const navigate = useNavigate();\n  const queryClient = useQueryClient();\n  const { setExplorerCollapsed } = useAgents();\n  const { data: config, refetch: refetchConfig } = useQuery({\n    queryKey: ['config'],\n    queryFn: () => api.getConfig(),\n  });\n\n  const { data: apiKeys, refetch: refetchKeys } = useQuery({\n    queryKey: ['apiKeys'],\n    queryFn: () => api.getApiKeys(),\n  });\n\n  const { data: vaultSecrets, refetch: refetchVault } = useQuery({\n    queryKey: ['vaultSecrets'],\n    queryFn: () => api.listVaultSecrets(),\n  });\n\n  const { data: status } = useQuery({\n    queryKey: ['status'],\n    queryFn: () => api.getStatus(),\n    refetchInterval: 5000,\n  });\n\n  const handleToggleAlwaysAllowAll = async () => {\n    const current = !!config?.security?.always_allow_all;\n    if (!current) {\n      const confirmed = await ask(\"WARNING: This will automatically approve ALL tool calls (including shell and browser) from ALL agents and sub-agents. This grants autonomous agents full control over your local system and web presence. Are you sure you want to disable all security oversight?\", {\n        title: \"Danger: Disable All Approvals\",\n        kind: \"error\",\n      });\n      if (!confirmed) return;\n    }\n\n    try {\n      await api.updateConfig({ security: { always_allow_all: !current } });\n      await refetchConfig();\n      triggerSuccess();\n    } catch (err) {\n      console.error('Failed to toggle always allow all:', err);\n    }\n  };\n\n  const handleUpdateShellPermissionMode = async (mode: string) => {\n    try {\n      await api.updateConfig({ security: { shell_permission_mode: mode } });\n      await refetchConfig();\n      triggerSuccess();\n    } catch (err) {\n      console.error('Failed to update shell permission mode:', err);\n    }\n  };\n\n  const handleToggleSubAgentsGlobal = async () => {\n    try {\n      const current = !!config?.sub_agent?.enabled;\n      await api.updateConfig({ sub_agent: { enabled: !current } });\n      await refetchConfig();\n      triggerSuccess();\n    } catch (err) {\n      console.error('Failed to toggle sub-agents globally:', err);\n    }\n  };\n\n\n\n  const handleToggleCLIEnabled = async (cli: 'claude_code' | 'codex') => {\n    try {\n      const current = !!config?.sub_agent?.[cli]?.enabled;\n      await api.updateConfig({ sub_agent: { [cli]: { enabled: !current } } });\n      await refetchConfig();\n      triggerSuccess();\n    } catch (err) {\n      console.error(`Failed to toggle ${cli}:`, err);\n    }\n  };\n\n  const handleUpdateClaudeTools = async (tools: string) => {\n    try {\n      const toolList = tools.split(',').map(t => t.trim()).filter(Boolean);\n      await api.updateConfig({ sub_agent: { claude_code: { allowed_tools: toolList } } });\n      await refetchConfig();\n      triggerSuccess();\n    } catch (err) {\n      console.error('Failed to update Claude tools:', err);\n    }\n  };\n\n  const handleUpdateCodexMode = async (mode: string) => {\n    try {\n      await api.updateConfig({ sub_agent: { codex: { approval_mode: mode } } });\n      await refetchConfig();\n      triggerSuccess();\n    } catch (err) {\n      console.error('Failed to update Codex mode:', err);\n    }\n  };\n\n  const [theme, setTheme] = useState(config?.ui?.theme || 'default');\n  const [isSaving, setIsSaving] = useState(false);\n  const [showSuccess, setShowSuccess] = useState(false);\n  const [newKey, setNewKey] = useState<{ provider: string; key: string }>({ provider: '', key: '' });\n  const [newVaultSecret, setNewVaultSecret] = useState<{ name: string; value: string }>({ name: '', value: '' });\n  const [customBaseUrl, setCustomBaseUrl] = useState('');\n  const [isAddingCustomProvider, setIsAddingCustomProvider] = useState(false);\n  const [newCustomProviderName, setNewCustomProviderName] = useState('');\n\n  const [editingProvider, setEditingProvider] = useState<string | null>(null);\n  const [editingCapability, setEditingCapability] = useState<string>('chat');\n  const [newModelName, setNewModelName] = useState('');\n  const [isFetchingModels, setIsFetchingModels] = useState(false);\n  const { activeSettingsTab: activeTab } = useSystem();\n\n  const [recordingHotkey, setRecordingHotkey] = useState<string | null>(null);\n  const autoFetchedProviders = useRef<Set<string>>(new Set());\n\n  // Thinking configuration state - track which model is being edited\n  const [editingThinkingModel, setEditingThinkingModel] = useState<string | null>(null);\n\n  // Reasoning levels\n  type ReasoningLevel = '' | 'low' | 'medium' | 'high';\n  const reasoningLevels: { value: ReasoningLevel; label: string }[] = [\n    { value: '', label: 'None' },\n    { value: 'low', label: 'Low' },\n    { value: 'medium', label: 'Medium' },\n    { value: 'high', label: 'High' },\n  ];\n\n  // Helper to parse model string for reasoning level\n  // e.g., \"claude-haiku-4.5:thinking-high\" -> { baseModel: \"claude-haiku-4.5\", level: \"high\" }\n  const parseModelLevel = (model: string): { baseModel: string; level: ReasoningLevel } => {\n    for (const l of ['low', 'medium', 'high'] as ReasoningLevel[]) {\n      const suffix = `:thinking-${l}`;\n      if (model.endsWith(suffix)) {\n        return { baseModel: model.replace(suffix, ''), level: l };\n      }\n    }\n    // Legacy: :thinking without level = high\n    if (model.endsWith(':thinking')) {\n      return { baseModel: model.replace(':thinking', ''), level: 'high' };\n    }\n    return { baseModel: model, level: '' };\n  };\n\n  // Helper to build model string from base and level\n  const buildModelString = (baseModel: string, level: ReasoningLevel): string => {\n    if (level) {\n      return `${baseModel}:thinking-${level}`;\n    }\n    return baseModel;\n  };\n\n  // Providers that support thinking/reasoning\n  const thinkingProviders = ['openrouter', 'anthropic', 'openai', 'gemini'];\n\n  // Update a model's reasoning level\n  const handleUpdateModelLevel = async (oldModel: string, newLevel: ReasoningLevel) => {\n    if (!editingProvider || !editingCapability) return;\n\n    const { baseModel } = parseModelLevel(oldModel);\n    const newModel = buildModelString(baseModel, newLevel);\n\n    if (newModel === oldModel) return; // No change\n\n    const models = availableModels[editingProvider]?.[editingCapability] || [];\n    const updatedModels = models.map(m => m === oldModel ? newModel : m);\n\n    const updatedAvailableModels = {\n      ...availableModels,\n      [editingProvider]: {\n        ...(availableModels[editingProvider] || {}),\n        [editingCapability]: updatedModels\n      }\n    };\n\n    setIsSaving(true);\n    try {\n      await api.updateConfig({ available_models: updatedAvailableModels });\n      await refetchConfig();\n      triggerSuccess();\n    } catch (err) {\n      console.error('Failed to update model reasoning level:', err);\n    } finally {\n      setIsSaving(false);\n    }\n  };\n\n  useEffect(() => {\n    setExplorerCollapsed(false);\n  }, []);\n\n  const successTimeoutRef = useRef<ReturnType<typeof setTimeout> | null>(null);\n  const triggerSuccess = useCallback(() => {\n    setShowSuccess(true);\n    if (successTimeoutRef.current) clearTimeout(successTimeoutRef.current);\n    successTimeoutRef.current = setTimeout(() => setShowSuccess(false), 3000);\n  }, []);\n\n  useEffect(() => {\n    if (recordingHotkey) {\n      const handleGlobalKeyDown = (e: KeyboardEvent) => {\n        // Don't intercept if it's just a modifier key\n        if (['Control', 'Shift', 'Alt', 'Meta'].includes(e.key)) return;\n\n        e.preventDefault();\n        e.stopPropagation();\n\n        if (e.key === 'Escape') {\n          setRecordingHotkey(null);\n          return;\n        }\n\n        const modifiers = [];\n        if (e.metaKey) modifiers.push('Cmd');\n        else if (e.ctrlKey) modifiers.push('Ctrl');\n\n        if (e.shiftKey) modifiers.push('Shift');\n        if (e.altKey) modifiers.push('Alt');\n\n        let key = e.key;\n        if (key === ' ') key = 'Space';\n        if (key.length === 1) key = key.toUpperCase();\n\n        const hotkey = modifiers.length > 0 ? `${modifiers.join('+')}+${key}` : key;\n\n        handleUpdateHotkey(recordingHotkey, hotkey);\n        setRecordingHotkey(null);\n      };\n\n      window.addEventListener('keydown', handleGlobalKeyDown, true);\n      return () => window.removeEventListener('keydown', handleGlobalKeyDown, true);\n    }\n  }, [recordingHotkey, config]);\n\n  const handleUpdateHotkey = async (key: string, value: string) => {\n    const updatedHotkeys = { ...((config?.ui as any)?.hotkeys || {}), [key]: value };\n    try {\n      await api.updateConfig({ ui: { hotkeys: updatedHotkeys } });\n      await refetchConfig();\n      triggerSuccess();\n    } catch (err) {\n      console.error('Failed to update hotkey:', err);\n    }\n  };\n\n  const hotkeyDefaults: Record<string, string> = {\n    'global_back': 'Escape',\n    'new_agent': 'Cmd+N',\n    'focus_input': 'Cmd+L',\n    'toggle_sidebar': 'Cmd+B',\n    'toggle_settings': 'Cmd+,',\n    'toggle_pause': 'Cmd+P',\n    'compact': 'Cmd+Shift+C',\n    'toggle_unibar': 'Cmd+K',\n    'delete_agent': 'Cmd+D',\n    'toggle_explorer': 'Cmd+E',\n  };\n\n  const hotkeyLabels: Record<string, string> = {\n    'global_back': 'Global Back / Exit Dashboard',\n    'new_agent': 'Create New Agent (Dashboard)',\n    'focus_input': 'Focus Chat Input (Workspace)',\n    'toggle_sidebar': 'Toggle Sidebar (Workspace)',\n    'toggle_settings': 'Toggle Settings (Workspace)',\n    'toggle_pause': 'Toggle Pause/Resume',\n    'compact': 'Compact History (Workspace)',\n    'toggle_unibar': 'Omnibar / Command Palette',\n    'delete_agent': 'Delete Highlighted Agent (Dashboard)',\n    'toggle_explorer': 'Toggle Explorer Panel',\n  };\n\n  // Pointer-based drag state (bypasses Tauri's drag interception)\n  const [isDragging, setIsDragging] = useState(false);\n  const [dragSourceIndex, setDragSourceIndex] = useState<number | null>(null);\n  const [dragTargetIndex, setDragTargetIndex] = useState<number | null>(null);\n  const itemRefs = useRef<(HTMLDivElement | null)[]>([]);\n  const containerRef = useRef<HTMLDivElement>(null);\n  const scrollRef = useRef<HTMLDivElement>(null);\n\n  useEffect(() => {\n    const handleKeyDown = (e: KeyboardEvent) => {\n      // Don't scroll if we're recording a hotkey or typing in an input\n      if (recordingHotkey) return;\n\n      const activeElement = document.activeElement;\n      const isInput = activeElement instanceof HTMLInputElement ||\n        activeElement instanceof HTMLTextAreaElement ||\n        (activeElement as HTMLElement)?.isContentEditable;\n\n      if (isInput && !(e.metaKey || e.ctrlKey)) return;\n\n      if (e.key === 'ArrowUp') {\n        if (scrollRef.current) {\n          e.preventDefault();\n          scrollRef.current.scrollBy({ top: -100, behavior: 'smooth' });\n        }\n      }\n      if (e.key === 'ArrowDown') {\n        if (scrollRef.current) {\n          e.preventDefault();\n          scrollRef.current.scrollBy({ top: 100, behavior: 'smooth' });\n        }\n      }\n      if (e.key === ' ' && !isInput) {\n        if (scrollRef.current) {\n          e.preventDefault();\n          const direction = e.shiftKey ? -1 : 1;\n          scrollRef.current.scrollBy({\n            top: direction * scrollRef.current.clientHeight * 0.8,\n            behavior: 'smooth'\n          });\n        }\n      }\n    };\n\n    window.addEventListener('keydown', handleKeyDown);\n    return () => window.removeEventListener('keydown', handleKeyDown);\n  }, [recordingHotkey]);\n\n\n\n  useEffect(() => {\n    if (!editingProvider && config?.available_models && apiKeys) {\n      const availableModels = config.available_models;\n      const providers = Object.keys(availableModels);\n\n      // Preference order for default selection\n      const preference = ['openrouter', 'anthropic', 'openai', 'gemini'];\n      const defaultProvider = preference.find(p => providers.some(ap => ap.toLowerCase() === p));\n\n      if (defaultProvider) {\n        const matching = providers.find(p => p.toLowerCase() === defaultProvider);\n        if (matching) {\n          setEditingProvider(matching);\n          setNewKey(prev => ({ ...prev, provider: matching }));\n        }\n      } else if (providers.length > 0) {\n        setEditingProvider(providers[0]);\n        setNewKey(prev => ({ ...prev, provider: providers[0] }));\n      }\n    }\n  }, [config, editingProvider, apiKeys]);\n\n  useEffect(() => {\n    if (editingProvider && config?.custom_providers?.[editingProvider]) {\n      setCustomBaseUrl(config?.custom_providers[editingProvider].base_url || '');\n    } else {\n      setCustomBaseUrl('');\n    }\n  }, [editingProvider, config?.custom_providers]);\n\n  const availableModels = config?.available_models || {};\n  const localProvidersList = ['ollama', 'lmstudio'];\n  const standardProviders = ['openrouter', 'anthropic', 'openai', 'gemini', 'ollama', 'lmstudio'];\n\n  const handleFetchModels = useCallback(async (provider: string) => {\n    if (isFetchingModels) return;\n    setIsFetchingModels(true);\n    try {\n      const response = await api.fetchModels(provider);\n      if (response && response.models) {\n        const updatedAvailableModels = {\n          ...availableModels,\n          [provider]: {\n            ...(availableModels[provider] || {}),\n            chat: response.models\n          }\n        };\n\n        // If this is the active provider and has no model set, pick the first one\n        const updates: any = { available_models: updatedAvailableModels };\n        if (provider === config?.inference?.chat?.provider && (!config?.inference?.chat?.model || (availableModels[provider]?.chat?.length || 0) === 0)) {\n          if (response.models.length > 0) {\n            updates.inference = {\n              ...config.inference,\n              chat: {\n                ...config.inference.chat,\n                model: response.models[0]\n              }\n            };\n          }\n        }\n\n        await api.updateConfig(updates);\n        await refetchConfig();\n        triggerSuccess();\n      }\n    } catch (err) {\n      console.error('Failed to fetch models:', err);\n    } finally {\n      setIsFetchingModels(false);\n    }\n  }, [availableModels, config, isFetchingModels, refetchConfig, triggerSuccess]);\n\n  useEffect(() => {\n    if (editingProvider && localProvidersList.includes(editingProvider.toLowerCase())) {\n      const currentChatModels = availableModels[editingProvider]?.chat || [];\n      if (currentChatModels.length === 0 && !isFetchingModels && !autoFetchedProviders.current.has(editingProvider.toLowerCase())) {\n        autoFetchedProviders.current.add(editingProvider.toLowerCase());\n        handleFetchModels(editingProvider);\n      }\n    }\n  }, [editingProvider, availableModels, isFetchingModels, handleFetchModels]);\n\n  const allProviders = Object.keys(availableModels);\n  const cloudProviders = allProviders.filter(p => standardProviders.includes(p.toLowerCase()) && !localProvidersList.includes(p.toLowerCase()));\n  const localProviders = allProviders.filter(p => standardProviders.includes(p.toLowerCase()) && localProvidersList.includes(p.toLowerCase()));\n  const userCustomProvidersList = allProviders.filter(p => !standardProviders.includes(p.toLowerCase()));\n\n  const currentModels = (editingProvider && editingCapability) ? (availableModels[editingProvider]?.[editingCapability] || []) : [];\n  const hasCustomBaseUrl = !!customBaseUrl.trim();\n\n  const handleAddCustomProvider = async () => {\n    if (!newCustomProviderName.trim()) return;\n    const name = newCustomProviderName.trim().toLowerCase();\n    if (standardProviders.includes(name) || userCustomProvidersList.includes(name)) {\n      alert('Provider name already exists or is reserved.');\n      return;\n    }\n\n    setIsSaving(true);\n    try {\n      const updatedCustomProviders = {\n        ...(config?.custom_providers || {}),\n        [name]: { base_url: '' }\n      };\n      await api.updateConfig({ custom_providers: updatedCustomProviders });\n      await refetchConfig();\n      setEditingProvider(name);\n      setIsAddingCustomProvider(false);\n      setNewCustomProviderName('');\n      triggerSuccess();\n    } catch (err) {\n      console.error('Failed to add custom provider:', err);\n    } finally {\n      setIsSaving(false);\n    }\n  };\n\n  const handleRemoveCustomProvider = async (name: string) => {\n    const confirmed = await ask(`Are you sure you want to delete the custom provider \"${name}\"?`, {\n      title: 'Delete Provider',\n      kind: 'warning',\n    });\n\n    if (!confirmed) return;\n\n    setIsSaving(true);\n    try {\n      // Wipe API key from keychain first\n      try {\n        await api.removeApiKey(name);\n      } catch (keyErr) {\n        console.warn(`Failed to remove API key for ${name}:`, keyErr);\n      }\n\n      const updatedCustomProviders = { ...(config?.custom_providers || {}) };\n      delete updatedCustomProviders[name];\n\n      const updatedAvailableModels = { ...(config?.available_models || {}) };\n      delete updatedAvailableModels[name];\n\n      await api.updateConfig({\n        custom_providers: updatedCustomProviders,\n        available_models: updatedAvailableModels\n      });\n      await queryClient.invalidateQueries({ queryKey: ['config'] });\n      await queryClient.invalidateQueries({ queryKey: ['apiKeys'] });\n      if (editingProvider === name) {\n        setEditingProvider(cloudProviders[0] || 'openai');\n      }\n      triggerSuccess();\n    } catch (err) {\n      console.error('Failed to remove custom provider:', err);\n    } finally {\n      setIsSaving(false);\n    }\n  };\n\n  const handleAddModel = async () => {\n    if (!editingProvider || !editingCapability || !newModelName.trim()) return;\n\n    const modelToAdd = newModelName.trim();\n    if (currentModels.includes(modelToAdd)) return;\n\n    const updatedModels = [...currentModels, modelToAdd];\n    const updatedAvailableModels = {\n      ...availableModels,\n      [editingProvider]: {\n        ...(availableModels[editingProvider] || {}),\n        [editingCapability]: updatedModels\n      }\n    };\n\n    const updates: any = { available_models: updatedAvailableModels };\n\n    // If this is the first model for this provider, and it's the default provider, set it as default model\n    if (editingProvider === config?.inference?.chat?.provider && editingCapability === 'chat' && currentModels.length === 0) {\n      updates.inference = {\n        ...config.inference,\n        chat: {\n          ...config.inference.chat,\n          model: modelToAdd\n        }\n      };\n    }\n\n    setIsSaving(true);\n    try {\n      await api.updateConfig(updates);\n      setNewModelName('');\n      await refetchConfig();\n      triggerSuccess();\n    } catch (err) {\n      console.error('Failed to add model:', err);\n    } finally {\n      setIsSaving(false);\n    }\n  };\n\n  const handleRemoveModel = async (modelName: string) => {\n    if (!editingProvider || !editingCapability) return;\n    const updatedModels = currentModels.filter(m => m !== modelName);\n    const updatedAvailableModels = {\n      ...availableModels,\n      [editingProvider]: {\n        ...(availableModels[editingProvider] || {}),\n        [editingCapability]: updatedModels\n      }\n    };\n\n    const updates: any = { available_models: updatedAvailableModels };\n\n    // If we removed the top model, or changed the list, and this is the default provider, update the default model\n    if (editingProvider === config?.inference?.chat?.provider && editingCapability === 'chat' && updatedModels.length > 0) {\n      if (updatedModels[0] !== currentModels[0]) {\n        updates.inference = {\n          ...config.inference,\n          chat: {\n            ...config.inference.chat,\n            model: updatedModels[0]\n          }\n        };\n      }\n    }\n\n    setIsSaving(true);\n    try {\n      await api.updateConfig(updates);\n      await refetchConfig();\n      triggerSuccess();\n    } catch (err) {\n      console.error('Failed to remove model:', err);\n    } finally {\n      setIsSaving(false);\n    }\n  };\n\n  const saveModelOrder = async (newModels: string[]) => {\n    if (!editingProvider || !editingCapability) return;\n\n    const updatedAvailableModels = {\n      ...availableModels,\n      [editingProvider]: {\n        ...(availableModels[editingProvider] || {}),\n        [editingCapability]: newModels\n      }\n    };\n\n    const updates: any = { available_models: updatedAvailableModels };\n\n    // If we moved something to the top, and this is the default provider, update the default model\n    if (editingProvider === config?.inference?.chat?.provider && editingCapability === 'chat') {\n      updates.inference = {\n        ...config.inference,\n        chat: {\n          ...config.inference.chat,\n          model: newModels[0]\n        }\n      };\n    }\n\n    setIsSaving(true);\n    try {\n      await api.updateConfig(updates);\n      await refetchConfig();\n      triggerSuccess();\n    } catch (err) {\n      console.error('Failed to update model order:', err);\n    } finally {\n      setIsSaving(false);\n    }\n  };\n\n  const handleMoveModel = async (modelName: string, direction: 'up' | 'down') => {\n    if (!editingProvider || !editingCapability) return;\n\n    const index = currentModels.indexOf(modelName);\n    if (index === -1) return;\n    if (direction === 'up' && index === 0) return;\n    if (direction === 'down' && index === currentModels.length - 1) return;\n\n    const newModels = [...currentModels];\n    const targetIndex = direction === 'up' ? index - 1 : index + 1;\n    [newModels[index], newModels[targetIndex]] = [newModels[targetIndex], newModels[index]];\n\n    await saveModelOrder(newModels);\n  };\n\n  // Pointer-based drag handlers (works in Tauri)\n  const handlePointerDown = useCallback((e: React.PointerEvent, index: number) => {\n    e.preventDefault();\n    setIsDragging(true);\n    setDragSourceIndex(index);\n    setDragTargetIndex(index);\n    (e.target as HTMLElement).setPointerCapture(e.pointerId);\n  }, []);\n\n  const handlePointerMove = useCallback((e: React.PointerEvent) => {\n    if (!isDragging || dragSourceIndex === null || !containerRef.current) return;\n\n    const containerRect = containerRef.current.getBoundingClientRect();\n    const y = e.clientY - containerRect.top;\n\n    // Find which item we're over\n    let newTargetIndex = dragSourceIndex;\n    for (let i = 0; i < itemRefs.current.length; i++) {\n      const item = itemRefs.current[i];\n      if (!item) continue;\n      const rect = item.getBoundingClientRect();\n      const itemY = rect.top - containerRect.top + rect.height / 2;\n      if (y < itemY) {\n        newTargetIndex = i;\n        break;\n      }\n      newTargetIndex = i + 1;\n    }\n    newTargetIndex = Math.max(0, Math.min(newTargetIndex, currentModels.length - 1));\n\n    if (newTargetIndex !== dragTargetIndex) {\n      setDragTargetIndex(newTargetIndex);\n    }\n  }, [isDragging, dragSourceIndex, dragTargetIndex, currentModels.length]);\n\n  const handlePointerUp = useCallback(async (e: React.PointerEvent) => {\n    if (!isDragging) return;\n    (e.target as HTMLElement).releasePointerCapture(e.pointerId);\n\n    const sourceIndex = dragSourceIndex;\n    const targetIndex = dragTargetIndex;\n\n    setIsDragging(false);\n    setDragSourceIndex(null);\n    setDragTargetIndex(null);\n\n    if (sourceIndex === null || targetIndex === null || sourceIndex === targetIndex) return;\n\n    const newModels = [...currentModels];\n    const [removed] = newModels.splice(sourceIndex, 1);\n    newModels.splice(targetIndex, 0, removed);\n\n    await saveModelOrder(newModels);\n  }, [isDragging, dragSourceIndex, dragTargetIndex, currentModels, saveModelOrder]);\n\n  const handleUpdateTheme = async (newTheme: string) => {\n    setTheme(newTheme);\n    try {\n      await api.updateConfig({ ui: { theme: newTheme } });\n      localStorage.setItem('pa_theme', newTheme);\n      if (newTheme === 'default') {\n        document.documentElement.removeAttribute('data-theme');\n      } else {\n        document.documentElement.setAttribute('data-theme', newTheme);\n      }\n      await refetchConfig();\n      triggerSuccess();\n    } catch (err) {\n      console.error('Failed to update theme:', err);\n    }\n  };\n\n  const handleToggleAutoCompaction = async () => {\n    try {\n      const current = config?.agent?.auto_compaction_enabled !== false; // Default to true if undefined\n      await api.updateConfig({ agent: { auto_compaction_enabled: !current } });\n      await refetchConfig();\n      triggerSuccess();\n    } catch (err) {\n      console.error('Failed to toggle auto-compaction:', err);\n    }\n  };\n\n  const handleSetApiKey = async () => {\n    if (!newKey.provider || !newKey.key) return;\n    setIsSaving(true);\n    try {\n      await api.setApiKey(newKey.provider, newKey.key);\n      setNewKey({ provider: '', key: '' });\n      await queryClient.invalidateQueries({ queryKey: ['apiKeys'] });\n      triggerSuccess();\n    } catch (err) {\n      console.error('Failed to set API key:', err);\n    } finally {\n      setIsSaving(false);\n    }\n  };\n\n  const handleSaveCustomBaseUrl = async () => {\n    if (!customBaseUrl.trim() || !editingProvider) return;\n    setIsSaving(true);\n    try {\n      const updatedCustomProviders = {\n        ...(config?.custom_providers || {}),\n        [editingProvider]: { base_url: customBaseUrl.trim() }\n      };\n      await api.updateConfig({ custom_providers: updatedCustomProviders });\n      await queryClient.invalidateQueries({ queryKey: ['config'] });\n      triggerSuccess();\n    } catch (err) {\n      console.error('Failed to update custom provider base URL:', err);\n    } finally {\n      setIsSaving(false);\n    }\n  };\n\n  const handleRemoveApiKey = async (provider: string) => {\n    const confirmed = await ask(`Are you sure you want to wipe the API key for ${provider.toUpperCase()}? This will prevent agents from using this provider until a new key is registered.`, {\n      title: 'Wipe API Key',\n      kind: 'warning',\n    });\n\n    if (!confirmed) return;\n\n    try {\n      await api.removeApiKey(provider);\n      await queryClient.invalidateQueries({ queryKey: ['apiKeys'] });\n    } catch (err) {\n      console.error('Failed to remove API key:', err);\n    }\n  };\n\n  const handleToggleProvider = async (provider: string, currentEnabled: boolean) => {\n    setIsSaving(true);\n    try {\n      const updatedProviders = {\n        ...(config?.providers || {}),\n        [provider]: { enabled: !currentEnabled }\n      };\n      await api.updateConfig({ providers: updatedProviders });\n      await queryClient.invalidateQueries({ queryKey: ['config'] });\n      await queryClient.invalidateQueries({ queryKey: ['apiKeys'] });\n      triggerSuccess();\n    } catch (err) {\n      console.error('Failed to toggle provider:', err);\n    } finally {\n      setIsSaving(false);\n    }\n  };\n\n  const handleSetVaultSecret = async () => {\n    if (!newVaultSecret.name || !newVaultSecret.value) return;\n    setIsSaving(true);\n    try {\n      await api.setVaultSecret(newVaultSecret.name, newVaultSecret.value);\n      setNewVaultSecret({ name: '', value: '' });\n      await refetchVault();\n      triggerSuccess();\n    } catch (err) {\n      console.error('Failed to set vault secret:', err);\n    } finally {\n      setIsSaving(false);\n    }\n  };\n\n  const handleRemoveVaultSecret = async (name: string) => {\n    const confirmed = await ask(`Are you sure you want to delete the secret \"${name}\"? This cannot be undone.`, {\n      title: 'Delete Secret',\n      kind: 'warning',\n    });\n\n    if (!confirmed) return;\n\n    try {\n      await api.removeVaultSecret(name);\n      refetchVault();\n    } catch (err) {\n      console.error('Failed to remove vault secret:', err);\n    }\n  };\n\n  const themes = [\n    { id: 'default', name: 'Matrix Dark', colors: 'bg-[#181c21]', accent: 'bg-[#22d3ee]' },\n    { id: 'light', name: 'Paper White', colors: 'bg-[#f2f2f2]', accent: 'bg-[#2563eb]' },\n    { id: 'cobalt2', name: 'Cobalt2', colors: 'bg-[#193549]', accent: 'bg-[#ffc600]' },\n    { id: 'nerv', name: 'NERV HQ', colors: 'bg-[#1c1c1c]', accent: 'bg-[#ff9500]' },\n  ];\n\n  return (\n    <div className=\"flex h-full bg-background font-mono text-[13px] overflow-hidden\">\n      {/* Main Content Area */}\n      <div className=\"flex-1 flex flex-col min-w-0 bg-background relative\">\n        <div className=\"flex-1 overflow-auto p-8 custom-scrollbar relative\" ref={scrollRef}>\n          <div className=\"max-w-4xl mx-auto pb-20\">\n            {activeTab === 'models' && (\n              <div className=\"space-y-8 animate-in fade-in slide-in-from-bottom-2 duration-300 font-mono\">\n                {/* Model Registry Section */}\n                <section className=\"space-y-3\">\n                  <div className=\"flex flex-col gap-0.5\">\n                    <div className=\"flex items-center gap-2 text-accent/80\">\n                      <h2 className=\"text-[12px] font-black uppercase tracking-[0.2em]\">Provider Configuration</h2>\n                    </div>\n                    <p className=\"text-[10px] text-text-tertiary/60 italic leading-normal font-black tracking-tight\">\n                      LLM providers and endpoints. Credentials stored in system keychain.\n                    </p>\n                  </div>\n\n                  <div className=\"flex flex-col md:flex-row bg-surface/5 border border-border/10 overflow-hidden min-h-[450px]\">\n                    {/* Left Sidebar: Providers */}\n                    <div className=\"w-full md:w-48 border-b md:border-b-0 md:border-r border-border/10 bg-background/20 flex flex-col font-mono\">\n                      <div className=\"p-3 border-b border-border/10 bg-background/10\">\n                        <span className=\"text-[10px] font-black text-accent/60 uppercase tracking-[0.2em]\">Index</span>\n                      </div>\n                      <div className=\"flex-1 overflow-auto p-1.5 space-y-0.5 custom-scrollbar\">\n                        <div className=\"px-2 pb-1\">\n                          <span className=\"text-[8px] font-black text-text-tertiary/30 uppercase tracking-widest\">Cloud</span>\n                        </div>\n                        {cloudProviders.map(p => {\n                          const providerData = apiKeys?.find(k => k.provider.toLowerCase() === p.toLowerCase());\n                          const isConfigured = providerData?.configured;\n                          const isEnabled = providerData?.enabled === true;\n                          return (\n                            <button\n                              key={p}\n                              onClick={() => {\n                                setEditingProvider(p);\n                                setNewKey(prev => ({ ...prev, provider: p }));\n                              }}\n                              className={clsx(\n                                \"w-full px-2 py-1 text-left text-[11px] font-black uppercase transition-all flex items-center justify-between\",\n                                editingProvider === p\n                                  ? \"text-accent\"\n                                  : \"text-text-tertiary/60 hover:text-text-secondary hover:translate-x-0.5\",\n                                !isEnabled && \"opacity-40\"\n                              )}\n                            >\n                              <div className=\"flex items-center gap-2\">\n                                <span className=\"w-2\">{editingProvider === p ? '>' : ' '}</span>\n                                <span className=\"truncate\">{p}</span>\n                              </div>\n                              <div className={clsx(\n                                \"w-1 h-1 rounded-full\",\n                                isConfigured ? \"bg-status-success animate-pulse\" : \"bg-status-error/40\"\n                              )} />\n                            </button>\n                          );\n                        })}\n\n                        <div className=\"pt-4 mt-2\">\n                          <div className=\"px-2 pb-1 flex items-center justify-between\">\n                            <span className=\"text-[8px] font-black text-text-tertiary/30 uppercase tracking-widest\">Custom</span>\n                            <button\n                              onClick={() => setIsAddingCustomProvider(true)}\n                              className=\"text-accent/60 hover:text-accent transition-colors text-[10px]\"\n                            >\n                              [+]\n                            </button>\n                          </div>\n\n                          {isAddingCustomProvider && (\n                            <div className=\"px-1.5 py-1 space-y-1\">\n                              <input\n                                autoFocus\n                                type=\"text\"\n                                placeholder=\"NAME...\"\n                                value={newCustomProviderName}\n                                onChange={(e) => setNewCustomProviderName(e.target.value.toLowerCase().replace(/[^a-z0-9_-]/g, ''))}\n                                onKeyDown={(e) => {\n                                  if (e.key === 'Enter') handleAddCustomProvider();\n                                  if (e.key === 'Escape') setIsAddingCustomProvider(false);\n                                }}\n                                className=\"w-full bg-transparent border-b border-accent/20 px-1 py-0.5 text-[10px] text-text-primary focus:outline-none font-mono uppercase\"\n                              />\n                              <div className=\"flex gap-1\">\n                                  <button\n                                    onClick={handleAddCustomProvider}\n                                    className=\"flex-1 py-0.5 text-accent text-[9px] font-black border border-accent/20 hover:bg-accent/5\"\n                                  >\n                                    Add\n                                  </button>\n                                  <button\n                                    onClick={() => setIsAddingCustomProvider(false)}\n                                    className=\"flex-1 py-0.5 text-text-tertiary/60 text-[9px] font-black border border-border/10 hover:bg-surface/10\"\n                                  >\n                                    Cancel\n                                  </button>\n                              </div>\n                            </div>\n                          )}\n\n                          {userCustomProvidersList.map(p => {\n                            const providerData = apiKeys?.find(k => k.provider.toLowerCase() === p.toLowerCase());\n                            const isConfigured = providerData?.configured;\n                            const isEnabled = providerData?.enabled === true;\n                            return (\n                              <button\n                                key={p}\n                                onClick={() => {\n                                  setEditingProvider(p);\n                                  setNewKey(prev => ({ ...prev, provider: p }));\n                                }}\n                                className={clsx(\n                                  \"w-full px-2 py-1 text-left text-[11px] font-black uppercase transition-all flex items-center justify-between\",\n                                  editingProvider === p\n                                    ? \"text-accent\"\n                                    : \"text-text-tertiary/60 hover:text-text-secondary hover:translate-x-0.5\",\n                                  !isEnabled && \"opacity-40\"\n                                )}\n                              >\n                                <div className=\"flex items-center gap-2\">\n                                  <span className=\"w-2\">{editingProvider === p ? '>' : ' '}</span>\n                                  <span className=\"truncate\">{p}</span>\n                                </div>\n                                <div className={clsx(\n                                  \"w-1 h-1 rounded-full\",\n                                  isConfigured ? \"bg-status-success animate-pulse\" : \"bg-status-error/40\"\n                                )} />\n                              </button>\n                            );\n                          })}\n                        </div>\n\n                        <div className=\"pt-4 mt-2\">\n                          <div className=\"px-2 pb-1\">\n                            <span className=\"text-[8px] font-black text-text-tertiary/30 uppercase tracking-widest\">Local</span>\n                          </div>\n\n                          <div className=\"space-y-0.5\">\n                            {localProviders.map(p => {\n                              const isEnabled = apiKeys?.find(k => k.provider.toLowerCase() === p.toLowerCase())?.enabled === true;\n                              return (\n                                <button\n                                  key={p}\n                                  onClick={() => {\n                                    setNewKey(prev => ({ ...prev, provider: p }));\n                                    setEditingProvider(p);\n                                  }}\n                                  className={clsx(\n                                    \"w-full px-2 py-1 text-left text-[11px] font-black uppercase transition-all flex items-center justify-between\",\n                                    editingProvider === p\n                                      ? \"text-accent\"\n                                      : \"text-text-tertiary/60 hover:text-text-secondary hover:translate-x-0.5\",\n                                    !isEnabled && \"opacity-40\"\n                                  )}\n                                >\n                                  <div className=\"flex items-center gap-2\">\n                                    <span className=\"w-2\">{editingProvider === p ? '>' : ' '}</span>\n                                    <span className=\"truncate\">{p}</span>\n                                  </div>\n                                  <div className=\"w-1 h-1 rounded-full bg-status-success animate-pulse\" />\n                                </button>\n                              );\n                            })}\n                          </div>\n                        </div>\n                      </div>\n                    </div>\n\n                    {/* Right Panel: Skills and Models */}\n                    <div className=\"flex-1 flex flex-col bg-background/5 font-mono\">\n                      {!editingProvider ? (\n                        <div className=\"flex-1 flex flex-col items-center justify-center text-text-tertiary/20 space-y-2\">\n                          <span className=\"text-[10px] uppercase font-black tracking-[0.2em]\">Select a provider</span>\n                          <div className=\"animate-pulse\">_</div>\n                        </div>\n                      ) : (\n                        <div className=\"flex-1 overflow-auto p-5 space-y-8 custom-scrollbar\">\n                          {/* Provider Header & API Key Management */}\n                          <div className=\"space-y-4\">\n                            <div className=\"flex items-center justify-between border-b border-border/10 pb-3\">\n                              <div className=\"flex items-center gap-3\">\n                                <span className=\"text-[13px] font-black text-text-primary uppercase tracking-[0.1em]\">\n                                  {editingProvider}\n                                </span>\n                              </div>\n\n                              <div className=\"flex items-center gap-2\">\n                                {(() => {\n                                  const providerData = apiKeys?.find(k => k.provider.toLowerCase() === editingProvider.toLowerCase());\n                                  const isEnabled = providerData?.enabled === true;\n\n                                  return (\n                                    <button\n                                      onClick={() => handleToggleProvider(editingProvider, isEnabled)}\n                                      className={clsx(\n                                        \"text-[9px] font-black px-2 py-0.5 transition-all tracking-widest uppercase border active:scale-95\",\n                                        isEnabled\n                                          ? \"text-status-success border-status-success/20 hover:bg-status-success/5\"\n                                          : \"text-status-error border-status-error/20 hover:bg-status-error/5\"\n                                      )}\n                                    >\n                                      {isEnabled ? 'On' : 'Off'}\n                                    </button>\n                                  );\n                                })()}\n\n                                {userCustomProvidersList.includes(editingProvider) && (\n                                  <button\n                                    onClick={() => handleRemoveCustomProvider(editingProvider)}\n                                    className=\"text-[9px] text-text-tertiary/40 hover:text-status-error transition-all uppercase font-black px-2 py-0.5 border border-border/10 hover:bg-status-error/5 active:scale-95\"\n                                  >\n                                    Delete\n                                  </button>\n                                )}\n\n                                {apiKeys?.find(k => k.provider.toLowerCase() === editingProvider.toLowerCase())?.configured && !localProvidersList.includes(editingProvider.toLowerCase()) && (\n                                  <button\n                                    onClick={() => handleRemoveApiKey(editingProvider)}\n                                    className=\"text-[9px] text-text-tertiary/40 hover:text-status-error transition-all uppercase font-black px-2 py-0.5 border border-border/10 hover:bg-status-error/5 active:scale-95\"\n                                  >\n                                    Wipe Key\n                                  </button>\n                                )}\n                              </div>\n                            </div>\n\n                            {/* API Key Input */}\n                            {!localProvidersList.includes(editingProvider.toLowerCase()) ? (\n                              <div className=\"space-y-2\">\n                                <div className=\"flex flex-col gap-0.5\">\n                                  <div className=\"flex items-center gap-2\">\n                                    <span className=\"text-[9px] font-black text-text-tertiary/60 uppercase tracking-widest\">API Key</span>\n                                  </div>\n                                </div>\n                                <div className=\"flex flex-col sm:flex-row gap-2\">\n                                  <div className=\"flex-1 relative\">\n                                    <input\n                                      type=\"password\"\n                                      placeholder=\"Paste key...\"\n                                      value={newKey.key}\n                                      onChange={(e) => setNewKey(prev => ({ ...prev, key: e.target.value }))}\n                                      onKeyDown={(e) => e.key === 'Enter' && handleSetApiKey()}\n                                      className=\"w-full bg-transparent border-b border-border/10 px-0 py-1 text-[11px] text-text-primary focus:outline-none focus:border-accent/40 font-mono transition-all uppercase\"\n                                    />\n                                  </div>\n                                  <button\n                                    onClick={handleSetApiKey}\n                                    disabled={isSaving || !newKey.key}\n                                    className=\"px-3 py-1 text-accent hover:text-accent-hover font-black text-[10px] uppercase tracking-widest transition-all disabled:opacity-20\"\n                                  >\n                                    Register\n                                  </button>\n                                </div>\n                              </div>\n                            ) : (\n                              <div className=\"text-[9px] text-accent/40 font-black uppercase tracking-widest\">\n                                Local provider - no authentication required\n                              </div>\n                            )}\n                          </div>\n\n                          {userCustomProvidersList.includes(editingProvider) && (\n                            <div className=\"space-y-2\">\n                              <div className=\"flex flex-col gap-0.5\">\n                                <span className=\"text-[9px] font-black text-text-tertiary/60 uppercase tracking-widest\">Endpoint URL</span>\n                              </div>\n                              <div className=\"flex flex-col sm:flex-row gap-2\">\n                                <div className=\"flex-1 relative\">\n                                  <input\n                                    type=\"text\"\n                                    placeholder=\"https://api.provider.com/v1\"\n                                    value={customBaseUrl}\n                                    onChange={(e) => setCustomBaseUrl(e.target.value)}\n                                    onKeyDown={(e) => e.key === 'Enter' && handleSaveCustomBaseUrl()}\n                                    className=\"w-full bg-transparent border-b border-border/10 px-0 py-1 text-[11px] text-text-primary focus:outline-none focus:border-accent/40 font-mono transition-all\"\n                                  />\n                                </div>\n                                <button\n                                  onClick={handleSaveCustomBaseUrl}\n                                  disabled={isSaving || !customBaseUrl.trim()}\n                                  className=\"px-3 py-1 text-accent hover:text-accent-hover font-black text-[10px] uppercase tracking-widest transition-all disabled:opacity-20\"\n                                >\n                                  [SAVE]\n                                </button>\n                              </div>\n                            </div>\n                          )}\n\n                          {/* Model Registry Content */}\n                          <div className=\"space-y-6\">\n                            <div className=\"flex items-center justify-between\">\n                              <span className=\"text-[9px] font-black text-text-tertiary/60 uppercase tracking-widest\">Models</span>\n                              {localProvidersList.includes(editingProvider?.toLowerCase() || '') && (\n                                <button\n                                  onClick={() => editingProvider && handleFetchModels(editingProvider)}\n                                  disabled={isFetchingModels}\n                                  className={clsx(\n                                    \"text-[9px] font-black uppercase tracking-widest transition-all\",\n                                    isFetchingModels ? \"text-text-tertiary/20 animate-pulse\" : \"text-accent hover:text-accent-hover\"\n                                  )}\n                                >\n                                  {isFetchingModels ? 'Discovering...' : 'Discover local models'}\n                                </button>\n                              )}\n                            </div>\n\n                            {['chat'].map(cap => {\n                              const models = availableModels[editingProvider]?.[cap] || [];\n                              const isEditing = editingCapability === cap;\n\n                              const isOpenRouter = editingProvider?.toLowerCase() === 'openrouter';\n                              const supportsThinking = thinkingProviders.includes(editingProvider?.toLowerCase() || '');\n\n                              return (\n                                <div key={cap} className=\"space-y-1\">\n                                  {/* Column headers */}\n                                  {(supportsThinking || isOpenRouter) && models.length > 0 && (\n                                    <div className=\"flex items-center gap-2 px-2 py-1 border-b border-border/10\">\n                                      <div className=\"w-6\" /> {/* Spacer for drag handle */}\n                                      <span className=\"flex-1 text-[8px] font-black text-text-tertiary/40 uppercase tracking-widest\">MODEL NAME</span>\n                                      {isOpenRouter && (\n                                        <span className=\"text-[8px] font-black text-text-tertiary/40 uppercase tracking-widest w-24 text-right\">PRICING (INPUT/OUTPUT per 1M TOK)</span>\n                                      )}\n                                      {supportsThinking && (\n                                        <span className=\"text-[8px] font-black text-text-tertiary/40 uppercase tracking-widest w-20 text-right\">REASONING</span>\n                                      )}\n                                      <div className=\"w-6\" /> {/* Spacer for delete button */}\n                                    </div>\n                                  )}\n                                  <div\n                                    ref={containerRef}\n                                    className=\"flex flex-col gap-0.5 min-h-[50px]\"\n                                  >\n                                    {models.map((model, index) => {\n                                      const { baseModel, level } = parseModelLevel(model);\n                                      // Use baseModel for pricing lookup since pricing is stored by base model name\n                                      const pricing = isOpenRouter && config?.model_pricing?.['openrouter']?.[cap]?.[baseModel];\n\n                                      return (\n                                        <div\n                                          key={model}\n                                          ref={el => { itemRefs.current[index] = el; }}\n                                          className={clsx(\n                                            \"flex items-center justify-between px-2 py-1 border-b border-border/5 group transition-all relative select-none gap-2\",\n                                            isDragging && dragSourceIndex === index && \"opacity-50\",\n                                            isDragging && dragTargetIndex === index && dragSourceIndex !== index && \"border-t border-accent\"\n                                          )}\n                                        >\n                                          {/* Drag handle */}\n                                          <div\n                                            className=\"text-text-tertiary/20 hover:text-accent transition-all cursor-grab active:cursor-grabbing p-1 -m-1 touch-none shrink-0\"\n                                            onPointerDown={(e) => handlePointerDown(e, index)}\n                                            onPointerMove={handlePointerMove}\n                                            onPointerUp={handlePointerUp}\n                                            onPointerCancel={handlePointerUp}\n                                          >\n                                            <span className=\"text-[8px] font-black\">{index === 0 ? '@' : '#'}</span>\n                                          </div>\n\n                                          {/* Model name */}\n                                          <div className=\"flex-1 min-w-0\">\n                                            <span className={clsx(\n                                              \"text-[10px] transition-colors truncate font-mono uppercase block\",\n                                              index === 0 ? \"text-accent font-black\" : \"text-text-primary/60 group-hover:text-text-primary\"\n                                            )}>{baseModel}</span>\n                                          </div>\n\n                                          {/* Pricing column for OpenRouter */}\n                                          {isOpenRouter && (\n                                            <div className=\"text-[9px] text-text-tertiary/60 font-mono text-right shrink-0 w-24\">\n                                              {pricing ? (\n                                                <span>${pricing.prompt.toFixed(2)}/${pricing.completion.toFixed(2)}</span>\n                                              ) : (\n                                                <span className=\"text-text-tertiary/20\">—</span>\n                                              )}\n                                            </div>\n                                          )}\n\n                                          {/* Reasoning level dropdown */}\n                                          {supportsThinking && (\n                                            <select\n                                              value={level}\n                                              onChange={(e) => handleUpdateModelLevel(model, e.target.value as typeof level)}\n                                              className={clsx(\n                                                \"bg-transparent border px-1.5 py-0.5 text-[9px] font-black uppercase cursor-pointer transition-all shrink-0 w-20\",\n                                                level\n                                                  ? \"text-status-success border-status-success/30 bg-status-success/5\"\n                                                  : \"text-text-tertiary/50 border-border/20 hover:border-border/40\"\n                                              )}\n                                              style={{ WebkitAppearance: 'none', appearance: 'none', paddingRight: '16px', backgroundImage: 'url(\"data:image/svg+xml,%3csvg xmlns=%27http://www.w3.org/2000/svg%27 fill=%27none%27 viewBox=%270 0 24 24%27 stroke=%27%23666%27%3e%3cpath stroke-linecap=%27round%27 stroke-linejoin=%27round%27 stroke-width=%272%27 d=%27M19 9l-7 7-7-7%27/%3e%3c/svg%3e\")', backgroundRepeat: 'no-repeat', backgroundPosition: 'right 2px center', backgroundSize: '10px' }}\n                                            >\n                                              {reasoningLevels.map(l => (\n                                                <option key={l.value} value={l.value}>{l.label}</option>\n                                              ))}\n                                            </select>\n                                          )}\n\n                                          {/* Remove button */}\n                                          <button\n                                            onClick={(e) => {\n                                              e.stopPropagation();\n                                              setEditingCapability(cap);\n                                              handleRemoveModel(model);\n                                            }}\n                                            className=\"text-text-tertiary/20 hover:text-status-error opacity-0 group-hover:opacity-100 transition-all text-[10px] font-black shrink-0\"\n                                          >\n                                            [X]\n                                          </button>\n                                        </div>\n                                      );\n                                    })}\n\n                                    {/* Inline Add Model Input */}\n                                    <div className=\"flex gap-2 group/input mt-1\">\n                                      <div className=\"flex-1 relative\">\n                                        <input\n                                          type=\"text\"\n                                          placeholder=\"Add model...\"\n                                          value={isEditing ? newModelName : ''}\n                                          onFocus={() => setEditingCapability(cap)}\n                                          onChange={(e) => {\n                                            setEditingCapability(cap);\n                                            setNewModelName(e.target.value);\n                                          }}\n                                          onKeyDown={(e) => e.key === 'Enter' && handleAddModel()}\n                                          className=\"w-full bg-transparent border-b border-dashed border-border/20 px-0 py-0.5 text-[10px] text-text-primary placeholder:text-text-tertiary/20 focus:outline-none focus:border-accent/40 focus:border-solid font-mono transition-all uppercase\"\n                                        />\n                                      </div>\n                                      {isEditing && newModelName.trim() && (\n                                        <button\n                                          onClick={handleAddModel}\n                                          className=\"text-accent text-[10px] font-black\"\n                                        >\n                                          [+]\n                                        </button>\n                                      )}\n                                    </div>\n                                  </div>\n                                </div>\n                              );\n                            })}\n                          </div>\n                        </div>\n                      )}\n                    </div>\n                  </div>\n                </section>\n              </div>\n            )}\n\n            {activeTab === 'general' && (\n              <div className=\"space-y-12 animate-in fade-in slide-in-from-bottom-2 duration-300 font-mono\">\n                {/* Appearance Section */}\n                <section className=\"space-y-3\">\n                  <div className=\"flex flex-col gap-0.5\">\n                    <div className=\"flex items-center justify-between\">\n                      <div className=\"flex items-center gap-2 text-accent/80\">\n                        <h2 className=\"text-[12px] font-black uppercase tracking-[0.2em]\">Interface Theme</h2>\n                      </div>\n                    </div>\n                    <p className=\"text-[10px] text-text-tertiary/60 italic leading-normal font-black tracking-tight\">\n                      Visual styles update instantly across all sessions.\n                    </p>\n                  </div>\n                  <div className=\"grid grid-cols-2 sm:grid-cols-4 gap-2.5\">\n                    {themes.map((t) => (\n                      <button\n                        key={t.id}\n                        onClick={() => handleUpdateTheme(t.id)}\n                        className={clsx(\n                          \"group relative flex flex-col p-2 border transition-all text-left h-20 active:scale-[0.98]\",\n                          theme === t.id\n                            ? \"border-accent bg-accent/5 shadow-[0_0_15px_rgba(var(--accent),0.05)]\"\n                            : \"border-border/10 hover:border-accent/40 bg-surface/5\"\n                        )}\n                      >\n                        <div className={clsx(\"w-full flex-1 mb-1.5 border border-border/10 overflow-hidden relative opacity-60\", t.colors)}>\n                          <div className=\"absolute top-0 left-0 w-full h-1 bg-surface/20 border-b border-border/10\" />\n                          <div className={clsx(\"absolute bottom-1 right-1 w-2 h-2 rounded-full\", t.accent)} />\n                        </div>\n                        <div className=\"flex items-center justify-between font-mono\">\n                          <span className={clsx(\n                            \"text-[10px] font-black uppercase tracking-widest\",\n                            theme === t.id ? \"text-accent\" : \"text-text-tertiary/60 group-hover:text-text-secondary\"\n                          )}>\n                            {theme === t.id ? `[${t.name}]` : `  ${t.name}`}\n                          </span>\n                        </div>\n                      </button>\n                    ))}\n                  </div>\n                </section>\n\n                <div className=\"grid grid-cols-1 gap-12\">\n                  {/* Agent Behavior Section */}\n                  <section className=\"space-y-3\">\n                    <div className=\"flex flex-col gap-0.5\">\n                      <div className=\"flex items-center gap-2 text-accent/80\">\n                        <h2 className=\"text-[12px] font-black uppercase tracking-[0.2em]\">Behavior</h2>\n                      </div>\n                      <p className=\"text-[10px] text-text-tertiary/60 italic leading-normal font-black tracking-tight\">\n                        Global execution and memory policies.\n                      </p>\n                    </div>\n\n                    <div className=\"bg-surface/5 border border-border/10 p-4 space-y-3 font-mono\">\n                      <div className=\"flex items-center justify-between border-b border-border/5 pb-3\">\n                        <div className=\"flex flex-col gap-0.5\">\n                          <div className=\"flex items-center gap-2\">\n                            <span className=\"text-[11px] font-black text-text-primary uppercase tracking-[0.2em]\">Auto-compaction</span>\n                          </div>\n                          <p className=\"text-[10px] text-text-tertiary/60 italic px-3 leading-normal font-black tracking-tight\">\n                            Reduce token overhead automatically at threshold.\n                          </p>\n                        </div>\n                        <button\n                          onClick={handleToggleAutoCompaction}\n                          className={clsx(\n                            \"text-[10px] font-black px-2 py-1 transition-all tracking-widest uppercase active:scale-95\",\n                            config?.agent?.auto_compaction_enabled !== false\n                              ? \"text-status-success hover:bg-status-success/5\"\n                              : \"text-status-error hover:bg-status-error/5\"\n                          )}\n                        >\n                          {config?.agent?.auto_compaction_enabled !== false ? 'Active' : 'Inactive'}\n                        </button>\n                      </div>\n                    </div>\n                  </section>\n\n                  {/* Sub-Agent Ecosystem */}\n                  <section className=\"space-y-4\">\n                    <div className=\"flex flex-col gap-0.5\">\n                      <div className=\"flex items-center justify-between\">\n                        <div className=\"flex items-center gap-2 text-accent/80\">\n                          <h2 className=\"text-[12px] font-black uppercase tracking-[0.2em]\">Sub-agents</h2>\n                        </div>\n                        <button\n                          onClick={handleToggleSubAgentsGlobal}\n                          className={clsx(\n                            \"text-[10px] font-black px-2 py-0.5 transition-all tracking-widest uppercase border active:scale-95 font-mono\",\n                            config?.sub_agent?.enabled\n                              ? \"text-status-success border-status-success/20 hover:bg-status-success/5\"\n                              : \"text-status-error border-status-error/20 hover:bg-status-error/5\"\n                          )}\n                        >\n                          {config?.sub_agent?.enabled ? 'Enabled' : 'Disabled'}\n                        </button>\n                      </div>\n                      <p className=\"text-[10px] text-text-tertiary/60 italic leading-normal font-black tracking-tight\">\n                        Autonomous child-agents for specialized task processing.\n                      </p>\n                    </div>\n\n                    <div className={clsx(\n                      \"flex flex-col gap-4 transition-opacity duration-300 font-mono\",\n                      !config?.sub_agent?.enabled && \"opacity-30 pointer-events-none grayscale\"\n                    )}>\n                      {/* Configuration Controls */}\n                      <div className=\"flex flex-col gap-4\">\n\n\n                        <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                          {/* Claude Code */}\n                          <div className=\"bg-surface/5 border border-border/10 p-4 space-y-3\">\n                            <div className=\"flex items-center justify-between\">\n                              <div className=\"flex items-center gap-2\">\n                                <span className=\"text-[11px] font-black uppercase tracking-widest text-text-primary\">Claude Code</span>\n                                {status?.components?.claude === 'ok' && status?.auth?.claude?.startsWith('ok') && (\n                                  <span className=\"text-[8px] font-black text-status-success uppercase\">Ready</span>\n                                )}\n                              </div>\n                              <button\n                                onClick={() => handleToggleCLIEnabled('claude_code')}\n                                className={clsx(\n                                  \"text-[9px] font-black px-1.5 py-0.5 transition-all border active:scale-95\",\n                                  config?.sub_agent?.claude_code?.enabled\n                                    ? \"text-status-success border-status-success/20 hover:bg-status-success/5\"\n                                    : \"text-text-tertiary/40 border-border/10 hover:text-text-secondary\"\n                                )}\n                              >\n                                {config?.sub_agent?.claude_code?.enabled ? 'On' : 'Off'}\n                              </button>\n                            </div>\n\n                            <div className=\"space-y-3\">\n                              <div className=\"space-y-1\">\n                                <label className=\"text-[9px] font-black text-text-tertiary/40 uppercase tracking-widest ml-1\">Tools</label>\n                                <input\n                                  type=\"text\"\n                                  defaultValue={config?.sub_agent?.claude_code?.allowed_tools?.join(', ')}\n                                  onBlur={(e) => handleUpdateClaudeTools(e.target.value)}\n                                  placeholder=\"Edit, Bash, Read...\"\n                                  className=\"w-full bg-transparent border-b border-border/10 px-0 py-1 text-[10px] text-text-primary focus:outline-none focus:border-accent/40 font-mono transition-all uppercase\"\n                                />\n                              </div>\n                            </div>\n                          </div>\n\n                          {/* Codex */}\n                          <div className=\"bg-surface/5 border border-border/10 p-4 space-y-3\">\n                            <div className=\"flex items-center justify-between\">\n                              <div className=\"flex items-center gap-2\">\n                                <span className=\"text-[11px] font-black uppercase tracking-widest text-text-primary\">Codex</span>\n                                {status?.components?.codex === 'ok' && status?.auth?.codex?.startsWith('ok') && (\n                                  <span className=\"text-[8px] font-black text-status-success uppercase\">Ready</span>\n                                )}\n                              </div>\n                              <button\n                                onClick={() => handleToggleCLIEnabled('codex')}\n                                className={clsx(\n                                  \"text-[9px] font-black px-1.5 py-0.5 transition-all border active:scale-95\",\n                                  config?.sub_agent?.codex?.enabled\n                                    ? \"text-status-success border-status-success/20 hover:bg-status-success/5\"\n                                    : \"text-text-tertiary/40 border-border/10 hover:text-text-secondary\"\n                                )}\n                              >\n                                {config?.sub_agent?.codex?.enabled ? 'On' : 'Off'}\n                              </button>\n                            </div>\n\n                            <div className=\"space-y-3\">\n                              <div className=\"space-y-1\">\n                                <label className=\"text-[9px] font-black text-text-tertiary/40 uppercase tracking-widest ml-1\">Approval</label>\n                                <div className=\"flex gap-1\">\n                                  {['untrusted', 'on-failure', 'on-request', 'never'].map((mode) => (\n                                    <button\n                                      key={mode}\n                                      onClick={() => handleUpdateCodexMode(mode)}\n                                      className={clsx(\n                                        \"flex-1 py-1 text-[8px] font-black uppercase border transition-all active:scale-95\",\n                                        config?.sub_agent?.codex?.approval_mode?.toLowerCase() === mode.toLowerCase()\n                                          ? \"text-accent border-accent/40 bg-accent/5\"\n                                          : \"border-border/10 text-text-tertiary/40 hover:text-text-secondary hover:bg-surface/5\"\n                                      )}\n                                    >\n                                      {config?.sub_agent?.codex?.approval_mode?.toLowerCase() === mode.toLowerCase() \n                                        ? `[${mode.toUpperCase().replace('-', '_')}]` \n                                        : mode.toUpperCase().replace('-', '_')}\n                                    </button>\n                                  ))}\n                                </div>\n                              </div>\n                            </div>\n                          </div>\n                        </div>\n                      </div>\n                    </div>\n                  </section>\n                </div>\n              </div>\n            )\n            }\n\n            {activeTab === 'security' && (\n              <div className=\"space-y-12 animate-in fade-in slide-in-from-bottom-2 duration-300 font-mono\">\n                {/* Unrestricted Execution Mode Toggle */}\n                <div className={clsx(\n                  \"p-4 border transition-all duration-500\",\n                  config?.security?.always_allow_all\n                    ? \"bg-status-error text-background border-status-error shadow-[0_0_25px_rgba(var(--status-error),0.2)]\"\n                    : \"bg-status-error/5 border-status-error/10\"\n                )}>\n                  <div className=\"flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4\">\n                    <div className=\"flex flex-col gap-1 pr-4\">\n                      <div className=\"flex items-center gap-2\">\n                        <span className={clsx(\n                          \"text-[11px] font-black uppercase tracking-[0.2em]\",\n                          config?.security?.always_allow_all ? \"text-background\" : \"text-status-error\"\n                        )}>Unrestricted Execution</span>\n                        {config?.security?.always_allow_all && (\n                          <span className=\"text-[8px] font-black bg-background text-status-error px-1 py-0.5 animate-pulse tracking-widest\">System unlocked</span>\n                        )}\n                      </div>\n                      <p className={clsx(\n                        \"text-[9px] italic leading-relaxed max-w-2xl font-black uppercase tracking-tight\",\n                        config?.security?.always_allow_all ? \"text-background/90\" : \"text-text-tertiary/60\"\n                      )}>\n                        Bypass all security checks. Agents gain full unmonitored system access. Use only in trusted environments.\n                      </p>\n                    </div>\n                    <button\n                      onClick={handleToggleAlwaysAllowAll}\n                      className={clsx(\n                        \"text-[9px] font-black px-3 py-1.5 transition-all tracking-[0.1em] uppercase border whitespace-nowrap active:scale-95\",\n                        config?.security?.always_allow_all\n                          ? \"bg-background text-status-error border-background\"\n                          : \"bg-status-error text-background border-status-error\"\n                      )}\n                    >\n                      {config?.security?.always_allow_all ? 'Restore Security' : 'Disable Security'}\n                    </button>\n                  </div>\n                </div>\n\n                {/* Shell Execution Policy */}\n                <section className={clsx(\n                  \"space-y-3 transition-all duration-300\",\n                  config?.security?.always_allow_all && \"opacity-40 grayscale\"\n                )}>\n                  <div className=\"flex flex-col gap-0.5\">\n                    <div className=\"flex items-center justify-between\">\n                      <div className=\"flex items-center gap-2 text-accent/80\">\n                        <h2 className=\"text-[12px] font-black uppercase tracking-[0.2em]\">Shell Policy</h2>\n                      </div>\n                      {config?.security?.always_allow_all && (\n                        <span className=\"text-[8px] font-black text-status-error uppercase tracking-widest bg-status-error/10 px-1.5 py-0.5\">\n                          Overridden by unrestricted mode\n                        </span>\n                      )}\n                    </div>\n                    <p className=\"text-[10px] text-text-tertiary/60 italic leading-normal font-black tracking-tight\">\n                      Control auto-approval levels for terminal commands.\n                    </p>\n                  </div>\n\n                  <div className={clsx(\n                    \"bg-surface/5 border border-border/10 p-5 space-y-4\",\n                    config?.security?.always_allow_all && \"pointer-events-none\"\n                  )}>\n                    <div className=\"flex flex-col gap-0.5\">\n                      <span className=\"text-[11px] font-black text-text-primary uppercase tracking-[0.2em]\">Execution Mode</span>\n                    </div>\n\n                    <div className=\"grid grid-cols-2 sm:grid-cols-4 gap-2\">\n                      {[\n                        { id: 'restricted', label: 'RESTRICTED', desc: 'Minimal safe set' },\n                        { id: 'read-only', label: 'READ_ONLY', desc: 'All inspections' },\n                        { id: 'non-destructive', label: 'MUTABLE', desc: 'No deletions' },\n                        { id: 'unrestricted', label: 'OPEN', desc: 'No approvals' },\n                      ].map((mode) => (\n                        <button\n                          key={mode.id}\n                          onClick={() => handleUpdateShellPermissionMode(mode.id)}\n                          className={clsx(\n                            \"flex flex-col items-start p-3 border transition-all text-left group active:scale-[0.98]\",\n                            config?.security?.shell_permission_mode === mode.id\n                              ? \"border-accent bg-accent/5 shadow-[0_0_15px_rgba(var(--accent),0.05)]\"\n                              : \"border-border/10 hover:border-accent/40 bg-surface/5\"\n                          )}\n                        >\n                          <span className={clsx(\n                            \"text-[10px] font-black uppercase tracking-widest mb-1\",\n                            config?.security?.shell_permission_mode === mode.id ? \"text-accent\" : \"text-text-tertiary/60 group-hover:text-text-secondary\"\n                          )}>\n                            {config?.security?.shell_permission_mode === mode.id ? `[${mode.label}]` : `  ${mode.label}`}\n                          </span>\n                          <span className=\"text-[8px] text-text-tertiary/40 font-black uppercase leading-tight\">\n                            {mode.desc}\n                          </span>\n                        </button>\n                      ))}\n                    </div>\n                  </div>\n                </section>\n\n                {/* Vault Section */}\n                <section className=\"space-y-3\">\n                  <div className=\"flex flex-col gap-0.5\">\n                    <div className=\"flex items-center gap-2 text-accent/80\">\n                      <h2 className=\"text-[12px] font-black uppercase tracking-[0.2em]\">Secure Vault</h2>\n                    </div>\n                    <p className=\"text-[10px] text-text-tertiary/60 italic leading-normal font-black tracking-tight\">\n                      Protected tokens and environment variables.\n                    </p>\n                  </div>\n\n                  <div className=\"bg-surface/5 border border-border/10 p-5 space-y-6\">\n                    <div className=\"space-y-4\">\n                      <div className=\"flex flex-col gap-0.5\">\n                        <span className=\"text-[11px] font-black text-text-primary uppercase tracking-[0.2em]\">Vault Index</span>\n                        <p className=\"text-[10px] text-text-tertiary/60 italic px-3 font-black tracking-tight\">\n                          Access in tools via <code className=\"text-accent underline\">{\"{{vault:KEY}}\"}</code>.\n                        </p>\n                      </div>\n\n                      <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-2\">\n                        {vaultSecrets && vaultSecrets.length > 0 ? (\n                          vaultSecrets.map((secret: any) => (\n                            <div\n                              key={secret.name}\n                              className=\"flex items-center justify-between px-3 py-1.5 bg-background/20 border border-border/5 group hover:border-accent/20 transition-all\"\n                            >\n                              <div className=\"flex items-center gap-2\">\n                                <span className=\"text-[8px] font-black text-accent/40 uppercase\">[KEY]</span>\n                                <span className=\"text-[11px] font-black text-text-primary/70 font-mono truncate max-w-[120px]\">\n                                  {secret.name}\n                                </span>\n                              </div>\n                              <button\n                                onClick={() => handleRemoveVaultSecret(secret.name)}\n                                className=\"text-text-tertiary/20 hover:text-status-error opacity-0 group-hover:opacity-100 transition-all text-[10px] font-black\"\n                              >\n                                [X]\n                              </button>\n                            </div>\n                          ))\n                        ) : (\n                          <div className=\"col-span-full py-6 border border-dashed border-border/10 flex flex-col items-center justify-center text-text-tertiary/20\">\n                            <span className=\"text-[9px] uppercase font-black tracking-[0.2em]\">No secrets stored</span>\n                          </div>\n                        )}\n                      </div>\n\n                      {/* Add Secret Form */}\n                      <div className=\"mt-4 p-4 border-t border-border/5 space-y-3\">\n                        <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-4\">\n                          <div className=\"space-y-1\">\n                            <label className=\"text-[9px] font-black text-text-tertiary/40 uppercase tracking-widest ml-1\">Key</label>\n                            <input\n                              type=\"text\"\n                              placeholder=\"GITHUB_TOKEN\"\n                              value={newVaultSecret.name}\n                              onChange={(e) => setNewVaultSecret(prev => ({ ...prev, name: e.target.value.toUpperCase().replace(/[^A-Z0-9_]/g, '_') }))}\n                              className=\"w-full bg-transparent border-b border-border/10 px-0 py-1 text-[11px] text-text-primary focus:outline-none focus:border-accent/40 font-mono transition-all uppercase\"\n                            />\n                          </div>\n                          <div className=\"space-y-1\">\n                            <label className=\"text-[9px] font-black text-text-tertiary/40 uppercase tracking-widest ml-1\">Value</label>\n                            <input\n                              type=\"password\"\n                              placeholder=\"Secret value\"\n                              value={newVaultSecret.value}\n                              onChange={(e) => setNewVaultSecret(prev => ({ ...prev, value: e.target.value }))}\n                              className=\"w-full bg-transparent border-b border-border/10 px-0 py-1 text-[11px] text-text-primary focus:outline-none focus:border-accent/40 font-mono transition-all\"\n                            />\n                          </div>\n                        </div>\n                        <button\n                          onClick={handleSetVaultSecret}\n                          disabled={isSaving || !newVaultSecret.name || !newVaultSecret.value}\n                          className=\"w-full py-1 text-accent hover:text-accent-hover font-black text-[10px] uppercase tracking-widest transition-all disabled:opacity-20 active:scale-[0.98]\"\n                        >\n                          Store in Vault\n                        </button>\n                      </div>\n                    </div>\n                  </div>\n                </section>\n              </div>\n            )\n            }\n\n            {activeTab === 'shortcuts' && (\n              <div className=\"space-y-8 animate-in fade-in slide-in-from-bottom-2 duration-300 font-mono\">\n                {/* All Hotkeys Section */}\n                <section className=\"space-y-3\">\n                  <div className=\"flex flex-col gap-0.5\">\n                    <div className=\"flex items-center gap-2 text-accent/80\">\n                      <h2 className=\"text-[12px] font-black uppercase tracking-[0.2em]\">Shortcuts</h2>\n                    </div>\n                  </div>\n\n                  <div className=\"bg-surface/5 border border-border/10 p-5\">\n                    <div className=\"grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-1\">\n                      {Object.entries(hotkeyLabels).map(([key, label]) => (\n                        <div key={key} className=\"flex items-center justify-between py-1.5 border-b border-border/5 last:border-0 md:[&:nth-last-child(-n+2)]:border-0\">\n                          <span className=\"text-[10px] font-black text-text-tertiary/60 uppercase tracking-widest\">{label}</span>\n                          <button\n                            onClick={() => setRecordingHotkey(key)}\n                            className={clsx(\n                              \"font-mono text-[10px] font-black transition-all min-w-[90px] text-right\",\n                              recordingHotkey === key\n                                ? \"text-accent animate-pulse\"\n                                : \"text-accent/60 hover:text-accent\"\n                            )}\n                          >\n                            {recordingHotkey === key ? 'Recording...' : ((config?.ui as any)?.hotkeys?.[key] || hotkeyDefaults[key] || 'N/A')}\n                          </button>\n                        </div>\n                      ))}\n                    </div>\n                        <div className=\"mt-6 pt-3 border-t border-border/5\">\n                      <p className=\"text-[9px] text-text-tertiary/20 tracking-tighter italic font-black\">\n                        Press Escape to cancel. System reserved keys may override.\n                      </p>\n                    </div>\n                  </div>\n                </section>\n              </div>\n            )\n            }\n          </div >\n        </div >\n      </div >\n    </div >\n  );\n};\n","structuredPatch":[{"oldStart":1259,"oldLines":47,"newStart":1259,"newLines":6,"lines":[" ","             {activeTab === 'general' && (","               <div className=\"space-y-12 animate-in fade-in slide-in-from-bottom-2 duration-300 font-mono\">","-                {/* Appearance Section */}","-                <section className=\"space-y-3\">","-                  <div className=\"flex flex-col gap-0.5\">","-                    <div className=\"flex items-center justify-between\">","-                      <div className=\"flex items-center gap-2 text-accent/80\">","-                        <h2 className=\"text-[12px] font-black uppercase tracking-[0.2em]\">Interface Theme</h2>","-                      </div>","-                    </div>","-                    <p className=\"text-[10px] text-text-tertiary/60 italic leading-normal font-black tracking-tight\">","-                      Visual styles update instantly across all sessions.","-                    </p>","-                  </div>","-                  <div className=\"grid grid-cols-2 sm:grid-cols-4 gap-2.5\">","-                    {themes.map((t) => (","-                      <button","-                        key={t.id}","-                        onClick={() => handleUpdateTheme(t.id)}","-                        className={clsx(","-                          \"group relative flex flex-col p-2 border transition-all text-left h-20 active:scale-[0.98]\",","-                          theme === t.id","-                            ? \"border-accent bg-accent/5 shadow-[0_0_15px_rgba(var(--accent),0.05)]\"","-                            : \"border-border/10 hover:border-accent/40 bg-surface/5\"","-                        )}","-                      >","-                        <div className={clsx(\"w-full flex-1 mb-1.5 border border-border/10 overflow-hidden relative opacity-60\", t.colors)}>","-                          <div className=\"absolute top-0 left-0 w-full h-1 bg-surface/20 border-b border-border/10\" />","-                          <div className={clsx(\"absolute bottom-1 right-1 w-2 h-2 rounded-full\", t.accent)} />","-                        </div>","-                        <div className=\"flex items-center justify-between font-mono\">","-                          <span className={clsx(","-                            \"text-[10px] font-black uppercase tracking-widest\",","-                            theme === t.id ? \"text-accent\" : \"text-text-tertiary/60 group-hover:text-text-secondary\"","-                          )}>","-                            {theme === t.id ? `[${t.name}]` : `  ${t.name}`}","-                          </span>","-                        </div>","-                      </button>","-                    ))}","-                  </div>","-                </section>","-","                 <div className=\"grid grid-cols-1 gap-12\">","                   {/* Agent Behavior Section */}","                   <section className=\"space-y-3\">"]}],"userModified":false,"replaceAll":false}}
{"parentUuid":"b82694c8-01c6-4557-ae08-22e23fc19ec6","isSidechain":false,"userType":"external","cwd":"/Users/patrick/workingdir/familiar","sessionId":"507f4396-f3e4-4a63-8b43-9c891e06f5ee","version":"2.0.76","gitBranch":"main","slug":"precious-crunching-toast","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_014SH8XG4XkAxs2MZarwx9Yj","type":"tool_result","content":"The file /Users/patrick/workingdir/familiar/packages/desktop/ui/src/components/Agent/SettingsView.tsx has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n   105→      console.error('Failed to update Codex mode:', err);\n   106→    }\n   107→  };\n   108→\n   109→  const [isSaving, setIsSaving] = useState(false);\n   110→  const [showSuccess, setShowSuccess] = useState(false);\n   111→  const [newKey, setNewKey] = useState<{ provider: string; key: string }>({ provider: '', key: '' });\n   112→  const [newVaultSecret, setNewVaultSecret] = useState<{ name: string; value: string }>({ name: '', value: '' });\n   113→  const [customBaseUrl, setCustomBaseUrl] = useState('');"}]},"uuid":"8a4dfe09-a7b2-45c0-87ac-e29fa1adb166","timestamp":"2026-01-03T02:41:11.163Z","toolUseResult":{"filePath":"/Users/patrick/workingdir/familiar/packages/desktop/ui/src/components/Agent/SettingsView.tsx","oldString":"  const [theme, setTheme] = useState(config?.ui?.theme || 'default');","newString":"","originalFile":"import React, { useState, useEffect, useRef, useCallback } from 'react';\nimport { useQuery, useQueryClient } from '@tanstack/react-query';\nimport { useNavigate } from 'react-router-dom';\nimport { api } from '../../lib/api';\nimport { clsx } from 'clsx';\nimport { ask } from '@tauri-apps/plugin-dialog';\nimport { useSystem } from '../../context/SystemContext';\nimport { useAgents } from '../../context/AgentContext';\n\nexport const SettingsView: React.FC = () => {\n  const navigate = useNavigate();\n  const queryClient = useQueryClient();\n  const { setExplorerCollapsed } = useAgents();\n  const { data: config, refetch: refetchConfig } = useQuery({\n    queryKey: ['config'],\n    queryFn: () => api.getConfig(),\n  });\n\n  const { data: apiKeys, refetch: refetchKeys } = useQuery({\n    queryKey: ['apiKeys'],\n    queryFn: () => api.getApiKeys(),\n  });\n\n  const { data: vaultSecrets, refetch: refetchVault } = useQuery({\n    queryKey: ['vaultSecrets'],\n    queryFn: () => api.listVaultSecrets(),\n  });\n\n  const { data: status } = useQuery({\n    queryKey: ['status'],\n    queryFn: () => api.getStatus(),\n    refetchInterval: 5000,\n  });\n\n  const handleToggleAlwaysAllowAll = async () => {\n    const current = !!config?.security?.always_allow_all;\n    if (!current) {\n      const confirmed = await ask(\"WARNING: This will automatically approve ALL tool calls (including shell and browser) from ALL agents and sub-agents. This grants autonomous agents full control over your local system and web presence. Are you sure you want to disable all security oversight?\", {\n        title: \"Danger: Disable All Approvals\",\n        kind: \"error\",\n      });\n      if (!confirmed) return;\n    }\n\n    try {\n      await api.updateConfig({ security: { always_allow_all: !current } });\n      await refetchConfig();\n      triggerSuccess();\n    } catch (err) {\n      console.error('Failed to toggle always allow all:', err);\n    }\n  };\n\n  const handleUpdateShellPermissionMode = async (mode: string) => {\n    try {\n      await api.updateConfig({ security: { shell_permission_mode: mode } });\n      await refetchConfig();\n      triggerSuccess();\n    } catch (err) {\n      console.error('Failed to update shell permission mode:', err);\n    }\n  };\n\n  const handleToggleSubAgentsGlobal = async () => {\n    try {\n      const current = !!config?.sub_agent?.enabled;\n      await api.updateConfig({ sub_agent: { enabled: !current } });\n      await refetchConfig();\n      triggerSuccess();\n    } catch (err) {\n      console.error('Failed to toggle sub-agents globally:', err);\n    }\n  };\n\n\n\n  const handleToggleCLIEnabled = async (cli: 'claude_code' | 'codex') => {\n    try {\n      const current = !!config?.sub_agent?.[cli]?.enabled;\n      await api.updateConfig({ sub_agent: { [cli]: { enabled: !current } } });\n      await refetchConfig();\n      triggerSuccess();\n    } catch (err) {\n      console.error(`Failed to toggle ${cli}:`, err);\n    }\n  };\n\n  const handleUpdateClaudeTools = async (tools: string) => {\n    try {\n      const toolList = tools.split(',').map(t => t.trim()).filter(Boolean);\n      await api.updateConfig({ sub_agent: { claude_code: { allowed_tools: toolList } } });\n      await refetchConfig();\n      triggerSuccess();\n    } catch (err) {\n      console.error('Failed to update Claude tools:', err);\n    }\n  };\n\n  const handleUpdateCodexMode = async (mode: string) => {\n    try {\n      await api.updateConfig({ sub_agent: { codex: { approval_mode: mode } } });\n      await refetchConfig();\n      triggerSuccess();\n    } catch (err) {\n      console.error('Failed to update Codex mode:', err);\n    }\n  };\n\n  const [theme, setTheme] = useState(config?.ui?.theme || 'default');\n  const [isSaving, setIsSaving] = useState(false);\n  const [showSuccess, setShowSuccess] = useState(false);\n  const [newKey, setNewKey] = useState<{ provider: string; key: string }>({ provider: '', key: '' });\n  const [newVaultSecret, setNewVaultSecret] = useState<{ name: string; value: string }>({ name: '', value: '' });\n  const [customBaseUrl, setCustomBaseUrl] = useState('');\n  const [isAddingCustomProvider, setIsAddingCustomProvider] = useState(false);\n  const [newCustomProviderName, setNewCustomProviderName] = useState('');\n\n  const [editingProvider, setEditingProvider] = useState<string | null>(null);\n  const [editingCapability, setEditingCapability] = useState<string>('chat');\n  const [newModelName, setNewModelName] = useState('');\n  const [isFetchingModels, setIsFetchingModels] = useState(false);\n  const { activeSettingsTab: activeTab } = useSystem();\n\n  const [recordingHotkey, setRecordingHotkey] = useState<string | null>(null);\n  const autoFetchedProviders = useRef<Set<string>>(new Set());\n\n  // Thinking configuration state - track which model is being edited\n  const [editingThinkingModel, setEditingThinkingModel] = useState<string | null>(null);\n\n  // Reasoning levels\n  type ReasoningLevel = '' | 'low' | 'medium' | 'high';\n  const reasoningLevels: { value: ReasoningLevel; label: string }[] = [\n    { value: '', label: 'None' },\n    { value: 'low', label: 'Low' },\n    { value: 'medium', label: 'Medium' },\n    { value: 'high', label: 'High' },\n  ];\n\n  // Helper to parse model string for reasoning level\n  // e.g., \"claude-haiku-4.5:thinking-high\" -> { baseModel: \"claude-haiku-4.5\", level: \"high\" }\n  const parseModelLevel = (model: string): { baseModel: string; level: ReasoningLevel } => {\n    for (const l of ['low', 'medium', 'high'] as ReasoningLevel[]) {\n      const suffix = `:thinking-${l}`;\n      if (model.endsWith(suffix)) {\n        return { baseModel: model.replace(suffix, ''), level: l };\n      }\n    }\n    // Legacy: :thinking without level = high\n    if (model.endsWith(':thinking')) {\n      return { baseModel: model.replace(':thinking', ''), level: 'high' };\n    }\n    return { baseModel: model, level: '' };\n  };\n\n  // Helper to build model string from base and level\n  const buildModelString = (baseModel: string, level: ReasoningLevel): string => {\n    if (level) {\n      return `${baseModel}:thinking-${level}`;\n    }\n    return baseModel;\n  };\n\n  // Providers that support thinking/reasoning\n  const thinkingProviders = ['openrouter', 'anthropic', 'openai', 'gemini'];\n\n  // Update a model's reasoning level\n  const handleUpdateModelLevel = async (oldModel: string, newLevel: ReasoningLevel) => {\n    if (!editingProvider || !editingCapability) return;\n\n    const { baseModel } = parseModelLevel(oldModel);\n    const newModel = buildModelString(baseModel, newLevel);\n\n    if (newModel === oldModel) return; // No change\n\n    const models = availableModels[editingProvider]?.[editingCapability] || [];\n    const updatedModels = models.map(m => m === oldModel ? newModel : m);\n\n    const updatedAvailableModels = {\n      ...availableModels,\n      [editingProvider]: {\n        ...(availableModels[editingProvider] || {}),\n        [editingCapability]: updatedModels\n      }\n    };\n\n    setIsSaving(true);\n    try {\n      await api.updateConfig({ available_models: updatedAvailableModels });\n      await refetchConfig();\n      triggerSuccess();\n    } catch (err) {\n      console.error('Failed to update model reasoning level:', err);\n    } finally {\n      setIsSaving(false);\n    }\n  };\n\n  useEffect(() => {\n    setExplorerCollapsed(false);\n  }, []);\n\n  const successTimeoutRef = useRef<ReturnType<typeof setTimeout> | null>(null);\n  const triggerSuccess = useCallback(() => {\n    setShowSuccess(true);\n    if (successTimeoutRef.current) clearTimeout(successTimeoutRef.current);\n    successTimeoutRef.current = setTimeout(() => setShowSuccess(false), 3000);\n  }, []);\n\n  useEffect(() => {\n    if (recordingHotkey) {\n      const handleGlobalKeyDown = (e: KeyboardEvent) => {\n        // Don't intercept if it's just a modifier key\n        if (['Control', 'Shift', 'Alt', 'Meta'].includes(e.key)) return;\n\n        e.preventDefault();\n        e.stopPropagation();\n\n        if (e.key === 'Escape') {\n          setRecordingHotkey(null);\n          return;\n        }\n\n        const modifiers = [];\n        if (e.metaKey) modifiers.push('Cmd');\n        else if (e.ctrlKey) modifiers.push('Ctrl');\n\n        if (e.shiftKey) modifiers.push('Shift');\n        if (e.altKey) modifiers.push('Alt');\n\n        let key = e.key;\n        if (key === ' ') key = 'Space';\n        if (key.length === 1) key = key.toUpperCase();\n\n        const hotkey = modifiers.length > 0 ? `${modifiers.join('+')}+${key}` : key;\n\n        handleUpdateHotkey(recordingHotkey, hotkey);\n        setRecordingHotkey(null);\n      };\n\n      window.addEventListener('keydown', handleGlobalKeyDown, true);\n      return () => window.removeEventListener('keydown', handleGlobalKeyDown, true);\n    }\n  }, [recordingHotkey, config]);\n\n  const handleUpdateHotkey = async (key: string, value: string) => {\n    const updatedHotkeys = { ...((config?.ui as any)?.hotkeys || {}), [key]: value };\n    try {\n      await api.updateConfig({ ui: { hotkeys: updatedHotkeys } });\n      await refetchConfig();\n      triggerSuccess();\n    } catch (err) {\n      console.error('Failed to update hotkey:', err);\n    }\n  };\n\n  const hotkeyDefaults: Record<string, string> = {\n    'global_back': 'Escape',\n    'new_agent': 'Cmd+N',\n    'focus_input': 'Cmd+L',\n    'toggle_sidebar': 'Cmd+B',\n    'toggle_settings': 'Cmd+,',\n    'toggle_pause': 'Cmd+P',\n    'compact': 'Cmd+Shift+C',\n    'toggle_unibar': 'Cmd+K',\n    'delete_agent': 'Cmd+D',\n    'toggle_explorer': 'Cmd+E',\n  };\n\n  const hotkeyLabels: Record<string, string> = {\n    'global_back': 'Global Back / Exit Dashboard',\n    'new_agent': 'Create New Agent (Dashboard)',\n    'focus_input': 'Focus Chat Input (Workspace)',\n    'toggle_sidebar': 'Toggle Sidebar (Workspace)',\n    'toggle_settings': 'Toggle Settings (Workspace)',\n    'toggle_pause': 'Toggle Pause/Resume',\n    'compact': 'Compact History (Workspace)',\n    'toggle_unibar': 'Omnibar / Command Palette',\n    'delete_agent': 'Delete Highlighted Agent (Dashboard)',\n    'toggle_explorer': 'Toggle Explorer Panel',\n  };\n\n  // Pointer-based drag state (bypasses Tauri's drag interception)\n  const [isDragging, setIsDragging] = useState(false);\n  const [dragSourceIndex, setDragSourceIndex] = useState<number | null>(null);\n  const [dragTargetIndex, setDragTargetIndex] = useState<number | null>(null);\n  const itemRefs = useRef<(HTMLDivElement | null)[]>([]);\n  const containerRef = useRef<HTMLDivElement>(null);\n  const scrollRef = useRef<HTMLDivElement>(null);\n\n  useEffect(() => {\n    const handleKeyDown = (e: KeyboardEvent) => {\n      // Don't scroll if we're recording a hotkey or typing in an input\n      if (recordingHotkey) return;\n\n      const activeElement = document.activeElement;\n      const isInput = activeElement instanceof HTMLInputElement ||\n        activeElement instanceof HTMLTextAreaElement ||\n        (activeElement as HTMLElement)?.isContentEditable;\n\n      if (isInput && !(e.metaKey || e.ctrlKey)) return;\n\n      if (e.key === 'ArrowUp') {\n        if (scrollRef.current) {\n          e.preventDefault();\n          scrollRef.current.scrollBy({ top: -100, behavior: 'smooth' });\n        }\n      }\n      if (e.key === 'ArrowDown') {\n        if (scrollRef.current) {\n          e.preventDefault();\n          scrollRef.current.scrollBy({ top: 100, behavior: 'smooth' });\n        }\n      }\n      if (e.key === ' ' && !isInput) {\n        if (scrollRef.current) {\n          e.preventDefault();\n          const direction = e.shiftKey ? -1 : 1;\n          scrollRef.current.scrollBy({\n            top: direction * scrollRef.current.clientHeight * 0.8,\n            behavior: 'smooth'\n          });\n        }\n      }\n    };\n\n    window.addEventListener('keydown', handleKeyDown);\n    return () => window.removeEventListener('keydown', handleKeyDown);\n  }, [recordingHotkey]);\n\n\n\n  useEffect(() => {\n    if (!editingProvider && config?.available_models && apiKeys) {\n      const availableModels = config.available_models;\n      const providers = Object.keys(availableModels);\n\n      // Preference order for default selection\n      const preference = ['openrouter', 'anthropic', 'openai', 'gemini'];\n      const defaultProvider = preference.find(p => providers.some(ap => ap.toLowerCase() === p));\n\n      if (defaultProvider) {\n        const matching = providers.find(p => p.toLowerCase() === defaultProvider);\n        if (matching) {\n          setEditingProvider(matching);\n          setNewKey(prev => ({ ...prev, provider: matching }));\n        }\n      } else if (providers.length > 0) {\n        setEditingProvider(providers[0]);\n        setNewKey(prev => ({ ...prev, provider: providers[0] }));\n      }\n    }\n  }, [config, editingProvider, apiKeys]);\n\n  useEffect(() => {\n    if (editingProvider && config?.custom_providers?.[editingProvider]) {\n      setCustomBaseUrl(config?.custom_providers[editingProvider].base_url || '');\n    } else {\n      setCustomBaseUrl('');\n    }\n  }, [editingProvider, config?.custom_providers]);\n\n  const availableModels = config?.available_models || {};\n  const localProvidersList = ['ollama', 'lmstudio'];\n  const standardProviders = ['openrouter', 'anthropic', 'openai', 'gemini', 'ollama', 'lmstudio'];\n\n  const handleFetchModels = useCallback(async (provider: string) => {\n    if (isFetchingModels) return;\n    setIsFetchingModels(true);\n    try {\n      const response = await api.fetchModels(provider);\n      if (response && response.models) {\n        const updatedAvailableModels = {\n          ...availableModels,\n          [provider]: {\n            ...(availableModels[provider] || {}),\n            chat: response.models\n          }\n        };\n\n        // If this is the active provider and has no model set, pick the first one\n        const updates: any = { available_models: updatedAvailableModels };\n        if (provider === config?.inference?.chat?.provider && (!config?.inference?.chat?.model || (availableModels[provider]?.chat?.length || 0) === 0)) {\n          if (response.models.length > 0) {\n            updates.inference = {\n              ...config.inference,\n              chat: {\n                ...config.inference.chat,\n                model: response.models[0]\n              }\n            };\n          }\n        }\n\n        await api.updateConfig(updates);\n        await refetchConfig();\n        triggerSuccess();\n      }\n    } catch (err) {\n      console.error('Failed to fetch models:', err);\n    } finally {\n      setIsFetchingModels(false);\n    }\n  }, [availableModels, config, isFetchingModels, refetchConfig, triggerSuccess]);\n\n  useEffect(() => {\n    if (editingProvider && localProvidersList.includes(editingProvider.toLowerCase())) {\n      const currentChatModels = availableModels[editingProvider]?.chat || [];\n      if (currentChatModels.length === 0 && !isFetchingModels && !autoFetchedProviders.current.has(editingProvider.toLowerCase())) {\n        autoFetchedProviders.current.add(editingProvider.toLowerCase());\n        handleFetchModels(editingProvider);\n      }\n    }\n  }, [editingProvider, availableModels, isFetchingModels, handleFetchModels]);\n\n  const allProviders = Object.keys(availableModels);\n  const cloudProviders = allProviders.filter(p => standardProviders.includes(p.toLowerCase()) && !localProvidersList.includes(p.toLowerCase()));\n  const localProviders = allProviders.filter(p => standardProviders.includes(p.toLowerCase()) && localProvidersList.includes(p.toLowerCase()));\n  const userCustomProvidersList = allProviders.filter(p => !standardProviders.includes(p.toLowerCase()));\n\n  const currentModels = (editingProvider && editingCapability) ? (availableModels[editingProvider]?.[editingCapability] || []) : [];\n  const hasCustomBaseUrl = !!customBaseUrl.trim();\n\n  const handleAddCustomProvider = async () => {\n    if (!newCustomProviderName.trim()) return;\n    const name = newCustomProviderName.trim().toLowerCase();\n    if (standardProviders.includes(name) || userCustomProvidersList.includes(name)) {\n      alert('Provider name already exists or is reserved.');\n      return;\n    }\n\n    setIsSaving(true);\n    try {\n      const updatedCustomProviders = {\n        ...(config?.custom_providers || {}),\n        [name]: { base_url: '' }\n      };\n      await api.updateConfig({ custom_providers: updatedCustomProviders });\n      await refetchConfig();\n      setEditingProvider(name);\n      setIsAddingCustomProvider(false);\n      setNewCustomProviderName('');\n      triggerSuccess();\n    } catch (err) {\n      console.error('Failed to add custom provider:', err);\n    } finally {\n      setIsSaving(false);\n    }\n  };\n\n  const handleRemoveCustomProvider = async (name: string) => {\n    const confirmed = await ask(`Are you sure you want to delete the custom provider \"${name}\"?`, {\n      title: 'Delete Provider',\n      kind: 'warning',\n    });\n\n    if (!confirmed) return;\n\n    setIsSaving(true);\n    try {\n      // Wipe API key from keychain first\n      try {\n        await api.removeApiKey(name);\n      } catch (keyErr) {\n        console.warn(`Failed to remove API key for ${name}:`, keyErr);\n      }\n\n      const updatedCustomProviders = { ...(config?.custom_providers || {}) };\n      delete updatedCustomProviders[name];\n\n      const updatedAvailableModels = { ...(config?.available_models || {}) };\n      delete updatedAvailableModels[name];\n\n      await api.updateConfig({\n        custom_providers: updatedCustomProviders,\n        available_models: updatedAvailableModels\n      });\n      await queryClient.invalidateQueries({ queryKey: ['config'] });\n      await queryClient.invalidateQueries({ queryKey: ['apiKeys'] });\n      if (editingProvider === name) {\n        setEditingProvider(cloudProviders[0] || 'openai');\n      }\n      triggerSuccess();\n    } catch (err) {\n      console.error('Failed to remove custom provider:', err);\n    } finally {\n      setIsSaving(false);\n    }\n  };\n\n  const handleAddModel = async () => {\n    if (!editingProvider || !editingCapability || !newModelName.trim()) return;\n\n    const modelToAdd = newModelName.trim();\n    if (currentModels.includes(modelToAdd)) return;\n\n    const updatedModels = [...currentModels, modelToAdd];\n    const updatedAvailableModels = {\n      ...availableModels,\n      [editingProvider]: {\n        ...(availableModels[editingProvider] || {}),\n        [editingCapability]: updatedModels\n      }\n    };\n\n    const updates: any = { available_models: updatedAvailableModels };\n\n    // If this is the first model for this provider, and it's the default provider, set it as default model\n    if (editingProvider === config?.inference?.chat?.provider && editingCapability === 'chat' && currentModels.length === 0) {\n      updates.inference = {\n        ...config.inference,\n        chat: {\n          ...config.inference.chat,\n          model: modelToAdd\n        }\n      };\n    }\n\n    setIsSaving(true);\n    try {\n      await api.updateConfig(updates);\n      setNewModelName('');\n      await refetchConfig();\n      triggerSuccess();\n    } catch (err) {\n      console.error('Failed to add model:', err);\n    } finally {\n      setIsSaving(false);\n    }\n  };\n\n  const handleRemoveModel = async (modelName: string) => {\n    if (!editingProvider || !editingCapability) return;\n    const updatedModels = currentModels.filter(m => m !== modelName);\n    const updatedAvailableModels = {\n      ...availableModels,\n      [editingProvider]: {\n        ...(availableModels[editingProvider] || {}),\n        [editingCapability]: updatedModels\n      }\n    };\n\n    const updates: any = { available_models: updatedAvailableModels };\n\n    // If we removed the top model, or changed the list, and this is the default provider, update the default model\n    if (editingProvider === config?.inference?.chat?.provider && editingCapability === 'chat' && updatedModels.length > 0) {\n      if (updatedModels[0] !== currentModels[0]) {\n        updates.inference = {\n          ...config.inference,\n          chat: {\n            ...config.inference.chat,\n            model: updatedModels[0]\n          }\n        };\n      }\n    }\n\n    setIsSaving(true);\n    try {\n      await api.updateConfig(updates);\n      await refetchConfig();\n      triggerSuccess();\n    } catch (err) {\n      console.error('Failed to remove model:', err);\n    } finally {\n      setIsSaving(false);\n    }\n  };\n\n  const saveModelOrder = async (newModels: string[]) => {\n    if (!editingProvider || !editingCapability) return;\n\n    const updatedAvailableModels = {\n      ...availableModels,\n      [editingProvider]: {\n        ...(availableModels[editingProvider] || {}),\n        [editingCapability]: newModels\n      }\n    };\n\n    const updates: any = { available_models: updatedAvailableModels };\n\n    // If we moved something to the top, and this is the default provider, update the default model\n    if (editingProvider === config?.inference?.chat?.provider && editingCapability === 'chat') {\n      updates.inference = {\n        ...config.inference,\n        chat: {\n          ...config.inference.chat,\n          model: newModels[0]\n        }\n      };\n    }\n\n    setIsSaving(true);\n    try {\n      await api.updateConfig(updates);\n      await refetchConfig();\n      triggerSuccess();\n    } catch (err) {\n      console.error('Failed to update model order:', err);\n    } finally {\n      setIsSaving(false);\n    }\n  };\n\n  const handleMoveModel = async (modelName: string, direction: 'up' | 'down') => {\n    if (!editingProvider || !editingCapability) return;\n\n    const index = currentModels.indexOf(modelName);\n    if (index === -1) return;\n    if (direction === 'up' && index === 0) return;\n    if (direction === 'down' && index === currentModels.length - 1) return;\n\n    const newModels = [...currentModels];\n    const targetIndex = direction === 'up' ? index - 1 : index + 1;\n    [newModels[index], newModels[targetIndex]] = [newModels[targetIndex], newModels[index]];\n\n    await saveModelOrder(newModels);\n  };\n\n  // Pointer-based drag handlers (works in Tauri)\n  const handlePointerDown = useCallback((e: React.PointerEvent, index: number) => {\n    e.preventDefault();\n    setIsDragging(true);\n    setDragSourceIndex(index);\n    setDragTargetIndex(index);\n    (e.target as HTMLElement).setPointerCapture(e.pointerId);\n  }, []);\n\n  const handlePointerMove = useCallback((e: React.PointerEvent) => {\n    if (!isDragging || dragSourceIndex === null || !containerRef.current) return;\n\n    const containerRect = containerRef.current.getBoundingClientRect();\n    const y = e.clientY - containerRect.top;\n\n    // Find which item we're over\n    let newTargetIndex = dragSourceIndex;\n    for (let i = 0; i < itemRefs.current.length; i++) {\n      const item = itemRefs.current[i];\n      if (!item) continue;\n      const rect = item.getBoundingClientRect();\n      const itemY = rect.top - containerRect.top + rect.height / 2;\n      if (y < itemY) {\n        newTargetIndex = i;\n        break;\n      }\n      newTargetIndex = i + 1;\n    }\n    newTargetIndex = Math.max(0, Math.min(newTargetIndex, currentModels.length - 1));\n\n    if (newTargetIndex !== dragTargetIndex) {\n      setDragTargetIndex(newTargetIndex);\n    }\n  }, [isDragging, dragSourceIndex, dragTargetIndex, currentModels.length]);\n\n  const handlePointerUp = useCallback(async (e: React.PointerEvent) => {\n    if (!isDragging) return;\n    (e.target as HTMLElement).releasePointerCapture(e.pointerId);\n\n    const sourceIndex = dragSourceIndex;\n    const targetIndex = dragTargetIndex;\n\n    setIsDragging(false);\n    setDragSourceIndex(null);\n    setDragTargetIndex(null);\n\n    if (sourceIndex === null || targetIndex === null || sourceIndex === targetIndex) return;\n\n    const newModels = [...currentModels];\n    const [removed] = newModels.splice(sourceIndex, 1);\n    newModels.splice(targetIndex, 0, removed);\n\n    await saveModelOrder(newModels);\n  }, [isDragging, dragSourceIndex, dragTargetIndex, currentModels, saveModelOrder]);\n\n  const handleUpdateTheme = async (newTheme: string) => {\n    setTheme(newTheme);\n    try {\n      await api.updateConfig({ ui: { theme: newTheme } });\n      localStorage.setItem('pa_theme', newTheme);\n      if (newTheme === 'default') {\n        document.documentElement.removeAttribute('data-theme');\n      } else {\n        document.documentElement.setAttribute('data-theme', newTheme);\n      }\n      await refetchConfig();\n      triggerSuccess();\n    } catch (err) {\n      console.error('Failed to update theme:', err);\n    }\n  };\n\n  const handleToggleAutoCompaction = async () => {\n    try {\n      const current = config?.agent?.auto_compaction_enabled !== false; // Default to true if undefined\n      await api.updateConfig({ agent: { auto_compaction_enabled: !current } });\n      await refetchConfig();\n      triggerSuccess();\n    } catch (err) {\n      console.error('Failed to toggle auto-compaction:', err);\n    }\n  };\n\n  const handleSetApiKey = async () => {\n    if (!newKey.provider || !newKey.key) return;\n    setIsSaving(true);\n    try {\n      await api.setApiKey(newKey.provider, newKey.key);\n      setNewKey({ provider: '', key: '' });\n      await queryClient.invalidateQueries({ queryKey: ['apiKeys'] });\n      triggerSuccess();\n    } catch (err) {\n      console.error('Failed to set API key:', err);\n    } finally {\n      setIsSaving(false);\n    }\n  };\n\n  const handleSaveCustomBaseUrl = async () => {\n    if (!customBaseUrl.trim() || !editingProvider) return;\n    setIsSaving(true);\n    try {\n      const updatedCustomProviders = {\n        ...(config?.custom_providers || {}),\n        [editingProvider]: { base_url: customBaseUrl.trim() }\n      };\n      await api.updateConfig({ custom_providers: updatedCustomProviders });\n      await queryClient.invalidateQueries({ queryKey: ['config'] });\n      triggerSuccess();\n    } catch (err) {\n      console.error('Failed to update custom provider base URL:', err);\n    } finally {\n      setIsSaving(false);\n    }\n  };\n\n  const handleRemoveApiKey = async (provider: string) => {\n    const confirmed = await ask(`Are you sure you want to wipe the API key for ${provider.toUpperCase()}? This will prevent agents from using this provider until a new key is registered.`, {\n      title: 'Wipe API Key',\n      kind: 'warning',\n    });\n\n    if (!confirmed) return;\n\n    try {\n      await api.removeApiKey(provider);\n      await queryClient.invalidateQueries({ queryKey: ['apiKeys'] });\n    } catch (err) {\n      console.error('Failed to remove API key:', err);\n    }\n  };\n\n  const handleToggleProvider = async (provider: string, currentEnabled: boolean) => {\n    setIsSaving(true);\n    try {\n      const updatedProviders = {\n        ...(config?.providers || {}),\n        [provider]: { enabled: !currentEnabled }\n      };\n      await api.updateConfig({ providers: updatedProviders });\n      await queryClient.invalidateQueries({ queryKey: ['config'] });\n      await queryClient.invalidateQueries({ queryKey: ['apiKeys'] });\n      triggerSuccess();\n    } catch (err) {\n      console.error('Failed to toggle provider:', err);\n    } finally {\n      setIsSaving(false);\n    }\n  };\n\n  const handleSetVaultSecret = async () => {\n    if (!newVaultSecret.name || !newVaultSecret.value) return;\n    setIsSaving(true);\n    try {\n      await api.setVaultSecret(newVaultSecret.name, newVaultSecret.value);\n      setNewVaultSecret({ name: '', value: '' });\n      await refetchVault();\n      triggerSuccess();\n    } catch (err) {\n      console.error('Failed to set vault secret:', err);\n    } finally {\n      setIsSaving(false);\n    }\n  };\n\n  const handleRemoveVaultSecret = async (name: string) => {\n    const confirmed = await ask(`Are you sure you want to delete the secret \"${name}\"? This cannot be undone.`, {\n      title: 'Delete Secret',\n      kind: 'warning',\n    });\n\n    if (!confirmed) return;\n\n    try {\n      await api.removeVaultSecret(name);\n      refetchVault();\n    } catch (err) {\n      console.error('Failed to remove vault secret:', err);\n    }\n  };\n\n  const themes = [\n    { id: 'default', name: 'Matrix Dark', colors: 'bg-[#181c21]', accent: 'bg-[#22d3ee]' },\n    { id: 'light', name: 'Paper White', colors: 'bg-[#f2f2f2]', accent: 'bg-[#2563eb]' },\n    { id: 'cobalt2', name: 'Cobalt2', colors: 'bg-[#193549]', accent: 'bg-[#ffc600]' },\n    { id: 'nerv', name: 'NERV HQ', colors: 'bg-[#1c1c1c]', accent: 'bg-[#ff9500]' },\n  ];\n\n  return (\n    <div className=\"flex h-full bg-background font-mono text-[13px] overflow-hidden\">\n      {/* Main Content Area */}\n      <div className=\"flex-1 flex flex-col min-w-0 bg-background relative\">\n        <div className=\"flex-1 overflow-auto p-8 custom-scrollbar relative\" ref={scrollRef}>\n          <div className=\"max-w-4xl mx-auto pb-20\">\n            {activeTab === 'models' && (\n              <div className=\"space-y-8 animate-in fade-in slide-in-from-bottom-2 duration-300 font-mono\">\n                {/* Model Registry Section */}\n                <section className=\"space-y-3\">\n                  <div className=\"flex flex-col gap-0.5\">\n                    <div className=\"flex items-center gap-2 text-accent/80\">\n                      <h2 className=\"text-[12px] font-black uppercase tracking-[0.2em]\">Provider Configuration</h2>\n                    </div>\n                    <p className=\"text-[10px] text-text-tertiary/60 italic leading-normal font-black tracking-tight\">\n                      LLM providers and endpoints. Credentials stored in system keychain.\n                    </p>\n                  </div>\n\n                  <div className=\"flex flex-col md:flex-row bg-surface/5 border border-border/10 overflow-hidden min-h-[450px]\">\n                    {/* Left Sidebar: Providers */}\n                    <div className=\"w-full md:w-48 border-b md:border-b-0 md:border-r border-border/10 bg-background/20 flex flex-col font-mono\">\n                      <div className=\"p-3 border-b border-border/10 bg-background/10\">\n                        <span className=\"text-[10px] font-black text-accent/60 uppercase tracking-[0.2em]\">Index</span>\n                      </div>\n                      <div className=\"flex-1 overflow-auto p-1.5 space-y-0.5 custom-scrollbar\">\n                        <div className=\"px-2 pb-1\">\n                          <span className=\"text-[8px] font-black text-text-tertiary/30 uppercase tracking-widest\">Cloud</span>\n                        </div>\n                        {cloudProviders.map(p => {\n                          const providerData = apiKeys?.find(k => k.provider.toLowerCase() === p.toLowerCase());\n                          const isConfigured = providerData?.configured;\n                          const isEnabled = providerData?.enabled === true;\n                          return (\n                            <button\n                              key={p}\n                              onClick={() => {\n                                setEditingProvider(p);\n                                setNewKey(prev => ({ ...prev, provider: p }));\n                              }}\n                              className={clsx(\n                                \"w-full px-2 py-1 text-left text-[11px] font-black uppercase transition-all flex items-center justify-between\",\n                                editingProvider === p\n                                  ? \"text-accent\"\n                                  : \"text-text-tertiary/60 hover:text-text-secondary hover:translate-x-0.5\",\n                                !isEnabled && \"opacity-40\"\n                              )}\n                            >\n                              <div className=\"flex items-center gap-2\">\n                                <span className=\"w-2\">{editingProvider === p ? '>' : ' '}</span>\n                                <span className=\"truncate\">{p}</span>\n                              </div>\n                              <div className={clsx(\n                                \"w-1 h-1 rounded-full\",\n                                isConfigured ? \"bg-status-success animate-pulse\" : \"bg-status-error/40\"\n                              )} />\n                            </button>\n                          );\n                        })}\n\n                        <div className=\"pt-4 mt-2\">\n                          <div className=\"px-2 pb-1 flex items-center justify-between\">\n                            <span className=\"text-[8px] font-black text-text-tertiary/30 uppercase tracking-widest\">Custom</span>\n                            <button\n                              onClick={() => setIsAddingCustomProvider(true)}\n                              className=\"text-accent/60 hover:text-accent transition-colors text-[10px]\"\n                            >\n                              [+]\n                            </button>\n                          </div>\n\n                          {isAddingCustomProvider && (\n                            <div className=\"px-1.5 py-1 space-y-1\">\n                              <input\n                                autoFocus\n                                type=\"text\"\n                                placeholder=\"NAME...\"\n                                value={newCustomProviderName}\n                                onChange={(e) => setNewCustomProviderName(e.target.value.toLowerCase().replace(/[^a-z0-9_-]/g, ''))}\n                                onKeyDown={(e) => {\n                                  if (e.key === 'Enter') handleAddCustomProvider();\n                                  if (e.key === 'Escape') setIsAddingCustomProvider(false);\n                                }}\n                                className=\"w-full bg-transparent border-b border-accent/20 px-1 py-0.5 text-[10px] text-text-primary focus:outline-none font-mono uppercase\"\n                              />\n                              <div className=\"flex gap-1\">\n                                  <button\n                                    onClick={handleAddCustomProvider}\n                                    className=\"flex-1 py-0.5 text-accent text-[9px] font-black border border-accent/20 hover:bg-accent/5\"\n                                  >\n                                    Add\n                                  </button>\n                                  <button\n                                    onClick={() => setIsAddingCustomProvider(false)}\n                                    className=\"flex-1 py-0.5 text-text-tertiary/60 text-[9px] font-black border border-border/10 hover:bg-surface/10\"\n                                  >\n                                    Cancel\n                                  </button>\n                              </div>\n                            </div>\n                          )}\n\n                          {userCustomProvidersList.map(p => {\n                            const providerData = apiKeys?.find(k => k.provider.toLowerCase() === p.toLowerCase());\n                            const isConfigured = providerData?.configured;\n                            const isEnabled = providerData?.enabled === true;\n                            return (\n                              <button\n                                key={p}\n                                onClick={() => {\n                                  setEditingProvider(p);\n                                  setNewKey(prev => ({ ...prev, provider: p }));\n                                }}\n                                className={clsx(\n                                  \"w-full px-2 py-1 text-left text-[11px] font-black uppercase transition-all flex items-center justify-between\",\n                                  editingProvider === p\n                                    ? \"text-accent\"\n                                    : \"text-text-tertiary/60 hover:text-text-secondary hover:translate-x-0.5\",\n                                  !isEnabled && \"opacity-40\"\n                                )}\n                              >\n                                <div className=\"flex items-center gap-2\">\n                                  <span className=\"w-2\">{editingProvider === p ? '>' : ' '}</span>\n                                  <span className=\"truncate\">{p}</span>\n                                </div>\n                                <div className={clsx(\n                                  \"w-1 h-1 rounded-full\",\n                                  isConfigured ? \"bg-status-success animate-pulse\" : \"bg-status-error/40\"\n                                )} />\n                              </button>\n                            );\n                          })}\n                        </div>\n\n                        <div className=\"pt-4 mt-2\">\n                          <div className=\"px-2 pb-1\">\n                            <span className=\"text-[8px] font-black text-text-tertiary/30 uppercase tracking-widest\">Local</span>\n                          </div>\n\n                          <div className=\"space-y-0.5\">\n                            {localProviders.map(p => {\n                              const isEnabled = apiKeys?.find(k => k.provider.toLowerCase() === p.toLowerCase())?.enabled === true;\n                              return (\n                                <button\n                                  key={p}\n                                  onClick={() => {\n                                    setNewKey(prev => ({ ...prev, provider: p }));\n                                    setEditingProvider(p);\n                                  }}\n                                  className={clsx(\n                                    \"w-full px-2 py-1 text-left text-[11px] font-black uppercase transition-all flex items-center justify-between\",\n                                    editingProvider === p\n                                      ? \"text-accent\"\n                                      : \"text-text-tertiary/60 hover:text-text-secondary hover:translate-x-0.5\",\n                                    !isEnabled && \"opacity-40\"\n                                  )}\n                                >\n                                  <div className=\"flex items-center gap-2\">\n                                    <span className=\"w-2\">{editingProvider === p ? '>' : ' '}</span>\n                                    <span className=\"truncate\">{p}</span>\n                                  </div>\n                                  <div className=\"w-1 h-1 rounded-full bg-status-success animate-pulse\" />\n                                </button>\n                              );\n                            })}\n                          </div>\n                        </div>\n                      </div>\n                    </div>\n\n                    {/* Right Panel: Skills and Models */}\n                    <div className=\"flex-1 flex flex-col bg-background/5 font-mono\">\n                      {!editingProvider ? (\n                        <div className=\"flex-1 flex flex-col items-center justify-center text-text-tertiary/20 space-y-2\">\n                          <span className=\"text-[10px] uppercase font-black tracking-[0.2em]\">Select a provider</span>\n                          <div className=\"animate-pulse\">_</div>\n                        </div>\n                      ) : (\n                        <div className=\"flex-1 overflow-auto p-5 space-y-8 custom-scrollbar\">\n                          {/* Provider Header & API Key Management */}\n                          <div className=\"space-y-4\">\n                            <div className=\"flex items-center justify-between border-b border-border/10 pb-3\">\n                              <div className=\"flex items-center gap-3\">\n                                <span className=\"text-[13px] font-black text-text-primary uppercase tracking-[0.1em]\">\n                                  {editingProvider}\n                                </span>\n                              </div>\n\n                              <div className=\"flex items-center gap-2\">\n                                {(() => {\n                                  const providerData = apiKeys?.find(k => k.provider.toLowerCase() === editingProvider.toLowerCase());\n                                  const isEnabled = providerData?.enabled === true;\n\n                                  return (\n                                    <button\n                                      onClick={() => handleToggleProvider(editingProvider, isEnabled)}\n                                      className={clsx(\n                                        \"text-[9px] font-black px-2 py-0.5 transition-all tracking-widest uppercase border active:scale-95\",\n                                        isEnabled\n                                          ? \"text-status-success border-status-success/20 hover:bg-status-success/5\"\n                                          : \"text-status-error border-status-error/20 hover:bg-status-error/5\"\n                                      )}\n                                    >\n                                      {isEnabled ? 'On' : 'Off'}\n                                    </button>\n                                  );\n                                })()}\n\n                                {userCustomProvidersList.includes(editingProvider) && (\n                                  <button\n                                    onClick={() => handleRemoveCustomProvider(editingProvider)}\n                                    className=\"text-[9px] text-text-tertiary/40 hover:text-status-error transition-all uppercase font-black px-2 py-0.5 border border-border/10 hover:bg-status-error/5 active:scale-95\"\n                                  >\n                                    Delete\n                                  </button>\n                                )}\n\n                                {apiKeys?.find(k => k.provider.toLowerCase() === editingProvider.toLowerCase())?.configured && !localProvidersList.includes(editingProvider.toLowerCase()) && (\n                                  <button\n                                    onClick={() => handleRemoveApiKey(editingProvider)}\n                                    className=\"text-[9px] text-text-tertiary/40 hover:text-status-error transition-all uppercase font-black px-2 py-0.5 border border-border/10 hover:bg-status-error/5 active:scale-95\"\n                                  >\n                                    Wipe Key\n                                  </button>\n                                )}\n                              </div>\n                            </div>\n\n                            {/* API Key Input */}\n                            {!localProvidersList.includes(editingProvider.toLowerCase()) ? (\n                              <div className=\"space-y-2\">\n                                <div className=\"flex flex-col gap-0.5\">\n                                  <div className=\"flex items-center gap-2\">\n                                    <span className=\"text-[9px] font-black text-text-tertiary/60 uppercase tracking-widest\">API Key</span>\n                                  </div>\n                                </div>\n                                <div className=\"flex flex-col sm:flex-row gap-2\">\n                                  <div className=\"flex-1 relative\">\n                                    <input\n                                      type=\"password\"\n                                      placeholder=\"Paste key...\"\n                                      value={newKey.key}\n                                      onChange={(e) => setNewKey(prev => ({ ...prev, key: e.target.value }))}\n                                      onKeyDown={(e) => e.key === 'Enter' && handleSetApiKey()}\n                                      className=\"w-full bg-transparent border-b border-border/10 px-0 py-1 text-[11px] text-text-primary focus:outline-none focus:border-accent/40 font-mono transition-all uppercase\"\n                                    />\n                                  </div>\n                                  <button\n                                    onClick={handleSetApiKey}\n                                    disabled={isSaving || !newKey.key}\n                                    className=\"px-3 py-1 text-accent hover:text-accent-hover font-black text-[10px] uppercase tracking-widest transition-all disabled:opacity-20\"\n                                  >\n                                    Register\n                                  </button>\n                                </div>\n                              </div>\n                            ) : (\n                              <div className=\"text-[9px] text-accent/40 font-black uppercase tracking-widest\">\n                                Local provider - no authentication required\n                              </div>\n                            )}\n                          </div>\n\n                          {userCustomProvidersList.includes(editingProvider) && (\n                            <div className=\"space-y-2\">\n                              <div className=\"flex flex-col gap-0.5\">\n                                <span className=\"text-[9px] font-black text-text-tertiary/60 uppercase tracking-widest\">Endpoint URL</span>\n                              </div>\n                              <div className=\"flex flex-col sm:flex-row gap-2\">\n                                <div className=\"flex-1 relative\">\n                                  <input\n                                    type=\"text\"\n                                    placeholder=\"https://api.provider.com/v1\"\n                                    value={customBaseUrl}\n                                    onChange={(e) => setCustomBaseUrl(e.target.value)}\n                                    onKeyDown={(e) => e.key === 'Enter' && handleSaveCustomBaseUrl()}\n                                    className=\"w-full bg-transparent border-b border-border/10 px-0 py-1 text-[11px] text-text-primary focus:outline-none focus:border-accent/40 font-mono transition-all\"\n                                  />\n                                </div>\n                                <button\n                                  onClick={handleSaveCustomBaseUrl}\n                                  disabled={isSaving || !customBaseUrl.trim()}\n                                  className=\"px-3 py-1 text-accent hover:text-accent-hover font-black text-[10px] uppercase tracking-widest transition-all disabled:opacity-20\"\n                                >\n                                  [SAVE]\n                                </button>\n                              </div>\n                            </div>\n                          )}\n\n                          {/* Model Registry Content */}\n                          <div className=\"space-y-6\">\n                            <div className=\"flex items-center justify-between\">\n                              <span className=\"text-[9px] font-black text-text-tertiary/60 uppercase tracking-widest\">Models</span>\n                              {localProvidersList.includes(editingProvider?.toLowerCase() || '') && (\n                                <button\n                                  onClick={() => editingProvider && handleFetchModels(editingProvider)}\n                                  disabled={isFetchingModels}\n                                  className={clsx(\n                                    \"text-[9px] font-black uppercase tracking-widest transition-all\",\n                                    isFetchingModels ? \"text-text-tertiary/20 animate-pulse\" : \"text-accent hover:text-accent-hover\"\n                                  )}\n                                >\n                                  {isFetchingModels ? 'Discovering...' : 'Discover local models'}\n                                </button>\n                              )}\n                            </div>\n\n                            {['chat'].map(cap => {\n                              const models = availableModels[editingProvider]?.[cap] || [];\n                              const isEditing = editingCapability === cap;\n\n                              const isOpenRouter = editingProvider?.toLowerCase() === 'openrouter';\n                              const supportsThinking = thinkingProviders.includes(editingProvider?.toLowerCase() || '');\n\n                              return (\n                                <div key={cap} className=\"space-y-1\">\n                                  {/* Column headers */}\n                                  {(supportsThinking || isOpenRouter) && models.length > 0 && (\n                                    <div className=\"flex items-center gap-2 px-2 py-1 border-b border-border/10\">\n                                      <div className=\"w-6\" /> {/* Spacer for drag handle */}\n                                      <span className=\"flex-1 text-[8px] font-black text-text-tertiary/40 uppercase tracking-widest\">MODEL NAME</span>\n                                      {isOpenRouter && (\n                                        <span className=\"text-[8px] font-black text-text-tertiary/40 uppercase tracking-widest w-24 text-right\">PRICING (INPUT/OUTPUT per 1M TOK)</span>\n                                      )}\n                                      {supportsThinking && (\n                                        <span className=\"text-[8px] font-black text-text-tertiary/40 uppercase tracking-widest w-20 text-right\">REASONING</span>\n                                      )}\n                                      <div className=\"w-6\" /> {/* Spacer for delete button */}\n                                    </div>\n                                  )}\n                                  <div\n                                    ref={containerRef}\n                                    className=\"flex flex-col gap-0.5 min-h-[50px]\"\n                                  >\n                                    {models.map((model, index) => {\n                                      const { baseModel, level } = parseModelLevel(model);\n                                      // Use baseModel for pricing lookup since pricing is stored by base model name\n                                      const pricing = isOpenRouter && config?.model_pricing?.['openrouter']?.[cap]?.[baseModel];\n\n                                      return (\n                                        <div\n                                          key={model}\n                                          ref={el => { itemRefs.current[index] = el; }}\n                                          className={clsx(\n                                            \"flex items-center justify-between px-2 py-1 border-b border-border/5 group transition-all relative select-none gap-2\",\n                                            isDragging && dragSourceIndex === index && \"opacity-50\",\n                                            isDragging && dragTargetIndex === index && dragSourceIndex !== index && \"border-t border-accent\"\n                                          )}\n                                        >\n                                          {/* Drag handle */}\n                                          <div\n                                            className=\"text-text-tertiary/20 hover:text-accent transition-all cursor-grab active:cursor-grabbing p-1 -m-1 touch-none shrink-0\"\n                                            onPointerDown={(e) => handlePointerDown(e, index)}\n                                            onPointerMove={handlePointerMove}\n                                            onPointerUp={handlePointerUp}\n                                            onPointerCancel={handlePointerUp}\n                                          >\n                                            <span className=\"text-[8px] font-black\">{index === 0 ? '@' : '#'}</span>\n                                          </div>\n\n                                          {/* Model name */}\n                                          <div className=\"flex-1 min-w-0\">\n                                            <span className={clsx(\n                                              \"text-[10px] transition-colors truncate font-mono uppercase block\",\n                                              index === 0 ? \"text-accent font-black\" : \"text-text-primary/60 group-hover:text-text-primary\"\n                                            )}>{baseModel}</span>\n                                          </div>\n\n                                          {/* Pricing column for OpenRouter */}\n                                          {isOpenRouter && (\n                                            <div className=\"text-[9px] text-text-tertiary/60 font-mono text-right shrink-0 w-24\">\n                                              {pricing ? (\n                                                <span>${pricing.prompt.toFixed(2)}/${pricing.completion.toFixed(2)}</span>\n                                              ) : (\n                                                <span className=\"text-text-tertiary/20\">—</span>\n                                              )}\n                                            </div>\n                                          )}\n\n                                          {/* Reasoning level dropdown */}\n                                          {supportsThinking && (\n                                            <select\n                                              value={level}\n                                              onChange={(e) => handleUpdateModelLevel(model, e.target.value as typeof level)}\n                                              className={clsx(\n                                                \"bg-transparent border px-1.5 py-0.5 text-[9px] font-black uppercase cursor-pointer transition-all shrink-0 w-20\",\n                                                level\n                                                  ? \"text-status-success border-status-success/30 bg-status-success/5\"\n                                                  : \"text-text-tertiary/50 border-border/20 hover:border-border/40\"\n                                              )}\n                                              style={{ WebkitAppearance: 'none', appearance: 'none', paddingRight: '16px', backgroundImage: 'url(\"data:image/svg+xml,%3csvg xmlns=%27http://www.w3.org/2000/svg%27 fill=%27none%27 viewBox=%270 0 24 24%27 stroke=%27%23666%27%3e%3cpath stroke-linecap=%27round%27 stroke-linejoin=%27round%27 stroke-width=%272%27 d=%27M19 9l-7 7-7-7%27/%3e%3c/svg%3e\")', backgroundRepeat: 'no-repeat', backgroundPosition: 'right 2px center', backgroundSize: '10px' }}\n                                            >\n                                              {reasoningLevels.map(l => (\n                                                <option key={l.value} value={l.value}>{l.label}</option>\n                                              ))}\n                                            </select>\n                                          )}\n\n                                          {/* Remove button */}\n                                          <button\n                                            onClick={(e) => {\n                                              e.stopPropagation();\n                                              setEditingCapability(cap);\n                                              handleRemoveModel(model);\n                                            }}\n                                            className=\"text-text-tertiary/20 hover:text-status-error opacity-0 group-hover:opacity-100 transition-all text-[10px] font-black shrink-0\"\n                                          >\n                                            [X]\n                                          </button>\n                                        </div>\n                                      );\n                                    })}\n\n                                    {/* Inline Add Model Input */}\n                                    <div className=\"flex gap-2 group/input mt-1\">\n                                      <div className=\"flex-1 relative\">\n                                        <input\n                                          type=\"text\"\n                                          placeholder=\"Add model...\"\n                                          value={isEditing ? newModelName : ''}\n                                          onFocus={() => setEditingCapability(cap)}\n                                          onChange={(e) => {\n                                            setEditingCapability(cap);\n                                            setNewModelName(e.target.value);\n                                          }}\n                                          onKeyDown={(e) => e.key === 'Enter' && handleAddModel()}\n                                          className=\"w-full bg-transparent border-b border-dashed border-border/20 px-0 py-0.5 text-[10px] text-text-primary placeholder:text-text-tertiary/20 focus:outline-none focus:border-accent/40 focus:border-solid font-mono transition-all uppercase\"\n                                        />\n                                      </div>\n                                      {isEditing && newModelName.trim() && (\n                                        <button\n                                          onClick={handleAddModel}\n                                          className=\"text-accent text-[10px] font-black\"\n                                        >\n                                          [+]\n                                        </button>\n                                      )}\n                                    </div>\n                                  </div>\n                                </div>\n                              );\n                            })}\n                          </div>\n                        </div>\n                      )}\n                    </div>\n                  </div>\n                </section>\n              </div>\n            )}\n\n            {activeTab === 'general' && (\n              <div className=\"space-y-12 animate-in fade-in slide-in-from-bottom-2 duration-300 font-mono\">\n                <div className=\"grid grid-cols-1 gap-12\">\n                  {/* Agent Behavior Section */}\n                  <section className=\"space-y-3\">\n                    <div className=\"flex flex-col gap-0.5\">\n                      <div className=\"flex items-center gap-2 text-accent/80\">\n                        <h2 className=\"text-[12px] font-black uppercase tracking-[0.2em]\">Behavior</h2>\n                      </div>\n                      <p className=\"text-[10px] text-text-tertiary/60 italic leading-normal font-black tracking-tight\">\n                        Global execution and memory policies.\n                      </p>\n                    </div>\n\n                    <div className=\"bg-surface/5 border border-border/10 p-4 space-y-3 font-mono\">\n                      <div className=\"flex items-center justify-between border-b border-border/5 pb-3\">\n                        <div className=\"flex flex-col gap-0.5\">\n                          <div className=\"flex items-center gap-2\">\n                            <span className=\"text-[11px] font-black text-text-primary uppercase tracking-[0.2em]\">Auto-compaction</span>\n                          </div>\n                          <p className=\"text-[10px] text-text-tertiary/60 italic px-3 leading-normal font-black tracking-tight\">\n                            Reduce token overhead automatically at threshold.\n                          </p>\n                        </div>\n                        <button\n                          onClick={handleToggleAutoCompaction}\n                          className={clsx(\n                            \"text-[10px] font-black px-2 py-1 transition-all tracking-widest uppercase active:scale-95\",\n                            config?.agent?.auto_compaction_enabled !== false\n                              ? \"text-status-success hover:bg-status-success/5\"\n                              : \"text-status-error hover:bg-status-error/5\"\n                          )}\n                        >\n                          {config?.agent?.auto_compaction_enabled !== false ? 'Active' : 'Inactive'}\n                        </button>\n                      </div>\n                    </div>\n                  </section>\n\n                  {/* Sub-Agent Ecosystem */}\n                  <section className=\"space-y-4\">\n                    <div className=\"flex flex-col gap-0.5\">\n                      <div className=\"flex items-center justify-between\">\n                        <div className=\"flex items-center gap-2 text-accent/80\">\n                          <h2 className=\"text-[12px] font-black uppercase tracking-[0.2em]\">Sub-agents</h2>\n                        </div>\n                        <button\n                          onClick={handleToggleSubAgentsGlobal}\n                          className={clsx(\n                            \"text-[10px] font-black px-2 py-0.5 transition-all tracking-widest uppercase border active:scale-95 font-mono\",\n                            config?.sub_agent?.enabled\n                              ? \"text-status-success border-status-success/20 hover:bg-status-success/5\"\n                              : \"text-status-error border-status-error/20 hover:bg-status-error/5\"\n                          )}\n                        >\n                          {config?.sub_agent?.enabled ? 'Enabled' : 'Disabled'}\n                        </button>\n                      </div>\n                      <p className=\"text-[10px] text-text-tertiary/60 italic leading-normal font-black tracking-tight\">\n                        Autonomous child-agents for specialized task processing.\n                      </p>\n                    </div>\n\n                    <div className={clsx(\n                      \"flex flex-col gap-4 transition-opacity duration-300 font-mono\",\n                      !config?.sub_agent?.enabled && \"opacity-30 pointer-events-none grayscale\"\n                    )}>\n                      {/* Configuration Controls */}\n                      <div className=\"flex flex-col gap-4\">\n\n\n                        <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                          {/* Claude Code */}\n                          <div className=\"bg-surface/5 border border-border/10 p-4 space-y-3\">\n                            <div className=\"flex items-center justify-between\">\n                              <div className=\"flex items-center gap-2\">\n                                <span className=\"text-[11px] font-black uppercase tracking-widest text-text-primary\">Claude Code</span>\n                                {status?.components?.claude === 'ok' && status?.auth?.claude?.startsWith('ok') && (\n                                  <span className=\"text-[8px] font-black text-status-success uppercase\">Ready</span>\n                                )}\n                              </div>\n                              <button\n                                onClick={() => handleToggleCLIEnabled('claude_code')}\n                                className={clsx(\n                                  \"text-[9px] font-black px-1.5 py-0.5 transition-all border active:scale-95\",\n                                  config?.sub_agent?.claude_code?.enabled\n                                    ? \"text-status-success border-status-success/20 hover:bg-status-success/5\"\n                                    : \"text-text-tertiary/40 border-border/10 hover:text-text-secondary\"\n                                )}\n                              >\n                                {config?.sub_agent?.claude_code?.enabled ? 'On' : 'Off'}\n                              </button>\n                            </div>\n\n                            <div className=\"space-y-3\">\n                              <div className=\"space-y-1\">\n                                <label className=\"text-[9px] font-black text-text-tertiary/40 uppercase tracking-widest ml-1\">Tools</label>\n                                <input\n                                  type=\"text\"\n                                  defaultValue={config?.sub_agent?.claude_code?.allowed_tools?.join(', ')}\n                                  onBlur={(e) => handleUpdateClaudeTools(e.target.value)}\n                                  placeholder=\"Edit, Bash, Read...\"\n                                  className=\"w-full bg-transparent border-b border-border/10 px-0 py-1 text-[10px] text-text-primary focus:outline-none focus:border-accent/40 font-mono transition-all uppercase\"\n                                />\n                              </div>\n                            </div>\n                          </div>\n\n                          {/* Codex */}\n                          <div className=\"bg-surface/5 border border-border/10 p-4 space-y-3\">\n                            <div className=\"flex items-center justify-between\">\n                              <div className=\"flex items-center gap-2\">\n                                <span className=\"text-[11px] font-black uppercase tracking-widest text-text-primary\">Codex</span>\n                                {status?.components?.codex === 'ok' && status?.auth?.codex?.startsWith('ok') && (\n                                  <span className=\"text-[8px] font-black text-status-success uppercase\">Ready</span>\n                                )}\n                              </div>\n                              <button\n                                onClick={() => handleToggleCLIEnabled('codex')}\n                                className={clsx(\n                                  \"text-[9px] font-black px-1.5 py-0.5 transition-all border active:scale-95\",\n                                  config?.sub_agent?.codex?.enabled\n                                    ? \"text-status-success border-status-success/20 hover:bg-status-success/5\"\n                                    : \"text-text-tertiary/40 border-border/10 hover:text-text-secondary\"\n                                )}\n                              >\n                                {config?.sub_agent?.codex?.enabled ? 'On' : 'Off'}\n                              </button>\n                            </div>\n\n                            <div className=\"space-y-3\">\n                              <div className=\"space-y-1\">\n                                <label className=\"text-[9px] font-black text-text-tertiary/40 uppercase tracking-widest ml-1\">Approval</label>\n                                <div className=\"flex gap-1\">\n                                  {['untrusted', 'on-failure', 'on-request', 'never'].map((mode) => (\n                                    <button\n                                      key={mode}\n                                      onClick={() => handleUpdateCodexMode(mode)}\n                                      className={clsx(\n                                        \"flex-1 py-1 text-[8px] font-black uppercase border transition-all active:scale-95\",\n                                        config?.sub_agent?.codex?.approval_mode?.toLowerCase() === mode.toLowerCase()\n                                          ? \"text-accent border-accent/40 bg-accent/5\"\n                                          : \"border-border/10 text-text-tertiary/40 hover:text-text-secondary hover:bg-surface/5\"\n                                      )}\n                                    >\n                                      {config?.sub_agent?.codex?.approval_mode?.toLowerCase() === mode.toLowerCase() \n                                        ? `[${mode.toUpperCase().replace('-', '_')}]` \n                                        : mode.toUpperCase().replace('-', '_')}\n                                    </button>\n                                  ))}\n                                </div>\n                              </div>\n                            </div>\n                          </div>\n                        </div>\n                      </div>\n                    </div>\n                  </section>\n                </div>\n              </div>\n            )\n            }\n\n            {activeTab === 'security' && (\n              <div className=\"space-y-12 animate-in fade-in slide-in-from-bottom-2 duration-300 font-mono\">\n                {/* Unrestricted Execution Mode Toggle */}\n                <div className={clsx(\n                  \"p-4 border transition-all duration-500\",\n                  config?.security?.always_allow_all\n                    ? \"bg-status-error text-background border-status-error shadow-[0_0_25px_rgba(var(--status-error),0.2)]\"\n                    : \"bg-status-error/5 border-status-error/10\"\n                )}>\n                  <div className=\"flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4\">\n                    <div className=\"flex flex-col gap-1 pr-4\">\n                      <div className=\"flex items-center gap-2\">\n                        <span className={clsx(\n                          \"text-[11px] font-black uppercase tracking-[0.2em]\",\n                          config?.security?.always_allow_all ? \"text-background\" : \"text-status-error\"\n                        )}>Unrestricted Execution</span>\n                        {config?.security?.always_allow_all && (\n                          <span className=\"text-[8px] font-black bg-background text-status-error px-1 py-0.5 animate-pulse tracking-widest\">System unlocked</span>\n                        )}\n                      </div>\n                      <p className={clsx(\n                        \"text-[9px] italic leading-relaxed max-w-2xl font-black uppercase tracking-tight\",\n                        config?.security?.always_allow_all ? \"text-background/90\" : \"text-text-tertiary/60\"\n                      )}>\n                        Bypass all security checks. Agents gain full unmonitored system access. Use only in trusted environments.\n                      </p>\n                    </div>\n                    <button\n                      onClick={handleToggleAlwaysAllowAll}\n                      className={clsx(\n                        \"text-[9px] font-black px-3 py-1.5 transition-all tracking-[0.1em] uppercase border whitespace-nowrap active:scale-95\",\n                        config?.security?.always_allow_all\n                          ? \"bg-background text-status-error border-background\"\n                          : \"bg-status-error text-background border-status-error\"\n                      )}\n                    >\n                      {config?.security?.always_allow_all ? 'Restore Security' : 'Disable Security'}\n                    </button>\n                  </div>\n                </div>\n\n                {/* Shell Execution Policy */}\n                <section className={clsx(\n                  \"space-y-3 transition-all duration-300\",\n                  config?.security?.always_allow_all && \"opacity-40 grayscale\"\n                )}>\n                  <div className=\"flex flex-col gap-0.5\">\n                    <div className=\"flex items-center justify-between\">\n                      <div className=\"flex items-center gap-2 text-accent/80\">\n                        <h2 className=\"text-[12px] font-black uppercase tracking-[0.2em]\">Shell Policy</h2>\n                      </div>\n                      {config?.security?.always_allow_all && (\n                        <span className=\"text-[8px] font-black text-status-error uppercase tracking-widest bg-status-error/10 px-1.5 py-0.5\">\n                          Overridden by unrestricted mode\n                        </span>\n                      )}\n                    </div>\n                    <p className=\"text-[10px] text-text-tertiary/60 italic leading-normal font-black tracking-tight\">\n                      Control auto-approval levels for terminal commands.\n                    </p>\n                  </div>\n\n                  <div className={clsx(\n                    \"bg-surface/5 border border-border/10 p-5 space-y-4\",\n                    config?.security?.always_allow_all && \"pointer-events-none\"\n                  )}>\n                    <div className=\"flex flex-col gap-0.5\">\n                      <span className=\"text-[11px] font-black text-text-primary uppercase tracking-[0.2em]\">Execution Mode</span>\n                    </div>\n\n                    <div className=\"grid grid-cols-2 sm:grid-cols-4 gap-2\">\n                      {[\n                        { id: 'restricted', label: 'RESTRICTED', desc: 'Minimal safe set' },\n                        { id: 'read-only', label: 'READ_ONLY', desc: 'All inspections' },\n                        { id: 'non-destructive', label: 'MUTABLE', desc: 'No deletions' },\n                        { id: 'unrestricted', label: 'OPEN', desc: 'No approvals' },\n                      ].map((mode) => (\n                        <button\n                          key={mode.id}\n                          onClick={() => handleUpdateShellPermissionMode(mode.id)}\n                          className={clsx(\n                            \"flex flex-col items-start p-3 border transition-all text-left group active:scale-[0.98]\",\n                            config?.security?.shell_permission_mode === mode.id\n                              ? \"border-accent bg-accent/5 shadow-[0_0_15px_rgba(var(--accent),0.05)]\"\n                              : \"border-border/10 hover:border-accent/40 bg-surface/5\"\n                          )}\n                        >\n                          <span className={clsx(\n                            \"text-[10px] font-black uppercase tracking-widest mb-1\",\n                            config?.security?.shell_permission_mode === mode.id ? \"text-accent\" : \"text-text-tertiary/60 group-hover:text-text-secondary\"\n                          )}>\n                            {config?.security?.shell_permission_mode === mode.id ? `[${mode.label}]` : `  ${mode.label}`}\n                          </span>\n                          <span className=\"text-[8px] text-text-tertiary/40 font-black uppercase leading-tight\">\n                            {mode.desc}\n                          </span>\n                        </button>\n                      ))}\n                    </div>\n                  </div>\n                </section>\n\n                {/* Vault Section */}\n                <section className=\"space-y-3\">\n                  <div className=\"flex flex-col gap-0.5\">\n                    <div className=\"flex items-center gap-2 text-accent/80\">\n                      <h2 className=\"text-[12px] font-black uppercase tracking-[0.2em]\">Secure Vault</h2>\n                    </div>\n                    <p className=\"text-[10px] text-text-tertiary/60 italic leading-normal font-black tracking-tight\">\n                      Protected tokens and environment variables.\n                    </p>\n                  </div>\n\n                  <div className=\"bg-surface/5 border border-border/10 p-5 space-y-6\">\n                    <div className=\"space-y-4\">\n                      <div className=\"flex flex-col gap-0.5\">\n                        <span className=\"text-[11px] font-black text-text-primary uppercase tracking-[0.2em]\">Vault Index</span>\n                        <p className=\"text-[10px] text-text-tertiary/60 italic px-3 font-black tracking-tight\">\n                          Access in tools via <code className=\"text-accent underline\">{\"{{vault:KEY}}\"}</code>.\n                        </p>\n                      </div>\n\n                      <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-2\">\n                        {vaultSecrets && vaultSecrets.length > 0 ? (\n                          vaultSecrets.map((secret: any) => (\n                            <div\n                              key={secret.name}\n                              className=\"flex items-center justify-between px-3 py-1.5 bg-background/20 border border-border/5 group hover:border-accent/20 transition-all\"\n                            >\n                              <div className=\"flex items-center gap-2\">\n                                <span className=\"text-[8px] font-black text-accent/40 uppercase\">[KEY]</span>\n                                <span className=\"text-[11px] font-black text-text-primary/70 font-mono truncate max-w-[120px]\">\n                                  {secret.name}\n                                </span>\n                              </div>\n                              <button\n                                onClick={() => handleRemoveVaultSecret(secret.name)}\n                                className=\"text-text-tertiary/20 hover:text-status-error opacity-0 group-hover:opacity-100 transition-all text-[10px] font-black\"\n                              >\n                                [X]\n                              </button>\n                            </div>\n                          ))\n                        ) : (\n                          <div className=\"col-span-full py-6 border border-dashed border-border/10 flex flex-col items-center justify-center text-text-tertiary/20\">\n                            <span className=\"text-[9px] uppercase font-black tracking-[0.2em]\">No secrets stored</span>\n                          </div>\n                        )}\n                      </div>\n\n                      {/* Add Secret Form */}\n                      <div className=\"mt-4 p-4 border-t border-border/5 space-y-3\">\n                        <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-4\">\n                          <div className=\"space-y-1\">\n                            <label className=\"text-[9px] font-black text-text-tertiary/40 uppercase tracking-widest ml-1\">Key</label>\n                            <input\n                              type=\"text\"\n                              placeholder=\"GITHUB_TOKEN\"\n                              value={newVaultSecret.name}\n                              onChange={(e) => setNewVaultSecret(prev => ({ ...prev, name: e.target.value.toUpperCase().replace(/[^A-Z0-9_]/g, '_') }))}\n                              className=\"w-full bg-transparent border-b border-border/10 px-0 py-1 text-[11px] text-text-primary focus:outline-none focus:border-accent/40 font-mono transition-all uppercase\"\n                            />\n                          </div>\n                          <div className=\"space-y-1\">\n                            <label className=\"text-[9px] font-black text-text-tertiary/40 uppercase tracking-widest ml-1\">Value</label>\n                            <input\n                              type=\"password\"\n                              placeholder=\"Secret value\"\n                              value={newVaultSecret.value}\n                              onChange={(e) => setNewVaultSecret(prev => ({ ...prev, value: e.target.value }))}\n                              className=\"w-full bg-transparent border-b border-border/10 px-0 py-1 text-[11px] text-text-primary focus:outline-none focus:border-accent/40 font-mono transition-all\"\n                            />\n                          </div>\n                        </div>\n                        <button\n                          onClick={handleSetVaultSecret}\n                          disabled={isSaving || !newVaultSecret.name || !newVaultSecret.value}\n                          className=\"w-full py-1 text-accent hover:text-accent-hover font-black text-[10px] uppercase tracking-widest transition-all disabled:opacity-20 active:scale-[0.98]\"\n                        >\n                          Store in Vault\n                        </button>\n                      </div>\n                    </div>\n                  </div>\n                </section>\n              </div>\n            )\n            }\n\n            {activeTab === 'shortcuts' && (\n              <div className=\"space-y-8 animate-in fade-in slide-in-from-bottom-2 duration-300 font-mono\">\n                {/* All Hotkeys Section */}\n                <section className=\"space-y-3\">\n                  <div className=\"flex flex-col gap-0.5\">\n                    <div className=\"flex items-center gap-2 text-accent/80\">\n                      <h2 className=\"text-[12px] font-black uppercase tracking-[0.2em]\">Shortcuts</h2>\n                    </div>\n                  </div>\n\n                  <div className=\"bg-surface/5 border border-border/10 p-5\">\n                    <div className=\"grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-1\">\n                      {Object.entries(hotkeyLabels).map(([key, label]) => (\n                        <div key={key} className=\"flex items-center justify-between py-1.5 border-b border-border/5 last:border-0 md:[&:nth-last-child(-n+2)]:border-0\">\n                          <span className=\"text-[10px] font-black text-text-tertiary/60 uppercase tracking-widest\">{label}</span>\n                          <button\n                            onClick={() => setRecordingHotkey(key)}\n                            className={clsx(\n                              \"font-mono text-[10px] font-black transition-all min-w-[90px] text-right\",\n                              recordingHotkey === key\n                                ? \"text-accent animate-pulse\"\n                                : \"text-accent/60 hover:text-accent\"\n                            )}\n                          >\n                            {recordingHotkey === key ? 'Recording...' : ((config?.ui as any)?.hotkeys?.[key] || hotkeyDefaults[key] || 'N/A')}\n                          </button>\n                        </div>\n                      ))}\n                    </div>\n                        <div className=\"mt-6 pt-3 border-t border-border/5\">\n                      <p className=\"text-[9px] text-text-tertiary/20 tracking-tighter italic font-black\">\n                        Press Escape to cancel. System reserved keys may override.\n                      </p>\n                    </div>\n                  </div>\n                </section>\n              </div>\n            )\n            }\n          </div >\n        </div >\n      </div >\n    </div >\n  );\n};\n","structuredPatch":[{"oldStart":106,"oldLines":7,"newStart":106,"newLines":6,"lines":["     }","   };"," ","-  const [theme, setTheme] = useState(config?.ui?.theme || 'default');","   const [isSaving, setIsSaving] = useState(false);","   const [showSuccess, setShowSuccess] = useState(false);","   const [newKey, setNewKey] = useState<{ provider: string; key: string }>({ provider: '', key: '' });"]}],"userModified":false,"replaceAll":false}}
{"parentUuid":"8a4dfe09-a7b2-45c0-87ac-e29fa1adb166","isSidechain":false,"userType":"external","cwd":"/Users/patrick/workingdir/familiar","sessionId":"507f4396-f3e4-4a63-8b43-9c891e06f5ee","version":"2.0.76","gitBranch":"main","slug":"precious-crunching-toast","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_017BTNXUwMoYua8wXG36pW5d","type":"tool_result","content":"The file /Users/patrick/workingdir/familiar/packages/desktop/ui/src/components/Agent/SettingsView.tsx has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n   670→\n   671→    await saveModelOrder(newModels);\n   672→  }, [isDragging, dragSourceIndex, dragTargetIndex, currentModels, saveModelOrder]);\n   673→\n   674→\n   675→  const handleToggleAutoCompaction = async () => {\n   676→    try {\n   677→      const current = config?.agent?.auto_compaction_enabled !== false; // Default to true if undefined\n   678→      await api.updateConfig({ agent: { auto_compaction_enabled: !current } });"}]},"uuid":"2539f56e-9b61-4f13-a56c-a500ad2b5127","timestamp":"2026-01-03T02:41:11.310Z","toolUseResult":{"filePath":"/Users/patrick/workingdir/familiar/packages/desktop/ui/src/components/Agent/SettingsView.tsx","oldString":"  const handleUpdateTheme = async (newTheme: string) => {\n    setTheme(newTheme);\n    try {\n      await api.updateConfig({ ui: { theme: newTheme } });\n      localStorage.setItem('pa_theme', newTheme);\n      if (newTheme === 'default') {\n        document.documentElement.removeAttribute('data-theme');\n      } else {\n        document.documentElement.setAttribute('data-theme', newTheme);\n      }\n      await refetchConfig();\n      triggerSuccess();\n    } catch (err) {\n      console.error('Failed to update theme:', err);\n    }\n  };","newString":"","originalFile":"import React, { useState, useEffect, useRef, useCallback } from 'react';\nimport { useQuery, useQueryClient } from '@tanstack/react-query';\nimport { useNavigate } from 'react-router-dom';\nimport { api } from '../../lib/api';\nimport { clsx } from 'clsx';\nimport { ask } from '@tauri-apps/plugin-dialog';\nimport { useSystem } from '../../context/SystemContext';\nimport { useAgents } from '../../context/AgentContext';\n\nexport const SettingsView: React.FC = () => {\n  const navigate = useNavigate();\n  const queryClient = useQueryClient();\n  const { setExplorerCollapsed } = useAgents();\n  const { data: config, refetch: refetchConfig } = useQuery({\n    queryKey: ['config'],\n    queryFn: () => api.getConfig(),\n  });\n\n  const { data: apiKeys, refetch: refetchKeys } = useQuery({\n    queryKey: ['apiKeys'],\n    queryFn: () => api.getApiKeys(),\n  });\n\n  const { data: vaultSecrets, refetch: refetchVault } = useQuery({\n    queryKey: ['vaultSecrets'],\n    queryFn: () => api.listVaultSecrets(),\n  });\n\n  const { data: status } = useQuery({\n    queryKey: ['status'],\n    queryFn: () => api.getStatus(),\n    refetchInterval: 5000,\n  });\n\n  const handleToggleAlwaysAllowAll = async () => {\n    const current = !!config?.security?.always_allow_all;\n    if (!current) {\n      const confirmed = await ask(\"WARNING: This will automatically approve ALL tool calls (including shell and browser) from ALL agents and sub-agents. This grants autonomous agents full control over your local system and web presence. Are you sure you want to disable all security oversight?\", {\n        title: \"Danger: Disable All Approvals\",\n        kind: \"error\",\n      });\n      if (!confirmed) return;\n    }\n\n    try {\n      await api.updateConfig({ security: { always_allow_all: !current } });\n      await refetchConfig();\n      triggerSuccess();\n    } catch (err) {\n      console.error('Failed to toggle always allow all:', err);\n    }\n  };\n\n  const handleUpdateShellPermissionMode = async (mode: string) => {\n    try {\n      await api.updateConfig({ security: { shell_permission_mode: mode } });\n      await refetchConfig();\n      triggerSuccess();\n    } catch (err) {\n      console.error('Failed to update shell permission mode:', err);\n    }\n  };\n\n  const handleToggleSubAgentsGlobal = async () => {\n    try {\n      const current = !!config?.sub_agent?.enabled;\n      await api.updateConfig({ sub_agent: { enabled: !current } });\n      await refetchConfig();\n      triggerSuccess();\n    } catch (err) {\n      console.error('Failed to toggle sub-agents globally:', err);\n    }\n  };\n\n\n\n  const handleToggleCLIEnabled = async (cli: 'claude_code' | 'codex') => {\n    try {\n      const current = !!config?.sub_agent?.[cli]?.enabled;\n      await api.updateConfig({ sub_agent: { [cli]: { enabled: !current } } });\n      await refetchConfig();\n      triggerSuccess();\n    } catch (err) {\n      console.error(`Failed to toggle ${cli}:`, err);\n    }\n  };\n\n  const handleUpdateClaudeTools = async (tools: string) => {\n    try {\n      const toolList = tools.split(',').map(t => t.trim()).filter(Boolean);\n      await api.updateConfig({ sub_agent: { claude_code: { allowed_tools: toolList } } });\n      await refetchConfig();\n      triggerSuccess();\n    } catch (err) {\n      console.error('Failed to update Claude tools:', err);\n    }\n  };\n\n  const handleUpdateCodexMode = async (mode: string) => {\n    try {\n      await api.updateConfig({ sub_agent: { codex: { approval_mode: mode } } });\n      await refetchConfig();\n      triggerSuccess();\n    } catch (err) {\n      console.error('Failed to update Codex mode:', err);\n    }\n  };\n\n  const [isSaving, setIsSaving] = useState(false);\n  const [showSuccess, setShowSuccess] = useState(false);\n  const [newKey, setNewKey] = useState<{ provider: string; key: string }>({ provider: '', key: '' });\n  const [newVaultSecret, setNewVaultSecret] = useState<{ name: string; value: string }>({ name: '', value: '' });\n  const [customBaseUrl, setCustomBaseUrl] = useState('');\n  const [isAddingCustomProvider, setIsAddingCustomProvider] = useState(false);\n  const [newCustomProviderName, setNewCustomProviderName] = useState('');\n\n  const [editingProvider, setEditingProvider] = useState<string | null>(null);\n  const [editingCapability, setEditingCapability] = useState<string>('chat');\n  const [newModelName, setNewModelName] = useState('');\n  const [isFetchingModels, setIsFetchingModels] = useState(false);\n  const { activeSettingsTab: activeTab } = useSystem();\n\n  const [recordingHotkey, setRecordingHotkey] = useState<string | null>(null);\n  const autoFetchedProviders = useRef<Set<string>>(new Set());\n\n  // Thinking configuration state - track which model is being edited\n  const [editingThinkingModel, setEditingThinkingModel] = useState<string | null>(null);\n\n  // Reasoning levels\n  type ReasoningLevel = '' | 'low' | 'medium' | 'high';\n  const reasoningLevels: { value: ReasoningLevel; label: string }[] = [\n    { value: '', label: 'None' },\n    { value: 'low', label: 'Low' },\n    { value: 'medium', label: 'Medium' },\n    { value: 'high', label: 'High' },\n  ];\n\n  // Helper to parse model string for reasoning level\n  // e.g., \"claude-haiku-4.5:thinking-high\" -> { baseModel: \"claude-haiku-4.5\", level: \"high\" }\n  const parseModelLevel = (model: string): { baseModel: string; level: ReasoningLevel } => {\n    for (const l of ['low', 'medium', 'high'] as ReasoningLevel[]) {\n      const suffix = `:thinking-${l}`;\n      if (model.endsWith(suffix)) {\n        return { baseModel: model.replace(suffix, ''), level: l };\n      }\n    }\n    // Legacy: :thinking without level = high\n    if (model.endsWith(':thinking')) {\n      return { baseModel: model.replace(':thinking', ''), level: 'high' };\n    }\n    return { baseModel: model, level: '' };\n  };\n\n  // Helper to build model string from base and level\n  const buildModelString = (baseModel: string, level: ReasoningLevel): string => {\n    if (level) {\n      return `${baseModel}:thinking-${level}`;\n    }\n    return baseModel;\n  };\n\n  // Providers that support thinking/reasoning\n  const thinkingProviders = ['openrouter', 'anthropic', 'openai', 'gemini'];\n\n  // Update a model's reasoning level\n  const handleUpdateModelLevel = async (oldModel: string, newLevel: ReasoningLevel) => {\n    if (!editingProvider || !editingCapability) return;\n\n    const { baseModel } = parseModelLevel(oldModel);\n    const newModel = buildModelString(baseModel, newLevel);\n\n    if (newModel === oldModel) return; // No change\n\n    const models = availableModels[editingProvider]?.[editingCapability] || [];\n    const updatedModels = models.map(m => m === oldModel ? newModel : m);\n\n    const updatedAvailableModels = {\n      ...availableModels,\n      [editingProvider]: {\n        ...(availableModels[editingProvider] || {}),\n        [editingCapability]: updatedModels\n      }\n    };\n\n    setIsSaving(true);\n    try {\n      await api.updateConfig({ available_models: updatedAvailableModels });\n      await refetchConfig();\n      triggerSuccess();\n    } catch (err) {\n      console.error('Failed to update model reasoning level:', err);\n    } finally {\n      setIsSaving(false);\n    }\n  };\n\n  useEffect(() => {\n    setExplorerCollapsed(false);\n  }, []);\n\n  const successTimeoutRef = useRef<ReturnType<typeof setTimeout> | null>(null);\n  const triggerSuccess = useCallback(() => {\n    setShowSuccess(true);\n    if (successTimeoutRef.current) clearTimeout(successTimeoutRef.current);\n    successTimeoutRef.current = setTimeout(() => setShowSuccess(false), 3000);\n  }, []);\n\n  useEffect(() => {\n    if (recordingHotkey) {\n      const handleGlobalKeyDown = (e: KeyboardEvent) => {\n        // Don't intercept if it's just a modifier key\n        if (['Control', 'Shift', 'Alt', 'Meta'].includes(e.key)) return;\n\n        e.preventDefault();\n        e.stopPropagation();\n\n        if (e.key === 'Escape') {\n          setRecordingHotkey(null);\n          return;\n        }\n\n        const modifiers = [];\n        if (e.metaKey) modifiers.push('Cmd');\n        else if (e.ctrlKey) modifiers.push('Ctrl');\n\n        if (e.shiftKey) modifiers.push('Shift');\n        if (e.altKey) modifiers.push('Alt');\n\n        let key = e.key;\n        if (key === ' ') key = 'Space';\n        if (key.length === 1) key = key.toUpperCase();\n\n        const hotkey = modifiers.length > 0 ? `${modifiers.join('+')}+${key}` : key;\n\n        handleUpdateHotkey(recordingHotkey, hotkey);\n        setRecordingHotkey(null);\n      };\n\n      window.addEventListener('keydown', handleGlobalKeyDown, true);\n      return () => window.removeEventListener('keydown', handleGlobalKeyDown, true);\n    }\n  }, [recordingHotkey, config]);\n\n  const handleUpdateHotkey = async (key: string, value: string) => {\n    const updatedHotkeys = { ...((config?.ui as any)?.hotkeys || {}), [key]: value };\n    try {\n      await api.updateConfig({ ui: { hotkeys: updatedHotkeys } });\n      await refetchConfig();\n      triggerSuccess();\n    } catch (err) {\n      console.error('Failed to update hotkey:', err);\n    }\n  };\n\n  const hotkeyDefaults: Record<string, string> = {\n    'global_back': 'Escape',\n    'new_agent': 'Cmd+N',\n    'focus_input': 'Cmd+L',\n    'toggle_sidebar': 'Cmd+B',\n    'toggle_settings': 'Cmd+,',\n    'toggle_pause': 'Cmd+P',\n    'compact': 'Cmd+Shift+C',\n    'toggle_unibar': 'Cmd+K',\n    'delete_agent': 'Cmd+D',\n    'toggle_explorer': 'Cmd+E',\n  };\n\n  const hotkeyLabels: Record<string, string> = {\n    'global_back': 'Global Back / Exit Dashboard',\n    'new_agent': 'Create New Agent (Dashboard)',\n    'focus_input': 'Focus Chat Input (Workspace)',\n    'toggle_sidebar': 'Toggle Sidebar (Workspace)',\n    'toggle_settings': 'Toggle Settings (Workspace)',\n    'toggle_pause': 'Toggle Pause/Resume',\n    'compact': 'Compact History (Workspace)',\n    'toggle_unibar': 'Omnibar / Command Palette',\n    'delete_agent': 'Delete Highlighted Agent (Dashboard)',\n    'toggle_explorer': 'Toggle Explorer Panel',\n  };\n\n  // Pointer-based drag state (bypasses Tauri's drag interception)\n  const [isDragging, setIsDragging] = useState(false);\n  const [dragSourceIndex, setDragSourceIndex] = useState<number | null>(null);\n  const [dragTargetIndex, setDragTargetIndex] = useState<number | null>(null);\n  const itemRefs = useRef<(HTMLDivElement | null)[]>([]);\n  const containerRef = useRef<HTMLDivElement>(null);\n  const scrollRef = useRef<HTMLDivElement>(null);\n\n  useEffect(() => {\n    const handleKeyDown = (e: KeyboardEvent) => {\n      // Don't scroll if we're recording a hotkey or typing in an input\n      if (recordingHotkey) return;\n\n      const activeElement = document.activeElement;\n      const isInput = activeElement instanceof HTMLInputElement ||\n        activeElement instanceof HTMLTextAreaElement ||\n        (activeElement as HTMLElement)?.isContentEditable;\n\n      if (isInput && !(e.metaKey || e.ctrlKey)) return;\n\n      if (e.key === 'ArrowUp') {\n        if (scrollRef.current) {\n          e.preventDefault();\n          scrollRef.current.scrollBy({ top: -100, behavior: 'smooth' });\n        }\n      }\n      if (e.key === 'ArrowDown') {\n        if (scrollRef.current) {\n          e.preventDefault();\n          scrollRef.current.scrollBy({ top: 100, behavior: 'smooth' });\n        }\n      }\n      if (e.key === ' ' && !isInput) {\n        if (scrollRef.current) {\n          e.preventDefault();\n          const direction = e.shiftKey ? -1 : 1;\n          scrollRef.current.scrollBy({\n            top: direction * scrollRef.current.clientHeight * 0.8,\n            behavior: 'smooth'\n          });\n        }\n      }\n    };\n\n    window.addEventListener('keydown', handleKeyDown);\n    return () => window.removeEventListener('keydown', handleKeyDown);\n  }, [recordingHotkey]);\n\n\n\n  useEffect(() => {\n    if (!editingProvider && config?.available_models && apiKeys) {\n      const availableModels = config.available_models;\n      const providers = Object.keys(availableModels);\n\n      // Preference order for default selection\n      const preference = ['openrouter', 'anthropic', 'openai', 'gemini'];\n      const defaultProvider = preference.find(p => providers.some(ap => ap.toLowerCase() === p));\n\n      if (defaultProvider) {\n        const matching = providers.find(p => p.toLowerCase() === defaultProvider);\n        if (matching) {\n          setEditingProvider(matching);\n          setNewKey(prev => ({ ...prev, provider: matching }));\n        }\n      } else if (providers.length > 0) {\n        setEditingProvider(providers[0]);\n        setNewKey(prev => ({ ...prev, provider: providers[0] }));\n      }\n    }\n  }, [config, editingProvider, apiKeys]);\n\n  useEffect(() => {\n    if (editingProvider && config?.custom_providers?.[editingProvider]) {\n      setCustomBaseUrl(config?.custom_providers[editingProvider].base_url || '');\n    } else {\n      setCustomBaseUrl('');\n    }\n  }, [editingProvider, config?.custom_providers]);\n\n  const availableModels = config?.available_models || {};\n  const localProvidersList = ['ollama', 'lmstudio'];\n  const standardProviders = ['openrouter', 'anthropic', 'openai', 'gemini', 'ollama', 'lmstudio'];\n\n  const handleFetchModels = useCallback(async (provider: string) => {\n    if (isFetchingModels) return;\n    setIsFetchingModels(true);\n    try {\n      const response = await api.fetchModels(provider);\n      if (response && response.models) {\n        const updatedAvailableModels = {\n          ...availableModels,\n          [provider]: {\n            ...(availableModels[provider] || {}),\n            chat: response.models\n          }\n        };\n\n        // If this is the active provider and has no model set, pick the first one\n        const updates: any = { available_models: updatedAvailableModels };\n        if (provider === config?.inference?.chat?.provider && (!config?.inference?.chat?.model || (availableModels[provider]?.chat?.length || 0) === 0)) {\n          if (response.models.length > 0) {\n            updates.inference = {\n              ...config.inference,\n              chat: {\n                ...config.inference.chat,\n                model: response.models[0]\n              }\n            };\n          }\n        }\n\n        await api.updateConfig(updates);\n        await refetchConfig();\n        triggerSuccess();\n      }\n    } catch (err) {\n      console.error('Failed to fetch models:', err);\n    } finally {\n      setIsFetchingModels(false);\n    }\n  }, [availableModels, config, isFetchingModels, refetchConfig, triggerSuccess]);\n\n  useEffect(() => {\n    if (editingProvider && localProvidersList.includes(editingProvider.toLowerCase())) {\n      const currentChatModels = availableModels[editingProvider]?.chat || [];\n      if (currentChatModels.length === 0 && !isFetchingModels && !autoFetchedProviders.current.has(editingProvider.toLowerCase())) {\n        autoFetchedProviders.current.add(editingProvider.toLowerCase());\n        handleFetchModels(editingProvider);\n      }\n    }\n  }, [editingProvider, availableModels, isFetchingModels, handleFetchModels]);\n\n  const allProviders = Object.keys(availableModels);\n  const cloudProviders = allProviders.filter(p => standardProviders.includes(p.toLowerCase()) && !localProvidersList.includes(p.toLowerCase()));\n  const localProviders = allProviders.filter(p => standardProviders.includes(p.toLowerCase()) && localProvidersList.includes(p.toLowerCase()));\n  const userCustomProvidersList = allProviders.filter(p => !standardProviders.includes(p.toLowerCase()));\n\n  const currentModels = (editingProvider && editingCapability) ? (availableModels[editingProvider]?.[editingCapability] || []) : [];\n  const hasCustomBaseUrl = !!customBaseUrl.trim();\n\n  const handleAddCustomProvider = async () => {\n    if (!newCustomProviderName.trim()) return;\n    const name = newCustomProviderName.trim().toLowerCase();\n    if (standardProviders.includes(name) || userCustomProvidersList.includes(name)) {\n      alert('Provider name already exists or is reserved.');\n      return;\n    }\n\n    setIsSaving(true);\n    try {\n      const updatedCustomProviders = {\n        ...(config?.custom_providers || {}),\n        [name]: { base_url: '' }\n      };\n      await api.updateConfig({ custom_providers: updatedCustomProviders });\n      await refetchConfig();\n      setEditingProvider(name);\n      setIsAddingCustomProvider(false);\n      setNewCustomProviderName('');\n      triggerSuccess();\n    } catch (err) {\n      console.error('Failed to add custom provider:', err);\n    } finally {\n      setIsSaving(false);\n    }\n  };\n\n  const handleRemoveCustomProvider = async (name: string) => {\n    const confirmed = await ask(`Are you sure you want to delete the custom provider \"${name}\"?`, {\n      title: 'Delete Provider',\n      kind: 'warning',\n    });\n\n    if (!confirmed) return;\n\n    setIsSaving(true);\n    try {\n      // Wipe API key from keychain first\n      try {\n        await api.removeApiKey(name);\n      } catch (keyErr) {\n        console.warn(`Failed to remove API key for ${name}:`, keyErr);\n      }\n\n      const updatedCustomProviders = { ...(config?.custom_providers || {}) };\n      delete updatedCustomProviders[name];\n\n      const updatedAvailableModels = { ...(config?.available_models || {}) };\n      delete updatedAvailableModels[name];\n\n      await api.updateConfig({\n        custom_providers: updatedCustomProviders,\n        available_models: updatedAvailableModels\n      });\n      await queryClient.invalidateQueries({ queryKey: ['config'] });\n      await queryClient.invalidateQueries({ queryKey: ['apiKeys'] });\n      if (editingProvider === name) {\n        setEditingProvider(cloudProviders[0] || 'openai');\n      }\n      triggerSuccess();\n    } catch (err) {\n      console.error('Failed to remove custom provider:', err);\n    } finally {\n      setIsSaving(false);\n    }\n  };\n\n  const handleAddModel = async () => {\n    if (!editingProvider || !editingCapability || !newModelName.trim()) return;\n\n    const modelToAdd = newModelName.trim();\n    if (currentModels.includes(modelToAdd)) return;\n\n    const updatedModels = [...currentModels, modelToAdd];\n    const updatedAvailableModels = {\n      ...availableModels,\n      [editingProvider]: {\n        ...(availableModels[editingProvider] || {}),\n        [editingCapability]: updatedModels\n      }\n    };\n\n    const updates: any = { available_models: updatedAvailableModels };\n\n    // If this is the first model for this provider, and it's the default provider, set it as default model\n    if (editingProvider === config?.inference?.chat?.provider && editingCapability === 'chat' && currentModels.length === 0) {\n      updates.inference = {\n        ...config.inference,\n        chat: {\n          ...config.inference.chat,\n          model: modelToAdd\n        }\n      };\n    }\n\n    setIsSaving(true);\n    try {\n      await api.updateConfig(updates);\n      setNewModelName('');\n      await refetchConfig();\n      triggerSuccess();\n    } catch (err) {\n      console.error('Failed to add model:', err);\n    } finally {\n      setIsSaving(false);\n    }\n  };\n\n  const handleRemoveModel = async (modelName: string) => {\n    if (!editingProvider || !editingCapability) return;\n    const updatedModels = currentModels.filter(m => m !== modelName);\n    const updatedAvailableModels = {\n      ...availableModels,\n      [editingProvider]: {\n        ...(availableModels[editingProvider] || {}),\n        [editingCapability]: updatedModels\n      }\n    };\n\n    const updates: any = { available_models: updatedAvailableModels };\n\n    // If we removed the top model, or changed the list, and this is the default provider, update the default model\n    if (editingProvider === config?.inference?.chat?.provider && editingCapability === 'chat' && updatedModels.length > 0) {\n      if (updatedModels[0] !== currentModels[0]) {\n        updates.inference = {\n          ...config.inference,\n          chat: {\n            ...config.inference.chat,\n            model: updatedModels[0]\n          }\n        };\n      }\n    }\n\n    setIsSaving(true);\n    try {\n      await api.updateConfig(updates);\n      await refetchConfig();\n      triggerSuccess();\n    } catch (err) {\n      console.error('Failed to remove model:', err);\n    } finally {\n      setIsSaving(false);\n    }\n  };\n\n  const saveModelOrder = async (newModels: string[]) => {\n    if (!editingProvider || !editingCapability) return;\n\n    const updatedAvailableModels = {\n      ...availableModels,\n      [editingProvider]: {\n        ...(availableModels[editingProvider] || {}),\n        [editingCapability]: newModels\n      }\n    };\n\n    const updates: any = { available_models: updatedAvailableModels };\n\n    // If we moved something to the top, and this is the default provider, update the default model\n    if (editingProvider === config?.inference?.chat?.provider && editingCapability === 'chat') {\n      updates.inference = {\n        ...config.inference,\n        chat: {\n          ...config.inference.chat,\n          model: newModels[0]\n        }\n      };\n    }\n\n    setIsSaving(true);\n    try {\n      await api.updateConfig(updates);\n      await refetchConfig();\n      triggerSuccess();\n    } catch (err) {\n      console.error('Failed to update model order:', err);\n    } finally {\n      setIsSaving(false);\n    }\n  };\n\n  const handleMoveModel = async (modelName: string, direction: 'up' | 'down') => {\n    if (!editingProvider || !editingCapability) return;\n\n    const index = currentModels.indexOf(modelName);\n    if (index === -1) return;\n    if (direction === 'up' && index === 0) return;\n    if (direction === 'down' && index === currentModels.length - 1) return;\n\n    const newModels = [...currentModels];\n    const targetIndex = direction === 'up' ? index - 1 : index + 1;\n    [newModels[index], newModels[targetIndex]] = [newModels[targetIndex], newModels[index]];\n\n    await saveModelOrder(newModels);\n  };\n\n  // Pointer-based drag handlers (works in Tauri)\n  const handlePointerDown = useCallback((e: React.PointerEvent, index: number) => {\n    e.preventDefault();\n    setIsDragging(true);\n    setDragSourceIndex(index);\n    setDragTargetIndex(index);\n    (e.target as HTMLElement).setPointerCapture(e.pointerId);\n  }, []);\n\n  const handlePointerMove = useCallback((e: React.PointerEvent) => {\n    if (!isDragging || dragSourceIndex === null || !containerRef.current) return;\n\n    const containerRect = containerRef.current.getBoundingClientRect();\n    const y = e.clientY - containerRect.top;\n\n    // Find which item we're over\n    let newTargetIndex = dragSourceIndex;\n    for (let i = 0; i < itemRefs.current.length; i++) {\n      const item = itemRefs.current[i];\n      if (!item) continue;\n      const rect = item.getBoundingClientRect();\n      const itemY = rect.top - containerRect.top + rect.height / 2;\n      if (y < itemY) {\n        newTargetIndex = i;\n        break;\n      }\n      newTargetIndex = i + 1;\n    }\n    newTargetIndex = Math.max(0, Math.min(newTargetIndex, currentModels.length - 1));\n\n    if (newTargetIndex !== dragTargetIndex) {\n      setDragTargetIndex(newTargetIndex);\n    }\n  }, [isDragging, dragSourceIndex, dragTargetIndex, currentModels.length]);\n\n  const handlePointerUp = useCallback(async (e: React.PointerEvent) => {\n    if (!isDragging) return;\n    (e.target as HTMLElement).releasePointerCapture(e.pointerId);\n\n    const sourceIndex = dragSourceIndex;\n    const targetIndex = dragTargetIndex;\n\n    setIsDragging(false);\n    setDragSourceIndex(null);\n    setDragTargetIndex(null);\n\n    if (sourceIndex === null || targetIndex === null || sourceIndex === targetIndex) return;\n\n    const newModels = [...currentModels];\n    const [removed] = newModels.splice(sourceIndex, 1);\n    newModels.splice(targetIndex, 0, removed);\n\n    await saveModelOrder(newModels);\n  }, [isDragging, dragSourceIndex, dragTargetIndex, currentModels, saveModelOrder]);\n\n  const handleUpdateTheme = async (newTheme: string) => {\n    setTheme(newTheme);\n    try {\n      await api.updateConfig({ ui: { theme: newTheme } });\n      localStorage.setItem('pa_theme', newTheme);\n      if (newTheme === 'default') {\n        document.documentElement.removeAttribute('data-theme');\n      } else {\n        document.documentElement.setAttribute('data-theme', newTheme);\n      }\n      await refetchConfig();\n      triggerSuccess();\n    } catch (err) {\n      console.error('Failed to update theme:', err);\n    }\n  };\n\n  const handleToggleAutoCompaction = async () => {\n    try {\n      const current = config?.agent?.auto_compaction_enabled !== false; // Default to true if undefined\n      await api.updateConfig({ agent: { auto_compaction_enabled: !current } });\n      await refetchConfig();\n      triggerSuccess();\n    } catch (err) {\n      console.error('Failed to toggle auto-compaction:', err);\n    }\n  };\n\n  const handleSetApiKey = async () => {\n    if (!newKey.provider || !newKey.key) return;\n    setIsSaving(true);\n    try {\n      await api.setApiKey(newKey.provider, newKey.key);\n      setNewKey({ provider: '', key: '' });\n      await queryClient.invalidateQueries({ queryKey: ['apiKeys'] });\n      triggerSuccess();\n    } catch (err) {\n      console.error('Failed to set API key:', err);\n    } finally {\n      setIsSaving(false);\n    }\n  };\n\n  const handleSaveCustomBaseUrl = async () => {\n    if (!customBaseUrl.trim() || !editingProvider) return;\n    setIsSaving(true);\n    try {\n      const updatedCustomProviders = {\n        ...(config?.custom_providers || {}),\n        [editingProvider]: { base_url: customBaseUrl.trim() }\n      };\n      await api.updateConfig({ custom_providers: updatedCustomProviders });\n      await queryClient.invalidateQueries({ queryKey: ['config'] });\n      triggerSuccess();\n    } catch (err) {\n      console.error('Failed to update custom provider base URL:', err);\n    } finally {\n      setIsSaving(false);\n    }\n  };\n\n  const handleRemoveApiKey = async (provider: string) => {\n    const confirmed = await ask(`Are you sure you want to wipe the API key for ${provider.toUpperCase()}? This will prevent agents from using this provider until a new key is registered.`, {\n      title: 'Wipe API Key',\n      kind: 'warning',\n    });\n\n    if (!confirmed) return;\n\n    try {\n      await api.removeApiKey(provider);\n      await queryClient.invalidateQueries({ queryKey: ['apiKeys'] });\n    } catch (err) {\n      console.error('Failed to remove API key:', err);\n    }\n  };\n\n  const handleToggleProvider = async (provider: string, currentEnabled: boolean) => {\n    setIsSaving(true);\n    try {\n      const updatedProviders = {\n        ...(config?.providers || {}),\n        [provider]: { enabled: !currentEnabled }\n      };\n      await api.updateConfig({ providers: updatedProviders });\n      await queryClient.invalidateQueries({ queryKey: ['config'] });\n      await queryClient.invalidateQueries({ queryKey: ['apiKeys'] });\n      triggerSuccess();\n    } catch (err) {\n      console.error('Failed to toggle provider:', err);\n    } finally {\n      setIsSaving(false);\n    }\n  };\n\n  const handleSetVaultSecret = async () => {\n    if (!newVaultSecret.name || !newVaultSecret.value) return;\n    setIsSaving(true);\n    try {\n      await api.setVaultSecret(newVaultSecret.name, newVaultSecret.value);\n      setNewVaultSecret({ name: '', value: '' });\n      await refetchVault();\n      triggerSuccess();\n    } catch (err) {\n      console.error('Failed to set vault secret:', err);\n    } finally {\n      setIsSaving(false);\n    }\n  };\n\n  const handleRemoveVaultSecret = async (name: string) => {\n    const confirmed = await ask(`Are you sure you want to delete the secret \"${name}\"? This cannot be undone.`, {\n      title: 'Delete Secret',\n      kind: 'warning',\n    });\n\n    if (!confirmed) return;\n\n    try {\n      await api.removeVaultSecret(name);\n      refetchVault();\n    } catch (err) {\n      console.error('Failed to remove vault secret:', err);\n    }\n  };\n\n  const themes = [\n    { id: 'default', name: 'Matrix Dark', colors: 'bg-[#181c21]', accent: 'bg-[#22d3ee]' },\n    { id: 'light', name: 'Paper White', colors: 'bg-[#f2f2f2]', accent: 'bg-[#2563eb]' },\n    { id: 'cobalt2', name: 'Cobalt2', colors: 'bg-[#193549]', accent: 'bg-[#ffc600]' },\n    { id: 'nerv', name: 'NERV HQ', colors: 'bg-[#1c1c1c]', accent: 'bg-[#ff9500]' },\n  ];\n\n  return (\n    <div className=\"flex h-full bg-background font-mono text-[13px] overflow-hidden\">\n      {/* Main Content Area */}\n      <div className=\"flex-1 flex flex-col min-w-0 bg-background relative\">\n        <div className=\"flex-1 overflow-auto p-8 custom-scrollbar relative\" ref={scrollRef}>\n          <div className=\"max-w-4xl mx-auto pb-20\">\n            {activeTab === 'models' && (\n              <div className=\"space-y-8 animate-in fade-in slide-in-from-bottom-2 duration-300 font-mono\">\n                {/* Model Registry Section */}\n                <section className=\"space-y-3\">\n                  <div className=\"flex flex-col gap-0.5\">\n                    <div className=\"flex items-center gap-2 text-accent/80\">\n                      <h2 className=\"text-[12px] font-black uppercase tracking-[0.2em]\">Provider Configuration</h2>\n                    </div>\n                    <p className=\"text-[10px] text-text-tertiary/60 italic leading-normal font-black tracking-tight\">\n                      LLM providers and endpoints. Credentials stored in system keychain.\n                    </p>\n                  </div>\n\n                  <div className=\"flex flex-col md:flex-row bg-surface/5 border border-border/10 overflow-hidden min-h-[450px]\">\n                    {/* Left Sidebar: Providers */}\n                    <div className=\"w-full md:w-48 border-b md:border-b-0 md:border-r border-border/10 bg-background/20 flex flex-col font-mono\">\n                      <div className=\"p-3 border-b border-border/10 bg-background/10\">\n                        <span className=\"text-[10px] font-black text-accent/60 uppercase tracking-[0.2em]\">Index</span>\n                      </div>\n                      <div className=\"flex-1 overflow-auto p-1.5 space-y-0.5 custom-scrollbar\">\n                        <div className=\"px-2 pb-1\">\n                          <span className=\"text-[8px] font-black text-text-tertiary/30 uppercase tracking-widest\">Cloud</span>\n                        </div>\n                        {cloudProviders.map(p => {\n                          const providerData = apiKeys?.find(k => k.provider.toLowerCase() === p.toLowerCase());\n                          const isConfigured = providerData?.configured;\n                          const isEnabled = providerData?.enabled === true;\n                          return (\n                            <button\n                              key={p}\n                              onClick={() => {\n                                setEditingProvider(p);\n                                setNewKey(prev => ({ ...prev, provider: p }));\n                              }}\n                              className={clsx(\n                                \"w-full px-2 py-1 text-left text-[11px] font-black uppercase transition-all flex items-center justify-between\",\n                                editingProvider === p\n                                  ? \"text-accent\"\n                                  : \"text-text-tertiary/60 hover:text-text-secondary hover:translate-x-0.5\",\n                                !isEnabled && \"opacity-40\"\n                              )}\n                            >\n                              <div className=\"flex items-center gap-2\">\n                                <span className=\"w-2\">{editingProvider === p ? '>' : ' '}</span>\n                                <span className=\"truncate\">{p}</span>\n                              </div>\n                              <div className={clsx(\n                                \"w-1 h-1 rounded-full\",\n                                isConfigured ? \"bg-status-success animate-pulse\" : \"bg-status-error/40\"\n                              )} />\n                            </button>\n                          );\n                        })}\n\n                        <div className=\"pt-4 mt-2\">\n                          <div className=\"px-2 pb-1 flex items-center justify-between\">\n                            <span className=\"text-[8px] font-black text-text-tertiary/30 uppercase tracking-widest\">Custom</span>\n                            <button\n                              onClick={() => setIsAddingCustomProvider(true)}\n                              className=\"text-accent/60 hover:text-accent transition-colors text-[10px]\"\n                            >\n                              [+]\n                            </button>\n                          </div>\n\n                          {isAddingCustomProvider && (\n                            <div className=\"px-1.5 py-1 space-y-1\">\n                              <input\n                                autoFocus\n                                type=\"text\"\n                                placeholder=\"NAME...\"\n                                value={newCustomProviderName}\n                                onChange={(e) => setNewCustomProviderName(e.target.value.toLowerCase().replace(/[^a-z0-9_-]/g, ''))}\n                                onKeyDown={(e) => {\n                                  if (e.key === 'Enter') handleAddCustomProvider();\n                                  if (e.key === 'Escape') setIsAddingCustomProvider(false);\n                                }}\n                                className=\"w-full bg-transparent border-b border-accent/20 px-1 py-0.5 text-[10px] text-text-primary focus:outline-none font-mono uppercase\"\n                              />\n                              <div className=\"flex gap-1\">\n                                  <button\n                                    onClick={handleAddCustomProvider}\n                                    className=\"flex-1 py-0.5 text-accent text-[9px] font-black border border-accent/20 hover:bg-accent/5\"\n                                  >\n                                    Add\n                                  </button>\n                                  <button\n                                    onClick={() => setIsAddingCustomProvider(false)}\n                                    className=\"flex-1 py-0.5 text-text-tertiary/60 text-[9px] font-black border border-border/10 hover:bg-surface/10\"\n                                  >\n                                    Cancel\n                                  </button>\n                              </div>\n                            </div>\n                          )}\n\n                          {userCustomProvidersList.map(p => {\n                            const providerData = apiKeys?.find(k => k.provider.toLowerCase() === p.toLowerCase());\n                            const isConfigured = providerData?.configured;\n                            const isEnabled = providerData?.enabled === true;\n                            return (\n                              <button\n                                key={p}\n                                onClick={() => {\n                                  setEditingProvider(p);\n                                  setNewKey(prev => ({ ...prev, provider: p }));\n                                }}\n                                className={clsx(\n                                  \"w-full px-2 py-1 text-left text-[11px] font-black uppercase transition-all flex items-center justify-between\",\n                                  editingProvider === p\n                                    ? \"text-accent\"\n                                    : \"text-text-tertiary/60 hover:text-text-secondary hover:translate-x-0.5\",\n                                  !isEnabled && \"opacity-40\"\n                                )}\n                              >\n                                <div className=\"flex items-center gap-2\">\n                                  <span className=\"w-2\">{editingProvider === p ? '>' : ' '}</span>\n                                  <span className=\"truncate\">{p}</span>\n                                </div>\n                                <div className={clsx(\n                                  \"w-1 h-1 rounded-full\",\n                                  isConfigured ? \"bg-status-success animate-pulse\" : \"bg-status-error/40\"\n                                )} />\n                              </button>\n                            );\n                          })}\n                        </div>\n\n                        <div className=\"pt-4 mt-2\">\n                          <div className=\"px-2 pb-1\">\n                            <span className=\"text-[8px] font-black text-text-tertiary/30 uppercase tracking-widest\">Local</span>\n                          </div>\n\n                          <div className=\"space-y-0.5\">\n                            {localProviders.map(p => {\n                              const isEnabled = apiKeys?.find(k => k.provider.toLowerCase() === p.toLowerCase())?.enabled === true;\n                              return (\n                                <button\n                                  key={p}\n                                  onClick={() => {\n                                    setNewKey(prev => ({ ...prev, provider: p }));\n                                    setEditingProvider(p);\n                                  }}\n                                  className={clsx(\n                                    \"w-full px-2 py-1 text-left text-[11px] font-black uppercase transition-all flex items-center justify-between\",\n                                    editingProvider === p\n                                      ? \"text-accent\"\n                                      : \"text-text-tertiary/60 hover:text-text-secondary hover:translate-x-0.5\",\n                                    !isEnabled && \"opacity-40\"\n                                  )}\n                                >\n                                  <div className=\"flex items-center gap-2\">\n                                    <span className=\"w-2\">{editingProvider === p ? '>' : ' '}</span>\n                                    <span className=\"truncate\">{p}</span>\n                                  </div>\n                                  <div className=\"w-1 h-1 rounded-full bg-status-success animate-pulse\" />\n                                </button>\n                              );\n                            })}\n                          </div>\n                        </div>\n                      </div>\n                    </div>\n\n                    {/* Right Panel: Skills and Models */}\n                    <div className=\"flex-1 flex flex-col bg-background/5 font-mono\">\n                      {!editingProvider ? (\n                        <div className=\"flex-1 flex flex-col items-center justify-center text-text-tertiary/20 space-y-2\">\n                          <span className=\"text-[10px] uppercase font-black tracking-[0.2em]\">Select a provider</span>\n                          <div className=\"animate-pulse\">_</div>\n                        </div>\n                      ) : (\n                        <div className=\"flex-1 overflow-auto p-5 space-y-8 custom-scrollbar\">\n                          {/* Provider Header & API Key Management */}\n                          <div className=\"space-y-4\">\n                            <div className=\"flex items-center justify-between border-b border-border/10 pb-3\">\n                              <div className=\"flex items-center gap-3\">\n                                <span className=\"text-[13px] font-black text-text-primary uppercase tracking-[0.1em]\">\n                                  {editingProvider}\n                                </span>\n                              </div>\n\n                              <div className=\"flex items-center gap-2\">\n                                {(() => {\n                                  const providerData = apiKeys?.find(k => k.provider.toLowerCase() === editingProvider.toLowerCase());\n                                  const isEnabled = providerData?.enabled === true;\n\n                                  return (\n                                    <button\n                                      onClick={() => handleToggleProvider(editingProvider, isEnabled)}\n                                      className={clsx(\n                                        \"text-[9px] font-black px-2 py-0.5 transition-all tracking-widest uppercase border active:scale-95\",\n                                        isEnabled\n                                          ? \"text-status-success border-status-success/20 hover:bg-status-success/5\"\n                                          : \"text-status-error border-status-error/20 hover:bg-status-error/5\"\n                                      )}\n                                    >\n                                      {isEnabled ? 'On' : 'Off'}\n                                    </button>\n                                  );\n                                })()}\n\n                                {userCustomProvidersList.includes(editingProvider) && (\n                                  <button\n                                    onClick={() => handleRemoveCustomProvider(editingProvider)}\n                                    className=\"text-[9px] text-text-tertiary/40 hover:text-status-error transition-all uppercase font-black px-2 py-0.5 border border-border/10 hover:bg-status-error/5 active:scale-95\"\n                                  >\n                                    Delete\n                                  </button>\n                                )}\n\n                                {apiKeys?.find(k => k.provider.toLowerCase() === editingProvider.toLowerCase())?.configured && !localProvidersList.includes(editingProvider.toLowerCase()) && (\n                                  <button\n                                    onClick={() => handleRemoveApiKey(editingProvider)}\n                                    className=\"text-[9px] text-text-tertiary/40 hover:text-status-error transition-all uppercase font-black px-2 py-0.5 border border-border/10 hover:bg-status-error/5 active:scale-95\"\n                                  >\n                                    Wipe Key\n                                  </button>\n                                )}\n                              </div>\n                            </div>\n\n                            {/* API Key Input */}\n                            {!localProvidersList.includes(editingProvider.toLowerCase()) ? (\n                              <div className=\"space-y-2\">\n                                <div className=\"flex flex-col gap-0.5\">\n                                  <div className=\"flex items-center gap-2\">\n                                    <span className=\"text-[9px] font-black text-text-tertiary/60 uppercase tracking-widest\">API Key</span>\n                                  </div>\n                                </div>\n                                <div className=\"flex flex-col sm:flex-row gap-2\">\n                                  <div className=\"flex-1 relative\">\n                                    <input\n                                      type=\"password\"\n                                      placeholder=\"Paste key...\"\n                                      value={newKey.key}\n                                      onChange={(e) => setNewKey(prev => ({ ...prev, key: e.target.value }))}\n                                      onKeyDown={(e) => e.key === 'Enter' && handleSetApiKey()}\n                                      className=\"w-full bg-transparent border-b border-border/10 px-0 py-1 text-[11px] text-text-primary focus:outline-none focus:border-accent/40 font-mono transition-all uppercase\"\n                                    />\n                                  </div>\n                                  <button\n                                    onClick={handleSetApiKey}\n                                    disabled={isSaving || !newKey.key}\n                                    className=\"px-3 py-1 text-accent hover:text-accent-hover font-black text-[10px] uppercase tracking-widest transition-all disabled:opacity-20\"\n                                  >\n                                    Register\n                                  </button>\n                                </div>\n                              </div>\n                            ) : (\n                              <div className=\"text-[9px] text-accent/40 font-black uppercase tracking-widest\">\n                                Local provider - no authentication required\n                              </div>\n                            )}\n                          </div>\n\n                          {userCustomProvidersList.includes(editingProvider) && (\n                            <div className=\"space-y-2\">\n                              <div className=\"flex flex-col gap-0.5\">\n                                <span className=\"text-[9px] font-black text-text-tertiary/60 uppercase tracking-widest\">Endpoint URL</span>\n                              </div>\n                              <div className=\"flex flex-col sm:flex-row gap-2\">\n                                <div className=\"flex-1 relative\">\n                                  <input\n                                    type=\"text\"\n                                    placeholder=\"https://api.provider.com/v1\"\n                                    value={customBaseUrl}\n                                    onChange={(e) => setCustomBaseUrl(e.target.value)}\n                                    onKeyDown={(e) => e.key === 'Enter' && handleSaveCustomBaseUrl()}\n                                    className=\"w-full bg-transparent border-b border-border/10 px-0 py-1 text-[11px] text-text-primary focus:outline-none focus:border-accent/40 font-mono transition-all\"\n                                  />\n                                </div>\n                                <button\n                                  onClick={handleSaveCustomBaseUrl}\n                                  disabled={isSaving || !customBaseUrl.trim()}\n                                  className=\"px-3 py-1 text-accent hover:text-accent-hover font-black text-[10px] uppercase tracking-widest transition-all disabled:opacity-20\"\n                                >\n                                  [SAVE]\n                                </button>\n                              </div>\n                            </div>\n                          )}\n\n                          {/* Model Registry Content */}\n                          <div className=\"space-y-6\">\n                            <div className=\"flex items-center justify-between\">\n                              <span className=\"text-[9px] font-black text-text-tertiary/60 uppercase tracking-widest\">Models</span>\n                              {localProvidersList.includes(editingProvider?.toLowerCase() || '') && (\n                                <button\n                                  onClick={() => editingProvider && handleFetchModels(editingProvider)}\n                                  disabled={isFetchingModels}\n                                  className={clsx(\n                                    \"text-[9px] font-black uppercase tracking-widest transition-all\",\n                                    isFetchingModels ? \"text-text-tertiary/20 animate-pulse\" : \"text-accent hover:text-accent-hover\"\n                                  )}\n                                >\n                                  {isFetchingModels ? 'Discovering...' : 'Discover local models'}\n                                </button>\n                              )}\n                            </div>\n\n                            {['chat'].map(cap => {\n                              const models = availableModels[editingProvider]?.[cap] || [];\n                              const isEditing = editingCapability === cap;\n\n                              const isOpenRouter = editingProvider?.toLowerCase() === 'openrouter';\n                              const supportsThinking = thinkingProviders.includes(editingProvider?.toLowerCase() || '');\n\n                              return (\n                                <div key={cap} className=\"space-y-1\">\n                                  {/* Column headers */}\n                                  {(supportsThinking || isOpenRouter) && models.length > 0 && (\n                                    <div className=\"flex items-center gap-2 px-2 py-1 border-b border-border/10\">\n                                      <div className=\"w-6\" /> {/* Spacer for drag handle */}\n                                      <span className=\"flex-1 text-[8px] font-black text-text-tertiary/40 uppercase tracking-widest\">MODEL NAME</span>\n                                      {isOpenRouter && (\n                                        <span className=\"text-[8px] font-black text-text-tertiary/40 uppercase tracking-widest w-24 text-right\">PRICING (INPUT/OUTPUT per 1M TOK)</span>\n                                      )}\n                                      {supportsThinking && (\n                                        <span className=\"text-[8px] font-black text-text-tertiary/40 uppercase tracking-widest w-20 text-right\">REASONING</span>\n                                      )}\n                                      <div className=\"w-6\" /> {/* Spacer for delete button */}\n                                    </div>\n                                  )}\n                                  <div\n                                    ref={containerRef}\n                                    className=\"flex flex-col gap-0.5 min-h-[50px]\"\n                                  >\n                                    {models.map((model, index) => {\n                                      const { baseModel, level } = parseModelLevel(model);\n                                      // Use baseModel for pricing lookup since pricing is stored by base model name\n                                      const pricing = isOpenRouter && config?.model_pricing?.['openrouter']?.[cap]?.[baseModel];\n\n                                      return (\n                                        <div\n                                          key={model}\n                                          ref={el => { itemRefs.current[index] = el; }}\n                                          className={clsx(\n                                            \"flex items-center justify-between px-2 py-1 border-b border-border/5 group transition-all relative select-none gap-2\",\n                                            isDragging && dragSourceIndex === index && \"opacity-50\",\n                                            isDragging && dragTargetIndex === index && dragSourceIndex !== index && \"border-t border-accent\"\n                                          )}\n                                        >\n                                          {/* Drag handle */}\n                                          <div\n                                            className=\"text-text-tertiary/20 hover:text-accent transition-all cursor-grab active:cursor-grabbing p-1 -m-1 touch-none shrink-0\"\n                                            onPointerDown={(e) => handlePointerDown(e, index)}\n                                            onPointerMove={handlePointerMove}\n                                            onPointerUp={handlePointerUp}\n                                            onPointerCancel={handlePointerUp}\n                                          >\n                                            <span className=\"text-[8px] font-black\">{index === 0 ? '@' : '#'}</span>\n                                          </div>\n\n                                          {/* Model name */}\n                                          <div className=\"flex-1 min-w-0\">\n                                            <span className={clsx(\n                                              \"text-[10px] transition-colors truncate font-mono uppercase block\",\n                                              index === 0 ? \"text-accent font-black\" : \"text-text-primary/60 group-hover:text-text-primary\"\n                                            )}>{baseModel}</span>\n                                          </div>\n\n                                          {/* Pricing column for OpenRouter */}\n                                          {isOpenRouter && (\n                                            <div className=\"text-[9px] text-text-tertiary/60 font-mono text-right shrink-0 w-24\">\n                                              {pricing ? (\n                                                <span>${pricing.prompt.toFixed(2)}/${pricing.completion.toFixed(2)}</span>\n                                              ) : (\n                                                <span className=\"text-text-tertiary/20\">—</span>\n                                              )}\n                                            </div>\n                                          )}\n\n                                          {/* Reasoning level dropdown */}\n                                          {supportsThinking && (\n                                            <select\n                                              value={level}\n                                              onChange={(e) => handleUpdateModelLevel(model, e.target.value as typeof level)}\n                                              className={clsx(\n                                                \"bg-transparent border px-1.5 py-0.5 text-[9px] font-black uppercase cursor-pointer transition-all shrink-0 w-20\",\n                                                level\n                                                  ? \"text-status-success border-status-success/30 bg-status-success/5\"\n                                                  : \"text-text-tertiary/50 border-border/20 hover:border-border/40\"\n                                              )}\n                                              style={{ WebkitAppearance: 'none', appearance: 'none', paddingRight: '16px', backgroundImage: 'url(\"data:image/svg+xml,%3csvg xmlns=%27http://www.w3.org/2000/svg%27 fill=%27none%27 viewBox=%270 0 24 24%27 stroke=%27%23666%27%3e%3cpath stroke-linecap=%27round%27 stroke-linejoin=%27round%27 stroke-width=%272%27 d=%27M19 9l-7 7-7-7%27/%3e%3c/svg%3e\")', backgroundRepeat: 'no-repeat', backgroundPosition: 'right 2px center', backgroundSize: '10px' }}\n                                            >\n                                              {reasoningLevels.map(l => (\n                                                <option key={l.value} value={l.value}>{l.label}</option>\n                                              ))}\n                                            </select>\n                                          )}\n\n                                          {/* Remove button */}\n                                          <button\n                                            onClick={(e) => {\n                                              e.stopPropagation();\n                                              setEditingCapability(cap);\n                                              handleRemoveModel(model);\n                                            }}\n                                            className=\"text-text-tertiary/20 hover:text-status-error opacity-0 group-hover:opacity-100 transition-all text-[10px] font-black shrink-0\"\n                                          >\n                                            [X]\n                                          </button>\n                                        </div>\n                                      );\n                                    })}\n\n                                    {/* Inline Add Model Input */}\n                                    <div className=\"flex gap-2 group/input mt-1\">\n                                      <div className=\"flex-1 relative\">\n                                        <input\n                                          type=\"text\"\n                                          placeholder=\"Add model...\"\n                                          value={isEditing ? newModelName : ''}\n                                          onFocus={() => setEditingCapability(cap)}\n                                          onChange={(e) => {\n                                            setEditingCapability(cap);\n                                            setNewModelName(e.target.value);\n                                          }}\n                                          onKeyDown={(e) => e.key === 'Enter' && handleAddModel()}\n                                          className=\"w-full bg-transparent border-b border-dashed border-border/20 px-0 py-0.5 text-[10px] text-text-primary placeholder:text-text-tertiary/20 focus:outline-none focus:border-accent/40 focus:border-solid font-mono transition-all uppercase\"\n                                        />\n                                      </div>\n                                      {isEditing && newModelName.trim() && (\n                                        <button\n                                          onClick={handleAddModel}\n                                          className=\"text-accent text-[10px] font-black\"\n                                        >\n                                          [+]\n                                        </button>\n                                      )}\n                                    </div>\n                                  </div>\n                                </div>\n                              );\n                            })}\n                          </div>\n                        </div>\n                      )}\n                    </div>\n                  </div>\n                </section>\n              </div>\n            )}\n\n            {activeTab === 'general' && (\n              <div className=\"space-y-12 animate-in fade-in slide-in-from-bottom-2 duration-300 font-mono\">\n                <div className=\"grid grid-cols-1 gap-12\">\n                  {/* Agent Behavior Section */}\n                  <section className=\"space-y-3\">\n                    <div className=\"flex flex-col gap-0.5\">\n                      <div className=\"flex items-center gap-2 text-accent/80\">\n                        <h2 className=\"text-[12px] font-black uppercase tracking-[0.2em]\">Behavior</h2>\n                      </div>\n                      <p className=\"text-[10px] text-text-tertiary/60 italic leading-normal font-black tracking-tight\">\n                        Global execution and memory policies.\n                      </p>\n                    </div>\n\n                    <div className=\"bg-surface/5 border border-border/10 p-4 space-y-3 font-mono\">\n                      <div className=\"flex items-center justify-between border-b border-border/5 pb-3\">\n                        <div className=\"flex flex-col gap-0.5\">\n                          <div className=\"flex items-center gap-2\">\n                            <span className=\"text-[11px] font-black text-text-primary uppercase tracking-[0.2em]\">Auto-compaction</span>\n                          </div>\n                          <p className=\"text-[10px] text-text-tertiary/60 italic px-3 leading-normal font-black tracking-tight\">\n                            Reduce token overhead automatically at threshold.\n                          </p>\n                        </div>\n                        <button\n                          onClick={handleToggleAutoCompaction}\n                          className={clsx(\n                            \"text-[10px] font-black px-2 py-1 transition-all tracking-widest uppercase active:scale-95\",\n                            config?.agent?.auto_compaction_enabled !== false\n                              ? \"text-status-success hover:bg-status-success/5\"\n                              : \"text-status-error hover:bg-status-error/5\"\n                          )}\n                        >\n                          {config?.agent?.auto_compaction_enabled !== false ? 'Active' : 'Inactive'}\n                        </button>\n                      </div>\n                    </div>\n                  </section>\n\n                  {/* Sub-Agent Ecosystem */}\n                  <section className=\"space-y-4\">\n                    <div className=\"flex flex-col gap-0.5\">\n                      <div className=\"flex items-center justify-between\">\n                        <div className=\"flex items-center gap-2 text-accent/80\">\n                          <h2 className=\"text-[12px] font-black uppercase tracking-[0.2em]\">Sub-agents</h2>\n                        </div>\n                        <button\n                          onClick={handleToggleSubAgentsGlobal}\n                          className={clsx(\n                            \"text-[10px] font-black px-2 py-0.5 transition-all tracking-widest uppercase border active:scale-95 font-mono\",\n                            config?.sub_agent?.enabled\n                              ? \"text-status-success border-status-success/20 hover:bg-status-success/5\"\n                              : \"text-status-error border-status-error/20 hover:bg-status-error/5\"\n                          )}\n                        >\n                          {config?.sub_agent?.enabled ? 'Enabled' : 'Disabled'}\n                        </button>\n                      </div>\n                      <p className=\"text-[10px] text-text-tertiary/60 italic leading-normal font-black tracking-tight\">\n                        Autonomous child-agents for specialized task processing.\n                      </p>\n                    </div>\n\n                    <div className={clsx(\n                      \"flex flex-col gap-4 transition-opacity duration-300 font-mono\",\n                      !config?.sub_agent?.enabled && \"opacity-30 pointer-events-none grayscale\"\n                    )}>\n                      {/* Configuration Controls */}\n                      <div className=\"flex flex-col gap-4\">\n\n\n                        <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                          {/* Claude Code */}\n                          <div className=\"bg-surface/5 border border-border/10 p-4 space-y-3\">\n                            <div className=\"flex items-center justify-between\">\n                              <div className=\"flex items-center gap-2\">\n                                <span className=\"text-[11px] font-black uppercase tracking-widest text-text-primary\">Claude Code</span>\n                                {status?.components?.claude === 'ok' && status?.auth?.claude?.startsWith('ok') && (\n                                  <span className=\"text-[8px] font-black text-status-success uppercase\">Ready</span>\n                                )}\n                              </div>\n                              <button\n                                onClick={() => handleToggleCLIEnabled('claude_code')}\n                                className={clsx(\n                                  \"text-[9px] font-black px-1.5 py-0.5 transition-all border active:scale-95\",\n                                  config?.sub_agent?.claude_code?.enabled\n                                    ? \"text-status-success border-status-success/20 hover:bg-status-success/5\"\n                                    : \"text-text-tertiary/40 border-border/10 hover:text-text-secondary\"\n                                )}\n                              >\n                                {config?.sub_agent?.claude_code?.enabled ? 'On' : 'Off'}\n                              </button>\n                            </div>\n\n                            <div className=\"space-y-3\">\n                              <div className=\"space-y-1\">\n                                <label className=\"text-[9px] font-black text-text-tertiary/40 uppercase tracking-widest ml-1\">Tools</label>\n                                <input\n                                  type=\"text\"\n                                  defaultValue={config?.sub_agent?.claude_code?.allowed_tools?.join(', ')}\n                                  onBlur={(e) => handleUpdateClaudeTools(e.target.value)}\n                                  placeholder=\"Edit, Bash, Read...\"\n                                  className=\"w-full bg-transparent border-b border-border/10 px-0 py-1 text-[10px] text-text-primary focus:outline-none focus:border-accent/40 font-mono transition-all uppercase\"\n                                />\n                              </div>\n                            </div>\n                          </div>\n\n                          {/* Codex */}\n                          <div className=\"bg-surface/5 border border-border/10 p-4 space-y-3\">\n                            <div className=\"flex items-center justify-between\">\n                              <div className=\"flex items-center gap-2\">\n                                <span className=\"text-[11px] font-black uppercase tracking-widest text-text-primary\">Codex</span>\n                                {status?.components?.codex === 'ok' && status?.auth?.codex?.startsWith('ok') && (\n                                  <span className=\"text-[8px] font-black text-status-success uppercase\">Ready</span>\n                                )}\n                              </div>\n                              <button\n                                onClick={() => handleToggleCLIEnabled('codex')}\n                                className={clsx(\n                                  \"text-[9px] font-black px-1.5 py-0.5 transition-all border active:scale-95\",\n                                  config?.sub_agent?.codex?.enabled\n                                    ? \"text-status-success border-status-success/20 hover:bg-status-success/5\"\n                                    : \"text-text-tertiary/40 border-border/10 hover:text-text-secondary\"\n                                )}\n                              >\n                                {config?.sub_agent?.codex?.enabled ? 'On' : 'Off'}\n                              </button>\n                            </div>\n\n                            <div className=\"space-y-3\">\n                              <div className=\"space-y-1\">\n                                <label className=\"text-[9px] font-black text-text-tertiary/40 uppercase tracking-widest ml-1\">Approval</label>\n                                <div className=\"flex gap-1\">\n                                  {['untrusted', 'on-failure', 'on-request', 'never'].map((mode) => (\n                                    <button\n                                      key={mode}\n                                      onClick={() => handleUpdateCodexMode(mode)}\n                                      className={clsx(\n                                        \"flex-1 py-1 text-[8px] font-black uppercase border transition-all active:scale-95\",\n                                        config?.sub_agent?.codex?.approval_mode?.toLowerCase() === mode.toLowerCase()\n                                          ? \"text-accent border-accent/40 bg-accent/5\"\n                                          : \"border-border/10 text-text-tertiary/40 hover:text-text-secondary hover:bg-surface/5\"\n                                      )}\n                                    >\n                                      {config?.sub_agent?.codex?.approval_mode?.toLowerCase() === mode.toLowerCase() \n                                        ? `[${mode.toUpperCase().replace('-', '_')}]` \n                                        : mode.toUpperCase().replace('-', '_')}\n                                    </button>\n                                  ))}\n                                </div>\n                              </div>\n                            </div>\n                          </div>\n                        </div>\n                      </div>\n                    </div>\n                  </section>\n                </div>\n              </div>\n            )\n            }\n\n            {activeTab === 'security' && (\n              <div className=\"space-y-12 animate-in fade-in slide-in-from-bottom-2 duration-300 font-mono\">\n                {/* Unrestricted Execution Mode Toggle */}\n                <div className={clsx(\n                  \"p-4 border transition-all duration-500\",\n                  config?.security?.always_allow_all\n                    ? \"bg-status-error text-background border-status-error shadow-[0_0_25px_rgba(var(--status-error),0.2)]\"\n                    : \"bg-status-error/5 border-status-error/10\"\n                )}>\n                  <div className=\"flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4\">\n                    <div className=\"flex flex-col gap-1 pr-4\">\n                      <div className=\"flex items-center gap-2\">\n                        <span className={clsx(\n                          \"text-[11px] font-black uppercase tracking-[0.2em]\",\n                          config?.security?.always_allow_all ? \"text-background\" : \"text-status-error\"\n                        )}>Unrestricted Execution</span>\n                        {config?.security?.always_allow_all && (\n                          <span className=\"text-[8px] font-black bg-background text-status-error px-1 py-0.5 animate-pulse tracking-widest\">System unlocked</span>\n                        )}\n                      </div>\n                      <p className={clsx(\n                        \"text-[9px] italic leading-relaxed max-w-2xl font-black uppercase tracking-tight\",\n                        config?.security?.always_allow_all ? \"text-background/90\" : \"text-text-tertiary/60\"\n                      )}>\n                        Bypass all security checks. Agents gain full unmonitored system access. Use only in trusted environments.\n                      </p>\n                    </div>\n                    <button\n                      onClick={handleToggleAlwaysAllowAll}\n                      className={clsx(\n                        \"text-[9px] font-black px-3 py-1.5 transition-all tracking-[0.1em] uppercase border whitespace-nowrap active:scale-95\",\n                        config?.security?.always_allow_all\n                          ? \"bg-background text-status-error border-background\"\n                          : \"bg-status-error text-background border-status-error\"\n                      )}\n                    >\n                      {config?.security?.always_allow_all ? 'Restore Security' : 'Disable Security'}\n                    </button>\n                  </div>\n                </div>\n\n                {/* Shell Execution Policy */}\n                <section className={clsx(\n                  \"space-y-3 transition-all duration-300\",\n                  config?.security?.always_allow_all && \"opacity-40 grayscale\"\n                )}>\n                  <div className=\"flex flex-col gap-0.5\">\n                    <div className=\"flex items-center justify-between\">\n                      <div className=\"flex items-center gap-2 text-accent/80\">\n                        <h2 className=\"text-[12px] font-black uppercase tracking-[0.2em]\">Shell Policy</h2>\n                      </div>\n                      {config?.security?.always_allow_all && (\n                        <span className=\"text-[8px] font-black text-status-error uppercase tracking-widest bg-status-error/10 px-1.5 py-0.5\">\n                          Overridden by unrestricted mode\n                        </span>\n                      )}\n                    </div>\n                    <p className=\"text-[10px] text-text-tertiary/60 italic leading-normal font-black tracking-tight\">\n                      Control auto-approval levels for terminal commands.\n                    </p>\n                  </div>\n\n                  <div className={clsx(\n                    \"bg-surface/5 border border-border/10 p-5 space-y-4\",\n                    config?.security?.always_allow_all && \"pointer-events-none\"\n                  )}>\n                    <div className=\"flex flex-col gap-0.5\">\n                      <span className=\"text-[11px] font-black text-text-primary uppercase tracking-[0.2em]\">Execution Mode</span>\n                    </div>\n\n                    <div className=\"grid grid-cols-2 sm:grid-cols-4 gap-2\">\n                      {[\n                        { id: 'restricted', label: 'RESTRICTED', desc: 'Minimal safe set' },\n                        { id: 'read-only', label: 'READ_ONLY', desc: 'All inspections' },\n                        { id: 'non-destructive', label: 'MUTABLE', desc: 'No deletions' },\n                        { id: 'unrestricted', label: 'OPEN', desc: 'No approvals' },\n                      ].map((mode) => (\n                        <button\n                          key={mode.id}\n                          onClick={() => handleUpdateShellPermissionMode(mode.id)}\n                          className={clsx(\n                            \"flex flex-col items-start p-3 border transition-all text-left group active:scale-[0.98]\",\n                            config?.security?.shell_permission_mode === mode.id\n                              ? \"border-accent bg-accent/5 shadow-[0_0_15px_rgba(var(--accent),0.05)]\"\n                              : \"border-border/10 hover:border-accent/40 bg-surface/5\"\n                          )}\n                        >\n                          <span className={clsx(\n                            \"text-[10px] font-black uppercase tracking-widest mb-1\",\n                            config?.security?.shell_permission_mode === mode.id ? \"text-accent\" : \"text-text-tertiary/60 group-hover:text-text-secondary\"\n                          )}>\n                            {config?.security?.shell_permission_mode === mode.id ? `[${mode.label}]` : `  ${mode.label}`}\n                          </span>\n                          <span className=\"text-[8px] text-text-tertiary/40 font-black uppercase leading-tight\">\n                            {mode.desc}\n                          </span>\n                        </button>\n                      ))}\n                    </div>\n                  </div>\n                </section>\n\n                {/* Vault Section */}\n                <section className=\"space-y-3\">\n                  <div className=\"flex flex-col gap-0.5\">\n                    <div className=\"flex items-center gap-2 text-accent/80\">\n                      <h2 className=\"text-[12px] font-black uppercase tracking-[0.2em]\">Secure Vault</h2>\n                    </div>\n                    <p className=\"text-[10px] text-text-tertiary/60 italic leading-normal font-black tracking-tight\">\n                      Protected tokens and environment variables.\n                    </p>\n                  </div>\n\n                  <div className=\"bg-surface/5 border border-border/10 p-5 space-y-6\">\n                    <div className=\"space-y-4\">\n                      <div className=\"flex flex-col gap-0.5\">\n                        <span className=\"text-[11px] font-black text-text-primary uppercase tracking-[0.2em]\">Vault Index</span>\n                        <p className=\"text-[10px] text-text-tertiary/60 italic px-3 font-black tracking-tight\">\n                          Access in tools via <code className=\"text-accent underline\">{\"{{vault:KEY}}\"}</code>.\n                        </p>\n                      </div>\n\n                      <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-2\">\n                        {vaultSecrets && vaultSecrets.length > 0 ? (\n                          vaultSecrets.map((secret: any) => (\n                            <div\n                              key={secret.name}\n                              className=\"flex items-center justify-between px-3 py-1.5 bg-background/20 border border-border/5 group hover:border-accent/20 transition-all\"\n                            >\n                              <div className=\"flex items-center gap-2\">\n                                <span className=\"text-[8px] font-black text-accent/40 uppercase\">[KEY]</span>\n                                <span className=\"text-[11px] font-black text-text-primary/70 font-mono truncate max-w-[120px]\">\n                                  {secret.name}\n                                </span>\n                              </div>\n                              <button\n                                onClick={() => handleRemoveVaultSecret(secret.name)}\n                                className=\"text-text-tertiary/20 hover:text-status-error opacity-0 group-hover:opacity-100 transition-all text-[10px] font-black\"\n                              >\n                                [X]\n                              </button>\n                            </div>\n                          ))\n                        ) : (\n                          <div className=\"col-span-full py-6 border border-dashed border-border/10 flex flex-col items-center justify-center text-text-tertiary/20\">\n                            <span className=\"text-[9px] uppercase font-black tracking-[0.2em]\">No secrets stored</span>\n                          </div>\n                        )}\n                      </div>\n\n                      {/* Add Secret Form */}\n                      <div className=\"mt-4 p-4 border-t border-border/5 space-y-3\">\n                        <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-4\">\n                          <div className=\"space-y-1\">\n                            <label className=\"text-[9px] font-black text-text-tertiary/40 uppercase tracking-widest ml-1\">Key</label>\n                            <input\n                              type=\"text\"\n                              placeholder=\"GITHUB_TOKEN\"\n                              value={newVaultSecret.name}\n                              onChange={(e) => setNewVaultSecret(prev => ({ ...prev, name: e.target.value.toUpperCase().replace(/[^A-Z0-9_]/g, '_') }))}\n                              className=\"w-full bg-transparent border-b border-border/10 px-0 py-1 text-[11px] text-text-primary focus:outline-none focus:border-accent/40 font-mono transition-all uppercase\"\n                            />\n                          </div>\n                          <div className=\"space-y-1\">\n                            <label className=\"text-[9px] font-black text-text-tertiary/40 uppercase tracking-widest ml-1\">Value</label>\n                            <input\n                              type=\"password\"\n                              placeholder=\"Secret value\"\n                              value={newVaultSecret.value}\n                              onChange={(e) => setNewVaultSecret(prev => ({ ...prev, value: e.target.value }))}\n                              className=\"w-full bg-transparent border-b border-border/10 px-0 py-1 text-[11px] text-text-primary focus:outline-none focus:border-accent/40 font-mono transition-all\"\n                            />\n                          </div>\n                        </div>\n                        <button\n                          onClick={handleSetVaultSecret}\n                          disabled={isSaving || !newVaultSecret.name || !newVaultSecret.value}\n                          className=\"w-full py-1 text-accent hover:text-accent-hover font-black text-[10px] uppercase tracking-widest transition-all disabled:opacity-20 active:scale-[0.98]\"\n                        >\n                          Store in Vault\n                        </button>\n                      </div>\n                    </div>\n                  </div>\n                </section>\n              </div>\n            )\n            }\n\n            {activeTab === 'shortcuts' && (\n              <div className=\"space-y-8 animate-in fade-in slide-in-from-bottom-2 duration-300 font-mono\">\n                {/* All Hotkeys Section */}\n                <section className=\"space-y-3\">\n                  <div className=\"flex flex-col gap-0.5\">\n                    <div className=\"flex items-center gap-2 text-accent/80\">\n                      <h2 className=\"text-[12px] font-black uppercase tracking-[0.2em]\">Shortcuts</h2>\n                    </div>\n                  </div>\n\n                  <div className=\"bg-surface/5 border border-border/10 p-5\">\n                    <div className=\"grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-1\">\n                      {Object.entries(hotkeyLabels).map(([key, label]) => (\n                        <div key={key} className=\"flex items-center justify-between py-1.5 border-b border-border/5 last:border-0 md:[&:nth-last-child(-n+2)]:border-0\">\n                          <span className=\"text-[10px] font-black text-text-tertiary/60 uppercase tracking-widest\">{label}</span>\n                          <button\n                            onClick={() => setRecordingHotkey(key)}\n                            className={clsx(\n                              \"font-mono text-[10px] font-black transition-all min-w-[90px] text-right\",\n                              recordingHotkey === key\n                                ? \"text-accent animate-pulse\"\n                                : \"text-accent/60 hover:text-accent\"\n                            )}\n                          >\n                            {recordingHotkey === key ? 'Recording...' : ((config?.ui as any)?.hotkeys?.[key] || hotkeyDefaults[key] || 'N/A')}\n                          </button>\n                        </div>\n                      ))}\n                    </div>\n                        <div className=\"mt-6 pt-3 border-t border-border/5\">\n                      <p className=\"text-[9px] text-text-tertiary/20 tracking-tighter italic font-black\">\n                        Press Escape to cancel. System reserved keys may override.\n                      </p>\n                    </div>\n                  </div>\n                </section>\n              </div>\n            )\n            }\n          </div >\n        </div >\n      </div >\n    </div >\n  );\n};\n","structuredPatch":[{"oldStart":671,"oldLines":22,"newStart":671,"newLines":6,"lines":["     await saveModelOrder(newModels);","   }, [isDragging, dragSourceIndex, dragTargetIndex, currentModels, saveModelOrder]);"," ","-  const handleUpdateTheme = async (newTheme: string) => {","-    setTheme(newTheme);","-    try {","-      await api.updateConfig({ ui: { theme: newTheme } });","-      localStorage.setItem('pa_theme', newTheme);","-      if (newTheme === 'default') {","-        document.documentElement.removeAttribute('data-theme');","-      } else {","-        document.documentElement.setAttribute('data-theme', newTheme);","-      }","-      await refetchConfig();","-      triggerSuccess();","-    } catch (err) {","-      console.error('Failed to update theme:', err);","-    }","-  };"," ","   const handleToggleAutoCompaction = async () => {","     try {"]}],"userModified":false,"replaceAll":false}}
{"parentUuid":"2539f56e-9b61-4f13-a56c-a500ad2b5127","isSidechain":false,"userType":"external","cwd":"/Users/patrick/workingdir/familiar","sessionId":"507f4396-f3e4-4a63-8b43-9c891e06f5ee","version":"2.0.76","gitBranch":"main","slug":"precious-crunching-toast","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01GynvDkXDWpPVaWbEh5FiXq","type":"tool_result","content":"The file /Users/patrick/workingdir/familiar/packages/desktop/ui/src/components/Agent/SettingsView.tsx has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n   780→      console.error('Failed to remove vault secret:', err);\n   781→    }\n   782→  };\n   783→\n   784→  return (\n   785→    <div className=\"flex h-full bg-background font-mono text-[13px] overflow-hidden\">\n   786→      {/* Main Content Area */}\n   787→      <div className=\"flex-1 flex flex-col min-w-0 bg-background relative\">\n   788→        <div className=\"flex-1 overflow-auto p-8 custom-scrollbar relative\" ref={scrollRef}>"}]},"uuid":"7a402b55-a291-402e-b83a-96c0419b8882","timestamp":"2026-01-03T02:41:11.482Z","toolUseResult":{"filePath":"/Users/patrick/workingdir/familiar/packages/desktop/ui/src/components/Agent/SettingsView.tsx","oldString":"  const themes = [\n    { id: 'default', name: 'Matrix Dark', colors: 'bg-[#181c21]', accent: 'bg-[#22d3ee]' },\n    { id: 'light', name: 'Paper White', colors: 'bg-[#f2f2f2]', accent: 'bg-[#2563eb]' },\n    { id: 'cobalt2', name: 'Cobalt2', colors: 'bg-[#193549]', accent: 'bg-[#ffc600]' },\n    { id: 'nerv', name: 'NERV HQ', colors: 'bg-[#1c1c1c]', accent: 'bg-[#ff9500]' },\n  ];\n\n  return (","newString":"  return (","originalFile":"import React, { useState, useEffect, useRef, useCallback } from 'react';\nimport { useQuery, useQueryClient } from '@tanstack/react-query';\nimport { useNavigate } from 'react-router-dom';\nimport { api } from '../../lib/api';\nimport { clsx } from 'clsx';\nimport { ask } from '@tauri-apps/plugin-dialog';\nimport { useSystem } from '../../context/SystemContext';\nimport { useAgents } from '../../context/AgentContext';\n\nexport const SettingsView: React.FC = () => {\n  const navigate = useNavigate();\n  const queryClient = useQueryClient();\n  const { setExplorerCollapsed } = useAgents();\n  const { data: config, refetch: refetchConfig } = useQuery({\n    queryKey: ['config'],\n    queryFn: () => api.getConfig(),\n  });\n\n  const { data: apiKeys, refetch: refetchKeys } = useQuery({\n    queryKey: ['apiKeys'],\n    queryFn: () => api.getApiKeys(),\n  });\n\n  const { data: vaultSecrets, refetch: refetchVault } = useQuery({\n    queryKey: ['vaultSecrets'],\n    queryFn: () => api.listVaultSecrets(),\n  });\n\n  const { data: status } = useQuery({\n    queryKey: ['status'],\n    queryFn: () => api.getStatus(),\n    refetchInterval: 5000,\n  });\n\n  const handleToggleAlwaysAllowAll = async () => {\n    const current = !!config?.security?.always_allow_all;\n    if (!current) {\n      const confirmed = await ask(\"WARNING: This will automatically approve ALL tool calls (including shell and browser) from ALL agents and sub-agents. This grants autonomous agents full control over your local system and web presence. Are you sure you want to disable all security oversight?\", {\n        title: \"Danger: Disable All Approvals\",\n        kind: \"error\",\n      });\n      if (!confirmed) return;\n    }\n\n    try {\n      await api.updateConfig({ security: { always_allow_all: !current } });\n      await refetchConfig();\n      triggerSuccess();\n    } catch (err) {\n      console.error('Failed to toggle always allow all:', err);\n    }\n  };\n\n  const handleUpdateShellPermissionMode = async (mode: string) => {\n    try {\n      await api.updateConfig({ security: { shell_permission_mode: mode } });\n      await refetchConfig();\n      triggerSuccess();\n    } catch (err) {\n      console.error('Failed to update shell permission mode:', err);\n    }\n  };\n\n  const handleToggleSubAgentsGlobal = async () => {\n    try {\n      const current = !!config?.sub_agent?.enabled;\n      await api.updateConfig({ sub_agent: { enabled: !current } });\n      await refetchConfig();\n      triggerSuccess();\n    } catch (err) {\n      console.error('Failed to toggle sub-agents globally:', err);\n    }\n  };\n\n\n\n  const handleToggleCLIEnabled = async (cli: 'claude_code' | 'codex') => {\n    try {\n      const current = !!config?.sub_agent?.[cli]?.enabled;\n      await api.updateConfig({ sub_agent: { [cli]: { enabled: !current } } });\n      await refetchConfig();\n      triggerSuccess();\n    } catch (err) {\n      console.error(`Failed to toggle ${cli}:`, err);\n    }\n  };\n\n  const handleUpdateClaudeTools = async (tools: string) => {\n    try {\n      const toolList = tools.split(',').map(t => t.trim()).filter(Boolean);\n      await api.updateConfig({ sub_agent: { claude_code: { allowed_tools: toolList } } });\n      await refetchConfig();\n      triggerSuccess();\n    } catch (err) {\n      console.error('Failed to update Claude tools:', err);\n    }\n  };\n\n  const handleUpdateCodexMode = async (mode: string) => {\n    try {\n      await api.updateConfig({ sub_agent: { codex: { approval_mode: mode } } });\n      await refetchConfig();\n      triggerSuccess();\n    } catch (err) {\n      console.error('Failed to update Codex mode:', err);\n    }\n  };\n\n  const [isSaving, setIsSaving] = useState(false);\n  const [showSuccess, setShowSuccess] = useState(false);\n  const [newKey, setNewKey] = useState<{ provider: string; key: string }>({ provider: '', key: '' });\n  const [newVaultSecret, setNewVaultSecret] = useState<{ name: string; value: string }>({ name: '', value: '' });\n  const [customBaseUrl, setCustomBaseUrl] = useState('');\n  const [isAddingCustomProvider, setIsAddingCustomProvider] = useState(false);\n  const [newCustomProviderName, setNewCustomProviderName] = useState('');\n\n  const [editingProvider, setEditingProvider] = useState<string | null>(null);\n  const [editingCapability, setEditingCapability] = useState<string>('chat');\n  const [newModelName, setNewModelName] = useState('');\n  const [isFetchingModels, setIsFetchingModels] = useState(false);\n  const { activeSettingsTab: activeTab } = useSystem();\n\n  const [recordingHotkey, setRecordingHotkey] = useState<string | null>(null);\n  const autoFetchedProviders = useRef<Set<string>>(new Set());\n\n  // Thinking configuration state - track which model is being edited\n  const [editingThinkingModel, setEditingThinkingModel] = useState<string | null>(null);\n\n  // Reasoning levels\n  type ReasoningLevel = '' | 'low' | 'medium' | 'high';\n  const reasoningLevels: { value: ReasoningLevel; label: string }[] = [\n    { value: '', label: 'None' },\n    { value: 'low', label: 'Low' },\n    { value: 'medium', label: 'Medium' },\n    { value: 'high', label: 'High' },\n  ];\n\n  // Helper to parse model string for reasoning level\n  // e.g., \"claude-haiku-4.5:thinking-high\" -> { baseModel: \"claude-haiku-4.5\", level: \"high\" }\n  const parseModelLevel = (model: string): { baseModel: string; level: ReasoningLevel } => {\n    for (const l of ['low', 'medium', 'high'] as ReasoningLevel[]) {\n      const suffix = `:thinking-${l}`;\n      if (model.endsWith(suffix)) {\n        return { baseModel: model.replace(suffix, ''), level: l };\n      }\n    }\n    // Legacy: :thinking without level = high\n    if (model.endsWith(':thinking')) {\n      return { baseModel: model.replace(':thinking', ''), level: 'high' };\n    }\n    return { baseModel: model, level: '' };\n  };\n\n  // Helper to build model string from base and level\n  const buildModelString = (baseModel: string, level: ReasoningLevel): string => {\n    if (level) {\n      return `${baseModel}:thinking-${level}`;\n    }\n    return baseModel;\n  };\n\n  // Providers that support thinking/reasoning\n  const thinkingProviders = ['openrouter', 'anthropic', 'openai', 'gemini'];\n\n  // Update a model's reasoning level\n  const handleUpdateModelLevel = async (oldModel: string, newLevel: ReasoningLevel) => {\n    if (!editingProvider || !editingCapability) return;\n\n    const { baseModel } = parseModelLevel(oldModel);\n    const newModel = buildModelString(baseModel, newLevel);\n\n    if (newModel === oldModel) return; // No change\n\n    const models = availableModels[editingProvider]?.[editingCapability] || [];\n    const updatedModels = models.map(m => m === oldModel ? newModel : m);\n\n    const updatedAvailableModels = {\n      ...availableModels,\n      [editingProvider]: {\n        ...(availableModels[editingProvider] || {}),\n        [editingCapability]: updatedModels\n      }\n    };\n\n    setIsSaving(true);\n    try {\n      await api.updateConfig({ available_models: updatedAvailableModels });\n      await refetchConfig();\n      triggerSuccess();\n    } catch (err) {\n      console.error('Failed to update model reasoning level:', err);\n    } finally {\n      setIsSaving(false);\n    }\n  };\n\n  useEffect(() => {\n    setExplorerCollapsed(false);\n  }, []);\n\n  const successTimeoutRef = useRef<ReturnType<typeof setTimeout> | null>(null);\n  const triggerSuccess = useCallback(() => {\n    setShowSuccess(true);\n    if (successTimeoutRef.current) clearTimeout(successTimeoutRef.current);\n    successTimeoutRef.current = setTimeout(() => setShowSuccess(false), 3000);\n  }, []);\n\n  useEffect(() => {\n    if (recordingHotkey) {\n      const handleGlobalKeyDown = (e: KeyboardEvent) => {\n        // Don't intercept if it's just a modifier key\n        if (['Control', 'Shift', 'Alt', 'Meta'].includes(e.key)) return;\n\n        e.preventDefault();\n        e.stopPropagation();\n\n        if (e.key === 'Escape') {\n          setRecordingHotkey(null);\n          return;\n        }\n\n        const modifiers = [];\n        if (e.metaKey) modifiers.push('Cmd');\n        else if (e.ctrlKey) modifiers.push('Ctrl');\n\n        if (e.shiftKey) modifiers.push('Shift');\n        if (e.altKey) modifiers.push('Alt');\n\n        let key = e.key;\n        if (key === ' ') key = 'Space';\n        if (key.length === 1) key = key.toUpperCase();\n\n        const hotkey = modifiers.length > 0 ? `${modifiers.join('+')}+${key}` : key;\n\n        handleUpdateHotkey(recordingHotkey, hotkey);\n        setRecordingHotkey(null);\n      };\n\n      window.addEventListener('keydown', handleGlobalKeyDown, true);\n      return () => window.removeEventListener('keydown', handleGlobalKeyDown, true);\n    }\n  }, [recordingHotkey, config]);\n\n  const handleUpdateHotkey = async (key: string, value: string) => {\n    const updatedHotkeys = { ...((config?.ui as any)?.hotkeys || {}), [key]: value };\n    try {\n      await api.updateConfig({ ui: { hotkeys: updatedHotkeys } });\n      await refetchConfig();\n      triggerSuccess();\n    } catch (err) {\n      console.error('Failed to update hotkey:', err);\n    }\n  };\n\n  const hotkeyDefaults: Record<string, string> = {\n    'global_back': 'Escape',\n    'new_agent': 'Cmd+N',\n    'focus_input': 'Cmd+L',\n    'toggle_sidebar': 'Cmd+B',\n    'toggle_settings': 'Cmd+,',\n    'toggle_pause': 'Cmd+P',\n    'compact': 'Cmd+Shift+C',\n    'toggle_unibar': 'Cmd+K',\n    'delete_agent': 'Cmd+D',\n    'toggle_explorer': 'Cmd+E',\n  };\n\n  const hotkeyLabels: Record<string, string> = {\n    'global_back': 'Global Back / Exit Dashboard',\n    'new_agent': 'Create New Agent (Dashboard)',\n    'focus_input': 'Focus Chat Input (Workspace)',\n    'toggle_sidebar': 'Toggle Sidebar (Workspace)',\n    'toggle_settings': 'Toggle Settings (Workspace)',\n    'toggle_pause': 'Toggle Pause/Resume',\n    'compact': 'Compact History (Workspace)',\n    'toggle_unibar': 'Omnibar / Command Palette',\n    'delete_agent': 'Delete Highlighted Agent (Dashboard)',\n    'toggle_explorer': 'Toggle Explorer Panel',\n  };\n\n  // Pointer-based drag state (bypasses Tauri's drag interception)\n  const [isDragging, setIsDragging] = useState(false);\n  const [dragSourceIndex, setDragSourceIndex] = useState<number | null>(null);\n  const [dragTargetIndex, setDragTargetIndex] = useState<number | null>(null);\n  const itemRefs = useRef<(HTMLDivElement | null)[]>([]);\n  const containerRef = useRef<HTMLDivElement>(null);\n  const scrollRef = useRef<HTMLDivElement>(null);\n\n  useEffect(() => {\n    const handleKeyDown = (e: KeyboardEvent) => {\n      // Don't scroll if we're recording a hotkey or typing in an input\n      if (recordingHotkey) return;\n\n      const activeElement = document.activeElement;\n      const isInput = activeElement instanceof HTMLInputElement ||\n        activeElement instanceof HTMLTextAreaElement ||\n        (activeElement as HTMLElement)?.isContentEditable;\n\n      if (isInput && !(e.metaKey || e.ctrlKey)) return;\n\n      if (e.key === 'ArrowUp') {\n        if (scrollRef.current) {\n          e.preventDefault();\n          scrollRef.current.scrollBy({ top: -100, behavior: 'smooth' });\n        }\n      }\n      if (e.key === 'ArrowDown') {\n        if (scrollRef.current) {\n          e.preventDefault();\n          scrollRef.current.scrollBy({ top: 100, behavior: 'smooth' });\n        }\n      }\n      if (e.key === ' ' && !isInput) {\n        if (scrollRef.current) {\n          e.preventDefault();\n          const direction = e.shiftKey ? -1 : 1;\n          scrollRef.current.scrollBy({\n            top: direction * scrollRef.current.clientHeight * 0.8,\n            behavior: 'smooth'\n          });\n        }\n      }\n    };\n\n    window.addEventListener('keydown', handleKeyDown);\n    return () => window.removeEventListener('keydown', handleKeyDown);\n  }, [recordingHotkey]);\n\n\n\n  useEffect(() => {\n    if (!editingProvider && config?.available_models && apiKeys) {\n      const availableModels = config.available_models;\n      const providers = Object.keys(availableModels);\n\n      // Preference order for default selection\n      const preference = ['openrouter', 'anthropic', 'openai', 'gemini'];\n      const defaultProvider = preference.find(p => providers.some(ap => ap.toLowerCase() === p));\n\n      if (defaultProvider) {\n        const matching = providers.find(p => p.toLowerCase() === defaultProvider);\n        if (matching) {\n          setEditingProvider(matching);\n          setNewKey(prev => ({ ...prev, provider: matching }));\n        }\n      } else if (providers.length > 0) {\n        setEditingProvider(providers[0]);\n        setNewKey(prev => ({ ...prev, provider: providers[0] }));\n      }\n    }\n  }, [config, editingProvider, apiKeys]);\n\n  useEffect(() => {\n    if (editingProvider && config?.custom_providers?.[editingProvider]) {\n      setCustomBaseUrl(config?.custom_providers[editingProvider].base_url || '');\n    } else {\n      setCustomBaseUrl('');\n    }\n  }, [editingProvider, config?.custom_providers]);\n\n  const availableModels = config?.available_models || {};\n  const localProvidersList = ['ollama', 'lmstudio'];\n  const standardProviders = ['openrouter', 'anthropic', 'openai', 'gemini', 'ollama', 'lmstudio'];\n\n  const handleFetchModels = useCallback(async (provider: string) => {\n    if (isFetchingModels) return;\n    setIsFetchingModels(true);\n    try {\n      const response = await api.fetchModels(provider);\n      if (response && response.models) {\n        const updatedAvailableModels = {\n          ...availableModels,\n          [provider]: {\n            ...(availableModels[provider] || {}),\n            chat: response.models\n          }\n        };\n\n        // If this is the active provider and has no model set, pick the first one\n        const updates: any = { available_models: updatedAvailableModels };\n        if (provider === config?.inference?.chat?.provider && (!config?.inference?.chat?.model || (availableModels[provider]?.chat?.length || 0) === 0)) {\n          if (response.models.length > 0) {\n            updates.inference = {\n              ...config.inference,\n              chat: {\n                ...config.inference.chat,\n                model: response.models[0]\n              }\n            };\n          }\n        }\n\n        await api.updateConfig(updates);\n        await refetchConfig();\n        triggerSuccess();\n      }\n    } catch (err) {\n      console.error('Failed to fetch models:', err);\n    } finally {\n      setIsFetchingModels(false);\n    }\n  }, [availableModels, config, isFetchingModels, refetchConfig, triggerSuccess]);\n\n  useEffect(() => {\n    if (editingProvider && localProvidersList.includes(editingProvider.toLowerCase())) {\n      const currentChatModels = availableModels[editingProvider]?.chat || [];\n      if (currentChatModels.length === 0 && !isFetchingModels && !autoFetchedProviders.current.has(editingProvider.toLowerCase())) {\n        autoFetchedProviders.current.add(editingProvider.toLowerCase());\n        handleFetchModels(editingProvider);\n      }\n    }\n  }, [editingProvider, availableModels, isFetchingModels, handleFetchModels]);\n\n  const allProviders = Object.keys(availableModels);\n  const cloudProviders = allProviders.filter(p => standardProviders.includes(p.toLowerCase()) && !localProvidersList.includes(p.toLowerCase()));\n  const localProviders = allProviders.filter(p => standardProviders.includes(p.toLowerCase()) && localProvidersList.includes(p.toLowerCase()));\n  const userCustomProvidersList = allProviders.filter(p => !standardProviders.includes(p.toLowerCase()));\n\n  const currentModels = (editingProvider && editingCapability) ? (availableModels[editingProvider]?.[editingCapability] || []) : [];\n  const hasCustomBaseUrl = !!customBaseUrl.trim();\n\n  const handleAddCustomProvider = async () => {\n    if (!newCustomProviderName.trim()) return;\n    const name = newCustomProviderName.trim().toLowerCase();\n    if (standardProviders.includes(name) || userCustomProvidersList.includes(name)) {\n      alert('Provider name already exists or is reserved.');\n      return;\n    }\n\n    setIsSaving(true);\n    try {\n      const updatedCustomProviders = {\n        ...(config?.custom_providers || {}),\n        [name]: { base_url: '' }\n      };\n      await api.updateConfig({ custom_providers: updatedCustomProviders });\n      await refetchConfig();\n      setEditingProvider(name);\n      setIsAddingCustomProvider(false);\n      setNewCustomProviderName('');\n      triggerSuccess();\n    } catch (err) {\n      console.error('Failed to add custom provider:', err);\n    } finally {\n      setIsSaving(false);\n    }\n  };\n\n  const handleRemoveCustomProvider = async (name: string) => {\n    const confirmed = await ask(`Are you sure you want to delete the custom provider \"${name}\"?`, {\n      title: 'Delete Provider',\n      kind: 'warning',\n    });\n\n    if (!confirmed) return;\n\n    setIsSaving(true);\n    try {\n      // Wipe API key from keychain first\n      try {\n        await api.removeApiKey(name);\n      } catch (keyErr) {\n        console.warn(`Failed to remove API key for ${name}:`, keyErr);\n      }\n\n      const updatedCustomProviders = { ...(config?.custom_providers || {}) };\n      delete updatedCustomProviders[name];\n\n      const updatedAvailableModels = { ...(config?.available_models || {}) };\n      delete updatedAvailableModels[name];\n\n      await api.updateConfig({\n        custom_providers: updatedCustomProviders,\n        available_models: updatedAvailableModels\n      });\n      await queryClient.invalidateQueries({ queryKey: ['config'] });\n      await queryClient.invalidateQueries({ queryKey: ['apiKeys'] });\n      if (editingProvider === name) {\n        setEditingProvider(cloudProviders[0] || 'openai');\n      }\n      triggerSuccess();\n    } catch (err) {\n      console.error('Failed to remove custom provider:', err);\n    } finally {\n      setIsSaving(false);\n    }\n  };\n\n  const handleAddModel = async () => {\n    if (!editingProvider || !editingCapability || !newModelName.trim()) return;\n\n    const modelToAdd = newModelName.trim();\n    if (currentModels.includes(modelToAdd)) return;\n\n    const updatedModels = [...currentModels, modelToAdd];\n    const updatedAvailableModels = {\n      ...availableModels,\n      [editingProvider]: {\n        ...(availableModels[editingProvider] || {}),\n        [editingCapability]: updatedModels\n      }\n    };\n\n    const updates: any = { available_models: updatedAvailableModels };\n\n    // If this is the first model for this provider, and it's the default provider, set it as default model\n    if (editingProvider === config?.inference?.chat?.provider && editingCapability === 'chat' && currentModels.length === 0) {\n      updates.inference = {\n        ...config.inference,\n        chat: {\n          ...config.inference.chat,\n          model: modelToAdd\n        }\n      };\n    }\n\n    setIsSaving(true);\n    try {\n      await api.updateConfig(updates);\n      setNewModelName('');\n      await refetchConfig();\n      triggerSuccess();\n    } catch (err) {\n      console.error('Failed to add model:', err);\n    } finally {\n      setIsSaving(false);\n    }\n  };\n\n  const handleRemoveModel = async (modelName: string) => {\n    if (!editingProvider || !editingCapability) return;\n    const updatedModels = currentModels.filter(m => m !== modelName);\n    const updatedAvailableModels = {\n      ...availableModels,\n      [editingProvider]: {\n        ...(availableModels[editingProvider] || {}),\n        [editingCapability]: updatedModels\n      }\n    };\n\n    const updates: any = { available_models: updatedAvailableModels };\n\n    // If we removed the top model, or changed the list, and this is the default provider, update the default model\n    if (editingProvider === config?.inference?.chat?.provider && editingCapability === 'chat' && updatedModels.length > 0) {\n      if (updatedModels[0] !== currentModels[0]) {\n        updates.inference = {\n          ...config.inference,\n          chat: {\n            ...config.inference.chat,\n            model: updatedModels[0]\n          }\n        };\n      }\n    }\n\n    setIsSaving(true);\n    try {\n      await api.updateConfig(updates);\n      await refetchConfig();\n      triggerSuccess();\n    } catch (err) {\n      console.error('Failed to remove model:', err);\n    } finally {\n      setIsSaving(false);\n    }\n  };\n\n  const saveModelOrder = async (newModels: string[]) => {\n    if (!editingProvider || !editingCapability) return;\n\n    const updatedAvailableModels = {\n      ...availableModels,\n      [editingProvider]: {\n        ...(availableModels[editingProvider] || {}),\n        [editingCapability]: newModels\n      }\n    };\n\n    const updates: any = { available_models: updatedAvailableModels };\n\n    // If we moved something to the top, and this is the default provider, update the default model\n    if (editingProvider === config?.inference?.chat?.provider && editingCapability === 'chat') {\n      updates.inference = {\n        ...config.inference,\n        chat: {\n          ...config.inference.chat,\n          model: newModels[0]\n        }\n      };\n    }\n\n    setIsSaving(true);\n    try {\n      await api.updateConfig(updates);\n      await refetchConfig();\n      triggerSuccess();\n    } catch (err) {\n      console.error('Failed to update model order:', err);\n    } finally {\n      setIsSaving(false);\n    }\n  };\n\n  const handleMoveModel = async (modelName: string, direction: 'up' | 'down') => {\n    if (!editingProvider || !editingCapability) return;\n\n    const index = currentModels.indexOf(modelName);\n    if (index === -1) return;\n    if (direction === 'up' && index === 0) return;\n    if (direction === 'down' && index === currentModels.length - 1) return;\n\n    const newModels = [...currentModels];\n    const targetIndex = direction === 'up' ? index - 1 : index + 1;\n    [newModels[index], newModels[targetIndex]] = [newModels[targetIndex], newModels[index]];\n\n    await saveModelOrder(newModels);\n  };\n\n  // Pointer-based drag handlers (works in Tauri)\n  const handlePointerDown = useCallback((e: React.PointerEvent, index: number) => {\n    e.preventDefault();\n    setIsDragging(true);\n    setDragSourceIndex(index);\n    setDragTargetIndex(index);\n    (e.target as HTMLElement).setPointerCapture(e.pointerId);\n  }, []);\n\n  const handlePointerMove = useCallback((e: React.PointerEvent) => {\n    if (!isDragging || dragSourceIndex === null || !containerRef.current) return;\n\n    const containerRect = containerRef.current.getBoundingClientRect();\n    const y = e.clientY - containerRect.top;\n\n    // Find which item we're over\n    let newTargetIndex = dragSourceIndex;\n    for (let i = 0; i < itemRefs.current.length; i++) {\n      const item = itemRefs.current[i];\n      if (!item) continue;\n      const rect = item.getBoundingClientRect();\n      const itemY = rect.top - containerRect.top + rect.height / 2;\n      if (y < itemY) {\n        newTargetIndex = i;\n        break;\n      }\n      newTargetIndex = i + 1;\n    }\n    newTargetIndex = Math.max(0, Math.min(newTargetIndex, currentModels.length - 1));\n\n    if (newTargetIndex !== dragTargetIndex) {\n      setDragTargetIndex(newTargetIndex);\n    }\n  }, [isDragging, dragSourceIndex, dragTargetIndex, currentModels.length]);\n\n  const handlePointerUp = useCallback(async (e: React.PointerEvent) => {\n    if (!isDragging) return;\n    (e.target as HTMLElement).releasePointerCapture(e.pointerId);\n\n    const sourceIndex = dragSourceIndex;\n    const targetIndex = dragTargetIndex;\n\n    setIsDragging(false);\n    setDragSourceIndex(null);\n    setDragTargetIndex(null);\n\n    if (sourceIndex === null || targetIndex === null || sourceIndex === targetIndex) return;\n\n    const newModels = [...currentModels];\n    const [removed] = newModels.splice(sourceIndex, 1);\n    newModels.splice(targetIndex, 0, removed);\n\n    await saveModelOrder(newModels);\n  }, [isDragging, dragSourceIndex, dragTargetIndex, currentModels, saveModelOrder]);\n\n\n  const handleToggleAutoCompaction = async () => {\n    try {\n      const current = config?.agent?.auto_compaction_enabled !== false; // Default to true if undefined\n      await api.updateConfig({ agent: { auto_compaction_enabled: !current } });\n      await refetchConfig();\n      triggerSuccess();\n    } catch (err) {\n      console.error('Failed to toggle auto-compaction:', err);\n    }\n  };\n\n  const handleSetApiKey = async () => {\n    if (!newKey.provider || !newKey.key) return;\n    setIsSaving(true);\n    try {\n      await api.setApiKey(newKey.provider, newKey.key);\n      setNewKey({ provider: '', key: '' });\n      await queryClient.invalidateQueries({ queryKey: ['apiKeys'] });\n      triggerSuccess();\n    } catch (err) {\n      console.error('Failed to set API key:', err);\n    } finally {\n      setIsSaving(false);\n    }\n  };\n\n  const handleSaveCustomBaseUrl = async () => {\n    if (!customBaseUrl.trim() || !editingProvider) return;\n    setIsSaving(true);\n    try {\n      const updatedCustomProviders = {\n        ...(config?.custom_providers || {}),\n        [editingProvider]: { base_url: customBaseUrl.trim() }\n      };\n      await api.updateConfig({ custom_providers: updatedCustomProviders });\n      await queryClient.invalidateQueries({ queryKey: ['config'] });\n      triggerSuccess();\n    } catch (err) {\n      console.error('Failed to update custom provider base URL:', err);\n    } finally {\n      setIsSaving(false);\n    }\n  };\n\n  const handleRemoveApiKey = async (provider: string) => {\n    const confirmed = await ask(`Are you sure you want to wipe the API key for ${provider.toUpperCase()}? This will prevent agents from using this provider until a new key is registered.`, {\n      title: 'Wipe API Key',\n      kind: 'warning',\n    });\n\n    if (!confirmed) return;\n\n    try {\n      await api.removeApiKey(provider);\n      await queryClient.invalidateQueries({ queryKey: ['apiKeys'] });\n    } catch (err) {\n      console.error('Failed to remove API key:', err);\n    }\n  };\n\n  const handleToggleProvider = async (provider: string, currentEnabled: boolean) => {\n    setIsSaving(true);\n    try {\n      const updatedProviders = {\n        ...(config?.providers || {}),\n        [provider]: { enabled: !currentEnabled }\n      };\n      await api.updateConfig({ providers: updatedProviders });\n      await queryClient.invalidateQueries({ queryKey: ['config'] });\n      await queryClient.invalidateQueries({ queryKey: ['apiKeys'] });\n      triggerSuccess();\n    } catch (err) {\n      console.error('Failed to toggle provider:', err);\n    } finally {\n      setIsSaving(false);\n    }\n  };\n\n  const handleSetVaultSecret = async () => {\n    if (!newVaultSecret.name || !newVaultSecret.value) return;\n    setIsSaving(true);\n    try {\n      await api.setVaultSecret(newVaultSecret.name, newVaultSecret.value);\n      setNewVaultSecret({ name: '', value: '' });\n      await refetchVault();\n      triggerSuccess();\n    } catch (err) {\n      console.error('Failed to set vault secret:', err);\n    } finally {\n      setIsSaving(false);\n    }\n  };\n\n  const handleRemoveVaultSecret = async (name: string) => {\n    const confirmed = await ask(`Are you sure you want to delete the secret \"${name}\"? This cannot be undone.`, {\n      title: 'Delete Secret',\n      kind: 'warning',\n    });\n\n    if (!confirmed) return;\n\n    try {\n      await api.removeVaultSecret(name);\n      refetchVault();\n    } catch (err) {\n      console.error('Failed to remove vault secret:', err);\n    }\n  };\n\n  const themes = [\n    { id: 'default', name: 'Matrix Dark', colors: 'bg-[#181c21]', accent: 'bg-[#22d3ee]' },\n    { id: 'light', name: 'Paper White', colors: 'bg-[#f2f2f2]', accent: 'bg-[#2563eb]' },\n    { id: 'cobalt2', name: 'Cobalt2', colors: 'bg-[#193549]', accent: 'bg-[#ffc600]' },\n    { id: 'nerv', name: 'NERV HQ', colors: 'bg-[#1c1c1c]', accent: 'bg-[#ff9500]' },\n  ];\n\n  return (\n    <div className=\"flex h-full bg-background font-mono text-[13px] overflow-hidden\">\n      {/* Main Content Area */}\n      <div className=\"flex-1 flex flex-col min-w-0 bg-background relative\">\n        <div className=\"flex-1 overflow-auto p-8 custom-scrollbar relative\" ref={scrollRef}>\n          <div className=\"max-w-4xl mx-auto pb-20\">\n            {activeTab === 'models' && (\n              <div className=\"space-y-8 animate-in fade-in slide-in-from-bottom-2 duration-300 font-mono\">\n                {/* Model Registry Section */}\n                <section className=\"space-y-3\">\n                  <div className=\"flex flex-col gap-0.5\">\n                    <div className=\"flex items-center gap-2 text-accent/80\">\n                      <h2 className=\"text-[12px] font-black uppercase tracking-[0.2em]\">Provider Configuration</h2>\n                    </div>\n                    <p className=\"text-[10px] text-text-tertiary/60 italic leading-normal font-black tracking-tight\">\n                      LLM providers and endpoints. Credentials stored in system keychain.\n                    </p>\n                  </div>\n\n                  <div className=\"flex flex-col md:flex-row bg-surface/5 border border-border/10 overflow-hidden min-h-[450px]\">\n                    {/* Left Sidebar: Providers */}\n                    <div className=\"w-full md:w-48 border-b md:border-b-0 md:border-r border-border/10 bg-background/20 flex flex-col font-mono\">\n                      <div className=\"p-3 border-b border-border/10 bg-background/10\">\n                        <span className=\"text-[10px] font-black text-accent/60 uppercase tracking-[0.2em]\">Index</span>\n                      </div>\n                      <div className=\"flex-1 overflow-auto p-1.5 space-y-0.5 custom-scrollbar\">\n                        <div className=\"px-2 pb-1\">\n                          <span className=\"text-[8px] font-black text-text-tertiary/30 uppercase tracking-widest\">Cloud</span>\n                        </div>\n                        {cloudProviders.map(p => {\n                          const providerData = apiKeys?.find(k => k.provider.toLowerCase() === p.toLowerCase());\n                          const isConfigured = providerData?.configured;\n                          const isEnabled = providerData?.enabled === true;\n                          return (\n                            <button\n                              key={p}\n                              onClick={() => {\n                                setEditingProvider(p);\n                                setNewKey(prev => ({ ...prev, provider: p }));\n                              }}\n                              className={clsx(\n                                \"w-full px-2 py-1 text-left text-[11px] font-black uppercase transition-all flex items-center justify-between\",\n                                editingProvider === p\n                                  ? \"text-accent\"\n                                  : \"text-text-tertiary/60 hover:text-text-secondary hover:translate-x-0.5\",\n                                !isEnabled && \"opacity-40\"\n                              )}\n                            >\n                              <div className=\"flex items-center gap-2\">\n                                <span className=\"w-2\">{editingProvider === p ? '>' : ' '}</span>\n                                <span className=\"truncate\">{p}</span>\n                              </div>\n                              <div className={clsx(\n                                \"w-1 h-1 rounded-full\",\n                                isConfigured ? \"bg-status-success animate-pulse\" : \"bg-status-error/40\"\n                              )} />\n                            </button>\n                          );\n                        })}\n\n                        <div className=\"pt-4 mt-2\">\n                          <div className=\"px-2 pb-1 flex items-center justify-between\">\n                            <span className=\"text-[8px] font-black text-text-tertiary/30 uppercase tracking-widest\">Custom</span>\n                            <button\n                              onClick={() => setIsAddingCustomProvider(true)}\n                              className=\"text-accent/60 hover:text-accent transition-colors text-[10px]\"\n                            >\n                              [+]\n                            </button>\n                          </div>\n\n                          {isAddingCustomProvider && (\n                            <div className=\"px-1.5 py-1 space-y-1\">\n                              <input\n                                autoFocus\n                                type=\"text\"\n                                placeholder=\"NAME...\"\n                                value={newCustomProviderName}\n                                onChange={(e) => setNewCustomProviderName(e.target.value.toLowerCase().replace(/[^a-z0-9_-]/g, ''))}\n                                onKeyDown={(e) => {\n                                  if (e.key === 'Enter') handleAddCustomProvider();\n                                  if (e.key === 'Escape') setIsAddingCustomProvider(false);\n                                }}\n                                className=\"w-full bg-transparent border-b border-accent/20 px-1 py-0.5 text-[10px] text-text-primary focus:outline-none font-mono uppercase\"\n                              />\n                              <div className=\"flex gap-1\">\n                                  <button\n                                    onClick={handleAddCustomProvider}\n                                    className=\"flex-1 py-0.5 text-accent text-[9px] font-black border border-accent/20 hover:bg-accent/5\"\n                                  >\n                                    Add\n                                  </button>\n                                  <button\n                                    onClick={() => setIsAddingCustomProvider(false)}\n                                    className=\"flex-1 py-0.5 text-text-tertiary/60 text-[9px] font-black border border-border/10 hover:bg-surface/10\"\n                                  >\n                                    Cancel\n                                  </button>\n                              </div>\n                            </div>\n                          )}\n\n                          {userCustomProvidersList.map(p => {\n                            const providerData = apiKeys?.find(k => k.provider.toLowerCase() === p.toLowerCase());\n                            const isConfigured = providerData?.configured;\n                            const isEnabled = providerData?.enabled === true;\n                            return (\n                              <button\n                                key={p}\n                                onClick={() => {\n                                  setEditingProvider(p);\n                                  setNewKey(prev => ({ ...prev, provider: p }));\n                                }}\n                                className={clsx(\n                                  \"w-full px-2 py-1 text-left text-[11px] font-black uppercase transition-all flex items-center justify-between\",\n                                  editingProvider === p\n                                    ? \"text-accent\"\n                                    : \"text-text-tertiary/60 hover:text-text-secondary hover:translate-x-0.5\",\n                                  !isEnabled && \"opacity-40\"\n                                )}\n                              >\n                                <div className=\"flex items-center gap-2\">\n                                  <span className=\"w-2\">{editingProvider === p ? '>' : ' '}</span>\n                                  <span className=\"truncate\">{p}</span>\n                                </div>\n                                <div className={clsx(\n                                  \"w-1 h-1 rounded-full\",\n                                  isConfigured ? \"bg-status-success animate-pulse\" : \"bg-status-error/40\"\n                                )} />\n                              </button>\n                            );\n                          })}\n                        </div>\n\n                        <div className=\"pt-4 mt-2\">\n                          <div className=\"px-2 pb-1\">\n                            <span className=\"text-[8px] font-black text-text-tertiary/30 uppercase tracking-widest\">Local</span>\n                          </div>\n\n                          <div className=\"space-y-0.5\">\n                            {localProviders.map(p => {\n                              const isEnabled = apiKeys?.find(k => k.provider.toLowerCase() === p.toLowerCase())?.enabled === true;\n                              return (\n                                <button\n                                  key={p}\n                                  onClick={() => {\n                                    setNewKey(prev => ({ ...prev, provider: p }));\n                                    setEditingProvider(p);\n                                  }}\n                                  className={clsx(\n                                    \"w-full px-2 py-1 text-left text-[11px] font-black uppercase transition-all flex items-center justify-between\",\n                                    editingProvider === p\n                                      ? \"text-accent\"\n                                      : \"text-text-tertiary/60 hover:text-text-secondary hover:translate-x-0.5\",\n                                    !isEnabled && \"opacity-40\"\n                                  )}\n                                >\n                                  <div className=\"flex items-center gap-2\">\n                                    <span className=\"w-2\">{editingProvider === p ? '>' : ' '}</span>\n                                    <span className=\"truncate\">{p}</span>\n                                  </div>\n                                  <div className=\"w-1 h-1 rounded-full bg-status-success animate-pulse\" />\n                                </button>\n                              );\n                            })}\n                          </div>\n                        </div>\n                      </div>\n                    </div>\n\n                    {/* Right Panel: Skills and Models */}\n                    <div className=\"flex-1 flex flex-col bg-background/5 font-mono\">\n                      {!editingProvider ? (\n                        <div className=\"flex-1 flex flex-col items-center justify-center text-text-tertiary/20 space-y-2\">\n                          <span className=\"text-[10px] uppercase font-black tracking-[0.2em]\">Select a provider</span>\n                          <div className=\"animate-pulse\">_</div>\n                        </div>\n                      ) : (\n                        <div className=\"flex-1 overflow-auto p-5 space-y-8 custom-scrollbar\">\n                          {/* Provider Header & API Key Management */}\n                          <div className=\"space-y-4\">\n                            <div className=\"flex items-center justify-between border-b border-border/10 pb-3\">\n                              <div className=\"flex items-center gap-3\">\n                                <span className=\"text-[13px] font-black text-text-primary uppercase tracking-[0.1em]\">\n                                  {editingProvider}\n                                </span>\n                              </div>\n\n                              <div className=\"flex items-center gap-2\">\n                                {(() => {\n                                  const providerData = apiKeys?.find(k => k.provider.toLowerCase() === editingProvider.toLowerCase());\n                                  const isEnabled = providerData?.enabled === true;\n\n                                  return (\n                                    <button\n                                      onClick={() => handleToggleProvider(editingProvider, isEnabled)}\n                                      className={clsx(\n                                        \"text-[9px] font-black px-2 py-0.5 transition-all tracking-widest uppercase border active:scale-95\",\n                                        isEnabled\n                                          ? \"text-status-success border-status-success/20 hover:bg-status-success/5\"\n                                          : \"text-status-error border-status-error/20 hover:bg-status-error/5\"\n                                      )}\n                                    >\n                                      {isEnabled ? 'On' : 'Off'}\n                                    </button>\n                                  );\n                                })()}\n\n                                {userCustomProvidersList.includes(editingProvider) && (\n                                  <button\n                                    onClick={() => handleRemoveCustomProvider(editingProvider)}\n                                    className=\"text-[9px] text-text-tertiary/40 hover:text-status-error transition-all uppercase font-black px-2 py-0.5 border border-border/10 hover:bg-status-error/5 active:scale-95\"\n                                  >\n                                    Delete\n                                  </button>\n                                )}\n\n                                {apiKeys?.find(k => k.provider.toLowerCase() === editingProvider.toLowerCase())?.configured && !localProvidersList.includes(editingProvider.toLowerCase()) && (\n                                  <button\n                                    onClick={() => handleRemoveApiKey(editingProvider)}\n                                    className=\"text-[9px] text-text-tertiary/40 hover:text-status-error transition-all uppercase font-black px-2 py-0.5 border border-border/10 hover:bg-status-error/5 active:scale-95\"\n                                  >\n                                    Wipe Key\n                                  </button>\n                                )}\n                              </div>\n                            </div>\n\n                            {/* API Key Input */}\n                            {!localProvidersList.includes(editingProvider.toLowerCase()) ? (\n                              <div className=\"space-y-2\">\n                                <div className=\"flex flex-col gap-0.5\">\n                                  <div className=\"flex items-center gap-2\">\n                                    <span className=\"text-[9px] font-black text-text-tertiary/60 uppercase tracking-widest\">API Key</span>\n                                  </div>\n                                </div>\n                                <div className=\"flex flex-col sm:flex-row gap-2\">\n                                  <div className=\"flex-1 relative\">\n                                    <input\n                                      type=\"password\"\n                                      placeholder=\"Paste key...\"\n                                      value={newKey.key}\n                                      onChange={(e) => setNewKey(prev => ({ ...prev, key: e.target.value }))}\n                                      onKeyDown={(e) => e.key === 'Enter' && handleSetApiKey()}\n                                      className=\"w-full bg-transparent border-b border-border/10 px-0 py-1 text-[11px] text-text-primary focus:outline-none focus:border-accent/40 font-mono transition-all uppercase\"\n                                    />\n                                  </div>\n                                  <button\n                                    onClick={handleSetApiKey}\n                                    disabled={isSaving || !newKey.key}\n                                    className=\"px-3 py-1 text-accent hover:text-accent-hover font-black text-[10px] uppercase tracking-widest transition-all disabled:opacity-20\"\n                                  >\n                                    Register\n                                  </button>\n                                </div>\n                              </div>\n                            ) : (\n                              <div className=\"text-[9px] text-accent/40 font-black uppercase tracking-widest\">\n                                Local provider - no authentication required\n                              </div>\n                            )}\n                          </div>\n\n                          {userCustomProvidersList.includes(editingProvider) && (\n                            <div className=\"space-y-2\">\n                              <div className=\"flex flex-col gap-0.5\">\n                                <span className=\"text-[9px] font-black text-text-tertiary/60 uppercase tracking-widest\">Endpoint URL</span>\n                              </div>\n                              <div className=\"flex flex-col sm:flex-row gap-2\">\n                                <div className=\"flex-1 relative\">\n                                  <input\n                                    type=\"text\"\n                                    placeholder=\"https://api.provider.com/v1\"\n                                    value={customBaseUrl}\n                                    onChange={(e) => setCustomBaseUrl(e.target.value)}\n                                    onKeyDown={(e) => e.key === 'Enter' && handleSaveCustomBaseUrl()}\n                                    className=\"w-full bg-transparent border-b border-border/10 px-0 py-1 text-[11px] text-text-primary focus:outline-none focus:border-accent/40 font-mono transition-all\"\n                                  />\n                                </div>\n                                <button\n                                  onClick={handleSaveCustomBaseUrl}\n                                  disabled={isSaving || !customBaseUrl.trim()}\n                                  className=\"px-3 py-1 text-accent hover:text-accent-hover font-black text-[10px] uppercase tracking-widest transition-all disabled:opacity-20\"\n                                >\n                                  [SAVE]\n                                </button>\n                              </div>\n                            </div>\n                          )}\n\n                          {/* Model Registry Content */}\n                          <div className=\"space-y-6\">\n                            <div className=\"flex items-center justify-between\">\n                              <span className=\"text-[9px] font-black text-text-tertiary/60 uppercase tracking-widest\">Models</span>\n                              {localProvidersList.includes(editingProvider?.toLowerCase() || '') && (\n                                <button\n                                  onClick={() => editingProvider && handleFetchModels(editingProvider)}\n                                  disabled={isFetchingModels}\n                                  className={clsx(\n                                    \"text-[9px] font-black uppercase tracking-widest transition-all\",\n                                    isFetchingModels ? \"text-text-tertiary/20 animate-pulse\" : \"text-accent hover:text-accent-hover\"\n                                  )}\n                                >\n                                  {isFetchingModels ? 'Discovering...' : 'Discover local models'}\n                                </button>\n                              )}\n                            </div>\n\n                            {['chat'].map(cap => {\n                              const models = availableModels[editingProvider]?.[cap] || [];\n                              const isEditing = editingCapability === cap;\n\n                              const isOpenRouter = editingProvider?.toLowerCase() === 'openrouter';\n                              const supportsThinking = thinkingProviders.includes(editingProvider?.toLowerCase() || '');\n\n                              return (\n                                <div key={cap} className=\"space-y-1\">\n                                  {/* Column headers */}\n                                  {(supportsThinking || isOpenRouter) && models.length > 0 && (\n                                    <div className=\"flex items-center gap-2 px-2 py-1 border-b border-border/10\">\n                                      <div className=\"w-6\" /> {/* Spacer for drag handle */}\n                                      <span className=\"flex-1 text-[8px] font-black text-text-tertiary/40 uppercase tracking-widest\">MODEL NAME</span>\n                                      {isOpenRouter && (\n                                        <span className=\"text-[8px] font-black text-text-tertiary/40 uppercase tracking-widest w-24 text-right\">PRICING (INPUT/OUTPUT per 1M TOK)</span>\n                                      )}\n                                      {supportsThinking && (\n                                        <span className=\"text-[8px] font-black text-text-tertiary/40 uppercase tracking-widest w-20 text-right\">REASONING</span>\n                                      )}\n                                      <div className=\"w-6\" /> {/* Spacer for delete button */}\n                                    </div>\n                                  )}\n                                  <div\n                                    ref={containerRef}\n                                    className=\"flex flex-col gap-0.5 min-h-[50px]\"\n                                  >\n                                    {models.map((model, index) => {\n                                      const { baseModel, level } = parseModelLevel(model);\n                                      // Use baseModel for pricing lookup since pricing is stored by base model name\n                                      const pricing = isOpenRouter && config?.model_pricing?.['openrouter']?.[cap]?.[baseModel];\n\n                                      return (\n                                        <div\n                                          key={model}\n                                          ref={el => { itemRefs.current[index] = el; }}\n                                          className={clsx(\n                                            \"flex items-center justify-between px-2 py-1 border-b border-border/5 group transition-all relative select-none gap-2\",\n                                            isDragging && dragSourceIndex === index && \"opacity-50\",\n                                            isDragging && dragTargetIndex === index && dragSourceIndex !== index && \"border-t border-accent\"\n                                          )}\n                                        >\n                                          {/* Drag handle */}\n                                          <div\n                                            className=\"text-text-tertiary/20 hover:text-accent transition-all cursor-grab active:cursor-grabbing p-1 -m-1 touch-none shrink-0\"\n                                            onPointerDown={(e) => handlePointerDown(e, index)}\n                                            onPointerMove={handlePointerMove}\n                                            onPointerUp={handlePointerUp}\n                                            onPointerCancel={handlePointerUp}\n                                          >\n                                            <span className=\"text-[8px] font-black\">{index === 0 ? '@' : '#'}</span>\n                                          </div>\n\n                                          {/* Model name */}\n                                          <div className=\"flex-1 min-w-0\">\n                                            <span className={clsx(\n                                              \"text-[10px] transition-colors truncate font-mono uppercase block\",\n                                              index === 0 ? \"text-accent font-black\" : \"text-text-primary/60 group-hover:text-text-primary\"\n                                            )}>{baseModel}</span>\n                                          </div>\n\n                                          {/* Pricing column for OpenRouter */}\n                                          {isOpenRouter && (\n                                            <div className=\"text-[9px] text-text-tertiary/60 font-mono text-right shrink-0 w-24\">\n                                              {pricing ? (\n                                                <span>${pricing.prompt.toFixed(2)}/${pricing.completion.toFixed(2)}</span>\n                                              ) : (\n                                                <span className=\"text-text-tertiary/20\">—</span>\n                                              )}\n                                            </div>\n                                          )}\n\n                                          {/* Reasoning level dropdown */}\n                                          {supportsThinking && (\n                                            <select\n                                              value={level}\n                                              onChange={(e) => handleUpdateModelLevel(model, e.target.value as typeof level)}\n                                              className={clsx(\n                                                \"bg-transparent border px-1.5 py-0.5 text-[9px] font-black uppercase cursor-pointer transition-all shrink-0 w-20\",\n                                                level\n                                                  ? \"text-status-success border-status-success/30 bg-status-success/5\"\n                                                  : \"text-text-tertiary/50 border-border/20 hover:border-border/40\"\n                                              )}\n                                              style={{ WebkitAppearance: 'none', appearance: 'none', paddingRight: '16px', backgroundImage: 'url(\"data:image/svg+xml,%3csvg xmlns=%27http://www.w3.org/2000/svg%27 fill=%27none%27 viewBox=%270 0 24 24%27 stroke=%27%23666%27%3e%3cpath stroke-linecap=%27round%27 stroke-linejoin=%27round%27 stroke-width=%272%27 d=%27M19 9l-7 7-7-7%27/%3e%3c/svg%3e\")', backgroundRepeat: 'no-repeat', backgroundPosition: 'right 2px center', backgroundSize: '10px' }}\n                                            >\n                                              {reasoningLevels.map(l => (\n                                                <option key={l.value} value={l.value}>{l.label}</option>\n                                              ))}\n                                            </select>\n                                          )}\n\n                                          {/* Remove button */}\n                                          <button\n                                            onClick={(e) => {\n                                              e.stopPropagation();\n                                              setEditingCapability(cap);\n                                              handleRemoveModel(model);\n                                            }}\n                                            className=\"text-text-tertiary/20 hover:text-status-error opacity-0 group-hover:opacity-100 transition-all text-[10px] font-black shrink-0\"\n                                          >\n                                            [X]\n                                          </button>\n                                        </div>\n                                      );\n                                    })}\n\n                                    {/* Inline Add Model Input */}\n                                    <div className=\"flex gap-2 group/input mt-1\">\n                                      <div className=\"flex-1 relative\">\n                                        <input\n                                          type=\"text\"\n                                          placeholder=\"Add model...\"\n                                          value={isEditing ? newModelName : ''}\n                                          onFocus={() => setEditingCapability(cap)}\n                                          onChange={(e) => {\n                                            setEditingCapability(cap);\n                                            setNewModelName(e.target.value);\n                                          }}\n                                          onKeyDown={(e) => e.key === 'Enter' && handleAddModel()}\n                                          className=\"w-full bg-transparent border-b border-dashed border-border/20 px-0 py-0.5 text-[10px] text-text-primary placeholder:text-text-tertiary/20 focus:outline-none focus:border-accent/40 focus:border-solid font-mono transition-all uppercase\"\n                                        />\n                                      </div>\n                                      {isEditing && newModelName.trim() && (\n                                        <button\n                                          onClick={handleAddModel}\n                                          className=\"text-accent text-[10px] font-black\"\n                                        >\n                                          [+]\n                                        </button>\n                                      )}\n                                    </div>\n                                  </div>\n                                </div>\n                              );\n                            })}\n                          </div>\n                        </div>\n                      )}\n                    </div>\n                  </div>\n                </section>\n              </div>\n            )}\n\n            {activeTab === 'general' && (\n              <div className=\"space-y-12 animate-in fade-in slide-in-from-bottom-2 duration-300 font-mono\">\n                <div className=\"grid grid-cols-1 gap-12\">\n                  {/* Agent Behavior Section */}\n                  <section className=\"space-y-3\">\n                    <div className=\"flex flex-col gap-0.5\">\n                      <div className=\"flex items-center gap-2 text-accent/80\">\n                        <h2 className=\"text-[12px] font-black uppercase tracking-[0.2em]\">Behavior</h2>\n                      </div>\n                      <p className=\"text-[10px] text-text-tertiary/60 italic leading-normal font-black tracking-tight\">\n                        Global execution and memory policies.\n                      </p>\n                    </div>\n\n                    <div className=\"bg-surface/5 border border-border/10 p-4 space-y-3 font-mono\">\n                      <div className=\"flex items-center justify-between border-b border-border/5 pb-3\">\n                        <div className=\"flex flex-col gap-0.5\">\n                          <div className=\"flex items-center gap-2\">\n                            <span className=\"text-[11px] font-black text-text-primary uppercase tracking-[0.2em]\">Auto-compaction</span>\n                          </div>\n                          <p className=\"text-[10px] text-text-tertiary/60 italic px-3 leading-normal font-black tracking-tight\">\n                            Reduce token overhead automatically at threshold.\n                          </p>\n                        </div>\n                        <button\n                          onClick={handleToggleAutoCompaction}\n                          className={clsx(\n                            \"text-[10px] font-black px-2 py-1 transition-all tracking-widest uppercase active:scale-95\",\n                            config?.agent?.auto_compaction_enabled !== false\n                              ? \"text-status-success hover:bg-status-success/5\"\n                              : \"text-status-error hover:bg-status-error/5\"\n                          )}\n                        >\n                          {config?.agent?.auto_compaction_enabled !== false ? 'Active' : 'Inactive'}\n                        </button>\n                      </div>\n                    </div>\n                  </section>\n\n                  {/* Sub-Agent Ecosystem */}\n                  <section className=\"space-y-4\">\n                    <div className=\"flex flex-col gap-0.5\">\n                      <div className=\"flex items-center justify-between\">\n                        <div className=\"flex items-center gap-2 text-accent/80\">\n                          <h2 className=\"text-[12px] font-black uppercase tracking-[0.2em]\">Sub-agents</h2>\n                        </div>\n                        <button\n                          onClick={handleToggleSubAgentsGlobal}\n                          className={clsx(\n                            \"text-[10px] font-black px-2 py-0.5 transition-all tracking-widest uppercase border active:scale-95 font-mono\",\n                            config?.sub_agent?.enabled\n                              ? \"text-status-success border-status-success/20 hover:bg-status-success/5\"\n                              : \"text-status-error border-status-error/20 hover:bg-status-error/5\"\n                          )}\n                        >\n                          {config?.sub_agent?.enabled ? 'Enabled' : 'Disabled'}\n                        </button>\n                      </div>\n                      <p className=\"text-[10px] text-text-tertiary/60 italic leading-normal font-black tracking-tight\">\n                        Autonomous child-agents for specialized task processing.\n                      </p>\n                    </div>\n\n                    <div className={clsx(\n                      \"flex flex-col gap-4 transition-opacity duration-300 font-mono\",\n                      !config?.sub_agent?.enabled && \"opacity-30 pointer-events-none grayscale\"\n                    )}>\n                      {/* Configuration Controls */}\n                      <div className=\"flex flex-col gap-4\">\n\n\n                        <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                          {/* Claude Code */}\n                          <div className=\"bg-surface/5 border border-border/10 p-4 space-y-3\">\n                            <div className=\"flex items-center justify-between\">\n                              <div className=\"flex items-center gap-2\">\n                                <span className=\"text-[11px] font-black uppercase tracking-widest text-text-primary\">Claude Code</span>\n                                {status?.components?.claude === 'ok' && status?.auth?.claude?.startsWith('ok') && (\n                                  <span className=\"text-[8px] font-black text-status-success uppercase\">Ready</span>\n                                )}\n                              </div>\n                              <button\n                                onClick={() => handleToggleCLIEnabled('claude_code')}\n                                className={clsx(\n                                  \"text-[9px] font-black px-1.5 py-0.5 transition-all border active:scale-95\",\n                                  config?.sub_agent?.claude_code?.enabled\n                                    ? \"text-status-success border-status-success/20 hover:bg-status-success/5\"\n                                    : \"text-text-tertiary/40 border-border/10 hover:text-text-secondary\"\n                                )}\n                              >\n                                {config?.sub_agent?.claude_code?.enabled ? 'On' : 'Off'}\n                              </button>\n                            </div>\n\n                            <div className=\"space-y-3\">\n                              <div className=\"space-y-1\">\n                                <label className=\"text-[9px] font-black text-text-tertiary/40 uppercase tracking-widest ml-1\">Tools</label>\n                                <input\n                                  type=\"text\"\n                                  defaultValue={config?.sub_agent?.claude_code?.allowed_tools?.join(', ')}\n                                  onBlur={(e) => handleUpdateClaudeTools(e.target.value)}\n                                  placeholder=\"Edit, Bash, Read...\"\n                                  className=\"w-full bg-transparent border-b border-border/10 px-0 py-1 text-[10px] text-text-primary focus:outline-none focus:border-accent/40 font-mono transition-all uppercase\"\n                                />\n                              </div>\n                            </div>\n                          </div>\n\n                          {/* Codex */}\n                          <div className=\"bg-surface/5 border border-border/10 p-4 space-y-3\">\n                            <div className=\"flex items-center justify-between\">\n                              <div className=\"flex items-center gap-2\">\n                                <span className=\"text-[11px] font-black uppercase tracking-widest text-text-primary\">Codex</span>\n                                {status?.components?.codex === 'ok' && status?.auth?.codex?.startsWith('ok') && (\n                                  <span className=\"text-[8px] font-black text-status-success uppercase\">Ready</span>\n                                )}\n                              </div>\n                              <button\n                                onClick={() => handleToggleCLIEnabled('codex')}\n                                className={clsx(\n                                  \"text-[9px] font-black px-1.5 py-0.5 transition-all border active:scale-95\",\n                                  config?.sub_agent?.codex?.enabled\n                                    ? \"text-status-success border-status-success/20 hover:bg-status-success/5\"\n                                    : \"text-text-tertiary/40 border-border/10 hover:text-text-secondary\"\n                                )}\n                              >\n                                {config?.sub_agent?.codex?.enabled ? 'On' : 'Off'}\n                              </button>\n                            </div>\n\n                            <div className=\"space-y-3\">\n                              <div className=\"space-y-1\">\n                                <label className=\"text-[9px] font-black text-text-tertiary/40 uppercase tracking-widest ml-1\">Approval</label>\n                                <div className=\"flex gap-1\">\n                                  {['untrusted', 'on-failure', 'on-request', 'never'].map((mode) => (\n                                    <button\n                                      key={mode}\n                                      onClick={() => handleUpdateCodexMode(mode)}\n                                      className={clsx(\n                                        \"flex-1 py-1 text-[8px] font-black uppercase border transition-all active:scale-95\",\n                                        config?.sub_agent?.codex?.approval_mode?.toLowerCase() === mode.toLowerCase()\n                                          ? \"text-accent border-accent/40 bg-accent/5\"\n                                          : \"border-border/10 text-text-tertiary/40 hover:text-text-secondary hover:bg-surface/5\"\n                                      )}\n                                    >\n                                      {config?.sub_agent?.codex?.approval_mode?.toLowerCase() === mode.toLowerCase() \n                                        ? `[${mode.toUpperCase().replace('-', '_')}]` \n                                        : mode.toUpperCase().replace('-', '_')}\n                                    </button>\n                                  ))}\n                                </div>\n                              </div>\n                            </div>\n                          </div>\n                        </div>\n                      </div>\n                    </div>\n                  </section>\n                </div>\n              </div>\n            )\n            }\n\n            {activeTab === 'security' && (\n              <div className=\"space-y-12 animate-in fade-in slide-in-from-bottom-2 duration-300 font-mono\">\n                {/* Unrestricted Execution Mode Toggle */}\n                <div className={clsx(\n                  \"p-4 border transition-all duration-500\",\n                  config?.security?.always_allow_all\n                    ? \"bg-status-error text-background border-status-error shadow-[0_0_25px_rgba(var(--status-error),0.2)]\"\n                    : \"bg-status-error/5 border-status-error/10\"\n                )}>\n                  <div className=\"flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4\">\n                    <div className=\"flex flex-col gap-1 pr-4\">\n                      <div className=\"flex items-center gap-2\">\n                        <span className={clsx(\n                          \"text-[11px] font-black uppercase tracking-[0.2em]\",\n                          config?.security?.always_allow_all ? \"text-background\" : \"text-status-error\"\n                        )}>Unrestricted Execution</span>\n                        {config?.security?.always_allow_all && (\n                          <span className=\"text-[8px] font-black bg-background text-status-error px-1 py-0.5 animate-pulse tracking-widest\">System unlocked</span>\n                        )}\n                      </div>\n                      <p className={clsx(\n                        \"text-[9px] italic leading-relaxed max-w-2xl font-black uppercase tracking-tight\",\n                        config?.security?.always_allow_all ? \"text-background/90\" : \"text-text-tertiary/60\"\n                      )}>\n                        Bypass all security checks. Agents gain full unmonitored system access. Use only in trusted environments.\n                      </p>\n                    </div>\n                    <button\n                      onClick={handleToggleAlwaysAllowAll}\n                      className={clsx(\n                        \"text-[9px] font-black px-3 py-1.5 transition-all tracking-[0.1em] uppercase border whitespace-nowrap active:scale-95\",\n                        config?.security?.always_allow_all\n                          ? \"bg-background text-status-error border-background\"\n                          : \"bg-status-error text-background border-status-error\"\n                      )}\n                    >\n                      {config?.security?.always_allow_all ? 'Restore Security' : 'Disable Security'}\n                    </button>\n                  </div>\n                </div>\n\n                {/* Shell Execution Policy */}\n                <section className={clsx(\n                  \"space-y-3 transition-all duration-300\",\n                  config?.security?.always_allow_all && \"opacity-40 grayscale\"\n                )}>\n                  <div className=\"flex flex-col gap-0.5\">\n                    <div className=\"flex items-center justify-between\">\n                      <div className=\"flex items-center gap-2 text-accent/80\">\n                        <h2 className=\"text-[12px] font-black uppercase tracking-[0.2em]\">Shell Policy</h2>\n                      </div>\n                      {config?.security?.always_allow_all && (\n                        <span className=\"text-[8px] font-black text-status-error uppercase tracking-widest bg-status-error/10 px-1.5 py-0.5\">\n                          Overridden by unrestricted mode\n                        </span>\n                      )}\n                    </div>\n                    <p className=\"text-[10px] text-text-tertiary/60 italic leading-normal font-black tracking-tight\">\n                      Control auto-approval levels for terminal commands.\n                    </p>\n                  </div>\n\n                  <div className={clsx(\n                    \"bg-surface/5 border border-border/10 p-5 space-y-4\",\n                    config?.security?.always_allow_all && \"pointer-events-none\"\n                  )}>\n                    <div className=\"flex flex-col gap-0.5\">\n                      <span className=\"text-[11px] font-black text-text-primary uppercase tracking-[0.2em]\">Execution Mode</span>\n                    </div>\n\n                    <div className=\"grid grid-cols-2 sm:grid-cols-4 gap-2\">\n                      {[\n                        { id: 'restricted', label: 'RESTRICTED', desc: 'Minimal safe set' },\n                        { id: 'read-only', label: 'READ_ONLY', desc: 'All inspections' },\n                        { id: 'non-destructive', label: 'MUTABLE', desc: 'No deletions' },\n                        { id: 'unrestricted', label: 'OPEN', desc: 'No approvals' },\n                      ].map((mode) => (\n                        <button\n                          key={mode.id}\n                          onClick={() => handleUpdateShellPermissionMode(mode.id)}\n                          className={clsx(\n                            \"flex flex-col items-start p-3 border transition-all text-left group active:scale-[0.98]\",\n                            config?.security?.shell_permission_mode === mode.id\n                              ? \"border-accent bg-accent/5 shadow-[0_0_15px_rgba(var(--accent),0.05)]\"\n                              : \"border-border/10 hover:border-accent/40 bg-surface/5\"\n                          )}\n                        >\n                          <span className={clsx(\n                            \"text-[10px] font-black uppercase tracking-widest mb-1\",\n                            config?.security?.shell_permission_mode === mode.id ? \"text-accent\" : \"text-text-tertiary/60 group-hover:text-text-secondary\"\n                          )}>\n                            {config?.security?.shell_permission_mode === mode.id ? `[${mode.label}]` : `  ${mode.label}`}\n                          </span>\n                          <span className=\"text-[8px] text-text-tertiary/40 font-black uppercase leading-tight\">\n                            {mode.desc}\n                          </span>\n                        </button>\n                      ))}\n                    </div>\n                  </div>\n                </section>\n\n                {/* Vault Section */}\n                <section className=\"space-y-3\">\n                  <div className=\"flex flex-col gap-0.5\">\n                    <div className=\"flex items-center gap-2 text-accent/80\">\n                      <h2 className=\"text-[12px] font-black uppercase tracking-[0.2em]\">Secure Vault</h2>\n                    </div>\n                    <p className=\"text-[10px] text-text-tertiary/60 italic leading-normal font-black tracking-tight\">\n                      Protected tokens and environment variables.\n                    </p>\n                  </div>\n\n                  <div className=\"bg-surface/5 border border-border/10 p-5 space-y-6\">\n                    <div className=\"space-y-4\">\n                      <div className=\"flex flex-col gap-0.5\">\n                        <span className=\"text-[11px] font-black text-text-primary uppercase tracking-[0.2em]\">Vault Index</span>\n                        <p className=\"text-[10px] text-text-tertiary/60 italic px-3 font-black tracking-tight\">\n                          Access in tools via <code className=\"text-accent underline\">{\"{{vault:KEY}}\"}</code>.\n                        </p>\n                      </div>\n\n                      <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-2\">\n                        {vaultSecrets && vaultSecrets.length > 0 ? (\n                          vaultSecrets.map((secret: any) => (\n                            <div\n                              key={secret.name}\n                              className=\"flex items-center justify-between px-3 py-1.5 bg-background/20 border border-border/5 group hover:border-accent/20 transition-all\"\n                            >\n                              <div className=\"flex items-center gap-2\">\n                                <span className=\"text-[8px] font-black text-accent/40 uppercase\">[KEY]</span>\n                                <span className=\"text-[11px] font-black text-text-primary/70 font-mono truncate max-w-[120px]\">\n                                  {secret.name}\n                                </span>\n                              </div>\n                              <button\n                                onClick={() => handleRemoveVaultSecret(secret.name)}\n                                className=\"text-text-tertiary/20 hover:text-status-error opacity-0 group-hover:opacity-100 transition-all text-[10px] font-black\"\n                              >\n                                [X]\n                              </button>\n                            </div>\n                          ))\n                        ) : (\n                          <div className=\"col-span-full py-6 border border-dashed border-border/10 flex flex-col items-center justify-center text-text-tertiary/20\">\n                            <span className=\"text-[9px] uppercase font-black tracking-[0.2em]\">No secrets stored</span>\n                          </div>\n                        )}\n                      </div>\n\n                      {/* Add Secret Form */}\n                      <div className=\"mt-4 p-4 border-t border-border/5 space-y-3\">\n                        <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-4\">\n                          <div className=\"space-y-1\">\n                            <label className=\"text-[9px] font-black text-text-tertiary/40 uppercase tracking-widest ml-1\">Key</label>\n                            <input\n                              type=\"text\"\n                              placeholder=\"GITHUB_TOKEN\"\n                              value={newVaultSecret.name}\n                              onChange={(e) => setNewVaultSecret(prev => ({ ...prev, name: e.target.value.toUpperCase().replace(/[^A-Z0-9_]/g, '_') }))}\n                              className=\"w-full bg-transparent border-b border-border/10 px-0 py-1 text-[11px] text-text-primary focus:outline-none focus:border-accent/40 font-mono transition-all uppercase\"\n                            />\n                          </div>\n                          <div className=\"space-y-1\">\n                            <label className=\"text-[9px] font-black text-text-tertiary/40 uppercase tracking-widest ml-1\">Value</label>\n                            <input\n                              type=\"password\"\n                              placeholder=\"Secret value\"\n                              value={newVaultSecret.value}\n                              onChange={(e) => setNewVaultSecret(prev => ({ ...prev, value: e.target.value }))}\n                              className=\"w-full bg-transparent border-b border-border/10 px-0 py-1 text-[11px] text-text-primary focus:outline-none focus:border-accent/40 font-mono transition-all\"\n                            />\n                          </div>\n                        </div>\n                        <button\n                          onClick={handleSetVaultSecret}\n                          disabled={isSaving || !newVaultSecret.name || !newVaultSecret.value}\n                          className=\"w-full py-1 text-accent hover:text-accent-hover font-black text-[10px] uppercase tracking-widest transition-all disabled:opacity-20 active:scale-[0.98]\"\n                        >\n                          Store in Vault\n                        </button>\n                      </div>\n                    </div>\n                  </div>\n                </section>\n              </div>\n            )\n            }\n\n            {activeTab === 'shortcuts' && (\n              <div className=\"space-y-8 animate-in fade-in slide-in-from-bottom-2 duration-300 font-mono\">\n                {/* All Hotkeys Section */}\n                <section className=\"space-y-3\">\n                  <div className=\"flex flex-col gap-0.5\">\n                    <div className=\"flex items-center gap-2 text-accent/80\">\n                      <h2 className=\"text-[12px] font-black uppercase tracking-[0.2em]\">Shortcuts</h2>\n                    </div>\n                  </div>\n\n                  <div className=\"bg-surface/5 border border-border/10 p-5\">\n                    <div className=\"grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-1\">\n                      {Object.entries(hotkeyLabels).map(([key, label]) => (\n                        <div key={key} className=\"flex items-center justify-between py-1.5 border-b border-border/5 last:border-0 md:[&:nth-last-child(-n+2)]:border-0\">\n                          <span className=\"text-[10px] font-black text-text-tertiary/60 uppercase tracking-widest\">{label}</span>\n                          <button\n                            onClick={() => setRecordingHotkey(key)}\n                            className={clsx(\n                              \"font-mono text-[10px] font-black transition-all min-w-[90px] text-right\",\n                              recordingHotkey === key\n                                ? \"text-accent animate-pulse\"\n                                : \"text-accent/60 hover:text-accent\"\n                            )}\n                          >\n                            {recordingHotkey === key ? 'Recording...' : ((config?.ui as any)?.hotkeys?.[key] || hotkeyDefaults[key] || 'N/A')}\n                          </button>\n                        </div>\n                      ))}\n                    </div>\n                        <div className=\"mt-6 pt-3 border-t border-border/5\">\n                      <p className=\"text-[9px] text-text-tertiary/20 tracking-tighter italic font-black\">\n                        Press Escape to cancel. System reserved keys may override.\n                      </p>\n                    </div>\n                  </div>\n                </section>\n              </div>\n            )\n            }\n          </div >\n        </div >\n      </div >\n    </div >\n  );\n};\n","structuredPatch":[{"oldStart":781,"oldLines":13,"newStart":781,"newLines":6,"lines":["     }","   };"," ","-  const themes = [","-    { id: 'default', name: 'Matrix Dark', colors: 'bg-[#181c21]', accent: 'bg-[#22d3ee]' },","-    { id: 'light', name: 'Paper White', colors: 'bg-[#f2f2f2]', accent: 'bg-[#2563eb]' },","-    { id: 'cobalt2', name: 'Cobalt2', colors: 'bg-[#193549]', accent: 'bg-[#ffc600]' },","-    { id: 'nerv', name: 'NERV HQ', colors: 'bg-[#1c1c1c]', accent: 'bg-[#ff9500]' },","-  ];","-","   return (","     <div className=\"flex h-full bg-background font-mono text-[13px] overflow-hidden\">","       {/* Main Content Area */}"]}],"userModified":false,"replaceAll":false}}
{"parentUuid":"7a402b55-a291-402e-b83a-96c0419b8882","isSidechain":false,"userType":"external","cwd":"/Users/patrick/workingdir/familiar","sessionId":"507f4396-f3e4-4a63-8b43-9c891e06f5ee","version":"2.0.76","gitBranch":"main","slug":"precious-crunching-toast","message":{"model":"claude-opus-4-5-20251101","id":"msg_01KxPRoimPWEyE7KaMDAehDE","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"All the edits have been made. I removed:\n1. The entire \"Interface Theme\" section (the theme picker UI)\n2. The `theme` state variable\n3. The `handleUpdateTheme` function\n4. The `themes` array\n\nThe theme picker has been completely removed from the settings/general page.","signature":"ErADCkYICxgCKkCYy+9Q3AhCe3S/Fkx0PBOM4XwbVmh3yieJeDRfInposIc/SarJJVTVWfYKjikN2K38PpfEfxOQKdtF0iPYjHvhEgwI4lt/69kUt/LG09YaDJWmuPIEWISCd6oSUSIw9Er/gveSAMDOYI3a94eH83+UrAbva58lkhXFG9Z976JPsPy/8koD+P4hhDm3yuDOKpcCNCQT78clsEiLczN2gto/e+eRMoEPX8SPUt3gaboiP5Eh9qmJKoJTqElQ6vmZ8rxCFNmEFNXjemwaVoGabJorlH+pFLoBjeatIvSa0WVFodcmv+OfgK6UaoOAJPRwBecbtsFnKtvAyl2DGMgglStMrnrmzynCsgH1W53+KDSu9UgvEh+VwllG27J2nwyIabwHLRUtM2JNyEb+fvDAyA9vUMEhIV+Vt+6hSNsWo/hrqftLRqsGqeFqyG0nLfNRUje7Esab+HO2hON3I0ry9+XMRbUQHsar6Au72GUxm5geOqaoCfM+qlXU8oZsbrCq8BJZSPaEuqER/ZfCrHT17USEEsenj/yuvlfoOzCJ2yQELGJPAQrn+ux4GAE="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":3351,"cache_read_input_tokens":55313,"cache_creation":{"ephemeral_5m_input_tokens":3351,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWjfxvMjUGcDBRQ9whH9z","type":"assistant","uuid":"e8dee0ec-e56f-403e-954f-baa65b33bd46","timestamp":"2026-01-03T02:41:16.828Z"}
{"parentUuid":"e8dee0ec-e56f-403e-954f-baa65b33bd46","isSidechain":false,"userType":"external","cwd":"/Users/patrick/workingdir/familiar","sessionId":"507f4396-f3e4-4a63-8b43-9c891e06f5ee","version":"2.0.76","gitBranch":"main","slug":"precious-crunching-toast","message":{"model":"claude-opus-4-5-20251101","id":"msg_01KxPRoimPWEyE7KaMDAehDE","type":"message","role":"assistant","content":[{"type":"text","text":"Done. Removed the theme picker section from settings/general, along with the related dead code (`theme` state, `handleUpdateTheme` handler, and `themes` array)."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":3351,"cache_read_input_tokens":55313,"cache_creation":{"ephemeral_5m_input_tokens":3351,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWjfxvMjUGcDBRQ9whH9z","type":"assistant","uuid":"f764ee52-739f-4d96-a6fd-ee6d5c25587a","timestamp":"2026-01-03T02:41:17.719Z"}
{"parentUuid":"f764ee52-739f-4d96-a6fd-ee6d5c25587a","isSidechain":false,"userType":"external","cwd":"/Users/patrick/workingdir/familiar","sessionId":"507f4396-f3e4-4a63-8b43-9c891e06f5ee","version":"2.0.76","gitBranch":"main","slug":"precious-crunching-toast","type":"system","subtype":"stop_hook_summary","hookCount":1,"hookInfos":[{"command":"callback"}],"hookErrors":[],"preventedContinuation":false,"stopReason":"","hasOutput":false,"level":"suggestion","timestamp":"2026-01-03T02:41:17.780Z","uuid":"33566ee6-cd16-4b92-8a1d-e81069240117","toolUseID":"9fc5e43d-390d-414a-b68c-67f9164aa1e9"}
{"type":"file-history-snapshot","messageId":"f663072d-6e1a-4ef4-b347-5e2309884127","snapshot":{"messageId":"f663072d-6e1a-4ef4-b347-5e2309884127","trackedFileBackups":{"packages/desktop/ui/src/components/Agent/SettingsView.tsx":{"backupFileName":"09d0ee9d4e040ead@v2","version":2,"backupTime":"2026-01-03T02:42:24.642Z"}},"timestamp":"2026-01-03T02:42:24.633Z"},"isSnapshotUpdate":false}
{"parentUuid":"33566ee6-cd16-4b92-8a1d-e81069240117","isSidechain":false,"userType":"external","cwd":"/Users/patrick/workingdir/familiar","sessionId":"507f4396-f3e4-4a63-8b43-9c891e06f5ee","version":"2.0.76","gitBranch":"main","slug":"precious-crunching-toast","type":"user","message":{"role":"user","content":"Caveat: The messages below were generated by the user while running local commands. DO NOT respond to these messages or otherwise consider them in your response unless the user explicitly asks you to."},"isMeta":true,"uuid":"82517509-acf7-4d44-8e7f-24146831c157","timestamp":"2026-01-03T02:42:24.621Z"}
{"parentUuid":"82517509-acf7-4d44-8e7f-24146831c157","isSidechain":false,"userType":"external","cwd":"/Users/patrick/workingdir/familiar","sessionId":"507f4396-f3e4-4a63-8b43-9c891e06f5ee","version":"2.0.76","gitBranch":"main","slug":"precious-crunching-toast","type":"user","message":{"role":"user","content":"<command-name>/exit</command-name>\n            <command-message>exit</command-message>\n            <command-args></command-args>"},"uuid":"f663072d-6e1a-4ef4-b347-5e2309884127","timestamp":"2026-01-03T02:42:24.619Z"}
{"parentUuid":"f663072d-6e1a-4ef4-b347-5e2309884127","isSidechain":false,"userType":"external","cwd":"/Users/patrick/workingdir/familiar","sessionId":"507f4396-f3e4-4a63-8b43-9c891e06f5ee","version":"2.0.76","gitBranch":"main","slug":"precious-crunching-toast","type":"user","message":{"role":"user","content":"<local-command-stdout>Catch you later!</local-command-stdout>"},"uuid":"c6b4c8cb-f8d5-43fb-a7a3-1f49ae35a9f2","timestamp":"2026-01-03T02:42:24.619Z"}
