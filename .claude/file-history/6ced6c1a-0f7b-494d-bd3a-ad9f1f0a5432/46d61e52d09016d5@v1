import { test, expect } from './fixtures/test-fixtures';

test.describe('Settings - Provider Configuration', () => {
  test.beforeEach(async ({ settingsPage }) => {
    await settingsPage.goto();
  });

  test('should display provider configuration section', async ({ page }) => {
    await expect(page.locator('text=Provider Configuration')).toBeVisible();
  });

  test('should show provider index with cloud providers', async ({ page }) => {
    await expect(page.locator('text=Cloud')).toBeVisible();
    // Should show common providers
    await expect(page.locator('text=anthropic').or(page.locator('text=Anthropic'))).toBeVisible();
  });

  test('should show local providers section', async ({ page }) => {
    await expect(page.locator('text=Local')).toBeVisible();
  });

  test('should select a provider and show details', async ({ page }) => {
    // Click on a provider
    await page.click('text=anthropic');

    // Should show API key input or status
    await expect(
      page.locator('text=API Key').or(page.locator('text=Register'))
    ).toBeVisible();
  });

  test('should add API key for a provider', async ({ page }) => {
    await page.click('text=anthropic');

    const keyInput = page.getByPlaceholder(/paste key/i);
    if (await keyInput.isVisible()) {
      await keyInput.fill('sk-test-key-12345');
      await page.getByRole('button', { name: /register/i }).click();
      // Should show success or update state
      await page.waitForTimeout(500);
    }
  });

  test('should toggle provider on/off', async ({ page }) => {
    await page.click('text=anthropic');

    const toggleButton = page.getByRole('button', { name: /on|off/i }).first();
    if (await toggleButton.isVisible()) {
      const initialState = await toggleButton.textContent();
      await toggleButton.click();
      await page.waitForTimeout(300);
      const newState = await toggleButton.textContent();
      expect(newState).not.toBe(initialState);
    }
  });

  test('should show models section for provider', async ({ page }) => {
    await page.click('text=anthropic');
    await expect(page.locator('text=Models')).toBeVisible();
  });
});

test.describe('Settings - Interface Theme', () => {
  test.beforeEach(async ({ settingsPage }) => {
    await settingsPage.goto();
  });

  test('should display theme section', async ({ page }) => {
    await expect(page.locator('text=Interface Theme')).toBeVisible();
  });

  test('should show multiple theme options', async ({ page }) => {
    // Look for theme buttons/options
    const themeButtons = page.locator('button').filter({ hasText: /dark|light|system|midnight/i });
    expect(await themeButtons.count()).toBeGreaterThan(0);
  });

  test('should change theme when clicked', async ({ page }) => {
    // Find and click a different theme
    const themeButton = page.locator('button').filter({ hasText: /midnight/i }).first();
    if (await themeButton.isVisible()) {
      await themeButton.click();
      await page.waitForTimeout(300);
      // Theme should be applied (check for visual change or selection state)
    }
  });
});

test.describe('Settings - Behavior', () => {
  test.beforeEach(async ({ settingsPage }) => {
    await settingsPage.goto();
  });

  test('should display behavior section', async ({ page }) => {
    await expect(page.locator('text=Behavior')).toBeVisible();
  });

  test('should show auto-compaction toggle', async ({ page }) => {
    await expect(page.locator('text=Auto-compaction')).toBeVisible();

    const toggleButton = page.getByRole('button', { name: /active|inactive/i }).first();
    await expect(toggleButton).toBeVisible();
  });

  test('should toggle auto-compaction', async ({ page }) => {
    const toggleButton = page.getByRole('button', { name: /active|inactive/i }).first();
    const initialState = await toggleButton.textContent();
    await toggleButton.click();
    await page.waitForTimeout(300);
    const newState = await toggleButton.textContent();
    expect(newState).not.toBe(initialState);
  });
});

test.describe('Settings - Sub-agents', () => {
  test.beforeEach(async ({ settingsPage }) => {
    await settingsPage.goto();
  });

  test('should display sub-agents section', async ({ page }) => {
    // Sub-agents section header (uppercase)
    await expect(page.locator('text=SUB-AGENTS').or(page.locator('text=Sub-agents'))).toBeVisible();
  });

  test('should toggle sub-agent options if available', async ({ page }) => {
    // Look for any toggle buttons in the sub-agents section
    const toggles = page.getByRole('button').filter({ hasText: /enabled|disabled|active|inactive/i });
    const count = await toggles.count();
    if (count > 0) {
      await toggles.first().click();
      await page.waitForTimeout(300);
    }
  });
});

test.describe('Settings - Shell Policy', () => {
  test.beforeEach(async ({ settingsPage }) => {
    await settingsPage.goto();
  });

  test('should display shell policy section', async ({ page }) => {
    await expect(page.locator('text=Shell Policy')).toBeVisible();
  });

  test('should show execution mode options', async ({ page }) => {
    await expect(page.locator('text=Execution Mode')).toBeVisible();
  });
});

test.describe('Settings - Secure Vault', () => {
  test.beforeEach(async ({ settingsPage }) => {
    await settingsPage.goto();
  });

  test('should display vault section', async ({ page }) => {
    await expect(page.locator('text=Secure Vault')).toBeVisible();
  });

  test('should show vault index', async ({ page }) => {
    await expect(page.locator('text=Vault Index')).toBeVisible();
  });

  test('should add a secret to vault', async ({ page }) => {
    const keyInput = page.getByPlaceholder(/github_token/i);
    const valueInput = page.getByPlaceholder(/secret value/i);

    if (await keyInput.isVisible() && await valueInput.isVisible()) {
      await keyInput.fill('TEST_SECRET');
      await valueInput.fill('test-secret-value');
      await page.getByRole('button', { name: /store in vault/i }).click();
      await page.waitForTimeout(500);
      // Secret should appear in the list
      await expect(page.locator('text=TEST_SECRET')).toBeVisible();
    }
  });
});

test.describe('Settings - Shortcuts', () => {
  test.beforeEach(async ({ settingsPage }) => {
    await settingsPage.goto();
  });

  test('should display shortcuts section', async ({ page }) => {
    await expect(page.locator('text=Shortcuts')).toBeVisible();
  });

  test('should show keyboard shortcut list', async ({ page }) => {
    // Should show various shortcut labels
    const shortcuts = page.locator('button').filter({ hasText: /âŒ˜|ctrl|alt|shift/i });
    expect(await shortcuts.count()).toBeGreaterThan(0);
  });
});
