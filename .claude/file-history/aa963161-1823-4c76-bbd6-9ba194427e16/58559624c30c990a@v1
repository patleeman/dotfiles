import React, { useState, useEffect, useRef } from 'react';
import { useAgents } from '../../context/AgentContext';
import { useNavigate } from 'react-router-dom';
import { ChevronRight, ClipboardList, Edit2, Check, Play, Pause, Zap, Folder, X, Trash2, PanelRight, PanelLeft, MoreHorizontal, Target, Compass, Cpu, Loader2, Settings } from 'lucide-react';
import { clsx } from 'clsx';
import { AgentSettings } from './AgentSettings';
import { api, type Attachment, isSubAgentManagedCLI } from '../../lib/api';
import { Command, open } from '@tauri-apps/plugin-shell';
import { ask, message } from '@tauri-apps/plugin-dialog';
import { useQuery } from '@tanstack/react-query';
import ReactMarkdown from 'react-markdown';
import { ChatInput } from './ChatInput';
import { LogViewer } from './LogViewer';
import { SecretRequest } from './SecretRequest';
import { isHotkey } from '../../lib/hotkeys';

export const AgentWorkspace: React.FC = () => {
  const { agents, tasks, activeAgentId, updateAgentState, sendMessage, updateScope, logs, clearConversation, isSidebarCollapsed, toggleSidebar, setSidebarCollapsed, isExplorerCollapsed, toggleExplorer, activeTab, setActiveTab, approveTool, openWorkspace } = useAgents();
  const navigate = useNavigate();
  const [isIntentCollapsed, setIsIntentCollapsed] = useState(() => {
    const visited = localStorage.getItem(`visited-${activeAgentId}`);
    return !!visited;
  });
  const [isPlanCollapsed, setIsPlanCollapsed] = useState(false);

  useEffect(() => {
    if (activeAgentId) {
      localStorage.setItem(`visited-${activeAgentId}`, 'true');
    }
  }, [activeAgentId]);
  const [isSavingSettings, setIsSavingSettings] = useState(false);
  const [showSaveSuccess, setShowSaveSuccess] = useState(false);
  const [isEditingPlan, setIsEditingPlan] = useState(false);
  const [editPlanContent, setEditPlanContent] = useState('');
  const [isProcessing, setIsProcessing] = useState(false);
  const [pendingState, setPendingState] = useState<'running' | 'paused' | null>(null);

  const agent = activeAgentId ? agents[activeAgentId] : null;
  const parentAgent = (agent && agent.parent_id) ? agents[agent.parent_id] : null;

  useEffect(() => {
    if (agent && pendingState === (agent.state === 'running' ? 'running' : 'paused')) {
      setPendingState(null);
    }
  }, [agent?.state, pendingState]);

  // Panel sizing state
  const [sidebarWidth, setSidebarWidth] = useState(() => {
    const saved = localStorage.getItem('agent-sidebar-width');
    return saved ? parseInt(saved, 10) : 300;
  });
  const [planHeight, setPlanHeight] = useState(() => {
    const saved = localStorage.getItem('agent-plan-height');
    return saved ? parseInt(saved, 10) : 300;
  });

  useEffect(() => {
    localStorage.setItem('agent-sidebar-width', sidebarWidth.toString());
  }, [sidebarWidth]);

  useEffect(() => {
    localStorage.setItem('agent-plan-height', planHeight.toString());
  }, [planHeight]);

  const isResizingSidebar = useRef(false);
  const isResizingPlan = useRef(false);

  useEffect(() => {
    const handleMouseMove = (e: MouseEvent) => {
      if (isResizingSidebar.current) {
        const newWidth = window.innerWidth - e.clientX;
        setSidebarWidth(Math.max(200, Math.min(600, newWidth)));
      } else if (isResizingPlan.current) {
        const planElement = document.getElementById('plan-section');
        if (planElement) {
          const rect = planElement.getBoundingClientRect();
          const newHeight = e.clientY - rect.top;
          setPlanHeight(Math.max(100, Math.min(window.innerHeight * 0.7, newHeight)));
        }
      }
    };

    const handleMouseUp = () => {
      isResizingSidebar.current = false;
      isResizingPlan.current = false;
      document.body.style.cursor = 'default';
      document.body.style.userSelect = 'auto';
    };

    window.addEventListener('mousemove', handleMouseMove);
    window.addEventListener('mouseup', handleMouseUp);
    return () => {
      window.removeEventListener('mousemove', handleMouseMove);
      window.removeEventListener('mouseup', handleMouseUp);
    };
  }, []);

  // Reset state on agent change
  useEffect(() => {
    if (activeAgentId) {
      setIsEditingPlan(false);
      setEditPlanContent('');
    }
  }, [activeAgentId]);

  const [logSearch] = useState('');
  const chatEndRef = useRef<HTMLDivElement>(null);
  const scrollRef = useRef<HTMLDivElement>(null);
  const shouldAutoScrollRef = useRef(true);

  const handleScroll = () => {
    const container = scrollRef.current;
    if (!container) return;
    // Classic IRC behavior: if we're within 30px of the bottom, we auto-scroll.
    const isAtBottom = container.scrollHeight - container.scrollTop - container.clientHeight < 30;
    shouldAutoScrollRef.current = isAtBottom;
  };

  const subAgentCount = agent ? Object.values(agents).filter(a => a.parent_id?.toLowerCase() === agent.id.toLowerCase() && !a.is_internal).length : 0;
  const taskCount = (agent && tasks) ? tasks.filter(t => t.parent_agent_id?.toLowerCase() === agent.id.toLowerCase()).length : 0;
  const hasProcesses = subAgentCount > 0 || taskCount > 0;

  const agentLogs = React.useMemo(() => (activeAgentId ? logs[activeAgentId] || [] : []), [activeAgentId, logs]);
  const latestSecretRequest = React.useMemo(() => {
    for (let i = agentLogs.length - 1; i >= 0; i--) {
      if (agentLogs[i].event_type === 'secret_request') {
        return agentLogs[i];
      }
    }
    return null;
  }, [agentLogs]);
  const latestSecretPayload = latestSecretRequest?.payload as any;
  const latestSecretToolCallId = latestSecretPayload?.tool_call_id || latestSecretPayload?.id;

  const hasSidebarInfo = React.useMemo(() => {
    if (!agent) return false;
    return !!agent.current_scope?.content ||
      hasProcesses ||
      !!agent.initial_prompt ||
      (agent.parent_id && !!agents[agent.parent_id]?.current_scope?.content);
  }, [agent, agents, hasProcesses]);

  const { data: config } = useQuery({
    queryKey: ['config'],
    queryFn: () => api.getConfig(),
  });

  const { data: apiKeys } = useQuery({
    queryKey: ['apiKeys'],
    queryFn: () => api.getApiKeys(),
  });

  useEffect(() => {
    if (shouldAutoScrollRef.current) {
      chatEndRef.current?.scrollIntoView({ behavior: 'auto' });
    }
  }, [agentLogs]);

  // Always scroll to bottom when switching to workspace tab or changing agents
  useEffect(() => {
    if (activeTab === 'workspace') {
      shouldAutoScrollRef.current = true;
      chatEndRef.current?.scrollIntoView({ behavior: 'auto' });
    }
  }, [activeTab, activeAgentId]);

  // Automatically collapse sidebar if empty when switching agents
  const lastActiveAgentIdRef = useRef<string | null>(null);
  useEffect(() => {
    if (activeAgentId && activeAgentId !== lastActiveAgentIdRef.current) {
      if (!hasSidebarInfo && !isSidebarCollapsed) {
        setSidebarCollapsed(true);
      }
      // We only set the ref when we have either successfully collapsed it
      // or we've decided it shouldn't be collapsed (has info or already collapsed)
      if (hasSidebarInfo || isSidebarCollapsed) {
        lastActiveAgentIdRef.current = activeAgentId;
      }
    }
  }, [activeAgentId, hasSidebarInfo, isSidebarCollapsed, setSidebarCollapsed]);

  const handleSaveEdit = React.useCallback(async (newContent: string) => {
    if (activeAgentId) {
      await updateScope(activeAgentId, newContent, agent?.current_scope?.frontmatter);
    }
  }, [activeAgentId, updateScope, agent?.current_scope?.frontmatter]);

  const handleSavePlan = React.useCallback(async () => {
    if (activeAgentId && agent?.current_scope) {
      await updateScope(activeAgentId, editPlanContent, agent.current_scope.frontmatter);
      setIsEditingPlan(false);
    }
  }, [activeAgentId, agent?.current_scope, editPlanContent, updateScope]);

  const openInFinder = React.useCallback(async (path: string) => {
    try {
      // Use the 'reveal' command we defined in capabilities/default.json to open Finder and highlight the file
      await Command.create('reveal', ['-R', path]).execute();
    } catch (err) {
      console.error('Failed to reveal path in finder:', path, err);
      // Fallback to regular open if reveal fails
      try {
        await open(path);
      } catch (openErr) {
        console.error('Failed to open path:', path, openErr);
      }
    }
  }, []);

  const filteredLogs = React.useMemo(() => {
    if (!agent) return [];
    return agentLogs.filter(log => {
      const matchesSearch = !logSearch || JSON.stringify(log.payload).toLowerCase().includes(logSearch.toLowerCase()) || log.event_type.toLowerCase().includes(logSearch.toLowerCase());

      // Filter out internal system logs that have no renderable content for the user
      const payload = log.payload as any;
      const handledEvents = [
        'user_interaction',
        'model_responded',
        'scope_updated',
        'agent_error',
        'tool_call',
        'tool_output',
        'tool_error',
        'model_thinking',
        'sub_agent_report',
        'sub_agent_error',
        'history_compacted',
        'conversation_cleared',
        'compaction_requested',
        'tool_approval_requested',
        'tool_approval_resolved',
        'cli_output',
        'shell_output'
      ];

      if (!handledEvents.includes(log.event_type)) {
        // If it's an unhandled system event, only show it if it has explicit content or message
        if (!payload?.content && !payload?.message && !payload?.findings) {
          return false;
        }
      }

      // Always hide chunks as they are aggregated into model_responded
      if (log.event_type === 'model_responded_chunk') return false;
      // Hide sub-agent proposals in the log as they trigger UI state changes elsewhere or are redundant
      if (log.event_type === 'sub_agent_proposal') return false;

      return matchesSearch;
    });
  }, [agent, agentLogs, logSearch]);

  // Find the latest history_compacted event to hide older messages
  const displayLogs = React.useMemo(() => {
    if (!agent) return [];

    let compactionCutoffIdx = -1;
    for (let i = filteredLogs.length - 1; i >= 0; i--) {
      if (filteredLogs[i].event_type === 'history_compacted' || filteredLogs[i].event_type === 'conversation_cleared') {
        compactionCutoffIdx = i;
        break;
      }
    }

    return compactionCutoffIdx === -1
      ? filteredLogs
      : filteredLogs.slice(compactionCutoffIdx);
  }, [agent, filteredLogs]);

  useEffect(() => {
    const handleKeyDown = (e: KeyboardEvent) => {
      // Don't trigger if user is typing in an input, unless it's a Cmd/Ctrl shortcut
      const activeElement = document.activeElement;
      const isInput = activeElement instanceof HTMLInputElement ||
        activeElement instanceof HTMLTextAreaElement ||
        (activeElement as HTMLElement)?.isContentEditable;

      const hotkeys = config?.ui?.hotkeys || {};

      if (isInput && !(e.metaKey || e.ctrlKey)) return;

      if (isHotkey(e, hotkeys['toggle_sidebar'] || 'Cmd+B')) {
        e.preventDefault();
        toggleSidebar();
      }
      if (isHotkey(e, hotkeys['toggle_settings'] || 'Cmd+,')) {
        e.preventDefault();
        setActiveTab(prev => prev === 'settings' ? 'workspace' : 'settings');
      }
      if (isHotkey(e, hotkeys['toggle_pause'] || 'Cmd+P') && agent) {
        e.preventDefault();
        updateAgentState(agent.id, agent.state === 'running' ? 'pause' : 'resume');
      }
      if (isHotkey(e, hotkeys['compact'] || 'Cmd+Shift+C') && agent) {
        e.preventDefault();
        updateAgentState(agent.id, 'repair');
      }

      if (e.key === 'ArrowUp') {
        if (scrollRef.current) {
          e.preventDefault();
          scrollRef.current.scrollBy({ top: -100, behavior: 'smooth' });
        }
      }
      if (e.key === 'ArrowDown') {
        if (scrollRef.current) {
          e.preventDefault();
          scrollRef.current.scrollBy({ top: 100, behavior: 'smooth' });
        }
      }
      if (e.key === ' ' && !isInput) {
        if (scrollRef.current) {
          e.preventDefault();
          const direction = e.shiftKey ? -1 : 1;
          scrollRef.current.scrollBy({
            top: direction * scrollRef.current.clientHeight * 0.8,
            behavior: 'smooth'
          });
        }
      }
    };

    window.addEventListener('keydown', handleKeyDown);
    return () => window.removeEventListener('keydown', handleKeyDown);
  }, [toggleSidebar, agent, updateAgentState, displayLogs, approveTool, config]);

  const handleSendMessageInternal = React.useCallback(async (content: string, attachments?: Attachment[]) => {
    if (agent) {
      await sendMessage(agent.id, content, attachments);
      shouldAutoScrollRef.current = true;
    }
  }, [agent?.id, sendMessage]);

  if (!agent) return null;

  const enabledProviders = Object.keys(config?.available_models || {}).filter(p => {
    const key = apiKeys?.find(k => k.provider.toLowerCase() === p.toLowerCase());
    return key?.enabled === true;
  });
  const providers = enabledProviders.includes(agent.model_config.provider)
    ? enabledProviders
    : (agent.model_config.provider ? [...enabledProviders, agent.model_config.provider] : enabledProviders);
  const currentProvider = agent.model_config.provider || providers[0] || '';
  const availableModels = config?.available_models?.[currentProvider]?.chat || [];

  const formatNextRun = (dateStr: string) => {
    const date = new Date(dateStr);
    const now = new Date();
    const isToday = date.toDateString() === now.toDateString();
    const options: Intl.DateTimeFormatOptions = isToday
      ? { hour: '2-digit', minute: '2-digit' }
      : { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' };
    return (isToday ? 'Today ' : '') + date.toLocaleString([], options);
  };

  return (
    <div className="flex flex-col h-full bg-background text-[13px]">
      {/* Main Layout */}
      <div className="flex-1 overflow-hidden flex flex-col">
        {activeTab === 'settings' ? (
          <div className="flex-1 overflow-y-auto custom-scrollbar">
            <AgentSettings
              agent={agent}
              onSavingChange={setIsSavingSettings}
              onSuccessChange={setShowSaveSuccess}
            />
          </div>
        ) : (
          <div className="flex h-full overflow-hidden">
            {/* Left Panel: Primary Buffer */}
            <div className="flex-1 flex flex-col min-w-0">
              <div
                ref={scrollRef}
                onScroll={handleScroll}
                className="flex-1 overflow-auto px-1.5 py-0.5 space-y-0 custom-scrollbar"
              >
                <LogViewer
                  logs={displayLogs}
                  agents={agents}
                  activeAgentId={activeAgentId!}
                  onUpdateScope={handleSaveEdit}
                  onUpdateAgentState={updateAgentState}
                  openInFinder={openInFinder}
                />
                {agent.state === 'awaiting_secret' && (
                  <div className="px-1.5 pb-2">
                    {latestSecretRequest && latestSecretToolCallId ? (
                      <SecretRequest
                        agentId={agent.id}
                        toolCallId={latestSecretToolCallId}
                        secretKeys={latestSecretPayload?.keys as string[] | undefined}
                        secretKey={latestSecretPayload?.key as string | undefined}
                        args={latestSecretPayload?.args}
                        isProcessed={false}
                      />
                    ) : (
                      <div className="px-3 py-2 text-[10px] font-black uppercase tracking-[0.2em] text-status-warning bg-surface/20 border border-status-warning/30">
                        Agent is waiting for a secure input. Please keep this window open and enter the requested secret once prompted.
                      </div>
                    )}
                  </div>
                )}
                <div ref={chatEndRef} />
              </div>

              {/* Bottom Input Area */}
              {agent.type !== 'cli' && (
                <div className="border-t border-border/50 bg-surface/5 flex items-stretch">
                  <div className="flex-1 min-w-0">
                    <ChatInput
                      agentId={agent.id}
                      onSendMessage={handleSendMessageInternal}
                      disabled={(agent.state === 'running' || agent.is_compacting || isProcessing) && agent.state !== 'error'}
                    />
                  </div>

                  {/* Agent Context & Controls Integrated Toolbar */}
                  <div className="flex items-center gap-1.5 px-1.5 border-l border-border/30 bg-background/20">
                    <div className="flex items-center gap-1">
                      {(pendingState || agent.state) === 'running' ? (
                        <button
                          onClick={async () => {
                            setIsProcessing(true);
                            setPendingState('paused');
                            try {
                              await updateAgentState(agent.id, 'pause');
                            } catch (e) {
                              setPendingState(null);
                            } finally {
                              setIsProcessing(false);
                            }
                          }}
                          disabled={agent.is_compacting || isProcessing}
                          className="p-1 hover:bg-status-warning/10 text-status-warning rounded transition-all disabled:opacity-20 active:scale-90 cursor-pointer"
                          title="Pause Agent"
                        >
                          <Pause size={13} fill="currentColor" />
                        </button>
                      ) : (
                        <button
                          onClick={async () => {
                            setIsProcessing(true);
                            setPendingState('running');
                            try {
                              await updateAgentState(agent.id, 'resume');
                            } catch (e) {
                              setPendingState(null);
                            } finally {
                              setIsProcessing(false);
                            }
                          }}
                          disabled={(agent.state === 'idle' && !agent.initial_prompt) || agent.is_compacting || isProcessing}
                          className="p-1 hover:bg-status-success/10 text-status-success rounded transition-all disabled:opacity-20 active:scale-90 cursor-pointer"
                          title="Start/Resume Agent"
                        >
                          <Play size={13} fill="currentColor" />
                        </button>
                      )}

                      <div className="w-[1px] h-3 bg-border/20" />

                      <button
                        onClick={async () => {
                          setIsProcessing(true);
                          try {
                            const result = await updateAgentState(agent.id, 'repair');
                            if (result?.status === 'skipped') {
                              if (result.reason === 'not_enough_history') {
                                await message("There isn't enough conversation history yet to compact. Compaction requires a longer history to summarize effectively.", {
                                  title: 'Compaction Skipped',
                                  kind: 'info'
                                });
                              }
                            }
                          } catch (err) {
                            console.error('Compaction failed:', err);
                            await message(err instanceof Error ? err.message : 'An unexpected error occurred during compaction.', {
                              title: 'Compaction Failed',
                              kind: 'error'
                            });
                          } finally {
                            setIsProcessing(false);
                          }
                        }}
                        disabled={agent.is_compacting || isProcessing}
                        className="p-1 hover:bg-accent/10 text-accent rounded transition-all disabled:opacity-20 active:scale-90 cursor-pointer"
                        title="Archive & Compact History"
                      >
                        <Zap size={13} fill={agent.is_compacting ? "none" : "currentColor"} className={clsx(agent.is_compacting && "animate-pulse")} />
                      </button>

                      <div className="w-[1px] h-3 bg-border/20" />


                      <button
                        onClick={async () => {
                          const confirmed = await ask("Are you sure you want to clear the entire conversation history? This will archive the current history and start a fresh session. This action cannot be undone.", {
                            title: 'Archive & Clear History',
                            kind: 'warning',
                          });
                          if (confirmed) {
                            setIsProcessing(true);
                            try {
                              await clearConversation(agent.id);
                            } finally {
                              setIsProcessing(false);
                            }
                          }
                        }}
                        disabled={agent.is_compacting || isProcessing}
                        className="p-1 hover:bg-status-error/10 text-status-error rounded transition-all disabled:opacity-20 active:scale-90 cursor-pointer"
                        title="Clear Conversation History"
                      >
                        <Trash2 size={13} />
                      </button>
                    </div>

                    {agent.is_compacting && (
                      <span className="text-[7px] text-accent animate-pulse font-black tracking-tighter shrink-0">COMPACTING</span>
                    )}
                  </div>
                </div>
              )}
            </div>

            {/* Vertical Resizer */}
            {!isSidebarCollapsed && (
              <div
                className="w-[1px] hover:w-1 bg-border hover:bg-accent/50 cursor-col-resize transition-all shrink-0 z-10"
                onMouseDown={(e) => {
                  e.preventDefault();
                  isResizingSidebar.current = true;
                  document.body.style.cursor = 'col-resize';
                  document.body.style.userSelect = 'none';
                }}
              />
            )}

            {/* Right Panel: Intent & Execution Sidebar */}
            <div
              style={{ width: isSidebarCollapsed ? 0 : sidebarWidth }}
              className={clsx(
                "flex flex-col bg-background shrink-0 transition-all duration-300 ease-in-out border-l border-border/50",
                isSidebarCollapsed && "overflow-hidden border-l-0"
              )}
            >
              <div className="flex-1 flex flex-col min-h-0 overflow-hidden">
                {/* Section 1: Intent (Inherited North Star & Mission) */}
                {((agent.parent_id && parentAgent?.current_scope) || (agent.parent_id && agent.initial_prompt)) && (
                  <div className="flex flex-col border-b border-border bg-surface/10 shrink-0 max-h-[50%] min-h-0">
                    <button
                      onClick={() => setIsIntentCollapsed(!isIntentCollapsed)}
                      className="flex items-center justify-between px-2.5 py-2 bg-surface/40 shrink-0 border-b border-border/20 group"
                    >
                      <div className="flex items-center gap-1.5">
                        <Compass size={11} className={clsx("text-accent transition-transform duration-300", !isIntentCollapsed && "rotate-180")} />
                        <span className="text-[10px] font-black text-text-primary uppercase tracking-[0.15em]">
                          Intent
                        </span>
                      </div>
                      <ChevronRight size={12} className={clsx("text-text-tertiary transition-transform duration-200 pointer-events-none", !isIntentCollapsed && "rotate-90")} />
                    </button>

                    {!isIntentCollapsed && (
                      <div className="flex flex-col min-h-0 overflow-y-auto custom-scrollbar">
                        {/* 1. Inherited North Star */}
                        {agent.parent_id && parentAgent?.current_scope && (
                          <div className="flex flex-col border-b border-border/10 bg-surface/5">
                            <div className="flex items-center gap-1.5 px-2.5 py-1.5 bg-background/20">
                              <span className="text-[8px] font-black text-text-tertiary uppercase tracking-widest">
                                Inherited North Star
                              </span>
                            </div>
                            <div className="p-2.5 text-[10.5px] font-mono leading-relaxed text-text-secondary opacity-80">
                              <ReactMarkdown
                                components={{
                                  h1: ({ children }) => <h1 className="text-accent font-bold uppercase tracking-widest mt-2 mb-1 text-[8.5px] border-b border-border/30 pb-0.5">{children}</h1>,
                                  h2: ({ children }) => <h2 className="text-accent font-bold uppercase tracking-widest mt-1.5 mb-0.5 text-[8.5px]">{children}</h2>,
                                  p: ({ children }) => <p className="mb-1.5 last:mb-0 whitespace-pre-wrap">{children}</p>,
                                  ul: ({ children }) => <ul className="list-disc pl-4 mb-1.5 space-y-0">{children}</ul>,
                                  ol: ({ children }) => <ol className="list-decimal pl-5 mb-1.5 space-y-0">{children}</ol>,
                                  li: ({ children }) => <li className="pl-0.5">{children}</li>,
                                }}
                              >
                                {parentAgent.current_scope.content}
                              </ReactMarkdown>
                            </div>
                          </div>
                        )}

                        {/* 2. Assigned Mission */}
                        {agent.parent_id && agent.initial_prompt && (
                          <div className="flex flex-col bg-surface/5">
                            <div className="flex items-center gap-1.5 px-2.5 py-1.5 bg-background/20">
                              <span className="text-[8px] font-black text-text-tertiary uppercase tracking-widest">
                                Assigned Mission
                              </span>
                            </div>
                            <div className="p-2.5 text-[10px] font-mono leading-relaxed text-text-secondary italic">
                              <ReactMarkdown
                                components={{
                                  p: ({ children }) => <p className="mb-1 last:mb-0">{children}</p>,
                                  code: ({ children }) => <code className="bg-black/30 px-1 rounded text-accent-hover font-mono">{children}</code>,
                                }}
                              >
                                {agent.initial_prompt}
                              </ReactMarkdown>
                            </div>
                          </div>
                        )}
                      </div>
                    )}
                  </div>
                )}

                {/* Section 2: Execution Plan */}
                {agent.current_scope && (
                  <div id="plan-section" className="flex flex-col flex-1 min-h-0 bg-surface/10">
                    <div className="flex items-center justify-between px-2.5 py-2 bg-surface/40 shrink-0 border-b border-border/20">
                      <button
                        onClick={() => setIsPlanCollapsed(!isPlanCollapsed)}
                        className="flex flex-col items-start flex-1 min-w-0"
                      >
                        <div className="flex items-center gap-1.5 w-full">
                          <ClipboardList size={11} className="text-accent" />
                          <span className="text-[10px] font-black text-text-primary uppercase tracking-[0.15em]">
                            Execution Plan
                          </span>
                          <ChevronRight size={12} className={clsx("text-text-tertiary transition-transform duration-200 ml-auto mr-2 pointer-events-none", !isPlanCollapsed && "rotate-90")} />
                        </div>
                        <div className="text-[8px] text-text-tertiary font-bold uppercase tracking-widest mt-0.5 opacity-60 truncate w-full pr-4">
                          Plan: {(agent.current_scope?.content.match(/^\d+\./gm) || []).length} steps â€¢ updated {new Date(agent.current_scope?.created_at || agent.updated_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                        </div>
                      </button>
                      <div className="flex items-center gap-1.5">
                        {!isEditingPlan ? (
                          <>
                            {agent.current_scope && (
                              <button
                                onClick={() => {
                                  setEditPlanContent(agent.current_scope!.content);
                                  setIsEditingPlan(true);
                                }}
                                className="p-1 hover:text-accent text-text-tertiary transition-all hover:bg-accent/10 rounded active:scale-90"
                                title="Edit Plan"
                              >
                                <Edit2 size={9} />
                              </button>
                            )}
                            <span className="text-[8px] font-mono text-text-tertiary opacity-70">
                              v{agent.current_scope?.version || 0}
                            </span>
                          </>
                        ) : (
                          <div className="flex items-center gap-1">
                            <button
                              onClick={handleSavePlan}
                              className="p-1 hover:text-status-success text-text-tertiary transition-all hover:bg-status-success/10 rounded active:scale-90"
                              title="Save Changes"
                            >
                              <Check size={9} />
                            </button>
                            <button
                              onClick={() => setIsEditingPlan(false)}
                              className="p-1 hover:text-status-error text-text-tertiary transition-all hover:bg-status-error/10 rounded active:scale-90"
                              title="Cancel"
                            >
                              <X size={9} />
                            </button>
                          </div>
                        )}
                      </div>
                    </div>

                    {!isPlanCollapsed && (
                      <>
                        <div
                          style={{ flexBasis: planHeight, minHeight: 300 }}
                          className="flex-1 overflow-y-auto p-2.5 custom-scrollbar text-[10.5px] font-mono leading-relaxed text-text-secondary"
                        >
                          {isEditingPlan ? (
                            <textarea
                              value={editPlanContent}
                              onChange={(e) => setEditPlanContent(e.target.value)}
                              className="w-full h-full bg-black/20 text-text-primary p-2 rounded border border-border/50 focus:outline-none focus:border-accent/50 resize-none font-mono text-[10.5px]"
                              autoFocus
                            />
                          ) : (
                            <ReactMarkdown
                              components={{
                                h1: ({ children }) => <h1 className="text-accent font-bold uppercase tracking-widest mt-2 mb-1 text-[9px] border-b border-border/30 pb-0.5">{children}</h1>,
                                h2: ({ children }) => <h2 className="text-accent font-bold uppercase tracking-widest mt-1.5 mb-0.5 text-[9px]">{children}</h2>,
                                h3: ({ children }) => <h3 className="text-accent font-bold uppercase tracking-widest mt-1 mb-0.5 text-[9px]">{children}</h3>,
                                p: ({ children }) => <p className="mb-1.5 last:mb-0 whitespace-pre-wrap">{children}</p>,
                                ul: ({ children }) => <ul className="list-disc pl-4 mb-1.5 space-y-0">{children}</ul>,
                                ol: ({ children }) => <ol className="list-decimal pl-5 mb-1.5 space-y-0">{children}</ol>,
                                li: ({ children }) => <li className="pl-0.5">{children}</li>,
                                code: ({ children }) => <code className="bg-black/30 px-1 rounded text-accent-hover font-mono">{children}</code>,
                              }}
                            >
                              {agent.current_scope.content}
                            </ReactMarkdown>
                          )}
                        </div>
                        {/* Horizontal Resizer */}
                        <div
                          className="h-[1px] hover:h-1 bg-border hover:bg-accent/50 cursor-row-resize transition-all shrink-0 z-10"
                          onMouseDown={(e) => {
                            e.preventDefault();
                            isResizingPlan.current = true;
                            document.body.style.cursor = 'row-resize';
                            document.body.style.userSelect = 'none';
                          }}
                        />
                      </>
                    )}
                  </div>
                )}
              </div>
            </div>
          </div>
        )}
      </div>
    </div>
  );
};
