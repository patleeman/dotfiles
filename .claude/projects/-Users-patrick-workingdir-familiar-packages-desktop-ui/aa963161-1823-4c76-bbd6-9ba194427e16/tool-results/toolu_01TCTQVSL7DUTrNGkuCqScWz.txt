     1→import React from 'react';
     2→import { clsx } from 'clsx';
     3→import { ChevronRight, Target, Loader2, Search } from 'lucide-react';
     4→import type { Agent } from '../../lib/api';
     5→
     6→interface HierarchyTreeProps {
     7→    agents: Record<string, Agent>;
     8→    activeAgentId: string | null;
     9→    highlightedAgentId?: string | null;
    10→    onSelectAgent: (id: string) => void;
    11→    onRename?: (id: string) => void;
    12→    onAddSubagent?: (parentId: string) => void;
    13→    onAction?: (id: string, action: 'pause' | 'pause_tree' | 'resume' | 'resume_tree' | 'delete') => void;
    14→}
    15→
    16→export const HierarchyTree: React.FC<HierarchyTreeProps> = ({
    17→    agents,
    18→    activeAgentId,
    19→    highlightedAgentId,
    20→    onSelectAgent,
    21→    onRename,
    22→    onAddSubagent,
    23→    onAction
    24→}) => {
    25→    const [contextMenu, setContextMenu] = React.useState<{ x: number, y: number, agentId: string } | null>(null);
    26→    const [expandedIds, setExpandedIds] = React.useState<Record<string, boolean>>({});
    27→
    28→    React.useEffect(() => {
    29→        const handleClick = () => setContextMenu(null);
    30→        window.addEventListener('click', handleClick);
    31→        return () => window.removeEventListener('click', handleClick);
    32→    }, []);
    33→
    34→    const handleContextMenu = (e: React.MouseEvent, agentId: string) => {
    35→        e.preventDefault();
    36→        e.stopPropagation();
    37→        setContextMenu({ x: e.clientX, y: e.clientY, agentId });
    38→    };
    39→
    40→    const renderAgentNode = (agent: Agent, depth: number) => {
    41→        const isCurrent = activeAgentId ? agent.id.toLowerCase() === activeAgentId.toLowerCase() : false;
    42→        const isHighlighted = highlightedAgentId ? agent.id.toLowerCase() === highlightedAgentId.toLowerCase() : false;
    43→
    44→        // Build path to active agent for expansion
    45→        const pathIds = new Set<string>();
    46→        if (activeAgentId && agents[activeAgentId]) {
    47→            let curr = agents[activeAgentId];
    48→            pathIds.add(curr.id.toLowerCase());
    49→            while (curr.parent_id && agents[curr.parent_id]) {
    50→                curr = agents[curr.parent_id];
    51→                pathIds.add(curr.id.toLowerCase());
    52→            }
    53→        }
    54→
    55→        const isOnPath = pathIds.has(agent.id.toLowerCase());
    56→
    57→        // Find visible children for this agent
    58→        const children = Object.values(agents).filter(
    59→            (a) => a.parent_id?.toLowerCase() === agent.id.toLowerCase() && !a.is_internal
    60→        ).sort((a, b) => new Date(a.created_at).getTime() - new Date(b.created_at).getTime());
    61→
    62→        const hasChildren = children.length > 0;
    63→        // Always show up to 3 levels deep, or if on path, unless manually toggled
    64→        const defaultExpand = depth < 3 || isOnPath || isCurrent;
    65→        const shouldExpand = expandedIds[agent.id] !== undefined ? expandedIds[agent.id] : defaultExpand;
    66→
    67→        return (
    68→            <div key={agent.id} className="flex flex-col">
    69→                <div className="group flex flex-col relative">
    70→                    <div
    71→                        onClick={() => onSelectAgent(agent.id)}
    72→                        onContextMenu={(e) => handleContextMenu(e, agent.id)}
    73→                        style={{ paddingLeft: `${depth * 12 + 4}px` }}
    74→                        className={clsx(
    75→                            "flex items-center gap-1.5 py-0.5 px-1 cursor-pointer relative transition-colors",
    76→                            isCurrent ? "bg-accent/20 text-accent" : (isHighlighted ? "bg-accent/10 text-accent/80" : "hover:bg-surface/30 text-text-secondary hover:text-text-primary")
    77→                        )}
    78→                    >
    79→                        {/* Keyboard Highlight Marker */}
    80→                        <span className="text-accent/40 w-2 shrink-0">{isHighlighted ? '>' : ' '}</span>
    81→
    82→                        {/* Status Marker */}
    83→                        <span className={clsx(
    84→                            "text-[9px] font-black shrink-0 font-mono w-8 text-center",
    85→                            agent.state === 'running' ? "text-status-success" :
    86→                                (agent.state === 'waiting' || agent.state === 'awaiting_approval' || agent.state === 'awaiting_secret') ? "text-status-warning" :
    87→                                    agent.state === 'error' ? "text-status-error" :
    88→                                        "text-text-tertiary/40"
    89→                        )}>
    90→                            {agent.state === 'running' ? '[RUN]' :
    91→                                agent.state === 'waiting' ? '[WAI]' :
    92→                                    (agent.state === 'awaiting_approval' || agent.state === 'awaiting_secret') ? '[!!!]' :
    93→                                        agent.state === 'error' ? '[ERR]' :
    94→                                            agent.state === 'paused' ? '[PAU]' : '[IDL]'}
    95→                        </span>
    96→
    97→                        <span className={clsx(
    98→                            "text-[10px] truncate font-mono flex-1 min-w-0 tracking-tighter uppercase",
    99→                            isCurrent ? "font-black" : (isHighlighted ? "font-black" : "font-bold opacity-80")
   100→                        )}>
   101→                            {depth > 0 && <span className="opacity-30 mr-1">↳</span>}
   102→                            {agent.name || agent.id.slice(0, 8)}
   103→                        </span>
   104→
   105→                        {agent.type === 'cli' && (
   106→                            <span className="text-[8px] text-accent opacity-50 font-black shrink-0">@CLI</span>
   107→                        )}
   108→
   109→                        {hasChildren && !isCurrent && (
   110→                            <span
   111→                                onClick={(e) => {
   112→                                    e.stopPropagation();
   113→                                    setExpandedIds(prev => ({ ...prev, [agent.id]: !shouldExpand }));
   114→                                }}
   115→                                className="text-[9px] text-text-tertiary hover:text-text-primary opacity-40 hover:opacity-100 shrink-0 font-mono p-1 -m-1"
   116→                            >
   117→                                {shouldExpand ? '[-]' : '[+]'}
   118→                            </span>
   119→                        )}
   120→                    </div>
   121→                </div>
   122→
   123→                {shouldExpand && hasChildren && (
   124→                    <div className="flex flex-col">
   125→                        {children.map((child) => renderAgentNode(child, depth + 1))}
   126→                    </div>
   127→                )}
   128→            </div>
   129→        );
   130→    };
   131→
   132→    // Find root agents (no parent or parent not found)
   133→    const rootAgents = Object.values(agents).filter(
   134→        (a) => (!a.parent_id || !agents[a.parent_id]) && !a.is_internal
   135→    ).sort((a, b) => new Date(a.created_at).getTime() - new Date(b.created_at).getTime());
   136→
   137→    return (
   138→        <div className="flex flex-col py-1">
   139→            {rootAgents.map((agent) => renderAgentNode(agent, 0))}
   140→
   141→            {contextMenu && (
   142→                <div
   143→                    className="fixed z-[100] w-44 bg-[#0a0a0a] border border-[#333] font-mono text-[10px] overflow-hidden animate-in fade-in duration-75"
   144→                    style={{ top: contextMenu.y, left: contextMenu.x }}
   145→                    onClick={(e) => e.stopPropagation()}
   146→                >
   147→                    <div className="px-2 py-1 border-b border-[#333] bg-[#111] text-[#666]">
   148→                        <span className="text-[8px] tracking-wider">
   149→                            *** {agents[contextMenu.agentId]?.name || agents[contextMenu.agentId]?.id.slice(0, 8)}
   150→                        </span>
   151→                    </div>
   152→
   153→                    <button
   154→                        className="w-full text-left px-2 py-1.5 text-[#0f0] hover:bg-[#0f0]/10 hover:text-[#0f0] transition-colors border-b border-[#222]"
   155→                        onClick={() => {
   156→                            onRename?.(contextMenu.agentId);
   157→                            setContextMenu(null);
   158→                        }}
   159→                    >
   160→                        RENAME
   161→                    </button>
   162→
   163→                    <button
   164→                        className="w-full text-left px-2 py-1.5 text-[#0f0] hover:bg-[#0f0]/10 hover:text-[#0f0] transition-colors border-b border-[#222]"
   165→                        onClick={() => {
   166→                            onAddSubagent?.(contextMenu.agentId);
   167→                            setContextMenu(null);
   168→                        }}
   169→                    >
   170→                        ADD SUBAGENT
   171→                    </button>
   172→
   173→                    <button
   174→                        className="w-full text-left px-2 py-1.5 text-[#0f0] hover:bg-[#0f0]/10 hover:text-[#0f0] transition-colors border-b border-[#222]"
   175→                        onClick={() => {
   176→                            const agent = agents[contextMenu.agentId];
   177→                            if (agent) {
   178→                                onAction?.(contextMenu.agentId, agent.state === 'running' ? 'pause' : 'resume');
   179→                            }
   180→                            setContextMenu(null);
   181→                        }}
   182→                    >
   183→                        {agents[contextMenu.agentId]?.state === 'running' ? 'PAUSE' : 'RESUME'}
   184→                    </button>
   185→
   186→                    {agents[contextMenu.agentId]?.state === 'running' && (
   187→                        <button
   188→                            className="w-full text-left px-2 py-1.5 text-[#0f0] hover:bg-[#0f0]/10 hover:text-[#0f0] transition-colors border-b border-[#222]"
   189→                            onClick={() => {
   190→                                onAction?.(contextMenu.agentId, 'pause_tree');
   191→                                setContextMenu(null);
   192→                            }}
   193→                        >
   194→                            PAUSE TREE
   195→                        </button>
   196→                    )}
   197→
   198→                    {(agents[contextMenu.agentId]?.state === 'paused' || agents[contextMenu.agentId]?.state === 'waiting') && (
   199→                        <button
   200→                            className="w-full text-left px-2 py-1.5 text-[#0f0] hover:bg-[#0f0]/10 hover:text-[#0f0] transition-colors border-b border-[#222]"
   201→                            onClick={() => {
   202→                                onAction?.(contextMenu.agentId, 'resume_tree');
   203→                                setContextMenu(null);
   204→                            }}
   205→                        >
   206→                            RESUME TREE
   207→                        </button>
   208→                    )}
   209→
   210→                    <button
   211→                        className="w-full text-left px-2 py-1.5 text-[#f44] hover:bg-[#f44]/10 hover:text-[#f44] transition-colors"
   212→                        onClick={async () => {
   213→                            await onAction?.(contextMenu.agentId, 'delete');
   214→                            setContextMenu(null);
   215→                        }}
   216→                    >
   217→                        DELETE
   218→                    </button>
   219→                </div>
   220→            )}
   221→        </div>
   222→    );
   223→};
   224→
   225→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
